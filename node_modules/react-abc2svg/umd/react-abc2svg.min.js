/*!
 * react-abc2svg v0.0.0-development
 * LGPL-3.0 Licensed
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("react")):"function"==typeof define&&define.amd?define(["react"],t):"object"==typeof exports?exports.ReactAbc2svg=t(require("react")):e.ReactAbc2svg=t(e.React)}("undefined"!=typeof self?self:this,function(__WEBPACK_EXTERNAL_MODULE_0__){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=2)}([function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_0__},function(e,t,n){"use strict";function r(e){return function(){return e}}var s=function(){};s.thatReturns=r,s.thatReturnsFalse=r(!1),s.thatReturnsTrue=r(!0),s.thatReturnsNull=r(null),s.thatReturnsThis=function(){return this},s.thatReturnsArgument=function(e){return e},e.exports=s},function(e,t,n){e.exports=n(3)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(0),s=n.n(r),a=n(4),o=(n.n(a),n(16));n.n(o);function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var l=function e(){var t=this;c(this,e),this.abc_svg_output="",this.abc_error_output="",this.img_out=function(e){t.abc_svg_output+=e},this.errmsg=function(e,n,r){t.abc_error_output+=e+"<br/>\n"},this.read_file=function(e){return""},this.anno_start=function(e,t,n,r,s,a,o){},this.anno_stop=function(e,t,n,r,s,a,o){},this.get_abcmodel=function(e,t,n,r){},this.page_format=!0},f=function(e){function t(){var n,r;c(this,t);for(var s=arguments.length,o=Array(s),f=0;f<s;f++)o[f]=arguments[f];return n=r=i(this,e.call.apply(e,[this].concat(o))),r.state={containerWidth:""},r.uniqueNumber=Date.now()+Math.random(),r.abcCallbacks=new l,r.fitWidth=function(){r.setState({containerWidth:"%%pagewidth "+window.getComputedStyle(Object(a.findDOMNode)(r)).width+"\n"})},i(r,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){this.fitWidth(),window.addEventListener("resize",this.fitWidth)},t.prototype.componentWillUnmount=function(){window.removeEventListener("resize",this.fitWidth)},t.prototype.render=function(){var e=this.props,t=e.abcNotation,n=e.showErrors,r=this.state.containerWidth,a=new o.Abc(this.abcCallbacks);return this.abcCallbacks.abc_svg_output="",this.abcCallbacks.abc_error_output="",a.tosvg("ABC NOTATION","%%fullsvg ra2s"+this.uniqueNumber+"\n"+r+t),s.a.createElement("div",{style:{width:"100%"}},s.a.createElement("div",{className:"abc2svg-result",style:{width:"100%"},dangerouslySetInnerHTML:{__html:this.abcCallbacks.abc_svg_output}}),n&&""!==this.abcCallbacks.abc_error_output&&s.a.createElement("div",{className:"abc2svg-errors",style:{width:"100%",textAlign:"center"},dangerouslySetInnerHTML:{__html:this.abcCallbacks.abc_error_output}}))},t}(r.PureComponent);f.defaultProps={abcNotation:"",showErrors:!1},t.default=f},function(e,t,n){"use strict";!function e(){if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE)try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(e){console.error(e)}}(),e.exports=n(5)},function(e,t,n){"use strict";var r=n(0),s=n(6),a=n(7),o=n(1),i=n(8),c=n(9),l=n(10),f=n(11),u=n(14),p=n(15);function d(e){for(var t=arguments.length-1,n="Minified React error #"+e+"; visit http://facebook.github.io/react/docs/error-decoder.html?invariant="+e,r=0;r<t;r++)n+="&args[]="+encodeURIComponent(arguments[r+1]);throw(t=Error(n+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings.")).name="Invariant Violation",t.framesToPop=1,t}r||d("227");var _={children:!0,dangerouslySetInnerHTML:!0,defaultValue:!0,defaultChecked:!0,innerHTML:!0,suppressContentEditableWarning:!0,suppressHydrationWarning:!0,style:!0};function m(e,t){return(e&t)===t}var v={MUST_USE_PROPERTY:1,HAS_BOOLEAN_VALUE:4,HAS_NUMERIC_VALUE:8,HAS_POSITIVE_NUMERIC_VALUE:24,HAS_OVERLOADED_BOOLEAN_VALUE:32,HAS_STRING_BOOLEAN_VALUE:64,injectDOMPropertyConfig:function(e){var t=v,n=e.Properties||{},r=e.DOMAttributeNamespaces||{},s=e.DOMAttributeNames||{};for(var a in e=e.DOMMutationMethods||{},n){y.hasOwnProperty(a)&&d("48",a);var o=a.toLowerCase(),i=n[a];1>=(o={attributeName:o,attributeNamespace:null,propertyName:a,mutationMethod:null,mustUseProperty:m(i,t.MUST_USE_PROPERTY),hasBooleanValue:m(i,t.HAS_BOOLEAN_VALUE),hasNumericValue:m(i,t.HAS_NUMERIC_VALUE),hasPositiveNumericValue:m(i,t.HAS_POSITIVE_NUMERIC_VALUE),hasOverloadedBooleanValue:m(i,t.HAS_OVERLOADED_BOOLEAN_VALUE),hasStringBooleanValue:m(i,t.HAS_STRING_BOOLEAN_VALUE)}).hasBooleanValue+o.hasNumericValue+o.hasOverloadedBooleanValue||d("50",a),s.hasOwnProperty(a)&&(o.attributeName=s[a]),r.hasOwnProperty(a)&&(o.attributeNamespace=r[a]),e.hasOwnProperty(a)&&(o.mutationMethod=e[a]),y[a]=o}}},y={};function h(e,t){if(_.hasOwnProperty(e)||2<e.length&&("o"===e[0]||"O"===e[0])&&("n"===e[1]||"N"===e[1]))return!1;if(null===t)return!0;switch(typeof t){case"boolean":return _.hasOwnProperty(e)?e=!0:(t=b(e))?e=t.hasBooleanValue||t.hasStringBooleanValue||t.hasOverloadedBooleanValue:e="data-"===(e=e.toLowerCase().slice(0,5))||"aria-"===e,e;case"undefined":case"number":case"string":case"object":return!0;default:return!1}}function b(e){return y.hasOwnProperty(e)?y[e]:null}var g=v,x=g.MUST_USE_PROPERTY,k=g.HAS_BOOLEAN_VALUE,w=g.HAS_NUMERIC_VALUE,E=g.HAS_POSITIVE_NUMERIC_VALUE,A=g.HAS_OVERLOADED_BOOLEAN_VALUE,T=g.HAS_STRING_BOOLEAN_VALUE,C={Properties:{allowFullScreen:k,async:k,autoFocus:k,autoPlay:k,capture:A,checked:x|k,cols:E,contentEditable:T,controls:k,default:k,defer:k,disabled:k,download:A,draggable:T,formNoValidate:k,hidden:k,loop:k,multiple:x|k,muted:x|k,noValidate:k,open:k,playsInline:k,readOnly:k,required:k,reversed:k,rows:E,rowSpan:w,scoped:k,seamless:k,selected:x|k,size:E,start:w,span:E,spellCheck:T,style:0,tabIndex:0,itemScope:k,acceptCharset:0,className:0,htmlFor:0,httpEquiv:0,value:T},DOMAttributeNames:{acceptCharset:"accept-charset",className:"class",htmlFor:"for",httpEquiv:"http-equiv"},DOMMutationMethods:{value:function(e,t){if(null==t)return e.removeAttribute("value");"number"!==e.type||!1===e.hasAttribute("value")?e.setAttribute("value",""+t):e.validity&&!e.validity.badInput&&e.ownerDocument.activeElement!==e&&e.setAttribute("value",""+t)}}},S=g.HAS_STRING_BOOLEAN_VALUE,O="http://www.w3.org/1999/xlink",N="http://www.w3.org/XML/1998/namespace",B={Properties:{autoReverse:S,externalResourcesRequired:S,preserveAlpha:S},DOMAttributeNames:{autoReverse:"autoReverse",externalResourcesRequired:"externalResourcesRequired",preserveAlpha:"preserveAlpha"},DOMAttributeNamespaces:{xlinkActuate:O,xlinkArcrole:O,xlinkHref:O,xlinkRole:O,xlinkShow:O,xlinkTitle:O,xlinkType:O,xmlBase:N,xmlLang:N,xmlSpace:N}},R=/[\-\:]([a-z])/g;function L(e){return e[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode x-height xlink:actuate xlink:arcrole xlink:href xlink:role xlink:show xlink:title xlink:type xml:base xmlns:xlink xml:lang xml:space".split(" ").forEach(function(e){var t=e.replace(R,L);B.Properties[t]=0,B.DOMAttributeNames[t]=e}),g.injectDOMPropertyConfig(C),g.injectDOMPropertyConfig(B);var P={_caughtError:null,_hasCaughtError:!1,_rethrowError:null,_hasRethrowError:!1,injection:{injectErrorUtils:function(e){"function"!=typeof e.invokeGuardedCallback&&d("197"),M=e.invokeGuardedCallback}},invokeGuardedCallback:function(e,t,n,r,s,a,o,i,c){M.apply(P,arguments)},invokeGuardedCallbackAndCatchFirstError:function(e,t,n,r,s,a,o,i,c){if(P.invokeGuardedCallback.apply(this,arguments),P.hasCaughtError()){var l=P.clearCaughtError();P._hasRethrowError||(P._hasRethrowError=!0,P._rethrowError=l)}},rethrowCaughtError:function(){return function(){if(P._hasRethrowError){var e=P._rethrowError;throw P._rethrowError=null,P._hasRethrowError=!1,e}}.apply(P,arguments)},hasCaughtError:function(){return P._hasCaughtError},clearCaughtError:function(){if(P._hasCaughtError){var e=P._caughtError;return P._caughtError=null,P._hasCaughtError=!1,e}d("198")}};function M(e,t,n,r,s,a,o,i,c){P._hasCaughtError=!1,P._caughtError=null;var l=Array.prototype.slice.call(arguments,3);try{t.apply(n,l)}catch(e){P._caughtError=e,P._hasCaughtError=!0}}var F=null,I={};function D(){if(F)for(var e in I){var t=I[e],n=F.indexOf(e);if(-1<n||d("96",e),!U[n])for(var r in t.extractEvents||d("97",e),U[n]=t,n=t.eventTypes){var s=void 0,a=n[r],o=t,i=r;V.hasOwnProperty(i)&&d("99",i),V[i]=a;var c=a.phasedRegistrationNames;if(c){for(s in c)c.hasOwnProperty(s)&&H(c[s],o,i);s=!0}else a.registrationName?(H(a.registrationName,o,i),s=!0):s=!1;s||d("98",r,e)}}}function H(e,t,n){z[e]&&d("100",e),z[e]=t,Y[e]=t.eventTypes[n].dependencies}var U=[],V={},z={},Y={};function X(e){F&&d("101"),F=Array.prototype.slice.call(e),D()}function j(e){var t,n=!1;for(t in e)if(e.hasOwnProperty(t)){var r=e[t];I.hasOwnProperty(t)&&I[t]===r||(I[t]&&d("102",t),I[t]=r,n=!0)}n&&D()}var K=Object.freeze({plugins:U,eventNameDispatchConfigs:V,registrationNameModules:z,registrationNameDependencies:Y,possibleRegistrationNames:null,injectEventPluginOrder:X,injectEventPluginsByName:j}),q=null,Q=null,W=null;function G(e,t,n,r){t=e.type||"unknown-event",e.currentTarget=W(r),P.invokeGuardedCallbackAndCatchFirstError(t,n,void 0,e),e.currentTarget=null}function J(e,t){return null==t&&d("30"),null==e?t:Array.isArray(e)?Array.isArray(t)?(e.push.apply(e,t),e):(e.push(t),e):Array.isArray(t)?[e].concat(t):[e,t]}function Z(e,t,n){Array.isArray(e)?e.forEach(t,n):e&&t.call(n,e)}var $=null;function ee(e,t){if(e){var n=e._dispatchListeners,r=e._dispatchInstances;if(Array.isArray(n))for(var s=0;s<n.length&&!e.isPropagationStopped();s++)G(e,t,n[s],r[s]);else n&&G(e,t,n,r);e._dispatchListeners=null,e._dispatchInstances=null,e.isPersistent()||e.constructor.release(e)}}function te(e){return ee(e,!0)}function ne(e){return ee(e,!1)}var re={injectEventPluginOrder:X,injectEventPluginsByName:j};function se(e,t){var n=e.stateNode;if(!n)return null;var r=q(n);if(!r)return null;n=r[t];e:switch(t){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":(r=!r.disabled)||(r=!("button"===(e=e.type)||"input"===e||"select"===e||"textarea"===e)),e=!r;break e;default:e=!1}return e?null:(n&&"function"!=typeof n&&d("231",t,typeof n),n)}function ae(e,t,n,r){for(var s,a=0;a<U.length;a++){var o=U[a];o&&(o=o.extractEvents(e,t,n,r))&&(s=J(s,o))}return s}function oe(e){e&&($=J($,e))}function ie(e){var t=$;$=null,t&&(Z(t,e?te:ne),$&&d("95"),P.rethrowCaughtError())}var ce=Object.freeze({injection:re,getListener:se,extractEvents:ae,enqueueEvents:oe,processEventQueue:ie}),le=Math.random().toString(36).slice(2),fe="__reactInternalInstance$"+le,ue="__reactEventHandlers$"+le;function pe(e){if(e[fe])return e[fe];for(var t=[];!e[fe];){if(t.push(e),!e.parentNode)return null;e=e.parentNode}var n=void 0,r=e[fe];if(5===r.tag||6===r.tag)return r;for(;e&&(r=e[fe]);e=t.pop())n=r;return n}function de(e){if(5===e.tag||6===e.tag)return e.stateNode;d("33")}function _e(e){return e[ue]||null}var me=Object.freeze({precacheFiberNode:function(e,t){t[fe]=e},getClosestInstanceFromNode:pe,getInstanceFromNode:function(e){return!(e=e[fe])||5!==e.tag&&6!==e.tag?null:e},getNodeFromInstance:de,getFiberCurrentPropsFromNode:_e,updateFiberProps:function(e,t){e[ue]=t}});function ve(e){do{e=e.return}while(e&&5!==e.tag);return e||null}function ye(e,t,n){for(var r=[];e;)r.push(e),e=ve(e);for(e=r.length;0<e--;)t(r[e],"captured",n);for(e=0;e<r.length;e++)t(r[e],"bubbled",n)}function he(e,t,n){(t=se(e,n.dispatchConfig.phasedRegistrationNames[t]))&&(n._dispatchListeners=J(n._dispatchListeners,t),n._dispatchInstances=J(n._dispatchInstances,e))}function be(e){e&&e.dispatchConfig.phasedRegistrationNames&&ye(e._targetInst,he,e)}function ge(e){if(e&&e.dispatchConfig.phasedRegistrationNames){var t=e._targetInst;ye(t=t?ve(t):null,he,e)}}function xe(e,t,n){e&&n&&n.dispatchConfig.registrationName&&(t=se(e,n.dispatchConfig.registrationName))&&(n._dispatchListeners=J(n._dispatchListeners,t),n._dispatchInstances=J(n._dispatchInstances,e))}function ke(e){e&&e.dispatchConfig.registrationName&&xe(e._targetInst,null,e)}function we(e){Z(e,be)}function Ee(e,t,n,r){if(n&&r)e:{for(var s=n,a=r,o=0,i=s;i;i=ve(i))o++;i=0;for(var c=a;c;c=ve(c))i++;for(;0<o-i;)s=ve(s),o--;for(;0<i-o;)a=ve(a),i--;for(;o--;){if(s===a||s===a.alternate)break e;s=ve(s),a=ve(a)}s=null}else s=null;for(a=s,s=[];n&&n!==a&&(null===(o=n.alternate)||o!==a);)s.push(n),n=ve(n);for(n=[];r&&r!==a&&(null===(o=r.alternate)||o!==a);)n.push(r),r=ve(r);for(r=0;r<s.length;r++)xe(s[r],"bubbled",e);for(e=n.length;0<e--;)xe(n[e],"captured",t)}var Ae=Object.freeze({accumulateTwoPhaseDispatches:we,accumulateTwoPhaseDispatchesSkipTarget:function(e){Z(e,ge)},accumulateEnterLeaveDispatches:Ee,accumulateDirectDispatches:function(e){Z(e,ke)}}),Te=null;function Ce(){return!Te&&s.canUseDOM&&(Te="textContent"in document.documentElement?"textContent":"innerText"),Te}var Se={_root:null,_startText:null,_fallbackText:null};function Oe(){if(Se._fallbackText)return Se._fallbackText;var e,t,n=Se._startText,r=n.length,s=Ne(),a=s.length;for(e=0;e<r&&n[e]===s[e];e++);var o=r-e;for(t=1;t<=o&&n[r-t]===s[a-t];t++);return Se._fallbackText=s.slice(e,1<t?1-t:void 0),Se._fallbackText}function Ne(){return"value"in Se._root?Se._root.value:Se._root[Ce()]}var Be="dispatchConfig _targetInst nativeEvent isDefaultPrevented isPropagationStopped _dispatchListeners _dispatchInstances".split(" "),Re={type:null,target:null,currentTarget:o.thatReturnsNull,eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(e){return e.timeStamp||Date.now()},defaultPrevented:null,isTrusted:null};function Le(e,t,n,r){for(var s in this.dispatchConfig=e,this._targetInst=t,this.nativeEvent=n,e=this.constructor.Interface)e.hasOwnProperty(s)&&((t=e[s])?this[s]=t(n):"target"===s?this.target=r:this[s]=n[s]);return this.isDefaultPrevented=(null!=n.defaultPrevented?n.defaultPrevented:!1===n.returnValue)?o.thatReturnsTrue:o.thatReturnsFalse,this.isPropagationStopped=o.thatReturnsFalse,this}function Pe(e,t,n,r){if(this.eventPool.length){var s=this.eventPool.pop();return this.call(s,e,t,n,r),s}return new this(e,t,n,r)}function Me(e){e instanceof this||d("223"),e.destructor(),10>this.eventPool.length&&this.eventPool.push(e)}function Fe(e){e.eventPool=[],e.getPooled=Pe,e.release=Me}function Ie(e,t,n,r){return Le.call(this,e,t,n,r)}function De(e,t,n,r){return Le.call(this,e,t,n,r)}a(Le.prototype,{preventDefault:function(){this.defaultPrevented=!0;var e=this.nativeEvent;e&&(e.preventDefault?e.preventDefault():"unknown"!=typeof e.returnValue&&(e.returnValue=!1),this.isDefaultPrevented=o.thatReturnsTrue)},stopPropagation:function(){var e=this.nativeEvent;e&&(e.stopPropagation?e.stopPropagation():"unknown"!=typeof e.cancelBubble&&(e.cancelBubble=!0),this.isPropagationStopped=o.thatReturnsTrue)},persist:function(){this.isPersistent=o.thatReturnsTrue},isPersistent:o.thatReturnsFalse,destructor:function(){var e,t=this.constructor.Interface;for(e in t)this[e]=null;for(t=0;t<Be.length;t++)this[Be[t]]=null}}),Le.Interface=Re,Le.augmentClass=function(e,t){function n(){}n.prototype=this.prototype;var r=new n;a(r,e.prototype),e.prototype=r,e.prototype.constructor=e,e.Interface=a({},this.Interface,t),e.augmentClass=this.augmentClass,Fe(e)},Fe(Le),Le.augmentClass(Ie,{data:null}),Le.augmentClass(De,{data:null});var He,Ue=[9,13,27,32],Ve=s.canUseDOM&&"CompositionEvent"in window,ze=null;if(s.canUseDOM&&"documentMode"in document&&(ze=document.documentMode),He=s.canUseDOM&&"TextEvent"in window&&!ze){var Ye=window.opera;He=!("object"==typeof Ye&&"function"==typeof Ye.version&&12>=parseInt(Ye.version(),10))}var Xe=He,je=s.canUseDOM&&(!Ve||ze&&8<ze&&11>=ze),Ke=String.fromCharCode(32),qe={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["topCompositionEnd","topKeyPress","topTextInput","topPaste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"topBlur topCompositionEnd topKeyDown topKeyPress topKeyUp topMouseDown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},dependencies:"topBlur topCompositionStart topKeyDown topKeyPress topKeyUp topMouseDown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"topBlur topCompositionUpdate topKeyDown topKeyPress topKeyUp topMouseDown".split(" ")}},Qe=!1;function We(e,t){switch(e){case"topKeyUp":return-1!==Ue.indexOf(t.keyCode);case"topKeyDown":return 229!==t.keyCode;case"topKeyPress":case"topMouseDown":case"topBlur":return!0;default:return!1}}function Ge(e){return"object"==typeof(e=e.detail)&&"data"in e?e.data:null}var Je=!1;var Ze={eventTypes:qe,extractEvents:function(e,t,n,r){var s;if(Ve)e:{switch(e){case"topCompositionStart":var a=qe.compositionStart;break e;case"topCompositionEnd":a=qe.compositionEnd;break e;case"topCompositionUpdate":a=qe.compositionUpdate;break e}a=void 0}else Je?We(e,n)&&(a=qe.compositionEnd):"topKeyDown"===e&&229===n.keyCode&&(a=qe.compositionStart);return a?(je&&(Je||a!==qe.compositionStart?a===qe.compositionEnd&&Je&&(s=Oe()):(Se._root=r,Se._startText=Ne(),Je=!0)),a=Ie.getPooled(a,t,n,r),s?a.data=s:null!==(s=Ge(n))&&(a.data=s),we(a),s=a):s=null,(e=Xe?function(e,t){switch(e){case"topCompositionEnd":return Ge(t);case"topKeyPress":return 32!==t.which?null:(Qe=!0,Ke);case"topTextInput":return(e=t.data)===Ke&&Qe?null:e;default:return null}}(e,n):function(e,t){if(Je)return"topCompositionEnd"===e||!Ve&&We(e,t)?(e=Oe(),Se._root=null,Se._startText=null,Se._fallbackText=null,Je=!1,e):null;switch(e){case"topPaste":return null;case"topKeyPress":if(!(t.ctrlKey||t.altKey||t.metaKey)||t.ctrlKey&&t.altKey){if(t.char&&1<t.char.length)return t.char;if(t.which)return String.fromCharCode(t.which)}return null;case"topCompositionEnd":return je?null:t.data;default:return null}}(e,n))?((t=De.getPooled(qe.beforeInput,t,n,r)).data=e,we(t)):t=null,[s,t]}},$e=null,et=null,tt=null;function nt(e){if(e=Q(e)){$e&&"function"==typeof $e.restoreControlledState||d("194");var t=q(e.stateNode);$e.restoreControlledState(e.stateNode,e.type,t)}}var rt={injectFiberControlledHostComponent:function(e){$e=e}};function st(e){et?tt?tt.push(e):tt=[e]:et=e}function at(){if(et){var e=et,t=tt;if(tt=et=null,nt(e),t)for(e=0;e<t.length;e++)nt(t[e])}}var ot=Object.freeze({injection:rt,enqueueStateRestore:st,restoreStateIfNeeded:at});function it(e,t){return e(t)}var ct=!1;function lt(e,t){if(ct)return it(e,t);ct=!0;try{return it(e,t)}finally{ct=!1,at()}}var ft,ut={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function pt(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return"input"===t?!!ut[e.type]:"textarea"===t}function dt(e){return(e=e.target||e.srcElement||window).correspondingUseElement&&(e=e.correspondingUseElement),3===e.nodeType?e.parentNode:e}function _t(e,t){if(!s.canUseDOM||t&&!("addEventListener"in document))return!1;var n=(t="on"+e)in document;return n||((n=document.createElement("div")).setAttribute(t,"return;"),n="function"==typeof n[t]),!n&&ft&&"wheel"===e&&(n=document.implementation.hasFeature("Events.wheel","3.0")),n}function mt(e){var t=e.type;return(e=e.nodeName)&&"input"===e.toLowerCase()&&("checkbox"===t||"radio"===t)}function vt(e){e._valueTracker||(e._valueTracker=function(e){var t=mt(e)?"checked":"value",n=Object.getOwnPropertyDescriptor(e.constructor.prototype,t),r=""+e[t];if(!e.hasOwnProperty(t)&&"function"==typeof n.get&&"function"==typeof n.set)return Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:!0,get:function(){return n.get.call(this)},set:function(e){r=""+e,n.set.call(this,e)}}),{getValue:function(){return r},setValue:function(e){r=""+e},stopTracking:function(){e._valueTracker=null,delete e[t]}}}(e))}function yt(e){if(!e)return!1;var t=e._valueTracker;if(!t)return!0;var n=t.getValue(),r="";return e&&(r=mt(e)?e.checked?"true":"false":e.value),(e=r)!==n&&(t.setValue(e),!0)}s.canUseDOM&&(ft=document.implementation&&document.implementation.hasFeature&&!0!==document.implementation.hasFeature("",""));var ht={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"topBlur topChange topClick topFocus topInput topKeyDown topKeyUp topSelectionChange".split(" ")}};function bt(e,t,n){return(e=Le.getPooled(ht.change,e,t,n)).type="change",st(n),we(e),e}var gt=null,xt=null;function kt(e){oe(e),ie(!1)}function wt(e){if(yt(de(e)))return e}function Et(e,t){if("topChange"===e)return t}var At=!1;function Tt(){gt&&(gt.detachEvent("onpropertychange",Ct),xt=gt=null)}function Ct(e){"value"===e.propertyName&&wt(xt)&&lt(kt,e=bt(xt,e,dt(e)))}function St(e,t,n){"topFocus"===e?(Tt(),xt=n,(gt=t).attachEvent("onpropertychange",Ct)):"topBlur"===e&&Tt()}function Ot(e){if("topSelectionChange"===e||"topKeyUp"===e||"topKeyDown"===e)return wt(xt)}function Nt(e,t){if("topClick"===e)return wt(t)}function Bt(e,t){if("topInput"===e||"topChange"===e)return wt(t)}s.canUseDOM&&(At=_t("input")&&(!document.documentMode||9<document.documentMode));var Rt={eventTypes:ht,_isInputEventSupported:At,extractEvents:function(e,t,n,r){var s=t?de(t):window,a=s.nodeName&&s.nodeName.toLowerCase();if("select"===a||"input"===a&&"file"===s.type)var o=Et;else if(pt(s))if(At)o=Bt;else{o=Ot;var i=St}else!(a=s.nodeName)||"input"!==a.toLowerCase()||"checkbox"!==s.type&&"radio"!==s.type||(o=Nt);if(o&&(o=o(e,t)))return bt(o,n,r);i&&i(e,s,t),"topBlur"===e&&null!=t&&(e=t._wrapperState||s._wrapperState)&&e.controlled&&"number"===s.type&&(e=""+s.value,s.getAttribute("value")!==e&&s.setAttribute("value",e))}};function Lt(e,t,n,r){return Le.call(this,e,t,n,r)}Le.augmentClass(Lt,{view:null,detail:null});var Pt={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function Mt(e){var t=this.nativeEvent;return t.getModifierState?t.getModifierState(e):!!(e=Pt[e])&&!!t[e]}function Ft(){return Mt}function It(e,t,n,r){return Le.call(this,e,t,n,r)}Lt.augmentClass(It,{screenX:null,screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:Ft,button:null,buttons:null,relatedTarget:function(e){return e.relatedTarget||(e.fromElement===e.srcElement?e.toElement:e.fromElement)}});var Dt={mouseEnter:{registrationName:"onMouseEnter",dependencies:["topMouseOut","topMouseOver"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["topMouseOut","topMouseOver"]}},Ht={eventTypes:Dt,extractEvents:function(e,t,n,r){if("topMouseOver"===e&&(n.relatedTarget||n.fromElement)||"topMouseOut"!==e&&"topMouseOver"!==e)return null;var s=r.window===r?r:(s=r.ownerDocument)?s.defaultView||s.parentWindow:window;if("topMouseOut"===e?(e=t,t=(t=n.relatedTarget||n.toElement)?pe(t):null):e=null,e===t)return null;var a=null==e?s:de(e);s=null==t?s:de(t);var o=It.getPooled(Dt.mouseLeave,e,n,r);return o.type="mouseleave",o.target=a,o.relatedTarget=s,(n=It.getPooled(Dt.mouseEnter,t,n,r)).type="mouseenter",n.target=s,n.relatedTarget=a,Ee(o,n,e,t),[o,n]}},Ut=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner;function Vt(e){return"string"==typeof(e=e.type)?e:"function"==typeof e?e.displayName||e.name:null}function zt(e){var t=e;if(e.alternate)for(;t.return;)t=t.return;else{if(0!=(2&t.effectTag))return 1;for(;t.return;)if(0!=(2&(t=t.return).effectTag))return 1}return 3===t.tag?2:3}function Yt(e){return!!(e=e._reactInternalFiber)&&2===zt(e)}function Xt(e){2!==zt(e)&&d("188")}function jt(e){var t=e.alternate;if(!t)return 3===(t=zt(e))&&d("188"),1===t?null:e;for(var n=e,r=t;;){var s=n.return,a=s?s.alternate:null;if(!s||!a)break;if(s.child===a.child){for(var o=s.child;o;){if(o===n)return Xt(s),e;if(o===r)return Xt(s),t;o=o.sibling}d("188")}if(n.return!==r.return)n=s,r=a;else{o=!1;for(var i=s.child;i;){if(i===n){o=!0,n=s,r=a;break}if(i===r){o=!0,r=s,n=a;break}i=i.sibling}if(!o){for(i=a.child;i;){if(i===n){o=!0,n=a,r=s;break}if(i===r){o=!0,r=a,n=s;break}i=i.sibling}o||d("189")}}n.alternate!==r&&d("190")}return 3!==n.tag&&d("188"),n.stateNode.current===n?e:t}var Kt=[];function qt(e){var t=e.targetInst;do{if(!t){e.ancestors.push(t);break}var n;for(n=t;n.return;)n=n.return;if(!(n=3!==n.tag?null:n.stateNode.containerInfo))break;e.ancestors.push(t),t=pe(n)}while(t);for(n=0;n<e.ancestors.length;n++)t=e.ancestors[n],Wt(e.topLevelType,t,e.nativeEvent,dt(e.nativeEvent))}var Qt=!0,Wt=void 0;function Gt(e){Qt=!!e}function Jt(e,t,n){return n?i.listen(n,t,$t.bind(null,e)):null}function Zt(e,t,n){return n?i.capture(n,t,$t.bind(null,e)):null}function $t(e,t){if(Qt){var n=dt(t);if(null===(n=pe(n))||"number"!=typeof n.tag||2===zt(n)||(n=null),Kt.length){var r=Kt.pop();r.topLevelType=e,r.nativeEvent=t,r.targetInst=n,e=r}else e={topLevelType:e,nativeEvent:t,targetInst:n,ancestors:[]};try{lt(qt,e)}finally{e.topLevelType=null,e.nativeEvent=null,e.targetInst=null,e.ancestors.length=0,10>Kt.length&&Kt.push(e)}}}var en=Object.freeze({get _enabled(){return Qt},get _handleTopLevel(){return Wt},setHandleTopLevel:function(e){Wt=e},setEnabled:Gt,isEnabled:function(){return Qt},trapBubbledEvent:Jt,trapCapturedEvent:Zt,dispatchEvent:$t});function tn(e,t){var n={};return n[e.toLowerCase()]=t.toLowerCase(),n["Webkit"+e]="webkit"+t,n["Moz"+e]="moz"+t,n["ms"+e]="MS"+t,n["O"+e]="o"+t.toLowerCase(),n}var nn={animationend:tn("Animation","AnimationEnd"),animationiteration:tn("Animation","AnimationIteration"),animationstart:tn("Animation","AnimationStart"),transitionend:tn("Transition","TransitionEnd")},rn={},sn={};function an(e){if(rn[e])return rn[e];if(!nn[e])return e;var t,n=nn[e];for(t in n)if(n.hasOwnProperty(t)&&t in sn)return rn[e]=n[t];return""}s.canUseDOM&&(sn=document.createElement("div").style,"AnimationEvent"in window||(delete nn.animationend.animation,delete nn.animationiteration.animation,delete nn.animationstart.animation),"TransitionEvent"in window||delete nn.transitionend.transition);var on={topAbort:"abort",topAnimationEnd:an("animationend")||"animationend",topAnimationIteration:an("animationiteration")||"animationiteration",topAnimationStart:an("animationstart")||"animationstart",topBlur:"blur",topCancel:"cancel",topCanPlay:"canplay",topCanPlayThrough:"canplaythrough",topChange:"change",topClick:"click",topClose:"close",topCompositionEnd:"compositionend",topCompositionStart:"compositionstart",topCompositionUpdate:"compositionupdate",topContextMenu:"contextmenu",topCopy:"copy",topCut:"cut",topDoubleClick:"dblclick",topDrag:"drag",topDragEnd:"dragend",topDragEnter:"dragenter",topDragExit:"dragexit",topDragLeave:"dragleave",topDragOver:"dragover",topDragStart:"dragstart",topDrop:"drop",topDurationChange:"durationchange",topEmptied:"emptied",topEncrypted:"encrypted",topEnded:"ended",topError:"error",topFocus:"focus",topInput:"input",topKeyDown:"keydown",topKeyPress:"keypress",topKeyUp:"keyup",topLoadedData:"loadeddata",topLoad:"load",topLoadedMetadata:"loadedmetadata",topLoadStart:"loadstart",topMouseDown:"mousedown",topMouseMove:"mousemove",topMouseOut:"mouseout",topMouseOver:"mouseover",topMouseUp:"mouseup",topPaste:"paste",topPause:"pause",topPlay:"play",topPlaying:"playing",topProgress:"progress",topRateChange:"ratechange",topScroll:"scroll",topSeeked:"seeked",topSeeking:"seeking",topSelectionChange:"selectionchange",topStalled:"stalled",topSuspend:"suspend",topTextInput:"textInput",topTimeUpdate:"timeupdate",topToggle:"toggle",topTouchCancel:"touchcancel",topTouchEnd:"touchend",topTouchMove:"touchmove",topTouchStart:"touchstart",topTransitionEnd:an("transitionend")||"transitionend",topVolumeChange:"volumechange",topWaiting:"waiting",topWheel:"wheel"},cn={},ln=0,fn="_reactListenersID"+(""+Math.random()).slice(2);function un(e){return Object.prototype.hasOwnProperty.call(e,fn)||(e[fn]=ln++,cn[e[fn]]={}),cn[e[fn]]}function pn(e){for(;e&&e.firstChild;)e=e.firstChild;return e}function dn(e,t){var n,r=pn(e);for(e=0;r;){if(3===r.nodeType){if(n=e+r.textContent.length,e<=t&&n>=t)return{node:r,offset:t-e};e=n}e:{for(;r;){if(r.nextSibling){r=r.nextSibling;break e}r=r.parentNode}r=void 0}r=pn(r)}}function _n(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return t&&("input"===t&&"text"===e.type||"textarea"===t||"true"===e.contentEditable)}var mn=s.canUseDOM&&"documentMode"in document&&11>=document.documentMode,vn={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},dependencies:"topBlur topContextMenu topFocus topKeyDown topKeyUp topMouseDown topMouseUp topSelectionChange".split(" ")}},yn=null,hn=null,bn=null,gn=!1;function xn(e,t){if(gn||null==yn||yn!==c())return null;var n=yn;return"selectionStart"in n&&_n(n)?n={start:n.selectionStart,end:n.selectionEnd}:window.getSelection?n={anchorNode:(n=window.getSelection()).anchorNode,anchorOffset:n.anchorOffset,focusNode:n.focusNode,focusOffset:n.focusOffset}:n=void 0,bn&&l(bn,n)?null:(bn=n,(e=Le.getPooled(vn.select,hn,e,t)).type="select",e.target=yn,we(e),e)}var kn={eventTypes:vn,extractEvents:function(e,t,n,r){var s,a=r.window===r?r.document:9===r.nodeType?r:r.ownerDocument;if(!(s=!a)){e:{a=un(a),s=Y.onSelect;for(var o=0;o<s.length;o++){var i=s[o];if(!a.hasOwnProperty(i)||!a[i]){a=!1;break e}}a=!0}s=!a}if(s)return null;switch(a=t?de(t):window,e){case"topFocus":(pt(a)||"true"===a.contentEditable)&&(yn=a,hn=t,bn=null);break;case"topBlur":bn=hn=yn=null;break;case"topMouseDown":gn=!0;break;case"topContextMenu":case"topMouseUp":return gn=!1,xn(n,r);case"topSelectionChange":if(mn)break;case"topKeyDown":case"topKeyUp":return xn(n,r)}return null}};function wn(e,t,n,r){return Le.call(this,e,t,n,r)}function En(e,t,n,r){return Le.call(this,e,t,n,r)}function An(e,t,n,r){return Le.call(this,e,t,n,r)}function Tn(e){var t=e.keyCode;return"charCode"in e?0===(e=e.charCode)&&13===t&&(e=13):e=t,32<=e||13===e?e:0}Le.augmentClass(wn,{animationName:null,elapsedTime:null,pseudoElement:null}),Le.augmentClass(En,{clipboardData:function(e){return"clipboardData"in e?e.clipboardData:window.clipboardData}}),Lt.augmentClass(An,{relatedTarget:null});var Cn={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},Sn={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"};function On(e,t,n,r){return Le.call(this,e,t,n,r)}function Nn(e,t,n,r){return Le.call(this,e,t,n,r)}function Bn(e,t,n,r){return Le.call(this,e,t,n,r)}function Rn(e,t,n,r){return Le.call(this,e,t,n,r)}function Ln(e,t,n,r){return Le.call(this,e,t,n,r)}Lt.augmentClass(On,{key:function(e){if(e.key){var t=Cn[e.key]||e.key;if("Unidentified"!==t)return t}return"keypress"===e.type?13===(e=Tn(e))?"Enter":String.fromCharCode(e):"keydown"===e.type||"keyup"===e.type?Sn[e.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:Ft,charCode:function(e){return"keypress"===e.type?Tn(e):0},keyCode:function(e){return"keydown"===e.type||"keyup"===e.type?e.keyCode:0},which:function(e){return"keypress"===e.type?Tn(e):"keydown"===e.type||"keyup"===e.type?e.keyCode:0}}),It.augmentClass(Nn,{dataTransfer:null}),Lt.augmentClass(Bn,{touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:Ft}),Le.augmentClass(Rn,{propertyName:null,elapsedTime:null,pseudoElement:null}),It.augmentClass(Ln,{deltaX:function(e){return"deltaX"in e?e.deltaX:"wheelDeltaX"in e?-e.wheelDeltaX:0},deltaY:function(e){return"deltaY"in e?e.deltaY:"wheelDeltaY"in e?-e.wheelDeltaY:"wheelDelta"in e?-e.wheelDelta:0},deltaZ:null,deltaMode:null});var Pn={},Mn={};"abort animationEnd animationIteration animationStart blur cancel canPlay canPlayThrough click close contextMenu copy cut doubleClick drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error focus input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing progress rateChange reset scroll seeked seeking stalled submit suspend timeUpdate toggle touchCancel touchEnd touchMove touchStart transitionEnd volumeChange waiting wheel".split(" ").forEach(function(e){var t=e[0].toUpperCase()+e.slice(1),n="on"+t;n={phasedRegistrationNames:{bubbled:n,captured:n+"Capture"},dependencies:[t="top"+t]},Pn[e]=n,Mn[t]=n});var Fn={eventTypes:Pn,extractEvents:function(e,t,n,r){var s=Mn[e];if(!s)return null;switch(e){case"topKeyPress":if(0===Tn(n))return null;case"topKeyDown":case"topKeyUp":e=On;break;case"topBlur":case"topFocus":e=An;break;case"topClick":if(2===n.button)return null;case"topDoubleClick":case"topMouseDown":case"topMouseMove":case"topMouseUp":case"topMouseOut":case"topMouseOver":case"topContextMenu":e=It;break;case"topDrag":case"topDragEnd":case"topDragEnter":case"topDragExit":case"topDragLeave":case"topDragOver":case"topDragStart":case"topDrop":e=Nn;break;case"topTouchCancel":case"topTouchEnd":case"topTouchMove":case"topTouchStart":e=Bn;break;case"topAnimationEnd":case"topAnimationIteration":case"topAnimationStart":e=wn;break;case"topTransitionEnd":e=Rn;break;case"topScroll":e=Lt;break;case"topWheel":e=Ln;break;case"topCopy":case"topCut":case"topPaste":e=En;break;default:e=Le}return we(t=e.getPooled(s,t,n,r)),t}};Wt=function(e,t,n,r){oe(e=ae(e,t,n,r)),ie(!1)},re.injectEventPluginOrder("ResponderEventPlugin SimpleEventPlugin TapEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" ")),q=me.getFiberCurrentPropsFromNode,Q=me.getInstanceFromNode,W=me.getNodeFromInstance,re.injectEventPluginsByName({SimpleEventPlugin:Fn,EnterLeaveEventPlugin:Ht,ChangeEventPlugin:Rt,SelectEventPlugin:kn,BeforeInputEventPlugin:Ze});var In=[],Dn=-1;function Hn(e){0>Dn||(e.current=In[Dn],In[Dn]=null,Dn--)}function Un(e,t){In[++Dn]=e.current,e.current=t}new Set;var Vn={current:p},zn={current:!1},Yn=p;function Xn(e){return Kn(e)?Yn:Vn.current}function jn(e,t){var n=e.type.contextTypes;if(!n)return p;var r=e.stateNode;if(r&&r.__reactInternalMemoizedUnmaskedChildContext===t)return r.__reactInternalMemoizedMaskedChildContext;var s,a={};for(s in n)a[s]=t[s];return r&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=t,e.__reactInternalMemoizedMaskedChildContext=a),a}function Kn(e){return 2===e.tag&&null!=e.type.childContextTypes}function qn(e){Kn(e)&&(Hn(zn),Hn(Vn))}function Qn(e,t,n){null!=Vn.cursor&&d("168"),Un(Vn,t),Un(zn,n)}function Wn(e,t){var n=e.stateNode,r=e.type.childContextTypes;if("function"!=typeof n.getChildContext)return t;for(var s in n=n.getChildContext())s in r||d("108",Vt(e)||"Unknown",s);return a({},t,n)}function Gn(e){if(!Kn(e))return!1;var t=e.stateNode;return t=t&&t.__reactInternalMemoizedMergedChildContext||p,Yn=Vn.current,Un(Vn,t),Un(zn,zn.current),!0}function Jn(e,t){var n=e.stateNode;if(n||d("169"),t){var r=Wn(e,Yn);n.__reactInternalMemoizedMergedChildContext=r,Hn(zn),Hn(Vn),Un(Vn,r)}else Hn(zn);Un(zn,t)}function Zn(e,t,n){this.tag=e,this.key=t,this.stateNode=this.type=null,this.sibling=this.child=this.return=null,this.index=0,this.memoizedState=this.updateQueue=this.memoizedProps=this.pendingProps=this.ref=null,this.internalContextTag=n,this.effectTag=0,this.lastEffect=this.firstEffect=this.nextEffect=null,this.expirationTime=0,this.alternate=null}function $n(e,t,n){var r=e.alternate;return null===r?((r=new Zn(e.tag,e.key,e.internalContextTag)).type=e.type,r.stateNode=e.stateNode,r.alternate=e,e.alternate=r):(r.effectTag=0,r.nextEffect=null,r.firstEffect=null,r.lastEffect=null),r.expirationTime=n,r.pendingProps=t,r.child=e.child,r.memoizedProps=e.memoizedProps,r.memoizedState=e.memoizedState,r.updateQueue=e.updateQueue,r.sibling=e.sibling,r.index=e.index,r.ref=e.ref,r}function er(e,t,n){var r=void 0,s=e.type,a=e.key;return"function"==typeof s?((r=s.prototype&&s.prototype.isReactComponent?new Zn(2,a,t):new Zn(0,a,t)).type=s,r.pendingProps=e.props):"string"==typeof s?((r=new Zn(5,a,t)).type=s,r.pendingProps=e.props):"object"==typeof s&&null!==s&&"number"==typeof s.tag?(r=s).pendingProps=e.props:d("130",null==s?s:typeof s,""),r.expirationTime=n,r}function tr(e,t,n,r){return(t=new Zn(10,r,t)).pendingProps=e,t.expirationTime=n,t}function nr(e,t,n){return(t=new Zn(6,null,t)).pendingProps=e,t.expirationTime=n,t}function rr(e,t,n){return(t=new Zn(7,e.key,t)).type=e.handler,t.pendingProps=e,t.expirationTime=n,t}function sr(e,t,n){return(e=new Zn(9,null,t)).expirationTime=n,e}function ar(e,t,n){return(t=new Zn(4,e.key,t)).pendingProps=e.children||[],t.expirationTime=n,t.stateNode={containerInfo:e.containerInfo,pendingChildren:null,implementation:e.implementation},t}var or=null,ir=null;function cr(e){return function(t){try{return e(t)}catch(e){}}}function lr(e){"function"==typeof or&&or(e)}function fr(e){"function"==typeof ir&&ir(e)}function ur(e){return{baseState:e,expirationTime:0,first:null,last:null,callbackList:null,hasForceUpdate:!1,isInitialized:!1}}function pr(e,t){null===e.last?e.first=e.last=t:(e.last.next=t,e.last=t),(0===e.expirationTime||e.expirationTime>t.expirationTime)&&(e.expirationTime=t.expirationTime)}function dr(e,t){var n=e.alternate,r=e.updateQueue;null===r&&(r=e.updateQueue=ur(null)),null!==n?null===(e=n.updateQueue)&&(e=n.updateQueue=ur(null)):e=null,null===(e=e!==r?e:null)?pr(r,t):null===r.last||null===e.last?(pr(r,t),pr(e,t)):(pr(r,t),e.last=t)}function _r(e,t,n,r){return"function"==typeof(e=e.partialState)?e.call(t,n,r):e}function mr(e,t,n,r,s,o){null!==e&&e.updateQueue===n&&(n=t.updateQueue={baseState:n.baseState,expirationTime:n.expirationTime,first:n.first,last:n.last,isInitialized:n.isInitialized,callbackList:null,hasForceUpdate:!1}),n.expirationTime=0,n.isInitialized?e=n.baseState:(e=n.baseState=t.memoizedState,n.isInitialized=!0);for(var i=!0,c=n.first,l=!1;null!==c;){var f=c.expirationTime;if(f>o){var u=n.expirationTime;(0===u||u>f)&&(n.expirationTime=f),l||(l=!0,n.baseState=e)}else l||(n.first=c.next,null===n.first&&(n.last=null)),c.isReplace?(e=_r(c,r,e,s),i=!0):(f=_r(c,r,e,s))&&(e=i?a({},e,f):a(e,f),i=!1),c.isForced&&(n.hasForceUpdate=!0),null!==c.callback&&(null===(f=n.callbackList)&&(f=n.callbackList=[]),f.push(c));c=c.next}return null!==n.callbackList?t.effectTag|=32:null!==n.first||n.hasForceUpdate||(t.updateQueue=null),l||(n.baseState=e),e}function vr(e,t){var n=e.callbackList;if(null!==n)for(e.callbackList=null,e=0;e<n.length;e++){var r=n[e],s=r.callback;r.callback=null,"function"!=typeof s&&d("191",s),s.call(t)}}var yr="function"==typeof Symbol&&Symbol.for,hr=yr?Symbol.for("react.element"):60103,br=yr?Symbol.for("react.call"):60104,gr=yr?Symbol.for("react.return"):60105,xr=yr?Symbol.for("react.portal"):60106,kr=yr?Symbol.for("react.fragment"):60107,wr="function"==typeof Symbol&&Symbol.iterator;function Er(e){return null===e||void 0===e?null:"function"==typeof(e=wr&&e[wr]||e["@@iterator"])?e:null}var Ar=Array.isArray;function Tr(e,t){var n=t.ref;if(null!==n&&"function"!=typeof n){if(t._owner){var r=void 0;(t=t._owner)&&(2!==t.tag&&d("110"),r=t.stateNode),r||d("147",n);var s=""+n;return null!==e&&null!==e.ref&&e.ref._stringRef===s?e.ref:((e=function(e){var t=r.refs===p?r.refs={}:r.refs;null===e?delete t[s]:t[s]=e})._stringRef=s,e)}"string"!=typeof n&&d("148"),t._owner||d("149",n)}return n}function Cr(e,t){"textarea"!==e.type&&d("31","[object Object]"===Object.prototype.toString.call(t)?"object with keys {"+Object.keys(t).join(", ")+"}":t,"")}function Sr(e){function t(t,n){if(e){var r=t.lastEffect;null!==r?(r.nextEffect=n,t.lastEffect=n):t.firstEffect=t.lastEffect=n,n.nextEffect=null,n.effectTag=8}}function n(n,r){if(!e)return null;for(;null!==r;)t(n,r),r=r.sibling;return null}function r(e,t){for(e=new Map;null!==t;)null!==t.key?e.set(t.key,t):e.set(t.index,t),t=t.sibling;return e}function s(e,t,n){return(e=$n(e,t,n)).index=0,e.sibling=null,e}function a(t,n,r){return t.index=r,e?null!==(r=t.alternate)?(r=r.index)<n?(t.effectTag=2,n):r:(t.effectTag=2,n):n}function o(t){return e&&null===t.alternate&&(t.effectTag=2),t}function i(e,t,n,r){return null===t||6!==t.tag?((t=nr(n,e.internalContextTag,r)).return=e,t):((t=s(t,n,r)).return=e,t)}function c(e,t,n,r){return null!==t&&t.type===n.type?((r=s(t,n.props,r)).ref=Tr(t,n),r.return=e,r):((r=er(n,e.internalContextTag,r)).ref=Tr(t,n),r.return=e,r)}function l(e,t,n,r){return null===t||7!==t.tag?((t=rr(n,e.internalContextTag,r)).return=e,t):((t=s(t,n,r)).return=e,t)}function f(e,t,n,r){return null===t||9!==t.tag?((t=sr(n,e.internalContextTag,r)).type=n.value,t.return=e,t):((t=s(t,null,r)).type=n.value,t.return=e,t)}function u(e,t,n,r){return null===t||4!==t.tag||t.stateNode.containerInfo!==n.containerInfo||t.stateNode.implementation!==n.implementation?((t=ar(n,e.internalContextTag,r)).return=e,t):((t=s(t,n.children||[],r)).return=e,t)}function p(e,t,n,r,a){return null===t||10!==t.tag?((t=tr(n,e.internalContextTag,r,a)).return=e,t):((t=s(t,n,r)).return=e,t)}function _(e,t,n){if("string"==typeof t||"number"==typeof t)return(t=nr(""+t,e.internalContextTag,n)).return=e,t;if("object"==typeof t&&null!==t){switch(t.$$typeof){case hr:return t.type===kr?((t=tr(t.props.children,e.internalContextTag,n,t.key)).return=e,t):((n=er(t,e.internalContextTag,n)).ref=Tr(null,t),n.return=e,n);case br:return(t=rr(t,e.internalContextTag,n)).return=e,t;case gr:return(n=sr(t,e.internalContextTag,n)).type=t.value,n.return=e,n;case xr:return(t=ar(t,e.internalContextTag,n)).return=e,t}if(Ar(t)||Er(t))return(t=tr(t,e.internalContextTag,n,null)).return=e,t;Cr(e,t)}return null}function m(e,t,n,r){var s=null!==t?t.key:null;if("string"==typeof n||"number"==typeof n)return null!==s?null:i(e,t,""+n,r);if("object"==typeof n&&null!==n){switch(n.$$typeof){case hr:return n.key===s?n.type===kr?p(e,t,n.props.children,r,s):c(e,t,n,r):null;case br:return n.key===s?l(e,t,n,r):null;case gr:return null===s?f(e,t,n,r):null;case xr:return n.key===s?u(e,t,n,r):null}if(Ar(n)||Er(n))return null!==s?null:p(e,t,n,r,null);Cr(e,n)}return null}function v(e,t,n,r,s){if("string"==typeof r||"number"==typeof r)return i(t,e=e.get(n)||null,""+r,s);if("object"==typeof r&&null!==r){switch(r.$$typeof){case hr:return e=e.get(null===r.key?n:r.key)||null,r.type===kr?p(t,e,r.props.children,s,r.key):c(t,e,r,s);case br:return l(t,e=e.get(null===r.key?n:r.key)||null,r,s);case gr:return f(t,e=e.get(n)||null,r,s);case xr:return u(t,e=e.get(null===r.key?n:r.key)||null,r,s)}if(Ar(r)||Er(r))return p(t,e=e.get(n)||null,r,s,null);Cr(t,r)}return null}function y(s,o,i,c){for(var l=null,f=null,u=o,p=o=0,d=null;null!==u&&p<i.length;p++){u.index>p?(d=u,u=null):d=u.sibling;var y=m(s,u,i[p],c);if(null===y){null===u&&(u=d);break}e&&u&&null===y.alternate&&t(s,u),o=a(y,o,p),null===f?l=y:f.sibling=y,f=y,u=d}if(p===i.length)return n(s,u),l;if(null===u){for(;p<i.length;p++)(u=_(s,i[p],c))&&(o=a(u,o,p),null===f?l=u:f.sibling=u,f=u);return l}for(u=r(s,u);p<i.length;p++)(d=v(u,s,p,i[p],c))&&(e&&null!==d.alternate&&u.delete(null===d.key?p:d.key),o=a(d,o,p),null===f?l=d:f.sibling=d,f=d);return e&&u.forEach(function(e){return t(s,e)}),l}function h(s,o,i,c){var l=Er(i);"function"!=typeof l&&d("150"),null==(i=l.call(i))&&d("151");for(var f=l=null,u=o,p=o=0,y=null,h=i.next();null!==u&&!h.done;p++,h=i.next()){u.index>p?(y=u,u=null):y=u.sibling;var b=m(s,u,h.value,c);if(null===b){u||(u=y);break}e&&u&&null===b.alternate&&t(s,u),o=a(b,o,p),null===f?l=b:f.sibling=b,f=b,u=y}if(h.done)return n(s,u),l;if(null===u){for(;!h.done;p++,h=i.next())null!==(h=_(s,h.value,c))&&(o=a(h,o,p),null===f?l=h:f.sibling=h,f=h);return l}for(u=r(s,u);!h.done;p++,h=i.next())null!==(h=v(u,s,p,h.value,c))&&(e&&null!==h.alternate&&u.delete(null===h.key?p:h.key),o=a(h,o,p),null===f?l=h:f.sibling=h,f=h);return e&&u.forEach(function(e){return t(s,e)}),l}return function(e,r,a,i){"object"==typeof a&&null!==a&&a.type===kr&&null===a.key&&(a=a.props.children);var c="object"==typeof a&&null!==a;if(c)switch(a.$$typeof){case hr:e:{var l=a.key;for(c=r;null!==c;){if(c.key===l){if(10===c.tag?a.type===kr:c.type===a.type){n(e,c.sibling),(r=s(c,a.type===kr?a.props.children:a.props,i)).ref=Tr(c,a),r.return=e,e=r;break e}n(e,c);break}t(e,c),c=c.sibling}a.type===kr?((r=tr(a.props.children,e.internalContextTag,i,a.key)).return=e,e=r):((i=er(a,e.internalContextTag,i)).ref=Tr(r,a),i.return=e,e=i)}return o(e);case br:e:{for(c=a.key;null!==r;){if(r.key===c){if(7===r.tag){n(e,r.sibling),(r=s(r,a,i)).return=e,e=r;break e}n(e,r);break}t(e,r),r=r.sibling}(r=rr(a,e.internalContextTag,i)).return=e,e=r}return o(e);case gr:e:{if(null!==r){if(9===r.tag){n(e,r.sibling),(r=s(r,null,i)).type=a.value,r.return=e,e=r;break e}n(e,r)}(r=sr(a,e.internalContextTag,i)).type=a.value,r.return=e,e=r}return o(e);case xr:e:{for(c=a.key;null!==r;){if(r.key===c){if(4===r.tag&&r.stateNode.containerInfo===a.containerInfo&&r.stateNode.implementation===a.implementation){n(e,r.sibling),(r=s(r,a.children||[],i)).return=e,e=r;break e}n(e,r);break}t(e,r),r=r.sibling}(r=ar(a,e.internalContextTag,i)).return=e,e=r}return o(e)}if("string"==typeof a||"number"==typeof a)return a=""+a,null!==r&&6===r.tag?(n(e,r.sibling),r=s(r,a,i)):(n(e,r),r=nr(a,e.internalContextTag,i)),r.return=e,o(e=r);if(Ar(a))return y(e,r,a,i);if(Er(a))return h(e,r,a,i);if(c&&Cr(e,a),void 0===a)switch(e.tag){case 2:case 1:d("152",(i=e.type).displayName||i.name||"Component")}return n(e,r)}}var Or=Sr(!0),Nr=Sr(!1);function Br(e,t,n,r,s){function a(e,t,n){var r=t.expirationTime;t.child=null===e?Nr(t,null,n,r):Or(t,e.child,n,r)}function o(e,t){var n=t.ref;null===n||e&&e.ref===n||(t.effectTag|=128)}function i(e,t,n,r){if(o(e,t),!n)return r&&Jn(t,!1),f(e,t);n=t.stateNode,Ut.current=t;var s=n.render();return t.effectTag|=1,a(e,t,s),t.memoizedState=n.state,t.memoizedProps=n.props,r&&Jn(t,!0),t.child}function c(e){var t=e.stateNode;t.pendingContext?Qn(0,t.pendingContext,t.pendingContext!==t.context):t.context&&Qn(0,t.context,!1),h(e,t.containerInfo)}function f(e,t){if(null!==e&&t.child!==e.child&&d("153"),null!==t.child){var n=$n(e=t.child,e.pendingProps,e.expirationTime);for(t.child=n,n.return=t;null!==e.sibling;)e=e.sibling,(n=n.sibling=$n(e,e.pendingProps,e.expirationTime)).return=t;n.sibling=null}return t.child}function u(e,t){switch(t.tag){case 3:c(t);break;case 2:Gn(t);break;case 4:h(t,t.stateNode.containerInfo)}return null}var _=e.shouldSetTextContent,m=e.useSyncScheduling,v=e.shouldDeprioritizeSubtree,y=t.pushHostContext,h=t.pushHostContainer,b=n.enterHydrationState,g=n.resetHydrationState,x=n.tryToClaimNextHydratableInstance,k=(e=function(e,t,n,r){function s(e,t){t.updater=a,e.stateNode=t,t._reactInternalFiber=e}var a={isMounted:Yt,enqueueSetState:function(n,r,s){n=n._reactInternalFiber,s=void 0===s?null:s;var a=t(n);dr(n,{expirationTime:a,partialState:r,callback:s,isReplace:!1,isForced:!1,nextCallback:null,next:null}),e(n,a)},enqueueReplaceState:function(n,r,s){n=n._reactInternalFiber,s=void 0===s?null:s;var a=t(n);dr(n,{expirationTime:a,partialState:r,callback:s,isReplace:!0,isForced:!1,nextCallback:null,next:null}),e(n,a)},enqueueForceUpdate:function(n,r){n=n._reactInternalFiber,r=void 0===r?null:r;var s=t(n);dr(n,{expirationTime:s,partialState:null,callback:r,isReplace:!1,isForced:!0,nextCallback:null,next:null}),e(n,s)}};return{adoptClassInstance:s,constructClassInstance:function(e,t){var n=e.type,r=Xn(e),a=2===e.tag&&null!=e.type.contextTypes,o=a?jn(e,r):p;return s(e,t=new n(t,o)),a&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=r,e.__reactInternalMemoizedMaskedChildContext=o),t},mountClassInstance:function(e,t){var n=e.alternate,r=e.stateNode,s=r.state||null,o=e.pendingProps;o||d("158");var i=Xn(e);r.props=o,r.state=e.memoizedState=s,r.refs=p,r.context=jn(e,i),null!=e.type&&null!=e.type.prototype&&!0===e.type.prototype.unstable_isAsyncReactComponent&&(e.internalContextTag|=1),"function"==typeof r.componentWillMount&&(s=r.state,r.componentWillMount(),s!==r.state&&a.enqueueReplaceState(r,r.state,null),null!==(s=e.updateQueue)&&(r.state=mr(n,e,s,r,o,t))),"function"==typeof r.componentDidMount&&(e.effectTag|=4)},updateClassInstance:function(e,t,s){var o=t.stateNode;o.props=t.memoizedProps,o.state=t.memoizedState;var i=t.memoizedProps,c=t.pendingProps;c||null==(c=i)&&d("159");var f=o.context,u=Xn(t);if(u=jn(t,u),"function"!=typeof o.componentWillReceiveProps||i===c&&f===u||(f=o.state,o.componentWillReceiveProps(c,u),o.state!==f&&a.enqueueReplaceState(o,o.state,null)),f=t.memoizedState,s=null!==t.updateQueue?mr(e,t,t.updateQueue,o,c,s):f,!(i!==c||f!==s||zn.current||null!==t.updateQueue&&t.updateQueue.hasForceUpdate))return"function"!=typeof o.componentDidUpdate||i===e.memoizedProps&&f===e.memoizedState||(t.effectTag|=4),!1;var p=c;if(null===i||null!==t.updateQueue&&t.updateQueue.hasForceUpdate)p=!0;else{var _=t.stateNode,m=t.type;p="function"==typeof _.shouldComponentUpdate?_.shouldComponentUpdate(p,s,u):!(m.prototype&&m.prototype.isPureReactComponent&&l(i,p)&&l(f,s))}return p?("function"==typeof o.componentWillUpdate&&o.componentWillUpdate(c,s,u),"function"==typeof o.componentDidUpdate&&(t.effectTag|=4)):("function"!=typeof o.componentDidUpdate||i===e.memoizedProps&&f===e.memoizedState||(t.effectTag|=4),n(t,c),r(t,s)),o.props=c,o.state=s,o.context=u,p}}}(r,s,function(e,t){e.memoizedProps=t},function(e,t){e.memoizedState=t})).adoptClassInstance,w=e.constructClassInstance,E=e.mountClassInstance,A=e.updateClassInstance;return{beginWork:function(e,t,n){if(0===t.expirationTime||t.expirationTime>n)return u(0,t);switch(t.tag){case 0:null!==e&&d("155");var r=t.type,s=t.pendingProps,l=Xn(t);return r=r(s,l=jn(t,l)),t.effectTag|=1,"object"==typeof r&&null!==r&&"function"==typeof r.render?(t.tag=2,s=Gn(t),k(t,r),E(t,n),t=i(e,t,!0,s)):(t.tag=1,a(e,t,r),t.memoizedProps=s,t=t.child),t;case 1:e:{if(s=t.type,n=t.pendingProps,r=t.memoizedProps,zn.current)null===n&&(n=r);else if(null===n||r===n){t=f(e,t);break e}s=s(n,r=jn(t,r=Xn(t))),t.effectTag|=1,a(e,t,s),t.memoizedProps=n,t=t.child}return t;case 2:return s=Gn(t),r=void 0,null===e?t.stateNode?d("153"):(w(t,t.pendingProps),E(t,n),r=!0):r=A(e,t,n),i(e,t,r,s);case 3:return c(t),null!==(s=t.updateQueue)?(r=t.memoizedState)===(s=mr(e,t,s,null,null,n))?(g(),t=f(e,t)):(r=s.element,l=t.stateNode,(null===e||null===e.child)&&l.hydrate&&b(t)?(t.effectTag|=2,t.child=Nr(t,null,r,n)):(g(),a(e,t,r)),t.memoizedState=s,t=t.child):(g(),t=f(e,t)),t;case 5:y(t),null===e&&x(t),s=t.type;var p=t.memoizedProps;return null===(r=t.pendingProps)&&(null===(r=p)&&d("154")),l=null!==e?e.memoizedProps:null,zn.current||null!==r&&p!==r?(p=r.children,_(s,r)?p=null:l&&_(s,l)&&(t.effectTag|=16),o(e,t),2147483647!==n&&!m&&v(s,r)?(t.expirationTime=2147483647,t=null):(a(e,t,p),t.memoizedProps=r,t=t.child)):t=f(e,t),t;case 6:return null===e&&x(t),null===(e=t.pendingProps)&&(e=t.memoizedProps),t.memoizedProps=e,null;case 8:t.tag=7;case 7:return s=t.pendingProps,zn.current?null===s&&(null===(s=e&&e.memoizedProps)&&d("154")):null!==s&&t.memoizedProps!==s||(s=t.memoizedProps),r=s.children,t.stateNode=null===e?Nr(t,t.stateNode,r,n):Or(t,t.stateNode,r,n),t.memoizedProps=s,t.stateNode;case 9:return null;case 4:e:{if(h(t,t.stateNode.containerInfo),s=t.pendingProps,zn.current)null===s&&(null==(s=e&&e.memoizedProps)&&d("154"));else if(null===s||t.memoizedProps===s){t=f(e,t);break e}null===e?t.child=Or(t,null,s,n):a(e,t,s),t.memoizedProps=s,t=t.child}return t;case 10:e:{if(n=t.pendingProps,zn.current)null===n&&(n=t.memoizedProps);else if(null===n||t.memoizedProps===n){t=f(e,t);break e}a(e,t,n),t.memoizedProps=n,t=t.child}return t;default:d("156")}},beginFailedWork:function(e,t,n){switch(t.tag){case 2:Gn(t);break;case 3:c(t);break;default:d("157")}return t.effectTag|=64,null===e?t.child=null:t.child!==e.child&&(t.child=e.child),0===t.expirationTime||t.expirationTime>n?u(0,t):(t.firstEffect=null,t.lastEffect=null,t.child=null===e?Nr(t,null,null,n):Or(t,e.child,null,n),2===t.tag&&(e=t.stateNode,t.memoizedProps=e.props,t.memoizedState=e.state),t.child)}}}var Rr={};function Lr(e){function t(e){oe=G=!0;var t=e.stateNode;if(t.current===e&&d("177"),t.isReadyForCommit=!1,Ut.current=null,1<e.effectTag)if(null!==e.lastEffect){e.lastEffect.nextEffect=e;var n=e.firstEffect}else n=e;else n=e.firstEffect;for(j(),ee=n;null!==ee;){var r=!1,s=void 0;try{for(;null!==ee;){var a=ee.effectTag;if(16&a&&P(ee),128&a){var o=ee.alternate;null!==o&&U(o)}switch(-242&a){case 2:M(ee),ee.effectTag&=-3;break;case 6:M(ee),ee.effectTag&=-3,I(ee.alternate,ee);break;case 4:I(ee.alternate,ee);break;case 8:ie=!0,F(ee),ie=!1}ee=ee.nextEffect}}catch(e){r=!0,s=e}r&&(null===ee&&d("178"),i(ee,s),null!==ee&&(ee=ee.nextEffect))}for(K(),t.current=e,ee=n;null!==ee;){n=!1,r=void 0;try{for(;null!==ee;){var c=ee.effectTag;if(36&c&&D(ee.alternate,ee),128&c&&H(ee),64&c)switch(s=ee,a=void 0,null!==te&&(a=te.get(s),te.delete(s),null==a&&null!==s.alternate&&(s=s.alternate,a=te.get(s),te.delete(s))),null==a&&d("184"),s.tag){case 2:s.stateNode.componentDidCatch(a.error,{componentStack:a.componentStack});break;case 3:null===se&&(se=a.error);break;default:d("157")}var l=ee.nextEffect;ee.nextEffect=null,ee=l}}catch(e){n=!0,r=e}n&&(null===ee&&d("178"),i(ee,r),null!==ee&&(ee=ee.nextEffect))}return G=oe=!1,lr(e.stateNode),re&&(re.forEach(v),re=null),null!==se&&(e=se,se=null,E(e)),0===(t=t.current.expirationTime)&&(ne=te=null),t}function n(e){for(;;){var t=L(e.alternate,e,$),n=e.return,r=e.sibling,s=e;if(2147483647===$||2147483647!==s.expirationTime){if(2!==s.tag&&3!==s.tag)var a=0;else a=null===(a=s.updateQueue)?0:a.expirationTime;for(var o=s.child;null!==o;)0!==o.expirationTime&&(0===a||a>o.expirationTime)&&(a=o.expirationTime),o=o.sibling;s.expirationTime=a}if(null!==t)return t;if(null!==n&&(null===n.firstEffect&&(n.firstEffect=e.firstEffect),null!==e.lastEffect&&(null!==n.lastEffect&&(n.lastEffect.nextEffect=e.firstEffect),n.lastEffect=e.lastEffect),1<e.effectTag&&(null!==n.lastEffect?n.lastEffect.nextEffect=e:n.firstEffect=e,n.lastEffect=e)),null!==r)return r;if(null===n){e.stateNode.isReadyForCommit=!0;break}e=n}return null}function r(e){var t=B(e.alternate,e,$);return null===t&&(t=n(e)),Ut.current=null,t}function s(e){var t=R(e.alternate,e,$);return null===t&&(t=n(e)),Ut.current=null,t}function a(e){if(null!==te){if(!(0===$||$>e))if($<=Q)for(;null!==J;)J=c(J)?s(J):r(J);else for(;null!==J&&!w();)J=c(J)?s(J):r(J)}else if(!(0===$||$>e))if($<=Q)for(;null!==J;)J=r(J);else for(;null!==J&&!w();)J=r(J)}function o(e,t){if(G&&d("243"),G=!0,e.isReadyForCommit=!1,e!==Z||t!==$||null===J){for(;-1<Dn;)In[Dn]=null,Dn--;Yn=p,Vn.current=p,zn.current=!1,O(),$=t,J=$n((Z=e).current,null,t)}var n=!1,r=null;try{a(t)}catch(e){n=!0,r=e}for(;n;){if(ae){se=r;break}var o=J;if(null===o)ae=!0;else{var c=i(o,r);if(null===c&&d("183"),!ae){try{for(r=t,c=n=c;null!==o;){switch(o.tag){case 2:qn(o);break;case 5:S(o);break;case 3:C(o);break;case 4:C(o)}if(o===c||o.alternate===c)break;o=o.return}J=s(n),a(r)}catch(e){n=!0,r=e;continue}break}}}return t=se,ae=G=!1,se=null,null!==t&&E(t),e.isReadyForCommit?e.current.alternate:null}function i(e,t){var n=Ut.current=null,r=!1,s=!1,a=null;if(3===e.tag)n=e,l(e)&&(ae=!0);else for(var o=e.return;null!==o&&null===n;){if(2===o.tag?"function"==typeof o.stateNode.componentDidCatch&&(r=!0,a=Vt(o),n=o,s=!0):3===o.tag&&(n=o),l(o)){if(ie||null!==re&&(re.has(o)||null!==o.alternate&&re.has(o.alternate)))return null;n=null,s=!1}o=o.return}if(null!==n){null===ne&&(ne=new Set),ne.add(n);var i="";o=e;do{e:switch(o.tag){case 0:case 1:case 2:case 5:var c=o._debugOwner,f=o._debugSource,u=Vt(o),p=null;c&&(p=Vt(c)),c=f,u="\n    in "+(u||"Unknown")+(c?" (at "+c.fileName.replace(/^.*[\\\/]/,"")+":"+c.lineNumber+")":p?" (created by "+p+")":"");break e;default:u=""}i+=u,o=o.return}while(o);o=i,e=Vt(e),null===te&&(te=new Map),t={componentName:e,componentStack:o,error:t,errorBoundary:r?n.stateNode:null,errorBoundaryFound:r,errorBoundaryName:a,willRetry:s},te.set(n,t);try{var d=t.error;d&&d.suppressReactErrorLogging||console.error(d)}catch(e){e&&e.suppressReactErrorLogging||console.error(e)}return oe?(null===re&&(re=new Set),re.add(n)):v(n),n}return null===se&&(se=t),null}function c(e){return null!==te&&(te.has(e)||null!==e.alternate&&te.has(e.alternate))}function l(e){return null!==ne&&(ne.has(e)||null!==e.alternate&&ne.has(e.alternate))}function f(){return 20*(1+((y()+100)/20|0))}function u(e){return 0!==W?W:G?oe?1:$:!X||1&e.internalContextTag?f():1}function _(e,t){return m(e,t)}function m(e,t){for(;null!==e;){if((0===e.expirationTime||e.expirationTime>t)&&(e.expirationTime=t),null!==e.alternate&&(0===e.alternate.expirationTime||e.alternate.expirationTime>t)&&(e.alternate.expirationTime=t),null===e.return){if(3!==e.tag)break;var n=e.stateNode;!G&&n===Z&&t<$&&(J=Z=null,$=0);var r=n,s=t;if(ke>xe&&d("185"),null===r.nextScheduledRoot)r.remainingExpirationTime=s,null===le?(ce=le=r,r.nextScheduledRoot=r):(le=le.nextScheduledRoot=r).nextScheduledRoot=ce;else{var a=r.remainingExpirationTime;(0===a||s<a)&&(r.remainingExpirationTime=s)}pe||(be?ge&&k(de=r,_e=1):1===s?x(1,null):h(s)),!G&&n===Z&&t<$&&(J=Z=null,$=0)}e=e.return}}function v(e){m(e,1)}function y(){return Q=2+((V()-q)/10|0)}function h(e){if(0!==fe){if(e>fe)return;Y(ue)}var t=V()-q;fe=e,ue=z(g,{timeout:10*(e-2)-t})}function b(){var e=0,t=null;if(null!==le)for(var n=le,r=ce;null!==r;){var s=r.remainingExpirationTime;if(0===s){if((null===n||null===le)&&d("244"),r===r.nextScheduledRoot){ce=le=r.nextScheduledRoot=null;break}if(r===ce)ce=s=r.nextScheduledRoot,le.nextScheduledRoot=s,r.nextScheduledRoot=null;else{if(r===le){(le=n).nextScheduledRoot=ce,r.nextScheduledRoot=null;break}n.nextScheduledRoot=r.nextScheduledRoot,r.nextScheduledRoot=null}r=n.nextScheduledRoot}else{if((0===e||s<e)&&(e=s,t=r),r===le)break;n=r,r=r.nextScheduledRoot}}null!==(n=de)&&n===t?ke++:ke=0,de=t,_e=e}function g(e){x(0,e)}function x(e,t){for(he=t,b();null!==de&&0!==_e&&(0===e||_e<=e)&&!me;)k(de,_e),b();if(null!==he&&(fe=0,ue=-1),0!==_e&&h(_e),he=null,me=!1,ke=0,ve)throw e=ye,ye=null,ve=!1,e}function k(e,n){if(pe&&d("245"),pe=!0,n<=y()){var r=e.finishedWork;null!==r?(e.finishedWork=null,e.remainingExpirationTime=t(r)):(e.finishedWork=null,null!==(r=o(e,n))&&(e.remainingExpirationTime=t(r)))}else null!==(r=e.finishedWork)?(e.finishedWork=null,e.remainingExpirationTime=t(r)):(e.finishedWork=null,null!==(r=o(e,n))&&(w()?e.finishedWork=r:e.remainingExpirationTime=t(r)));pe=!1}function w(){return!(null===he||he.timeRemaining()>we)&&(me=!0)}function E(e){null===de&&d("246"),de.remainingExpirationTime=0,ve||(ve=!0,ye=e)}var A=function(e){function t(e){return e===Rr&&d("174"),e}var n=e.getChildHostContext,r=e.getRootHostContext,s={current:Rr},a={current:Rr},o={current:Rr};return{getHostContext:function(){return t(s.current)},getRootHostContainer:function(){return t(o.current)},popHostContainer:function(e){Hn(s),Hn(a),Hn(o)},popHostContext:function(e){a.current===e&&(Hn(s),Hn(a))},pushHostContainer:function(e,t){Un(o,t),t=r(t),Un(a,e),Un(s,t)},pushHostContext:function(e){var r=t(o.current),i=t(s.current);i!==(r=n(i,e.type,r))&&(Un(a,e),Un(s,r))},resetHostContainer:function(){s.current=Rr,o.current=Rr}}}(e),T=function(e){function t(e,t){var n=new Zn(5,null,0);n.type="DELETED",n.stateNode=t,n.return=e,n.effectTag=8,null!==e.lastEffect?(e.lastEffect.nextEffect=n,e.lastEffect=n):e.firstEffect=e.lastEffect=n}function n(e,t){switch(e.tag){case 5:return null!==(t=a(t,e.type,e.pendingProps))&&(e.stateNode=t,!0);case 6:return null!==(t=o(t,e.pendingProps))&&(e.stateNode=t,!0);default:return!1}}function r(e){for(e=e.return;null!==e&&5!==e.tag&&3!==e.tag;)e=e.return;u=e}var s=e.shouldSetTextContent;if(!(e=e.hydration))return{enterHydrationState:function(){return!1},resetHydrationState:function(){},tryToClaimNextHydratableInstance:function(){},prepareToHydrateHostInstance:function(){d("175")},prepareToHydrateHostTextInstance:function(){d("176")},popHydrationState:function(){return!1}};var a=e.canHydrateInstance,o=e.canHydrateTextInstance,i=e.getNextHydratableSibling,c=e.getFirstHydratableChild,l=e.hydrateInstance,f=e.hydrateTextInstance,u=null,p=null,_=!1;return{enterHydrationState:function(e){return p=c(e.stateNode.containerInfo),u=e,_=!0},resetHydrationState:function(){p=u=null,_=!1},tryToClaimNextHydratableInstance:function(e){if(_){var r=p;if(r){if(!n(e,r)){if(!(r=i(r))||!n(e,r))return e.effectTag|=2,_=!1,void(u=e);t(u,p)}u=e,p=c(r)}else e.effectTag|=2,_=!1,u=e}},prepareToHydrateHostInstance:function(e,t,n){return t=l(e.stateNode,e.type,e.memoizedProps,t,n,e),e.updateQueue=t,null!==t},prepareToHydrateHostTextInstance:function(e){return f(e.stateNode,e.memoizedProps,e)},popHydrationState:function(e){if(e!==u)return!1;if(!_)return r(e),_=!0,!1;var n=e.type;if(5!==e.tag||"head"!==n&&"body"!==n&&!s(n,e.memoizedProps))for(n=p;n;)t(e,n),n=i(n);return r(e),p=u?i(e.stateNode):null,!0}}}(e),C=A.popHostContainer,S=A.popHostContext,O=A.resetHostContainer,N=Br(e,A,T,_,u),B=N.beginWork,R=N.beginFailedWork,L=function(e,t,n){function r(e){e.effectTag|=4}var s=e.createInstance,a=e.createTextInstance,o=e.appendInitialChild,i=e.finalizeInitialChildren,c=e.prepareUpdate,l=e.persistence,f=t.getRootHostContainer,u=t.popHostContext,p=t.getHostContext,_=t.popHostContainer,m=n.prepareToHydrateHostInstance,v=n.prepareToHydrateHostTextInstance,y=n.popHydrationState,h=void 0,b=void 0,g=void 0;return e.mutation?(h=function(){},b=function(e,t,n){(t.updateQueue=n)&&r(t)},g=function(e,t,n,s){n!==s&&r(t)}):d(l?"235":"236"),{completeWork:function(e,t,n){var l=t.pendingProps;switch(null===l?l=t.memoizedProps:2147483647===t.expirationTime&&2147483647!==n||(t.pendingProps=null),t.tag){case 1:return null;case 2:return qn(t),null;case 3:return _(t),Hn(zn),Hn(Vn),(l=t.stateNode).pendingContext&&(l.context=l.pendingContext,l.pendingContext=null),null!==e&&null!==e.child||(y(t),t.effectTag&=-3),h(t),null;case 5:u(t),n=f();var x=t.type;if(null!==e&&null!=t.stateNode){var k=e.memoizedProps,w=t.stateNode,E=p();w=c(w,x,k,l,n,E),b(e,t,w,x,k,l,n),e.ref!==t.ref&&(t.effectTag|=128)}else{if(!l)return null===t.stateNode&&d("166"),null;if(e=p(),y(t))m(t,n,e)&&r(t);else{e=s(x,l,n,e,t);e:for(k=t.child;null!==k;){if(5===k.tag||6===k.tag)o(e,k.stateNode);else if(4!==k.tag&&null!==k.child){k.child.return=k,k=k.child;continue}if(k===t)break;for(;null===k.sibling;){if(null===k.return||k.return===t)break e;k=k.return}k.sibling.return=k.return,k=k.sibling}i(e,x,l,n)&&r(t),t.stateNode=e}null!==t.ref&&(t.effectTag|=128)}return null;case 6:if(e&&null!=t.stateNode)g(e,t,e.memoizedProps,l);else{if("string"!=typeof l)return null===t.stateNode&&d("166"),null;e=f(),n=p(),y(t)?v(t)&&r(t):t.stateNode=a(l,e,n,t)}return null;case 7:(l=t.memoizedProps)||d("165"),t.tag=8,x=[];e:for((k=t.stateNode)&&(k.return=t);null!==k;){if(5===k.tag||6===k.tag||4===k.tag)d("247");else if(9===k.tag)x.push(k.type);else if(null!==k.child){k.child.return=k,k=k.child;continue}for(;null===k.sibling;){if(null===k.return||k.return===t)break e;k=k.return}k.sibling.return=k.return,k=k.sibling}return l=(k=l.handler)(l.props,x),t.child=Or(t,null!==e?e.child:null,l,n),t.child;case 8:return t.tag=7,null;case 9:case 10:return null;case 4:return _(t),h(t),null;case 0:d("167");default:d("156")}}}}(e,A,T).completeWork,P=(A=function(e,t){function n(e){var n=e.ref;if(null!==n)try{n(null)}catch(n){t(e,n)}}function r(e){switch(fr(e),e.tag){case 2:n(e);var r=e.stateNode;if("function"==typeof r.componentWillUnmount)try{r.props=e.memoizedProps,r.state=e.memoizedState,r.componentWillUnmount()}catch(n){t(e,n)}break;case 5:n(e);break;case 7:s(e.stateNode);break;case 4:c&&o(e)}}function s(e){for(var t=e;;)if(r(t),null===t.child||c&&4===t.tag){if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return;t=t.return}t.sibling.return=t.return,t=t.sibling}else t.child.return=t,t=t.child}function a(e){return 5===e.tag||3===e.tag||4===e.tag}function o(e){for(var t=e,n=!1,a=void 0,o=void 0;;){if(!n){n=t.return;e:for(;;){switch(null===n&&d("160"),n.tag){case 5:a=n.stateNode,o=!1;break e;case 3:case 4:a=n.stateNode.containerInfo,o=!0;break e}n=n.return}n=!0}if(5===t.tag||6===t.tag)s(t),o?b(a,t.stateNode):h(a,t.stateNode);else if(4===t.tag?a=t.stateNode.containerInfo:r(t),null!==t.child){t.child.return=t,t=t.child;continue}if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return;4===(t=t.return).tag&&(n=!1)}t.sibling.return=t.return,t=t.sibling}}var i=e.getPublicInstance,c=e.mutation;e=e.persistence,c||d(e?"235":"236");var l=c.commitMount,f=c.commitUpdate,u=c.resetTextContent,p=c.commitTextUpdate,_=c.appendChild,m=c.appendChildToContainer,v=c.insertBefore,y=c.insertInContainerBefore,h=c.removeChild,b=c.removeChildFromContainer;return{commitResetTextContent:function(e){u(e.stateNode)},commitPlacement:function(e){e:{for(var t=e.return;null!==t;){if(a(t)){var n=t;break e}t=t.return}d("160"),n=void 0}var r=t=void 0;switch(n.tag){case 5:t=n.stateNode,r=!1;break;case 3:case 4:t=n.stateNode.containerInfo,r=!0;break;default:d("161")}16&n.effectTag&&(u(t),n.effectTag&=-17);e:t:for(n=e;;){for(;null===n.sibling;){if(null===n.return||a(n.return)){n=null;break e}n=n.return}for(n.sibling.return=n.return,n=n.sibling;5!==n.tag&&6!==n.tag;){if(2&n.effectTag)continue t;if(null===n.child||4===n.tag)continue t;n.child.return=n,n=n.child}if(!(2&n.effectTag)){n=n.stateNode;break e}}for(var s=e;;){if(5===s.tag||6===s.tag)n?r?y(t,s.stateNode,n):v(t,s.stateNode,n):r?m(t,s.stateNode):_(t,s.stateNode);else if(4!==s.tag&&null!==s.child){s.child.return=s,s=s.child;continue}if(s===e)break;for(;null===s.sibling;){if(null===s.return||s.return===e)return;s=s.return}s.sibling.return=s.return,s=s.sibling}},commitDeletion:function(e){o(e),e.return=null,e.child=null,e.alternate&&(e.alternate.child=null,e.alternate.return=null)},commitWork:function(e,t){switch(t.tag){case 2:break;case 5:var n=t.stateNode;if(null!=n){var r=t.memoizedProps;e=null!==e?e.memoizedProps:r;var s=t.type,a=t.updateQueue;t.updateQueue=null,null!==a&&f(n,a,s,e,r,t)}break;case 6:null===t.stateNode&&d("162"),n=t.memoizedProps,p(t.stateNode,null!==e?e.memoizedProps:n,n);break;case 3:break;default:d("163")}},commitLifeCycles:function(e,t){switch(t.tag){case 2:var n=t.stateNode;if(4&t.effectTag)if(null===e)n.props=t.memoizedProps,n.state=t.memoizedState,n.componentDidMount();else{var r=e.memoizedProps;e=e.memoizedState,n.props=t.memoizedProps,n.state=t.memoizedState,n.componentDidUpdate(r,e)}null!==(t=t.updateQueue)&&vr(t,n);break;case 3:null!==(n=t.updateQueue)&&vr(n,null!==t.child?t.child.stateNode:null);break;case 5:n=t.stateNode,null===e&&4&t.effectTag&&l(n,t.type,t.memoizedProps,t);break;case 6:case 4:break;default:d("163")}},commitAttachRef:function(e){var t=e.ref;if(null!==t){var n=e.stateNode;switch(e.tag){case 5:t(i(n));break;default:t(n)}}},commitDetachRef:function(e){null!==(e=e.ref)&&e(null)}}}(e,i)).commitResetTextContent,M=A.commitPlacement,F=A.commitDeletion,I=A.commitWork,D=A.commitLifeCycles,H=A.commitAttachRef,U=A.commitDetachRef,V=e.now,z=e.scheduleDeferredCallback,Y=e.cancelDeferredCallback,X=e.useSyncScheduling,j=e.prepareForCommit,K=e.resetAfterCommit,q=V(),Q=2,W=0,G=!1,J=null,Z=null,$=0,ee=null,te=null,ne=null,re=null,se=null,ae=!1,oe=!1,ie=!1,ce=null,le=null,fe=0,ue=-1,pe=!1,de=null,_e=0,me=!1,ve=!1,ye=null,he=null,be=!1,ge=!1,xe=1e3,ke=0,we=1;return{computeAsyncExpiration:f,computeExpirationForFiber:u,scheduleWork:_,batchedUpdates:function(e,t){var n=be;be=!0;try{return e(t)}finally{(be=n)||pe||x(1,null)}},unbatchedUpdates:function(e){if(be&&!ge){ge=!0;try{return e()}finally{ge=!1}}return e()},flushSync:function(e){var t=be;be=!0;try{e:{var n=W;W=1;try{var r=e();break e}finally{W=n}r=void 0}return r}finally{be=t,pe&&d("187"),x(1,null)}},deferredUpdates:function(e){var t=W;W=f();try{return e()}finally{W=t}}}}function Pr(e){function t(e){return null===(e=function(e){if(!(e=jt(e)))return null;for(var t=e;;){if(5===t.tag||6===t.tag)return t;if(t.child)t.child.return=t,t=t.child;else{if(t===e)break;for(;!t.sibling;){if(!t.return||t.return===e)return null;t=t.return}t.sibling.return=t.return,t=t.sibling}}return null}(e))?null:e.stateNode}var n=e.getPublicInstance,r=(e=Lr(e)).computeAsyncExpiration,s=e.computeExpirationForFiber,o=e.scheduleWork;return{createContainer:function(e,t){var n=new Zn(3,null,0);return e={current:n,containerInfo:e,pendingChildren:null,remainingExpirationTime:0,isReadyForCommit:!1,finishedWork:null,context:null,pendingContext:null,hydrate:t,nextScheduledRoot:null},n.stateNode=e},updateContainer:function(e,t,n,a){var i=t.current;if(n){var c;n=n._reactInternalFiber;e:{for(2===zt(n)&&2===n.tag||d("170"),c=n;3!==c.tag;){if(Kn(c)){c=c.stateNode.__reactInternalMemoizedMergedChildContext;break e}(c=c.return)||d("171")}c=c.stateNode.context}n=Kn(n)?Wn(n,c):c}else n=p;null===t.context?t.context=n:t.pendingContext=n,t=void 0===(t=a)?null:t,dr(i,{expirationTime:a=null!=e&&null!=e.type&&null!=e.type.prototype&&!0===e.type.prototype.unstable_isAsyncReactComponent?r():s(i),partialState:{element:e},callback:t,isReplace:!1,isForced:!1,nextCallback:null,next:null}),o(i,a)},batchedUpdates:e.batchedUpdates,unbatchedUpdates:e.unbatchedUpdates,deferredUpdates:e.deferredUpdates,flushSync:e.flushSync,getPublicRootInstance:function(e){if(!(e=e.current).child)return null;switch(e.child.tag){case 5:return n(e.child.stateNode);default:return e.child.stateNode}},findHostInstance:t,findHostInstanceWithNoPortals:function(e){return null===(e=function(e){if(!(e=jt(e)))return null;for(var t=e;;){if(5===t.tag||6===t.tag)return t;if(t.child&&4!==t.tag)t.child.return=t,t=t.child;else{if(t===e)break;for(;!t.sibling;){if(!t.return||t.return===e)return null;t=t.return}t.sibling.return=t.return,t=t.sibling}}return null}(e))?null:e.stateNode},injectIntoDevTools:function(e){var n=e.findFiberByHostInstance;return function(e){if("undefined"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var t=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(t.isDisabled||!t.supportsFiber)return!0;try{var n=t.inject(e);or=cr(function(e){return t.onCommitFiberRoot(n,e)}),ir=cr(function(e){return t.onCommitFiberUnmount(n,e)})}catch(e){}return!0}(a({},e,{findHostInstanceByFiber:function(e){return t(e)},findFiberByHostInstance:function(e){return n?n(e):null}}))}}}var Mr=Object.freeze({default:Pr}),Fr=Mr&&Pr||Mr,Ir=Fr.default?Fr.default:Fr;var Dr="object"==typeof performance&&"function"==typeof performance.now,Hr=void 0;Hr=Dr?function(){return performance.now()}:function(){return Date.now()};var Ur=void 0,Vr=void 0;if(s.canUseDOM)if("function"!=typeof requestIdleCallback||"function"!=typeof cancelIdleCallback){var zr,Yr=null,Xr=!1,jr=-1,Kr=!1,qr=0,Qr=33,Wr=33;zr=Dr?{didTimeout:!1,timeRemaining:function(){var e=qr-performance.now();return 0<e?e:0}}:{didTimeout:!1,timeRemaining:function(){var e=qr-Date.now();return 0<e?e:0}};var Gr="__reactIdleCallback$"+Math.random().toString(36).slice(2);window.addEventListener("message",function(e){if(e.source===window&&e.data===Gr){if(Xr=!1,e=Hr(),0>=qr-e){if(!(-1!==jr&&jr<=e))return void(Kr||(Kr=!0,requestAnimationFrame(Jr)));zr.didTimeout=!0}else zr.didTimeout=!1;jr=-1,e=Yr,Yr=null,null!==e&&e(zr)}},!1);var Jr=function(e){Kr=!1;var t=e-qr+Wr;t<Wr&&Qr<Wr?(8>t&&(t=8),Wr=t<Qr?Qr:t):Qr=t,qr=e+Wr,Xr||(Xr=!0,window.postMessage(Gr,"*"))};Ur=function(e,t){return Yr=e,null!=t&&"number"==typeof t.timeout&&(jr=Hr()+t.timeout),Kr||(Kr=!0,requestAnimationFrame(Jr)),0},Vr=function(){Yr=null,Xr=!1,jr=-1}}else Ur=window.requestIdleCallback,Vr=window.cancelIdleCallback;else Ur=function(e){return setTimeout(function(){e({timeRemaining:function(){return 1/0}})})},Vr=function(e){clearTimeout(e)};var Zr=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,$r={},es={};function ts(e,t,n){var r=b(t);if(r&&h(t,n)){var s=r.mutationMethod;s?s(e,n):null==n||r.hasBooleanValue&&!n||r.hasNumericValue&&isNaN(n)||r.hasPositiveNumericValue&&1>n||r.hasOverloadedBooleanValue&&!1===n?rs(e,t):r.mustUseProperty?e[r.propertyName]=n:(t=r.attributeName,(s=r.attributeNamespace)?e.setAttributeNS(s,t,""+n):r.hasBooleanValue||r.hasOverloadedBooleanValue&&!0===n?e.setAttribute(t,""):e.setAttribute(t,""+n))}else ns(e,t,h(t,n)?n:null)}function ns(e,t,n){(function(e){return!!es.hasOwnProperty(e)||!$r.hasOwnProperty(e)&&(Zr.test(e)?es[e]=!0:($r[e]=!0,!1))})(t)&&(null==n?e.removeAttribute(t):e.setAttribute(t,""+n))}function rs(e,t){var n=b(t);n?(t=n.mutationMethod)?t(e,void 0):n.mustUseProperty?e[n.propertyName]=!n.hasBooleanValue&&"":e.removeAttribute(n.attributeName):e.removeAttribute(t)}function ss(e,t){var n=t.value,r=t.checked;return a({type:void 0,step:void 0,min:void 0,max:void 0},t,{defaultChecked:void 0,defaultValue:void 0,value:null!=n?n:e._wrapperState.initialValue,checked:null!=r?r:e._wrapperState.initialChecked})}function as(e,t){var n=t.defaultValue;e._wrapperState={initialChecked:null!=t.checked?t.checked:t.defaultChecked,initialValue:null!=t.value?t.value:n,controlled:"checkbox"===t.type||"radio"===t.type?null!=t.checked:null!=t.value}}function os(e,t){null!=(t=t.checked)&&ts(e,"checked",t)}function is(e,t){os(e,t);var n=t.value;null!=n?0===n&&""===e.value?e.value="0":"number"===t.type?(n!=(t=parseFloat(e.value)||0)||n==t&&e.value!=n)&&(e.value=""+n):e.value!==""+n&&(e.value=""+n):(null==t.value&&null!=t.defaultValue&&e.defaultValue!==""+t.defaultValue&&(e.defaultValue=""+t.defaultValue),null==t.checked&&null!=t.defaultChecked&&(e.defaultChecked=!!t.defaultChecked))}function cs(e,t){switch(t.type){case"submit":case"reset":break;case"color":case"date":case"datetime":case"datetime-local":case"month":case"time":case"week":e.value="",e.value=e.defaultValue;break;default:e.value=e.value}""!==(t=e.name)&&(e.name=""),e.defaultChecked=!e.defaultChecked,e.defaultChecked=!e.defaultChecked,""!==t&&(e.name=t)}function ls(e,t){return e=a({children:void 0},t),(t=function(e){var t="";return r.Children.forEach(e,function(e){null==e||"string"!=typeof e&&"number"!=typeof e||(t+=e)}),t}(t.children))&&(e.children=t),e}function fs(e,t,n,r){if(e=e.options,t){t={};for(var s=0;s<n.length;s++)t["$"+n[s]]=!0;for(n=0;n<e.length;n++)s=t.hasOwnProperty("$"+e[n].value),e[n].selected!==s&&(e[n].selected=s),s&&r&&(e[n].defaultSelected=!0)}else{for(n=""+n,t=null,s=0;s<e.length;s++){if(e[s].value===n)return e[s].selected=!0,void(r&&(e[s].defaultSelected=!0));null!==t||e[s].disabled||(t=e[s])}null!==t&&(t.selected=!0)}}function us(e,t){var n=t.value;e._wrapperState={initialValue:null!=n?n:t.defaultValue,wasMultiple:!!t.multiple}}function ps(e,t){return null!=t.dangerouslySetInnerHTML&&d("91"),a({},t,{value:void 0,defaultValue:void 0,children:""+e._wrapperState.initialValue})}function ds(e,t){var n=t.value;null==n&&(n=t.defaultValue,null!=(t=t.children)&&(null!=n&&d("92"),Array.isArray(t)&&(1>=t.length||d("93"),t=t[0]),n=""+t),null==n&&(n="")),e._wrapperState={initialValue:""+n}}function _s(e,t){var n=t.value;null!=n&&((n=""+n)!==e.value&&(e.value=n),null==t.defaultValue&&(e.defaultValue=n)),null!=t.defaultValue&&(e.defaultValue=t.defaultValue)}function ms(e){var t=e.textContent;t===e._wrapperState.initialValue&&(e.value=t)}var vs="http://www.w3.org/1999/xhtml",ys="http://www.w3.org/2000/svg";function hs(e){switch(e){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function bs(e,t){return null==e||"http://www.w3.org/1999/xhtml"===e?hs(t):"http://www.w3.org/2000/svg"===e&&"foreignObject"===t?"http://www.w3.org/1999/xhtml":e}var gs,xs=void 0,ks=(gs=function(e,t){if(e.namespaceURI!==ys||"innerHTML"in e)e.innerHTML=t;else{for((xs=xs||document.createElement("div")).innerHTML="<svg>"+t+"</svg>",t=xs.firstChild;e.firstChild;)e.removeChild(e.firstChild);for(;t.firstChild;)e.appendChild(t.firstChild)}},"undefined"!=typeof MSApp&&MSApp.execUnsafeLocalFunction?function(e,t,n,r){MSApp.execUnsafeLocalFunction(function(){return gs(e,t)})}:gs);function ws(e,t){if(t){var n=e.firstChild;if(n&&n===e.lastChild&&3===n.nodeType)return void(n.nodeValue=t)}e.textContent=t}var Es={animationIterationCount:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},As=["Webkit","ms","Moz","O"];function Ts(e,t){for(var n in e=e.style,t)if(t.hasOwnProperty(n)){var r=0===n.indexOf("--"),s=n,a=t[n];s=null==a||"boolean"==typeof a||""===a?"":r||"number"!=typeof a||0===a||Es.hasOwnProperty(s)&&Es[s]?(""+a).trim():a+"px","float"===n&&(n="cssFloat"),r?e.setProperty(n,s):e[n]=s}}Object.keys(Es).forEach(function(e){As.forEach(function(t){t=t+e.charAt(0).toUpperCase()+e.substring(1),Es[t]=Es[e]})});var Cs=a({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function Ss(e,t,n){t&&(Cs[e]&&(null!=t.children||null!=t.dangerouslySetInnerHTML)&&d("137",e,n()),null!=t.dangerouslySetInnerHTML&&(null!=t.children&&d("60"),"object"==typeof t.dangerouslySetInnerHTML&&"__html"in t.dangerouslySetInnerHTML||d("61")),null!=t.style&&"object"!=typeof t.style&&d("62",n()))}function Os(e,t){if(-1===e.indexOf("-"))return"string"==typeof t.is;switch(e){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var Ns=vs,Bs=o.thatReturns("");function Rs(e,t){var n=un(e=9===e.nodeType||11===e.nodeType?e:e.ownerDocument);t=Y[t];for(var r=0;r<t.length;r++){var s=t[r];n.hasOwnProperty(s)&&n[s]||("topScroll"===s?Zt("topScroll","scroll",e):"topFocus"===s||"topBlur"===s?(Zt("topFocus","focus",e),Zt("topBlur","blur",e),n.topBlur=!0,n.topFocus=!0):"topCancel"===s?(_t("cancel",!0)&&Zt("topCancel","cancel",e),n.topCancel=!0):"topClose"===s?(_t("close",!0)&&Zt("topClose","close",e),n.topClose=!0):on.hasOwnProperty(s)&&Jt(s,on[s],e),n[s]=!0)}}var Ls={topAbort:"abort",topCanPlay:"canplay",topCanPlayThrough:"canplaythrough",topDurationChange:"durationchange",topEmptied:"emptied",topEncrypted:"encrypted",topEnded:"ended",topError:"error",topLoadedData:"loadeddata",topLoadedMetadata:"loadedmetadata",topLoadStart:"loadstart",topPause:"pause",topPlay:"play",topPlaying:"playing",topProgress:"progress",topRateChange:"ratechange",topSeeked:"seeked",topSeeking:"seeking",topStalled:"stalled",topSuspend:"suspend",topTimeUpdate:"timeupdate",topVolumeChange:"volumechange",topWaiting:"waiting"};function Ps(e,t,n,r){return n=9===n.nodeType?n:n.ownerDocument,r===Ns&&(r=hs(e)),r===Ns?"script"===e?((e=n.createElement("div")).innerHTML="<script><\/script>",e=e.removeChild(e.firstChild)):e="string"==typeof t.is?n.createElement(e,{is:t.is}):n.createElement(e):e=n.createElementNS(r,e),e}function Ms(e,t){return(9===t.nodeType?t:t.ownerDocument).createTextNode(e)}function Fs(e,t,n,r){var s=Os(t,n);switch(t){case"iframe":case"object":Jt("topLoad","load",e);var i=n;break;case"video":case"audio":for(i in Ls)Ls.hasOwnProperty(i)&&Jt(i,Ls[i],e);i=n;break;case"source":Jt("topError","error",e),i=n;break;case"img":case"image":Jt("topError","error",e),Jt("topLoad","load",e),i=n;break;case"form":Jt("topReset","reset",e),Jt("topSubmit","submit",e),i=n;break;case"details":Jt("topToggle","toggle",e),i=n;break;case"input":as(e,n),i=ss(e,n),Jt("topInvalid","invalid",e),Rs(r,"onChange");break;case"option":i=ls(e,n);break;case"select":us(e,n),i=a({},n,{value:void 0}),Jt("topInvalid","invalid",e),Rs(r,"onChange");break;case"textarea":ds(e,n),i=ps(e,n),Jt("topInvalid","invalid",e),Rs(r,"onChange");break;default:i=n}Ss(t,i,Bs);var c,l=i;for(c in l)if(l.hasOwnProperty(c)){var f=l[c];"style"===c?Ts(e,f):"dangerouslySetInnerHTML"===c?null!=(f=f?f.__html:void 0)&&ks(e,f):"children"===c?"string"==typeof f?("textarea"!==t||""!==f)&&ws(e,f):"number"==typeof f&&ws(e,""+f):"suppressContentEditableWarning"!==c&&"suppressHydrationWarning"!==c&&"autoFocus"!==c&&(z.hasOwnProperty(c)?null!=f&&Rs(r,c):s?ns(e,c,f):null!=f&&ts(e,c,f))}switch(t){case"input":vt(e),cs(e,n);break;case"textarea":vt(e),ms(e);break;case"option":null!=n.value&&e.setAttribute("value",n.value);break;case"select":e.multiple=!!n.multiple,null!=(t=n.value)?fs(e,!!n.multiple,t,!1):null!=n.defaultValue&&fs(e,!!n.multiple,n.defaultValue,!0);break;default:"function"==typeof i.onClick&&(e.onclick=o)}}function Is(e,t,n,r,s){var i,c,l=null;switch(t){case"input":n=ss(e,n),r=ss(e,r),l=[];break;case"option":n=ls(e,n),r=ls(e,r),l=[];break;case"select":n=a({},n,{value:void 0}),r=a({},r,{value:void 0}),l=[];break;case"textarea":n=ps(e,n),r=ps(e,r),l=[];break;default:"function"!=typeof n.onClick&&"function"==typeof r.onClick&&(e.onclick=o)}for(i in Ss(t,r,Bs),e=null,n)if(!r.hasOwnProperty(i)&&n.hasOwnProperty(i)&&null!=n[i])if("style"===i)for(c in t=n[i])t.hasOwnProperty(c)&&(e||(e={}),e[c]="");else"dangerouslySetInnerHTML"!==i&&"children"!==i&&"suppressContentEditableWarning"!==i&&"suppressHydrationWarning"!==i&&"autoFocus"!==i&&(z.hasOwnProperty(i)?l||(l=[]):(l=l||[]).push(i,null));for(i in r){var f=r[i];if(t=null!=n?n[i]:void 0,r.hasOwnProperty(i)&&f!==t&&(null!=f||null!=t))if("style"===i)if(t){for(c in t)!t.hasOwnProperty(c)||f&&f.hasOwnProperty(c)||(e||(e={}),e[c]="");for(c in f)f.hasOwnProperty(c)&&t[c]!==f[c]&&(e||(e={}),e[c]=f[c])}else e||(l||(l=[]),l.push(i,e)),e=f;else"dangerouslySetInnerHTML"===i?(f=f?f.__html:void 0,t=t?t.__html:void 0,null!=f&&t!==f&&(l=l||[]).push(i,""+f)):"children"===i?t===f||"string"!=typeof f&&"number"!=typeof f||(l=l||[]).push(i,""+f):"suppressContentEditableWarning"!==i&&"suppressHydrationWarning"!==i&&(z.hasOwnProperty(i)?(null!=f&&Rs(s,i),l||t===f||(l=[])):(l=l||[]).push(i,f))}return e&&(l=l||[]).push("style",e),l}function Ds(e,t,n,r,s){"input"===n&&"radio"===s.type&&null!=s.name&&os(e,s),Os(n,r),r=Os(n,s);for(var a=0;a<t.length;a+=2){var o=t[a],i=t[a+1];"style"===o?Ts(e,i):"dangerouslySetInnerHTML"===o?ks(e,i):"children"===o?ws(e,i):r?null!=i?ns(e,o,i):e.removeAttribute(o):null!=i?ts(e,o,i):rs(e,o)}switch(n){case"input":is(e,s);break;case"textarea":_s(e,s);break;case"select":e._wrapperState.initialValue=void 0,t=e._wrapperState.wasMultiple,e._wrapperState.wasMultiple=!!s.multiple,null!=(n=s.value)?fs(e,!!s.multiple,n,!1):t!==!!s.multiple&&(null!=s.defaultValue?fs(e,!!s.multiple,s.defaultValue,!0):fs(e,!!s.multiple,s.multiple?[]:"",!1))}}function Hs(e,t,n,r,s){switch(t){case"iframe":case"object":Jt("topLoad","load",e);break;case"video":case"audio":for(var a in Ls)Ls.hasOwnProperty(a)&&Jt(a,Ls[a],e);break;case"source":Jt("topError","error",e);break;case"img":case"image":Jt("topError","error",e),Jt("topLoad","load",e);break;case"form":Jt("topReset","reset",e),Jt("topSubmit","submit",e);break;case"details":Jt("topToggle","toggle",e);break;case"input":as(e,n),Jt("topInvalid","invalid",e),Rs(s,"onChange");break;case"select":us(e,n),Jt("topInvalid","invalid",e),Rs(s,"onChange");break;case"textarea":ds(e,n),Jt("topInvalid","invalid",e),Rs(s,"onChange")}for(var i in Ss(t,n,Bs),r=null,n)n.hasOwnProperty(i)&&(a=n[i],"children"===i?"string"==typeof a?e.textContent!==a&&(r=["children",a]):"number"==typeof a&&e.textContent!==""+a&&(r=["children",""+a]):z.hasOwnProperty(i)&&null!=a&&Rs(s,i));switch(t){case"input":vt(e),cs(e,n);break;case"textarea":vt(e),ms(e);break;case"select":case"option":break;default:"function"==typeof n.onClick&&(e.onclick=o)}return r}function Us(e,t){return e.nodeValue!==t}var Vs=Object.freeze({createElement:Ps,createTextNode:Ms,setInitialProperties:Fs,diffProperties:Is,updateProperties:Ds,diffHydratedProperties:Hs,diffHydratedText:Us,warnForUnmatchedText:function(){},warnForDeletedHydratableElement:function(){},warnForDeletedHydratableText:function(){},warnForInsertedHydratedElement:function(){},warnForInsertedHydratedText:function(){},restoreControlledState:function(e,t,n){switch(t){case"input":if(is(e,n),t=n.name,"radio"===n.type&&null!=t){for(n=e;n.parentNode;)n=n.parentNode;for(n=n.querySelectorAll("input[name="+JSON.stringify(""+t)+'][type="radio"]'),t=0;t<n.length;t++){var r=n[t];if(r!==e&&r.form===e.form){var s=_e(r);s||d("90"),yt(r),is(r,s)}}}break;case"textarea":_s(e,n);break;case"select":null!=(t=n.value)&&fs(e,!!n.multiple,t,!1)}}});rt.injectFiberControlledHostComponent(Vs);var zs=null,Ys=null;function Xs(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType&&(8!==e.nodeType||" react-mount-point-unstable "!==e.nodeValue))}var js=Ir({getRootHostContext:function(e){var t=e.nodeType;switch(t){case 9:case 11:e=(e=e.documentElement)?e.namespaceURI:bs(null,"");break;default:e=bs(e=(t=8===t?e.parentNode:e).namespaceURI||null,t=t.tagName)}return e},getChildHostContext:function(e,t){return bs(e,t)},getPublicInstance:function(e){return e},prepareForCommit:function(){zs=Qt;var e=c();if(_n(e)){if("selectionStart"in e)var t={start:e.selectionStart,end:e.selectionEnd};else e:{var n=window.getSelection&&window.getSelection();if(n&&0!==n.rangeCount){t=n.anchorNode;var r=n.anchorOffset,s=n.focusNode;n=n.focusOffset;try{t.nodeType,s.nodeType}catch(e){t=null;break e}var a=0,o=-1,i=-1,l=0,f=0,u=e,p=null;t:for(;;){for(var d;u!==t||0!==r&&3!==u.nodeType||(o=a+r),u!==s||0!==n&&3!==u.nodeType||(i=a+n),3===u.nodeType&&(a+=u.nodeValue.length),null!==(d=u.firstChild);)p=u,u=d;for(;;){if(u===e)break t;if(p===t&&++l===r&&(o=a),p===s&&++f===n&&(i=a),null!==(d=u.nextSibling))break;p=(u=p).parentNode}u=d}t=-1===o||-1===i?null:{start:o,end:i}}else t=null}t=t||{start:0,end:0}}else t=null;Ys={focusedElem:e,selectionRange:t},Gt(!1)},resetAfterCommit:function(){var e=Ys,t=c(),n=e.focusedElem,r=e.selectionRange;if(t!==n&&f(document.documentElement,n)){if(_n(n))if(t=r.start,void 0===(e=r.end)&&(e=t),"selectionStart"in n)n.selectionStart=t,n.selectionEnd=Math.min(e,n.value.length);else if(window.getSelection){t=window.getSelection();var s=n[Ce()].length;e=Math.min(r.start,s),r=void 0===r.end?e:Math.min(r.end,s),!t.extend&&e>r&&(s=r,r=e,e=s),s=dn(n,e);var a=dn(n,r);if(s&&a&&(1!==t.rangeCount||t.anchorNode!==s.node||t.anchorOffset!==s.offset||t.focusNode!==a.node||t.focusOffset!==a.offset)){var o=document.createRange();o.setStart(s.node,s.offset),t.removeAllRanges(),e>r?(t.addRange(o),t.extend(a.node,a.offset)):(o.setEnd(a.node,a.offset),t.addRange(o))}}for(t=[],e=n;e=e.parentNode;)1===e.nodeType&&t.push({element:e,left:e.scrollLeft,top:e.scrollTop});for(u(n),n=0;n<t.length;n++)(e=t[n]).element.scrollLeft=e.left,e.element.scrollTop=e.top}Ys=null,Gt(zs),zs=null},createInstance:function(e,t,n,r,s){return(e=Ps(e,t,n,r))[fe]=s,e[ue]=t,e},appendInitialChild:function(e,t){e.appendChild(t)},finalizeInitialChildren:function(e,t,n,r){Fs(e,t,n,r);e:{switch(t){case"button":case"input":case"select":case"textarea":e=!!n.autoFocus;break e}e=!1}return e},prepareUpdate:function(e,t,n,r,s){return Is(e,t,n,r,s)},shouldSetTextContent:function(e,t){return"textarea"===e||"string"==typeof t.children||"number"==typeof t.children||"object"==typeof t.dangerouslySetInnerHTML&&null!==t.dangerouslySetInnerHTML&&"string"==typeof t.dangerouslySetInnerHTML.__html},shouldDeprioritizeSubtree:function(e,t){return!!t.hidden},createTextInstance:function(e,t,n,r){return(e=Ms(e,t))[fe]=r,e},now:Hr,mutation:{commitMount:function(e){e.focus()},commitUpdate:function(e,t,n,r,s){e[ue]=s,Ds(e,t,n,r,s)},resetTextContent:function(e){e.textContent=""},commitTextUpdate:function(e,t,n){e.nodeValue=n},appendChild:function(e,t){e.appendChild(t)},appendChildToContainer:function(e,t){8===e.nodeType?e.parentNode.insertBefore(t,e):e.appendChild(t)},insertBefore:function(e,t,n){e.insertBefore(t,n)},insertInContainerBefore:function(e,t,n){8===e.nodeType?e.parentNode.insertBefore(t,n):e.insertBefore(t,n)},removeChild:function(e,t){e.removeChild(t)},removeChildFromContainer:function(e,t){8===e.nodeType?e.parentNode.removeChild(t):e.removeChild(t)}},hydration:{canHydrateInstance:function(e,t){return 1!==e.nodeType||t.toLowerCase()!==e.nodeName.toLowerCase()?null:e},canHydrateTextInstance:function(e,t){return""===t||3!==e.nodeType?null:e},getNextHydratableSibling:function(e){for(e=e.nextSibling;e&&1!==e.nodeType&&3!==e.nodeType;)e=e.nextSibling;return e},getFirstHydratableChild:function(e){for(e=e.firstChild;e&&1!==e.nodeType&&3!==e.nodeType;)e=e.nextSibling;return e},hydrateInstance:function(e,t,n,r,s,a){return e[fe]=a,e[ue]=n,Hs(e,t,n,s,r)},hydrateTextInstance:function(e,t,n){return e[fe]=n,Us(e,t)},didNotMatchHydratedContainerTextInstance:function(){},didNotMatchHydratedTextInstance:function(){},didNotHydrateContainerInstance:function(){},didNotHydrateInstance:function(){},didNotFindHydratableContainerInstance:function(){},didNotFindHydratableContainerTextInstance:function(){},didNotFindHydratableInstance:function(){},didNotFindHydratableTextInstance:function(){}},scheduleDeferredCallback:Ur,cancelDeferredCallback:Vr,useSyncScheduling:!0});function Ks(e,t,n,r,s){Xs(n)||d("200");var a=n._reactRootContainer;if(a)js.updateContainer(t,a,e,s);else{if(!(r=r||function(e){return!(!(e=e?9===e.nodeType?e.documentElement:e.firstChild:null)||1!==e.nodeType||!e.hasAttribute("data-reactroot"))}(n)))for(a=void 0;a=n.lastChild;)n.removeChild(a);var o=js.createContainer(n,r);a=n._reactRootContainer=o,js.unbatchedUpdates(function(){js.updateContainer(t,o,e,s)})}return js.getPublicRootInstance(a)}function qs(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;return Xs(t)||d("200"),function(e,t,n){var r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:xr,key:null==r?null:""+r,children:e,containerInfo:t,implementation:n}}(e,t,null,n)}function Qs(e,t){this._reactRootContainer=js.createContainer(e,t)}it=js.batchedUpdates,Qs.prototype.render=function(e,t){js.updateContainer(e,this._reactRootContainer,null,t)},Qs.prototype.unmount=function(e){js.updateContainer(null,this._reactRootContainer,null,e)};var Ws={createPortal:qs,findDOMNode:function(e){if(null==e)return null;if(1===e.nodeType)return e;var t=e._reactInternalFiber;if(t)return js.findHostInstance(t);"function"==typeof e.render?d("188"):d("213",Object.keys(e))},hydrate:function(e,t,n){return Ks(null,e,t,!0,n)},render:function(e,t,n){return Ks(null,e,t,!1,n)},unstable_renderSubtreeIntoContainer:function(e,t,n,r){return(null==e||void 0===e._reactInternalFiber)&&d("38"),Ks(e,t,n,!1,r)},unmountComponentAtNode:function(e){return Xs(e)||d("40"),!!e._reactRootContainer&&(js.unbatchedUpdates(function(){Ks(null,null,e,!1,function(){e._reactRootContainer=null})}),!0)},unstable_createPortal:qs,unstable_batchedUpdates:lt,unstable_deferredUpdates:js.deferredUpdates,flushSync:js.flushSync,__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED:{EventPluginHub:ce,EventPluginRegistry:K,EventPropagators:Ae,ReactControlledComponent:ot,ReactDOMComponentTree:me,ReactDOMEventListener:en}};js.injectIntoDevTools({findFiberByHostInstance:pe,bundleType:0,version:"16.2.0",rendererPackageName:"react-dom"});var Gs=Object.freeze({default:Ws}),Js=Gs&&Ws||Gs;e.exports=Js.default?Js.default:Js},function(e,t,n){"use strict";var r=!("undefined"==typeof window||!window.document||!window.document.createElement),s={canUseDOM:r,canUseWorkers:"undefined"!=typeof Worker,canUseEventListeners:r&&!(!window.addEventListener&&!window.attachEvent),canUseViewport:r&&!!window.screen,isInWorker:!r};e.exports=s},function(e,t,n){"use strict";var r=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable;e.exports=function(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},n=0;n<10;n++)t["_"+String.fromCharCode(n)]=n;if("0123456789"!==Object.getOwnPropertyNames(t).map(function(e){return t[e]}).join(""))return!1;var r={};return"abcdefghijklmnopqrst".split("").forEach(function(e){r[e]=e}),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},r)).join("")}catch(e){return!1}}()?Object.assign:function(e,t){for(var n,o,i=function(e){if(null===e||void 0===e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}(e),c=1;c<arguments.length;c++){for(var l in n=Object(arguments[c]))s.call(n,l)&&(i[l]=n[l]);if(r){o=r(n);for(var f=0;f<o.length;f++)a.call(n,o[f])&&(i[o[f]]=n[o[f]])}}return i}},function(e,t,n){"use strict";var r=n(1),s={listen:function(e,t,n){return e.addEventListener?(e.addEventListener(t,n,!1),{remove:function(){e.removeEventListener(t,n,!1)}}):e.attachEvent?(e.attachEvent("on"+t,n),{remove:function(){e.detachEvent("on"+t,n)}}):void 0},capture:function(e,t,n){return e.addEventListener?(e.addEventListener(t,n,!0),{remove:function(){e.removeEventListener(t,n,!0)}}):{remove:r}},registerDefault:function(){}};e.exports=s},function(e,t,n){"use strict";e.exports=function(e){if(void 0===(e=e||("undefined"!=typeof document?document:void 0)))return null;try{return e.activeElement||e.body}catch(t){return e.body}}},function(e,t,n){"use strict";var r=Object.prototype.hasOwnProperty;function s(e,t){return e===t?0!==e||0!==t||1/e==1/t:e!=e&&t!=t}e.exports=function(e,t){if(s(e,t))return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;var n=Object.keys(e),a=Object.keys(t);if(n.length!==a.length)return!1;for(var o=0;o<n.length;o++)if(!r.call(t,n[o])||!s(e[n[o]],t[n[o]]))return!1;return!0}},function(e,t,n){"use strict";var r=n(12);e.exports=function e(t,n){return!(!t||!n)&&(t===n||!r(t)&&(r(n)?e(t,n.parentNode):"contains"in t?t.contains(n):!!t.compareDocumentPosition&&!!(16&t.compareDocumentPosition(n))))}},function(e,t,n){"use strict";var r=n(13);e.exports=function(e){return r(e)&&3==e.nodeType}},function(e,t,n){"use strict";e.exports=function(e){var t=(e?e.ownerDocument||e:document).defaultView||window;return!(!e||!("function"==typeof t.Node?e instanceof t.Node:"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName))}},function(e,t,n){"use strict";e.exports=function(e){try{e.focus()}catch(e){}}},function(e,t,n){"use strict";var r={};e.exports=r},function(module,exports,__webpack_require__){var abc2svg={version:"1.15.9",vdate:"2018-01-28"};function Abc(user){"use strict";var require=empty_function,system=empty_function,write=empty_function,XMLHttpRequest=empty_function;this.user=user;var BAR=0,CLEF=1,CUSTOS=2,GRACE=4,KEY=5,METER=6,MREST=7,NOTE=8,PART=9,REST=10,SPACE=11,STAVES=12,STBRK=13,TEMPO=14,BLOCK=16,REMARK=17,FULL=0,EMPTY=1,OVAL=2,OVALBARS=3,SQUARE=4,SL_ABOVE=1,SL_BELOW=2,SL_AUTO=3,SL_HIDDEN=4,SL_DOTTED=8,OPEN_BRACE=1,CLOSE_BRACE=2,OPEN_BRACKET=4,CLOSE_BRACKET=8,OPEN_PARENTH=16,CLOSE_PARENTH=32,STOP_BAR=64,FL_VOICE=128,OPEN_BRACE2=256,CLOSE_BRACE2=512,OPEN_BRACKET2=1024,CLOSE_BRACKET2=2048,MASTER_VOICE=4096,BASE_LEN=1536,IN=96,CM=37.8,YSTEP=256,glovar={meter:{type:METER,wmeasure:1,a_meter:[]}},info={},mac={},maci=new Int8Array(128),parse={ctx:{},prefix:"%",state:0,line:new scanBuf},psvg;function clone(e){if(!e)return e;var t=new e.constructor;for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function errbld(e,t,n,r){var s,a,o,i,c;if(user.errbld){switch(e){case 0:e="warn";break;case 1:e="error";break;default:e="fatal"}user.errbld(e,t,n,r)}else{if(void 0!=r&&r>=0){for(s=o=0;!((a=parse.file.indexOf("\n",s))<0||a>r);)o++,s=a+1;i=r-s}switch(c="",n&&(c=n,o&&(c+=":"+(o+1)+":"+(i+1)),c+=" "),e){case 0:c+="Warning: ";break;case 1:c+="Error: ";break;default:c+="Internal bug: "}user.errmsg(c+t,o,i)}}function error(e,t,n,r,s,a,o){var i;user.textrans&&(i=user.textrans[n])&&(n=i),arguments.length>3&&(n=n.replace(/\$./g,function(e){switch(e){case"$1":return r;case"$2":return s;case"$3":return a;default:return o}})),t&&t.ctx?errbld(e,n,t.ctx.fname,t.istart):errbld(e,n)}function scanBuf(){this.index=0,scanBuf.prototype.char=function(){return this.buffer[this.index]},scanBuf.prototype.next_char=function(){return this.buffer[++this.index]},scanBuf.prototype.get_int=function(){for(var e=0,t=this.buffer[this.index];t>="0"&&t<="9";)e=10*e+Number(t),t=this.next_char();return e}}function syntax(e,t,n,r,s,a){error(e,{ctx:parse.ctx,istart:parse.istart+parse.line.index},t,n,r,s,a)}function is_secure(e){return!e.match(/eval *\(|Function/)}var dd_tb={},a_de,od,std_deco={dot:"0 stc 5 1 1",tenuto:"0 emb 5 3 3",slide:"1 sld 3 7 0",arpeggio:"2 arp 12 10 0",roll:"3 roll 7 6 6",fermata:"3 hld 12 7 7",emphasis:"3 accent 7 4 4",lowermordent:"3 lmrd 10 5 5",coda:"3 coda 24 10 10",uppermordent:"3 umrd 10 5 5",segno:"3 sgno 20 8 8",trill:"3 trl 14 5 5",upbow:"3 upb 10 5 5",downbow:"3 dnb 9 5 5",gmark:"3 grm 6 5 5",wedge:"3 wedge 8 3 3",turnx:"3 turnx 10 0 5",breath:"3 brth 0 1 20",longphrase:"3 lphr 0 1 1",mediumphrase:"3 mphr 0 1 1",shortphrase:"3 sphr 0 1 1",invertedfermata:"3 hld 12 7 7",invertedturn:"3 turn 10 0 5",invertedturnx:"3 turnx 10 0 5",0:"3 fng 8 3 3 0",1:"3 fng 8 3 3 1",2:"3 fng 8 3 3 2",3:"3 fng 8 3 3 3",4:"3 fng 8 3 3 4",5:"3 fng 8 3 3 5",plus:"3 dplus 7 3 3","+":"3 dplus 7 3 3",accent:"3 accent 6 4 4",">":"3 accent 6 4 4",marcato:"3 marcato 9 3 3","^":"3 marcato 9 3 3",mordent:"3 lmrd 10 5 5",open:"3 opend 10 3 3",snap:"3 snap 14 3 3",thumb:"3 thumb 14 3 3","D.C.":"3 dacs 16 10 10 D.C.","D.S.":"3 dacs 16 10 10 D.S.",fine:"3 dacs 16 10 10 FINE",turn:"3 turn 10 0 5","trill(":"3 ltr 8 0 0","trill)":"3 ltr 8 0 0",f:"6 pf 18 1 7",ff:"6 pf 18 2 10",fff:"6 pf 18 4 13",ffff:"6 pf 18 6 16",mf:"6 pf 18 6 13",mp:"6 pf 18 6 16",p:"6 pf 18 2 8",pp:"6 pf 18 5 14",ppp:"6 pf 18 8 20",pppp:"6 pf 18 10 25",pralltriller:"3 umrd 10 5 5",sfz:'6 sfz 18 4 10 ""',ped:"4 ped 20 0 0","ped-up":"4 pedoff 20 0 0","crescendo(":"7 cresc 18 0 0","crescendo)":"7 cresc 18 0 0","<(":"7 cresc 18 0 0","<)":"7 cresc 18 0 0","diminuendo(":"7 dim 18 0 0","diminuendo)":"7 dim 18 0 0",">(":"7 dim 18 0 0",">)":"7 dim 18 0 0","-(":"8 gliss 0 0 0","-)":"8 gliss 0 0 0","~(":"8 glisq 0 0 0","~)":"8 glisq 0 0 0","8va(":"3 8va 10 0 0","8va)":"3 8va 10 0 0","8vb(":"4 8vb 10 0 0","8vb)":"4 8vb 10 0 0","15ma(":"3 15ma 10 0 0","15ma)":"3 15ma 10 0 0","15mb(":"4 15mb 10 0 0","15mb)":"4 15mb 10 0 0",invisible:"32 0 0 0 0",beamon:"33 0 0 0 0",trem1:"34 0 0 0 0",trem2:"34 0 0 0 0",trem3:"34 0 0 0 0",trem4:"34 0 0 0 0",xstem:"35 0 0 0 0",beambr1:"36 0 0 0 0",beambr2:"36 0 0 0 0",rbstop:"37 0 0 0 0","/":"38 0 0 6 6","//":"38 0 0 6 6","///":"38 0 0 6 6","beam-accel":"39 0 0 0 0","beam-rall":"39 0 0 0 0",stemless:"40 0 0 0 0",rbend:"41 0 0 0 0"},f_near=[!0,!0,!0],f_note=[!1,!1,!1,!0,!0,!0,!1,!1,!0],f_staff=[!1,!1,!1,!1,!1,!1,!0,!0],user_deco={};function y_get(e,t,n,r){var s,a=staff_tb[e],o=n/realwidth*YSTEP|0,i=(n+r)/realwidth*YSTEP|0;if(o<0&&(o=0),i>=YSTEP&&o>(i=YSTEP-1)&&(o=i),t)for(s=a.top[o++];o<=i;)s<a.top[o]&&(s=a.top[o]),o++;else for(s=a.bot[o++];o<=i;)s>a.bot[o]&&(s=a.bot[o]),o++;return s}function y_set(e,t,n,r,s){var a=staff_tb[e],o=n/realwidth*YSTEP|0,i=(n+r)/realwidth*YSTEP|0;if(o<0&&(o=0),i>=YSTEP&&o>(i=YSTEP-1)&&(o=i),t)for(;o<=i;)a.top[o]<s&&(a.top[o]=s),o++;else for(;o<=i;)a.bot[o]>s&&(a.bot[o]=s),o++}function up_p(e,t){switch(t){case SL_ABOVE:return!0;case SL_BELOW:return!1}return e.multi&&0!=e.multi?e.multi>0:!!e.p_v.have_ly&&e.pos.voc!=SL_ABOVE}function d_arp(e){var t,n,r,s=e.s,a=e.dd,o=5;if(s.type==NOTE)for(t=0;t<=s.nhd;t++){if(s.notes[t].acc)r=5+s.notes[t].shac;else switch(r=6-s.notes[t].shhd,s.head){case SQUARE:r+=3.5;break;case OVALBARS:case OVAL:r+=2}r>o&&(o=r)}(n=3*(s.notes[s.nhd].pit-s.notes[0].pit)+4)<(t=a.h)&&(n=t),e.has_val=!0,e.val=n,e.x-=o,e.y=3*(s.notes[0].pit-18)-3}function d_cresc(e){if(!e.ldst){var t,n,r,s,a,o,i,c,l,f,u=e.s,p=e.start;a=(t=p.s).x+3,(c=p.ix)>0&&(l=a_de[c-1]),e.st=u.st,e.lden=!1,e.has_val=!0,(s=up_p(u,u.pos.dyn))&&(e.up=!0),l&&l.s==t&&(e.up&&!l.up||!e.up&&l.up)&&(r=l.dd,f_staff[r.func]&&(i=l.x+l.val+4)>a&&(a=i)),e.defl.noen?(o=e.x-a)<20&&(a=e.x-20-3,o=20):(i=u.x,(f=a_de[e.ix+1])&&f.s==t&&(e.up&&!f.up||!e.up&&f.up)&&(r=f.dd,f_staff[r.func]&&(i-=5)),(o=i-a-4)<20&&(a-=.5*(20-o),o=20)),e.val=o,e.x=a,e.y=y_get(e.st,s,a,o),s||(n=e.dd,e.y-=n.h)}}function d_near(e){var t,n,r=e.s,s=e.dd;s.str||((t=(n=r.multi?r.multi>0:r.stem<0)?0|r.ymx:r.ymn-s.h|0)>-6&&t<24&&(n&&(t+=3),t=6*((t+6)/6|0)-6),n?r.ymx=t+s.h:r.ymn=t,e.y=t,r.type==NOTE&&(e.x+=r.notes[r.stem>=0?0:r.nhd].shhd),"d"==s.name[0]&&r.nflags>=-1&&(n?r.stem>0&&(e.x+=3.5):r.stem<0&&(e.x-=3.5)))}function d_pf(e){var t,n,r,s,a,o=e.s,i=e.dd;e.val=i.wl+i.wr,(s=up_p(o,o.pos.vol))&&(e.up=!0),r=o.x-i.wl,e.ix>0&&(a=a_de[e.ix-1]).s==o&&(e.up&&!a.up||!e.up&&a.up)&&(t=a.dd,f_staff[t.func]&&(n=a.x+a.val+4)>r&&(r=n)),e.x=r,e.y=y_get(o.st,s,r,e.val),s||(e.y-=i.h)}function d_slide(e){var t,n,r=e.s,s=r.notes[0].pit,a=5;for(t=0;t<=r.nhd;t++){if(r.notes[t].acc)n=4+r.notes[t].shac;else switch(n=5-r.notes[t].shhd,r.head){case SQUARE:n+=3.5;break;case OVALBARS:case OVAL:n+=2}r.notes[t].pit<=s+3&&n>a&&(a=n)}e.x-=a,e.y=3*(s-18)}function d_trill(e){if(!e.ldst){var t,n,r,s,a,o=e.s,i=o.st,c=e.start.s,l=c.x;if(e.prev&&(l=e.prev.x+10,r=e.prev.y),e.st=i,4!=e.dd.func)switch(e.dd.glyph){case"8va":case"15ma":n=1;break;default:n=o.multi>=0}e.defl.noen?(s=e.x-l)<20&&(l=e.x-20-3,s=20):(s=o.x-l-6,o.type==NOTE&&(s-=6),s<20&&(l-=.5*(20-s),s=20)),t=e.dd,r||(r=y_get(i,n,l,s)),n?r<(a=staff_tb[c.st].topbar+2)&&(r=a):(r-=t.h)>(a=staff_tb[c.st].botbar-2)&&(r=a),e.lden=!1,e.has_val=!0,e.val=s,e.x=l,e.y=r,n&&(r+=t.h),y_set(i,n,l,s,r),n?c.ymx=o.ymx=r:c.ymn=o.ymn=r}}function d_upstaff(e){if(!e.ldst)if(e.start)d_trill(e);else{var t,n,r,s=e.s,a=e.dd,o=s.x,i=a.wl+a.wr,c=staff_tb[s.st].topbar+2,l=staff_tb[s.st].botbar-2;if(s.nhd&&(o+=s.notes[s.stem>=0?0:s.nhd].shhd),n=-1,4==a.func)n=0;else if(s.pos)switch(s.pos.orn){case SL_ABOVE:n=1;break;case SL_BELOW:n=0}switch(a.glyph){case"accent":case"roll":!n||n<0&&(s.multi<0||!s.multi&&s.stem>0)?((t=y_get(s.st,!1,s.x-a.wl,i))>l&&(t=l),t-=a.h,y_set(s.st,!1,s.x,0,t),r=!0,s.ymn=t):((t=y_get(s.st,!0,s.x,0))<c&&(t=c),y_set(s.st,!0,s.x-a.wl,i,t+a.h),s.ymx=t+a.h);break;case"brth":case"lphr":case"mphr":case"sphr":for(t=c+1,"brth"==a.glyph&&t<s.ymx&&(t=s.ymx),s=s.ts_next;s&&!s.shrink;s=s.ts_next);o+=.4*((s?s.x:realwidth)-o);break;default:0==a.name.indexOf("invert")&&(r=!0),"invertedfermata"!=a.name&&(n>0||n<0&&s.multi>=0)?((t=y_get(s.st,!0,s.x-a.wl,i))<c&&(t=c),y_set(s.st,!0,s.x-a.wl,i,t+a.h),s.ymx=t+a.h):((t=y_get(s.st,!1,s.x-a.wl,i))>l&&(t=l),t-=a.h,y_set(s.st,!1,s.x-a.wl,i,t),"fermata"==a.name&&(r=!0),s.ymn=t)}r&&(t+=a.h,e.inv=!0),e.x=o,e.y=t}}var func_tb=[d_near,d_slide,d_arp,d_upstaff,d_upstaff,d_trill,d_pf,d_cresc];function deco_add(e){var t=e.match(/(\S*)\s+(.*)/);user_deco[t[1]]=t[2]}function deco_build(e,t){var n,r,s,a,o,i;if(n=t.match(/(\d+)\s+(.+?)\s+([0-9.]+)\s+([0-9.]+)\s+([0-9.]+)/)){var c=Number(n[1]),l=parseFloat(n[3]),f=parseFloat(n[4]),u=parseFloat(n[5]);if(isNaN(c))error(1,null,"%%deco: bad C function value '$1'",n[1]);else if((c<0||c>10)&&(c<32||c>41))error(1,null,"%%deco: bad C function index '$1'",c);else if(l<0||f<0||u<0)error(1,null,"%%deco: cannot have a negative value '$1'",t);else{if(!(l>50||f>80||u>80)){if((r=dd_tb[e])||(r={name:e},dd_tb[e]=r),r.func=0==r.name.indexOf("head-")?9:c,r.glyph=n[2],r.h=l,r.wl=f,r.wr=u,(i=t.replace(n[0],"").trim())&&('"'==i[0]&&(i=i.slice(1,-1)),r.str=i),6==r.func&&void 0==r.str&&(r.str=r.name),"("==(o=r.name.slice(-1))||")"==o&&r.name.indexOf("(")<0)if(a=r.name.slice(0,-1)+("("==o?")":"("),s=dd_tb[a])"("==o?(r.dd_en=s,s.dd_st=r):(r.dd_st=s,s.dd_en=r);else if(!(s=deco_def(a)))return;return r}error(1,null,"%%deco: abnormal h/wl/wr value '$1'",t)}}else error(1,null,"Invalid decoration '$1'",e)}function deco_cnv(e,t,n){var r,s,a,o,i,c=e.length;for(r=0;r<c;r++)if(o=e[r],(a=dd_tb[o])||(a=deco_def(o))){switch(a.func){case 0:if(t.type==BAR&&"dot"==a.name){t.bar_dotted=!0;break}case 1:case 2:if(!t.notes){error(1,t,"!$1! must be on a note or a rest",a.name);continue}break;case 8:if(t.type!=NOTE){error(1,t,"!$1! must be on a note",a.name);continue}(i=t.notes[t.nhd]).a_dcn||(i.a_dcn=[]),i.a_dcn.push(a.name);continue;case 9:if(!t.notes){error(1,t,"!$1! must be on a note or rest",a.name);continue}for(s=0;s<=t.nhd;s++)(i=t.notes[s]).a_dcn||(i.a_dcn=[]),i.a_dcn.push(a.name);continue;default:break;case 10:if(t.notes)for(s=0;s<=t.nhd;s++)t.notes[s].color=a.name;else t.color=a.name;continue;case 32:t.invis=!0;continue;case 33:if(t.type!=BAR){error(1,t,"!beamon! must be on a bar");continue}t.beam_on=!0;continue;case 34:if(t.type!=NOTE||!n||n.type!=NOTE||t.nflags!=n.nflags){error(1,t,"!$1! must be on the last of a couple of notes",a.name);continue}for(t.trem2=!0,t.beam_end=!0,n.trem2=!0,n.beam_st=!0,t.ntrem=n.ntrem=Number(a.name[4]),n.nflags=--t.nflags,n.head=++t.head,t.nflags>0?t.nflags+=t.ntrem:(t.nflags<=-2&&(t.stemless=!0,n.stemless=!0),t.nflags=t.ntrem),n.nflags=t.nflags,s=0;s<=t.nhd;s++)t.notes[s].dur*=2;for(s=0;s<=n.nhd;s++)n.notes[s].dur*=2;continue;case 35:if(t.type!=NOTE){error(1,t,"!xstem! must be on a note");continue}t.xstem=!0,t.nflags=0;continue;case 36:if(t.type!=NOTE){error(1,t,"!$1! must be on a note",a.name);continue}"1"==a.name[6]?t.beam_br1=!0:t.beam_br2=!0;continue;case 37:t.rbstop=1;continue;case 38:if(t.type!=NOTE){error(1,t,"!$1! must be on a note",a.name);continue}t.trem1=!0,t.ntrem=a.name.length,t.nflags>0?t.nflags+=t.ntrem:t.nflags=t.ntrem;continue;case 39:if(t.type!=NOTE){error(1,t,"!$1! must be on a note",a.name);continue}t.feathered_beam="a"==a.name[5]?1:-1;continue;case 40:t.stemless=!0;continue;case 41:t.rbstop=2;continue}t.a_dd||(t.a_dd=[]),t.a_dd.push(a)}}function deco_def(e){return user_deco&&user_deco[e]?deco_build(e,user_deco[e]):std_deco[e]?deco_build(e,std_deco[e]):void(cfmt.decoerr&&error(1,null,"Unknown decoration '$1'",e))}function deco_update(e,t){var n,r,s=a_de.length;for(n=0;n<s;n++)(r=a_de[n]).s==e&&(r.x+=t)}function deco_width(e){var t,n=0,r=e.a_dd,s=r.length;for(t=0;t<s;t++)switch(r[t].func){case 1:n<7&&(n=7);break;case 2:n<14&&(n=14)}return 0!=n&&e.prev&&e.prev.type==BAR&&(n-=3),n}function draw_all_deco(){if(0!=a_de.length){var e,t,n,r,s,a,o,i,c,l,f,u,p,d=[],_=[];if(!cfmt.dynalign)for(o=staff_tb[s=nstaff].y;--s>=0;)i=staff_tb[s].y,_[s]=.5*(o+24+i),o=i;for(;e=a_de.shift();)(t=e.dd)&&(t.dd_en||(n=e.s,(f=(r=t.glyph).indexOf("/"))>0&&(r=n.stem>=0?r.slice(0,f):r.slice(f+1)),f_staff[t.func]?set_sscale(-1):set_scale(n),s=e.st,staff_tb[s].topbar&&(a=e.x,o=e.y+staff_tb[s].y,void 0!=e.m?a+=n.notes[e.m].shhd*stv_g.scale:f_staff[t.func]&&!cfmt.dynalign&&(e.up&&s>0||!e.up&&s<nstaff)&&(c=e.up?_[--s]:_[s++],c-=.5*t.h,(e.up&&o<c||!e.up&&o>c)&&(i=y_get(s,!e.up,e.x,e.val)+staff_tb[s].y,e.up&&(i-=t.h),(e.up&&i>c||!e.up&&i<c)&&(o=c))),(l=user[r])&&"function"==typeof l?l(a,o,e):psdeco(r,a,o,e)||(anno_start(n,"deco"),e.inv&&(g_open(a,o,0,1,-1),a=o=0),e.has_val?(2!=t.func||stv_g.st<0?out_deco_val(a,o,r,e.val/stv_g.scale,e.defl):out_deco_val(a,o,r,e.val,e.defl),e.defl.noen&&d.push(e.start)):void 0!=t.str&&"sfz"!=t.str?("@"==(u=t.str)[0]&&(p=u.match(/^@([0-9.-]+),([0-9.-]+);?/),a+=Number(p[1]),o+=Number(p[2]),u=u.replace(p[0],"")),out_deco_str(a,o,r,u)):e.lden?out_deco_long(a,o,e):xygl(a,o,r),stv_g.g&&g_close(),anno_stop(n,"deco")))));a_de=d}}var ottava={"8va(":1,"8va)":1,"15ma(":1,"15ma)":1,"8vb(":1,"8vb)":1,"15mb(":1,"15mb)":1};function draw_deco_near(){var e,t;function n(e,t){var n,r,s,a,o=e.notes[t],i=o.a_dcn.length;for(r=0;r<i;r++)if(s=o.a_dcn[r],(a=dd_tb[s])||(a=deco_def(s))){switch(a.func){case 0:case 1:case 3:case 4:break;default:case 2:case 5:case 7:error(1,null,"Cannot have !$1! on a head",a.name);continue;case 9:o.invis=!0;break;case 10:o.color=a.name;continue;case 32:o.invis=!0;continue;case 40:e.stemless=!0;continue}n={s:e,dd:a,st:e.st,m:t,ix:0,defl:{},x:e.x,y:3*(o.pit-18)},a_de.push(n),a.dd_en?n.ldst=!0:a.dd_st&&(n.lden=!0,n.defl.nost=!0)}}function r(e){var t;if(e.a_dd&&function(e){var t,n,r,s,a,o=e.a_dd.length;for(n=0;n<o;n++){switch((t=e.a_dd[n]).func){default:r=0;break;case 3:case 4:case 5:if(ottava[t.name])if(a=t.name.slice(0,-1)+e.st.toString(),od[a]){if("("==t.name[t.name.length-1]){od[a]++;continue}if(od[a]--,e.v+1!=od[a]>>8||!od[a])continue;od[a]&=255}else"("==t.name[t.name.length-1]&&(od[a]=1+(e.v+1<<8));r=e.pos.orn;break;case 6:r=e.pos.vol;break;case 7:r=e.pos.dyn}r!=SL_HIDDEN&&(s={s:e,dd:t,st:e.st,ix:a_de.length,defl:{},x:e.x,y:e.y},a_de.push(s),t.dd_en?s.ldst=!0:t.dd_st&&(s.lden=!0,s.defl.nost=!0),f_near[t.func]&&func_tb[t.func](s))}}(e),e.notes)for(t=0;t<e.notes.length;t++)e.notes[t].a_dcn&&n(e,t)}for(e=tsfirst;e;e=e.ts_next){switch(e.type){case CLEF:case KEY:case METER:continue}break}for(0!=a_de.length&&function(e){var t,n,r=e.x-e.wl,s=a_de.length;for(t=0;t<s;t++)(n=a_de[t]).ix=t,n.s.x=n.x=r,n.defl.nost=!0}(e);e;e=e.ts_next){switch(e.type){case BAR:case MREST:case NOTE:case REST:case SPACE:break;case GRACE:for(t=e.extra;t;t=t.next)r(t);default:continue}r(e)}!function(){var e,t,n,r,s,a,o,i,c,l=a_de.length;for(e=0;e<l;e++)if((n=a_de[e]).ldst){for(a=(s=n.dd).dd_en,o=(i=n.s).v,t=e+1;t<l&&((r=a_de[t]).start||r.dd!=a||r.s.v!=o);t++);if(t==l)for(c=i.st,t=e+1;t<l&&((r=a_de[t]).start||r.dd!=a||r.s.st!=c);t++);t==l&&((r={s:n.s,st:n.st,dd:a,ix:a_de.length-1,x:realwidth-6,y:n.s.y,lden:!0,defl:{noen:!0}}).x<i.x+10&&(r.x=i.x+10),void 0!=n.m&&(r.m=n.m),a_de.push(r)),r.start=n,r.defl.nost=n.defl.nost,"trill("==s.name&&e>0&&"trill"==a_de[e-1].dd.name&&(r.prev=a_de[e-1])}for(e=0;e<l;e++)(r=a_de[e]).lden&&!r.start&&((n={s:prev_scut(i=r.s),st:r.st,dd:r.dd.dd_st,ix:a_de.length-1,y:i.y,ldst:!0}).x=n.s.x,void 0!=r.m&&(n.m=r.m),a_de.push(n),r.start=n)}()}function draw_deco_note(){var e,t,n,r=a_de.length;for(e=0;e<r;e++)n=(t=a_de[e]).dd.func,f_note[n]&&void 0==t.m&&func_tb[n](t)}function draw_deco_staff(){var e,t,n,r,s,a,o,i,c,l,f,u,p,d,_,m=new Array(nstaff),v=a_de.length;function y(e){var t,n,s,a,o,i;for(s=staff_tb[e.st].topbar+25,t=e.sym;t;t=t.next)if(t.type==BAR&&t.rbstart&&!t.norepbra){if(!t.next)break;for(i||(i=t,set_font("repeat")),n=t;t.next&&!(t=t.next).rbstop;);s<(a=y_get(e.st,!0,n.x,t.x-n.x))&&(s=a),n.text&&(o=strw(n.text),a=y_get(e.st,!0,n.x+4,o),s<(a+=gene.curfont.size)&&(s=a)),t.rbstart&&(t=t.prev)}if(t=i)for(set_dscale(e.st,!0),a=s*staff_tb[e.st].staffscale;t;t=t.next)if(t.rbstart&&!t.norepbra){for(n=t;t.next&&!(t=t.next).rbstop;);if(n==t)break;r=n.x,o=t.type!=BAR?t.rbstop?0:t.x-realwidth+4:t.bar_type.length>1&&"[]"!=t.bar_type||"]"==t.bar_type?n.st>0&&!(cur_sy.staves[n.st-1].flags&STOP_BAR)?t.wl:":"==t.bar_type.slice(-1)?12:":"!=t.bar_type[0]?0:8:t.rbstop?0:8,o=t.x-r-o,t.next||t.rbstop||e.bar_start||(e.bar_start=clone(t),e.bar_start.type=BAR,e.bar_start.bar_type="[",delete e.bar_start.text,e.bar_start.rbstart=1,delete e.bar_start.a_gch),n.text&&xy_str(r+4,a-gene.curfont.size-3,n.text),xypath(r,a),2==n.rbstart&&output.push("m0 20v-20"),output.push("h"),output.push(o.toFixed(2)),2==t.rbstop&&output.push("v20"),output.push('"/>\n'),y_set(n.st,!0,r,o,s+2),t.rbstart&&(t=t.prev)}}for(o=0;o<=nstaff;o++)m[o]={ymin:0,ymax:24};for(e=tsfirst;e;e=e.ts_next)if(e.a_gch){for(t||(t=e),u=null,p=0;p<e.a_gch.length&&!("g"==(f=e.a_gch[p]).type&&(u=f,f.y<0));p++);u&&(a=u.w,u.y>=0?(s=y_get(e.st,!0,e.x,a))>m[e.st].ymax&&(m[e.st].ymax=s):(s=y_get(e.st,!1,e.x,a))<m[e.st].ymin&&(m[e.st].ymin=s))}if(t){for(o=0;o<=nstaff;o++)_=staff_tb[o].botbar,m[o].ymin-=3,m[o].ymin>_-10&&(m[o].ymin=_-10),d=staff_tb[o].topbar,m[o].ymax+=3,m[o].ymax<d+10&&(m[o].ymax=d+10);for(set_sscale(-1),e=t;e;e=e.ts_next)e.a_gch&&draw_gchord(e,m[e.st].ymin,m[e.st].ymax)}for(i=0;i<voice_tb.length;i++)!(n=voice_tb[i]).second&&n.sym&&y(n);for(o=0;o<=nstaff;o++)m[o]={ymin:0,ymax:0};for(o=0;o<v;o++)(l=(c=a_de[o]).dd)&&f_staff[l.func]&&void 0==c.m&&(func_tb[l.func](c),l.dd_en||cfmt.dynalign&&(c.up?c.y>m[c.st].ymax&&(m[c.st].ymax=c.y):c.y<m[c.st].ymin&&(m[c.st].ymin=c.y)));for(o=0;o<v;o++)(l=(c=a_de[o]).dd)&&!l.dd_en&&f_staff[l.func]&&(cfmt.dynalign?(s=c.up?m[c.st].ymax:m[c.st].ymin,c.y=s):s=c.y,c.up&&(s+=l.h),y_set(c.st,c.up,c.x,c.val,s))}function draw_measnb(){var e,t,n,r,s,a,o,i,c=cur_sy;for(t=0;t<=nstaff&&!c.st_print[t];t++);if(!(t>nstaff)){if(set_dscale(t),1!=staff_tb[t].staffscale&&param_set_font("measurefont","* "+((i=get_font("measure").size)/staff_tb[t].staffscale).toString()),set_font("measure"),e=tsfirst,(n=gene.nbar)>1)if(0==cfmt.measurenb)o=!0,(s=y_get(t,!0,0,20))<staff_tb[t].topbar+14&&(s=staff_tb[t].topbar+14),xy_str(0,s,n.toString()),y_set(t,!0,0,20,s+gene.curfont.size+2);else if(n%cfmt.measurenb==0){for(;;e=e.ts_next){switch(e.type){case METER:case CLEF:case KEY:case STBRK:continue}break}for(;e.st!=t;)e=e.ts_next;e.prev&&e.prev.type!=CLEF&&(e=e.prev),r=e.x-e.wl,o=!0,a=cwid("0")*gene.curfont.swfac,n>=10&&(a*=n>=100?3:2),cfmt.measurebox&&(a+=4),(s=y_get(t,!0,r,a))<staff_tb[t].topbar+6&&(s=staff_tb[t].topbar+6),s+=2,cfmt.measurebox?(xy_str_b(r,s,n.toString()),a+=3):xy_str(r,s,n.toString()),y_set(t,!0,r,a,s+=gene.curfont.size),e.ymx=s}for(;e;e=e.ts_next){switch(e.type){case STAVES:for(c=e.sy,t=0;t<nstaff&&!c.st_print[t];t++);set_sscale(t);continue;default:continue;case BAR:if(!e.bar_num)continue}n=e.bar_num,0!=cfmt.measurenb&&n%cfmt.measurenb==0&&e.next&&(o||(o=!0),a=cwid("0")*gene.curfont.swfac,n>=10&&(a*=n>=100?3:2),cfmt.measurebox&&(a+=4),(s=y_get(t,!0,r=e.x-.4*a,a))<staff_tb[t].topbar+6&&(s=staff_tb[t].topbar+6),e.next.type==NOTE&&(e.next.stem>0?s<e.next.ys-gene.curfont.size&&(s=e.next.ys-gene.curfont.size):s<e.next.y&&(s=e.next.y)),s+=2,cfmt.measurebox?(xy_str_b(r,s,n.toString()),a+=3):xy_str(r,s,n.toString()),y_set(t,!0,r,a,s+=gene.curfont.size),e.ymx=s)}gene.nbar=n,i&&param_set_font("measurefont","* "+i.toString())}}function draw_notempo(e,t,n,r,s){var a,o,i,c=identify_note(e,r),l=c[0],f=c[1],u=c[2];switch(stv_g.started&&(output.push("</g>\n"),stv_g.started=!1),out_XYAB('<g transform="translate(X,Y) scale(F)">\n',t+4,n+2,s),l){case OVAL:o="HD";break;case EMPTY:o="Hd";break;default:o="hd"}if(xygl(-posx,posy,o),a=4,f){switch(i=9,u>0&&(i+=4),l){case SQUARE:i+=3;break;case OVALBARS:case OVAL:i+=2;break;case EMPTY:i+=1}for(a=i*f,i-=posx;--f>=0;)xygl(i,posy,"dot"),i+=3.5}return r<BASE_LEN&&(u<=0?out_stem(-posx,posy,21):(out_stem(-posx,posy,21,!1,u),a<6&&(a=6))),output.push("</g>\n"),(a+15)*s}function tempo_width(e){var t=0;return set_font("tempo"),e.tempo_str1&&(t=strw(e.tempo_str1)),e.tempo_ca&&(t+=strw(e.tempo_ca)),e.tempo_notes&&(t+=10*e.tempo_notes.length+6+cwid(" ")*gene.curfont.swfac*6+10),e.tempo_str2&&(t+=strw(e.tempo_str2)),t}function write_tempo(e,t,n){var r,s,a=.6*gene.curfont.size/15;if(set_font("tempo"),e.tempo_str1&&(xy_str(t,n,e.tempo_str1),t+=strw(e.tempo_str1)+3),e.tempo_notes){for(r=0;r<e.tempo_notes.length;r++)t+=draw_notempo(e,t,n,e.tempo_notes[r],a);xy_str(t,n,"="),t+=strw("= "),e.tempo_ca&&(xy_str(t,n,e.tempo_ca),t+=strw(e.tempo_ca)),e.tempo?(xy_str(t,n,e.tempo.toString()),t+=(s=cwid("0")*gene.curfont.swfac)+5,e.tempo>=10&&(t+=s,e.tempo>=100&&(t+=s))):t+=draw_notempo(e,t,n,e.new_beat,a)}e.tempo_str2&&xy_str(t,n,e.tempo_str2),e.del=!0}function draw_partempo(e,t){var n,r,s,a,o,i,c=0,l=0,f=staff_tb[e].topbar+12,u=0,p=1,d=0;for(n=tsfirst;n;n=n.ts_next)n.type!=TEMPO||n.del||(s||(s=n),o=tempo_width(n),(i=y_get(e,!0,n.x-5,o)+2)>f&&(f=i),d>=n.x-5&&!(u&p>>1)&&(u|=p),p<<=1,d=n.x-5+o);if(s)for(set_sscale(-1),set_font("tempo"),a=(i=2-(l=gene.curfont.size+2+2))-l,0!=u&&(l*=2),t<f+l&&(c=f+l-t),n=s;n;n=n.ts_next)n.type!=TEMPO||n.del||((user.anno_start||user.anno_stop)&&(n.wl=5,n.wr=40,n.ymn=1&u?a:i,n.ymx=n.ymn+14,anno_start(n)),write_tempo(n,n.x-5,1&u?a:i),anno_stop(n),u>>=1);for(f=staff_tb[e].topbar+14,n=tsfirst;n;n=n.ts_next)n.type==PART&&(r||(r=n,set_font("parts"),a=gene.curfont.size+2+2),o=strw(n.text),f<(i=y_get(e,!0,n.x-10,o+3)+5)&&(f=i));if(r)for(set_sscale(-1),t<f+a+l&&(c=f+a+l-t),n=r;n;n=n.ts_next)n.type==PART&&(n.x-=10,(user.anno_start||user.anno_stop)&&(o=strw(n.text),n.wl=0,n.wr=o,n.ymn=-l-a,n.ymx=n.ymn+a,anno_start(n)),cfmt.partsbox?xy_str_b(n.x,2-l-a,n.text):xy_str(n.x,2-l-a,n.text),anno_stop(n));return c}var STEM_MIN=16,STEM_MIN2=14,STEM_MIN3=12,STEM_MIN4=10,STEM_CH_MIN=14,STEM_CH_MIN2=10,STEM_CH_MIN3=9,STEM_CH_MIN4=9,BEAM_DEPTH=3.2,BEAM_OFFSET=.25,BEAM_SHIFT=5,BEAM_SLOPE=.4,BEAM_STUB=8,SLUR_SLOPE=.5,GSTEM=15,GSTEM_XOFF=2.3,cache;function b_pos(e,t,n,r){var s,a,o,i,c=e?3.5:BEAM_SHIFT,l=e?1.8:BEAM_DEPTH;function f(e){return 6*Math.round((e+12)/6)-12-e}if(t>0){if((a=r-(n-1)*c-l)>26)return 0;s=r}else{if((s=r+(n-1)*c+l)<-2)return 0;a=r}return(o=f(s-BEAM_OFFSET))*o>(i=f(a+BEAM_OFFSET))*i?i:o}function sym_dup(e){var t,n=clone(e);for(n.invis=!0,delete n.text,delete n.a_gch,delete n.a_ly,delete n.a_dd,n.notes=clone(e.notes),t=0;t<=n.nhd;t++)delete(n.notes[t]=clone(e.notes[t])).a_dcn;return n}var min_tb=[[STEM_MIN,STEM_MIN,STEM_MIN2,STEM_MIN3,STEM_MIN4,STEM_MIN4],[STEM_CH_MIN,STEM_CH_MIN,STEM_CH_MIN2,STEM_CH_MIN3,STEM_CH_MIN4,STEM_CH_MIN4]];function calculate_beam(e,t){var n,r,s,a,o,i,c,l,f,u,p,d,_,m,v,y,h,b,g,x,k,w;for(t.beam_st||(lkvsym(n=sym_dup(t),t),lktsym(n,t),n.x-=12,n.x>t.prev.x+12&&(n.x=t.prev.x+12),n.beam_st=!0,delete n.beam_end,n.tmp=!0,delete n.slur_start,delete n.slur_end,t=n),s=a=0,c=l=!1,o=t.st,i=t.v,g=t.grace?GSTEM_XOFF:3.5,r=t;r.type!=NOTE||(r.nflags>a&&(a=r.nflags),s++,r.st!=o&&(c=!0),r.stem!=t.stem&&(l=!0),k||r.invis||r.stemless&&!r.trem2||(k=!0),!r.beam_end);r=r.next)if(!r.next){for(;r.type!=NOTE;r=r.prev);(n=sym_dup(r)).next=r.next,n.next&&(n.next.prev=n),r.next=n,n.prev=r,n.ts_next=r.ts_next,n.ts_next&&(n.ts_next.ts_prev=n),r.ts_next=n,n.ts_prev=r,delete n.beam_st,n.beam_end=!0,n.tmp=!0,delete n.slur_start,delete n.slur_end,n.x+=12,n.x<realwidth-12&&(n.x=realwidth-12),r=n,s++;break}if(!k)return!1;if(e.s2=r,0==staff_tb[o].y){if(c)return!1}else if(!c)return e.s1=t,e.a=(t.ys-r.ys)/(t.xs-r.xs),e.b=t.ys-t.xs*e.a+staff_tb[o].y,e.nflags=a,!0;for(b=t,y=100,h=0,n=t;n.type!=NOTE||(1==(x=n.p_v.scale)&&(x=staff_tb[n.st].staffscale),n.stem>=0?(f=g+n.notes[0].shhd,n.notes[n.nhd].pit>h&&(h=n.notes[n.nhd].pit,b=n)):(f=-g+n.notes[n.nhd].shhd,n.notes[0].pit<y&&(y=n.notes[0].pit,b=n)),n.xs=n.x+f*x,n!=r);n=n.next);if(cfmt.flatbeams?d=0:!l&&s>=3&&b!=t&&b!=r&&(d=0),u=t.ys+staff_tb[o].y,void 0==d&&(d=(r.ys+staff_tb[r.st].y-u)/(r.xs-t.xs)),0!=d&&(d=d>0?BEAM_SLOPE*d/(BEAM_SLOPE+d):BEAM_SLOPE*d/(BEAM_SLOPE-d)),_=u-d*t.xs,v=0,n=t,l)p=.5*((t.grace?3.5:BEAM_SHIFT)*(a-1)+BEAM_DEPTH),t.stem!=r.stem&&t.nflags<r.nflags?p*=r.stem:p*=t.stem,_+=p;else if(t.grace)for(;p=d*n.xs+_-staff_tb[n.st].y,m=GSTEM-2,n.stem>0?m-=p-3*(n.notes[n.nhd].pit-18):m+=p-3*(n.notes[0].pit-18),(m+=3*(n.nflags-1))>v&&(v=m),n!=r;n=n.next);else{for(var E=BEAM_DEPTH+BEAM_SHIFT*(a-1);n.ts_prev&&n.ts_prev.type==NOTE&&n.ts_prev.time==n.time&&n.ts_prev.x>t.xs;)n=n.ts_prev;for(;n&&n.time<=r.time;n=n.ts_next)if(!(n.type!=NOTE||n.invis||n.st!=o&&n.v!=i)){if(p=d*(f=n.v==i?n.xs:n.x)+_-staff_tb[n.st].y,n.v==i)m=min_tb[0==n.nhd?0:1][n.nflags],n.stem>0?(n.notes[n.nhd].pit>26&&(m-=2,n.notes[n.nhd].pit>28&&(m-=2)),m-=p-3*(n.notes[n.nhd].pit-18)):(n.notes[0].pit<18&&(m-=2,n.notes[0].pit<16&&(m-=2)),m-=3*(n.notes[0].pit-18)-p),m+=BEAM_DEPTH+BEAM_SHIFT*(n.nflags-1);else{if(t.stem>0)if(n.stem>0){if(n.ymn>p+4||n.ymx<p-E-2)continue;m=n.v>i?n.ymx-p:n.ymn+8-p}else m=n.ymx-p;else if(n.stem<0){if(n.ymx<p-4||n.ymn>p-E-2)continue;m=n.v<i?p-n.ymn:p-n.ymx+8}else m=p-n.ymn;m+=2+E}m>v&&(v=m)}}if(v>0&&(_+=t.stem*v),!c&&!l)for(n=t.next;;n=n.next){var A;switch(n.type){case REST:if(!(A=n.ts_next)||A.st!=o||A.type!=NOTE&&A.type!=REST)break;case BAR:if(n.invis)break;case CLEF:u=d*n.x+_,t.stem>0?(u=n.ymx-u+BEAM_DEPTH+BEAM_SHIFT*(a-1)+2)>0&&(_+=u):(u=n.ymn-u-BEAM_DEPTH-BEAM_SHIFT*(a-1)-2)<0&&(_+=u);break;case GRACE:for(A=n.extra;A;A=A.next)u=d*A.x+_,t.stem>0?(u=A.ymx-u+BEAM_DEPTH+BEAM_SHIFT*(a-1)+2)>0&&(_+=u):(u=A.ymn-u-BEAM_DEPTH-BEAM_SHIFT*(a-1)-2)<0&&(_+=u)}if(n==r)break}for(0==d&&(_+=b_pos(t.grace,t.stem,a,_-staff_tb[o].y)),n=t;;n=n.next){switch(n.type){case NOTE:n.ys=d*n.xs+_-staff_tb[n.st].y,n.stem>0?(n.ymx=n.ys+2.5,n.ts_prev&&n.ts_prev.stem>0&&n.ts_prev.st==n.st&&n.ts_prev.ymn<n.ymx&&n.ts_prev.x==n.x&&0==n.notes[0].shhd&&(n.ts_prev.x-=5,n.ts_prev.xs-=5)):n.ymn=n.ys-2.5;break;case REST:if(u=d*n.x+_-staff_tb[n.st].y,w=BEAM_DEPTH+BEAM_SHIFT*(a-1)+(n.head!=FULL?4:9),t.stem>0){if(u-=w,0==t.multi&&u>12&&(u=12),n.y<=u)break}else if(u+=w,0==t.multi&&u<12&&(u=12),n.y>=u)break;n.head!=FULL&&(u=6*((u+3+12)/6|0)-12),n.y=u}if(n==r)break}return 0!=staff_tb[o].y&&(e.s1=t,e.a=d,e.b=_,e.nflags=a,!0)}function draw_beams(e){var t,n,r,s,a,o,i,c,l,f,u,p,d=e.s1,_=e.s2;function m(e,t,n,r,s,a){var o,i,c=s.s1,l=c.nflags;c.ntrem&&(l-=c.ntrem),c.trem2&&a>l&&(c.dur>=BASE_LEN/2?(e=c.x+6,t=s.s2.x-6):c.dur<BASE_LEN/4&&(e+=5,t-=6)),o=s.a*e+s.b-n,t-=e,t/=stv_g.scale,i=s.a*t*stv_g.scale,xypath(e,o,!0),output.push("l"+t.toFixed(2)+" "+(-i).toFixed(2)+"v"+r.toFixed(2)+"l"+(-t).toFixed(2)+" "+i.toFixed(2)+'"/>\n')}for(anno_start(d,"beam"),d.grace?(a=3.5,o=3.2,s=.29,i=1.8):(a=BEAM_SHIFT,o=BEAM_STUB,s=.34,i=BEAM_DEPTH),r=d.stem,d.stem!=_.stem&&d.nflags<_.nflags&&(r=_.stem),r<0&&(i=-i),m(d.xs-s,_.xs+s,0,i,e,1),c=0,t=d;t.type==NOTE&&t.stem!=r&&(t.ys=e.a*t.xs+e.b-staff_tb[t.st].y+a*(t.nflags-1)*t.stem-i),t!=_;t=t.next);for(d.feathered_beam&&(c=a/(_.xs-d.xs),a=d.feathered_beam>0?(c=-c)*d.xs:c*_.xs,c*=r),s=0,n=2;n<=e.nflags;n++)for(s+=a,0!=c&&(e.a+=c),t=d;;t=t.next)if(t.type!=NOTE||t.nflags<n){if(t==_)break}else if(t.trem1&&n>t.nflags-t.ntrem){if(m((p=t.dur>=BASE_LEN/2?t.x:t.xs)-5,p+5,(s+2.5)*r,i,e,n),t==_)break}else{for(f=t;t!=_;){if((l=t.next).type==NOTE||l.type==REST)if(l.trem1){if(l.nflags-l.ntrem<n)break}else if(l.nflags<n)break;if(l.beam_br1||l.beam_br2&&n>2)break;t=l}for(u=t;u.type!=NOTE;)u=u.prev;if(p=f.xs,f==u)if(f==d)p+=o;else if(f==_)p-=o;else if(f.beam_br1||f.beam_br2&&n>2)p+=o;else{for(l=f.next;l.type!=NOTE;)l=l.next;if(l.beam_br1||l.beam_br2&&n>2)p-=o;else{for(f=f.prev;f.type!=NOTE;)f=f.prev;f.nflags<l.nflags||f.nflags==l.nflags&&f.dots<l.dots?p+=o:p-=o}}if(m(p,u.xs,s*r,i,e,n),t==_)break}d.tmp?unlksym(d):_.tmp&&unlksym(_),anno_stop(d,"beam")}function draw_lstaff(e){var t,n,r,s,a=cur_sy.nstaff,o=0;function i(e,t,n){for(var r,s,a,o;!cur_sy.st_print[t];){if(cur_sy.staves[t].flags&n)return;t++}for(r=s=t;cur_sy.st_print[r]&&(s=r),!(cur_sy.staves[r].flags&n);)r++;a=staff_tb[t].y+staff_tb[t].topbar*staff_tb[t].staffscale,o=staff_tb[s].y+staff_tb[s].botbar*staff_tb[s].staffscale,n&(CLOSE_BRACE|CLOSE_BRACE2)?out_brace(e,o,a-o):out_bracket(e,a,a-o)}for(t=0;(cur_sy.staves[t].flags&(OPEN_BRACE|OPEN_BRACKET)&&o++,!cur_sy.st_print[t])&&(cur_sy.staves[t].flags&(CLOSE_BRACE|CLOSE_BRACKET)&&o--,t!=a);t++);for(n=a;n>t&&!cur_sy.st_print[n];n--);if(t!=n||0!=o)for(r=staff_tb[n].y+staff_tb[n].botbar*staff_tb[n].staffscale,s=staff_tb[t].y+staff_tb[t].topbar*staff_tb[t].staffscale-r,xypath(e,r),output.push("v"+(-s).toFixed(2)+'"/>\n'),t=0;t<=a;t++)cur_sy.staves[t].flags&OPEN_BRACE&&i(e,t,CLOSE_BRACE),cur_sy.staves[t].flags&OPEN_BRACKET&&i(e,t,CLOSE_BRACKET),cur_sy.staves[t].flags&OPEN_BRACE2&&i(e-6,t,CLOSE_BRACE2),cur_sy.staves[t].flags&OPEN_BRACKET2&&i(e-6,t,CLOSE_BRACKET2)}function draw_meter(e,t){if(t.a_meter){var n,r,s=t.st,a=staff_tb[s],o=a.y;if("|||||"!=a.stafflines){for(r=0;r<a.stafflines.length&&!a.stafflines[r].match(/[\[|]/);r++);r==a.stafflines.length&&r--,o+=3*(r+a.stafflines.length)-15}for(e-=t.wl,r=0;r<t.a_meter.length;r++){var i,c=t.a_meter[r];if(n="C|"==c.top?13:13*c.top.length,c.bot)c.bot.length>c.top.length&&(n=13*c.bot.length),out_XYAB('<g style="font-family:serif; font-weight:bold; font-size: 16px"\n\ttransform="translate(X,Y) scale(1.2,1)">\n\t<text y="-12" text-anchor="middle">A</text>\n\t<text text-anchor="middle">B</text>\n</g>\n',e+.5*n,o,c.top,c.bot);else switch(c.top[0]){case"C":i="|"!=c.top[1]?"csig":"ctsig",e-=5,o+=12;break;case"c":i="."!=c.top[1]?"imsig":"iMsig";break;case"o":i="."!=c.top[1]?"pmsig":"pMsig";break;default:out_XYAB('<g style="font-family:serif; font-weight:bold; font-size: 18px"\n\ttransform="translate(X,Y) scale(1.2,1)">\n\t<text y="-6" text-anchor="middle">A</text>\n</g>\n',e+.5*n,o,c.top)}i&&xygl(e+.5*n,o,i),e+=n}}}function draw_acc(e,t,n,r,s){if(r)if(r==s)n=-1==n?-2:2;else if(2*r!=s)return void xygl(e,t,"acc"+n+"_"+r+"_"+s);xygl(e,t,"acc"+n)}function draw_hl(e,t,n,r,s){var a=staff_tb[r],o=a.y,i=6*(a.stafflines.length-1);for(t=6*Math.ceil(t/6);t<a.botline;t+=6)xygl(e,o+t,s);for(n-=n%6;n>i;n-=6)xygl(e,o+n,s)}var sharp_cl=new Int8Array([24,9,15,21,6,12,18]),flat_cl=new Int8Array([12,18,24,9,15,21,6]),sharp1=new Int8Array([-9,12,-9,-9,12,-9]),sharp2=new Int8Array([12,-9,12,-9,12,-9]),flat1=new Int8Array([9,-12,9,-12,9,-12]),flat2=new Int8Array([-12,9,-12,9,-12,9]);function draw_keysig(e,t,n){if(!n.k_none){var r,s,a,o=n.k_old_sf,i=e.st,c=staff_tb[i].y,l=n.k_y_clef;for(1&l&&(l+=7),l/=2;l<0;)l+=7;if(l%=7,n.k_a_acc){if(n.k_a_acc.length){var f,u=n.k_a_acc[0].acc,p=100;for(r=0;r<n.k_a_acc.length;r++)f=n.k_a_acc[r],s=3*(n.k_y_clef+f.pit-18),0!=r&&(s>p+18||s<p-18)?t-=5.5:f.acc!=u&&(t+=3),u=f.acc,draw_hl(t,s,s,i,"hl"),p=s,draw_acc(t,c+s,f.acc,f.micro_n,f.micro_d),t+=5.5}}else{if((cfmt.cancelkey||0==n.k_sf)&&(0==n.k_sf||o*n.k_sf<0)){for(a=(s=sharp_cl[l])>9?sharp1:sharp2,r=0;r<o;r++)xygl(t,c+s,"acc3"),s+=a[r],t+=5.5;for(a=(s=flat_cl[l])<18?flat1:flat2,r=0;r>o;r--)xygl(t,c+s,"acc3"),s+=a[-r],t+=5.5;0!=n.k_sf&&(t+=3)}if(n.k_sf>0){for(a=(s=sharp_cl[l])>9?sharp1:sharp2,r=0;r<n.k_sf;r++)xygl(t,c+s,"acc1"),s+=a[r],t+=5.5;if(cfmt.cancelkey&&r<o)for(t+=2;r<o;r++)xygl(t,c+s,"acc3"),s+=a[r],t+=5.5}if(n.k_sf<0){for(a=(s=flat_cl[l])<18?flat1:flat2,r=0;r>n.k_sf;r--)xygl(t,c+s,"acc-1"),s+=a[-r],t+=5.5;if(cfmt.cancelkey&&r>o)for(t+=2;r>o;r--)xygl(t,c+s,"acc3"),s+=a[-r],t+=5.5}}}}function bar_cnv(e){switch(e){case"[":case"[]":return"";case"|:":case"|::":case"|:::":return"["+e;case":|":case"::|":case":::|":return e+"]";case"::":return cfmt.dblrepbar;case"||:":return"[|:"}return e}function draw_bar(e,t,n){var r,s,a,o,i=e.st,c=e.x;if(o=bar_cnv(e.bar_type)){if(0!=i&&e.ts_prev&&e.ts_prev.type!=BAR&&(n=staff_tb[i].topbar*staff_tb[i].staffscale),e.ymx=e.ymn+n,set_sscale(-1),anno_start(e),e.bar_mrep)if(a=staff_tb[i].y+12,set_sscale(i),1==e.bar_mrep){for(s=e.prev;s.type!=REST;s=s.prev);xygl(s.x,a,"mrep")}else xygl(c,a,"mrep2"),e.v==cur_sy.top_voice&&(set_font("annotation"),xy_str(c,a+staff_tb[i].topbar-9,e.bar_mrep.toString(),"c"));for(r=o.length;--r>=0;){switch(o[r]){case"|":set_sscale(-1),out_bar(c,t,n,e.bar_dotted);break;default:c-=3,set_sscale(-1),out_thbar(c,t,n);break;case":":c-=2,set_sscale(i),xygl(c+1,staff_tb[i].y,"rdots")}c-=3}set_sscale(-1),anno_stop(e)}}var rest_tb=["r128","r64","r32","r16","r8","r4","r2","r1","r0","r00"];function draw_rest(e){var t,n,r,s,a,o,i=staff_tb[e.st];if(i.topbar){if(e.dur==e.p_v.meter.wmeasure||e.rep_nb&&e.rep_nb>=0){for(t=e.ts_next;t&&t.time!=e.time+e.dur;)t=t.ts_next;for(s=t?t.x:realwidth,t=e;!t.seqst;)t=t.ts_prev;s=(s+(t=t.ts_prev).x)/2,e.a_dd&&deco_update(e,s-e.x),e.x=s}else s=e.x,e.notes[0].shhd&&(s+=e.notes[0].shhd*stv_g.scale);if(!e.invis){if(o=i.y,e.rep_nb)return set_sscale(e.st),anno_start(e),o+=12,e.rep_nb<0?xygl(s,o,"srep"):(xygl(s,o,"mrep"),e.rep_nb>2&&e.v==cur_sy.top_voice&&(set_font("annotation"),xy_str(s,o+i.topbar-9,e.rep_nb.toString(),"c"))),void anno_stop(e);if(set_scale(e),anno_start(e),a=e.y,7==(n=5-e.nflags)&&12==a&&i.stafflines.length<=2&&(a-=6),xygl(s,a+o,e.notes[0].head?e.notes[0].head:rest_tb[n]),n>=6){switch(r=a/6,n){default:switch(i.stafflines[r+1]){case"|":case"[":break;default:xygl(s,a+6+o,"hl1")}9==n&&(a-=6,r--);break;case 7:a+=6,r++;case 6:}switch(i.stafflines[r]){case"|":case"[":break;default:xygl(s,a+o,"hl1")}}for(s+=8,a+=o+3,n=0;n<e.dots;n++)xygl(s,a,"dot"),s+=3.5;anno_stop(e)}}}function draw_gracenotes(e){var t,n,r,s,a,o,i,c,l,f,u,p,d,_,m,v,y={};for(_=e.extra;_&&(_.beam_st&&!_.beam_end&&calculate_beam(y,_)&&draw_beams(y),anno_start(_),draw_note(_,!y.s2),_==y.s2&&(y.s2=null),anno_stop(_),_.next);_=_.next);if(e.sappo&&((_=e.extra).next?(s=.5*(_.next.x-_.x)+4,a=.5*(_.ys+_.next.ys)-_.y,_.stem>0?a-=1:a+=1):(s=9,a=_.stem>0?5:-5),out_acciac(x_head(_,v=_.notes[_.stem<0?0:_.nhd]),y_head(_,v),s,a,_.stem>0)),!e.p_v.key.k_bagpipe&&cfmt.graceslurs&&!e.slur_start&&e.next&&e.next.type==NOTE){if((m=_).stem>=0){for(t=127,_=e.extra;_;_=_.next)_.y<t&&(t=_.y,m=_);n=m.x,r=m.y-5,e.extra!=m&&(n-=4,r+=1),c=(e=e.next).x-1,e.stem<0&&(c-=4),l=3*(e.notes[0].pit-18)-5,(p=.4*(c-n))>3&&(p=3),d=p,f=.2,u=.8,r>l+7?(n=m.x-1,r+=.5,l+=6.5,c=e.x-5.5,p=.8*(r-l),d=.2*(r-l),f=0):l>r+4&&(l=r+4,n=m.x+2,r=m.y-4)}else{for(t=-127,_=e.extra;_;_=_.next)_.y>t&&(t=_.y,m=_);n=m.x,r=m.y+5,e.extra!=m&&(n-=4,r-=1),c=(e=e.next).x-1,e.stem>=0&&(c-=2),l=3*(e.notes[e.nhd].pit-18)+5,(p=.4*(n-c))<-3&&(p=-3),d=p,f=.2,u=.8,r<l-7?(n=m.x-1,r-=.5,l-=6.5,c=e.x-5.5,p=.8*(r-l),d=.2*(r-l),f=0):l<r-4&&(l=r-4,n=m.x+2,r=m.y+4)}s=f*c+(1-f)*n-n,a=f*l+(1-f)*r-p-r,o=u*c+(1-u)*n-n,i=u*l+(1-u)*r-d-r,anno_start(e,"slur"),xypath(n,r+staff_tb[e.st].y),output.push("c"+s.toFixed(2)+" "+(-a).toFixed(2)+" "+o.toFixed(2)+" "+(-i).toFixed(2)+" "+(c-n).toFixed(2)+" "+(-l+r).toFixed(2)+'"/>\n'),anno_stop(e,"slur")}}function setdoty(e,t){var n,r,s;for(n=0;n<=e.nhd;n++)(s=3*(e.notes[n].pit-18))%6==0&&(e.dot_low?s-=3:s+=3),t[n]=s;for(n=0;n<e.nhd;n++)if(!(t[n+1]>t[n])){for(r=n;r>0&&!(t[r]>t[r-1]+6);)r--;if(3*(e.notes[r].pit-18)-t[r]<t[n+1]-3*(e.notes[n+1].pit-18))for(;r<=n;)t[r++]-=6;else t[n+1]=t[n]+6}}function x_head(e,t){return e.x+t.shhd}function y_head(e,t){return staff_tb[e.st].y+3*(t.pit-18)}function draw_basic_note(e,t,n,r){var s,a,o,i,c,l=!1,f=t.notes[n],u=staff_tb[t.st].y,p=3*(f.pit-18),d=f.shhd*stv_g.scale,_=e+d,m=p+u,v=identify_note(t,f.dur),y=v[0],h=v[1];v[2];if(p%6==0&&d!=(t.stem>0?t.notes[0].shhd:t.notes[t.nhd].shhd)&&(o=0,p>=30?(o=p)%6&&(o-=3):p<=-6&&(o=p)%6&&(o+=3),o&&xygl(_,o+u,"hl")),f.invis);else if(t.grace)a="ghd",_-=4.5*stv_g.scale;else if(f.map&&f.map[0])s=t.head,(a=f.map[0][s])||(a=f.map[0][f.map[0].length-1]),(s=a.indexOf("/"))>=0&&(a=t.stem>=0?a.slice(0,s):a.slice(s+1));else if(t.type==CUSTOS)a="custos";else switch(y){case OVAL:a="HD";break;case OVALBARS:if(t.head!=SQUARE){a="HDD";break}case SQUARE:a=f.dur<4*BASE_LEN?"breve":"longa",tsnext||!t.next||t.next.type!=BAR||t.next.next||(h=0);break;case EMPTY:a="Hd";break;default:a="hd"}if(f.color?l=set_color(f.color):f.map&&f.map[2]&&(l=set_color(f.map[2])),a&&(psxygl(_,m,a)||xygl(_,m,a)),h)for(i=e+(7.7+t.xmx)*stv_g.scale,void 0==r[n]&&(r[n]=3*(t.notes[n].pit-18),0==(1&t.notes[n].pit)&&(r[n]+=3)),c=r[n]+u;--h>=0;)xygl(i,c,"dot"),i+=3.5;f.acc&&(e-=f.shac*stv_g.scale,t.grace?(g_open(e,p+u,0,.75),draw_acc(0,0,f.acc,f.micro_n,f.micro_d),g_close()):draw_acc(e,p+u,f.acc,f.micro_n,f.micro_d)),0!=l&&set_color(l)}function draw_note(e,t){var n,r,s,a,o,i,c,l,f,u=new Array(e.nhd+1);if(e.dots&&setdoty(e,u),c=x_head(e,f=e.notes[e.stem<0?e.nhd:0]),s=staff_tb[e.st].y,e.grace)o="ghl";else switch(e.head){default:o="hl";break;case OVAL:case OVALBARS:o="hl1";break;case SQUARE:o="hl2"}if(draw_hl(c,3*(e.notes[0].pit-18),3*(e.notes[e.nhd].pit-18),e.st,o),l=y_head(e,f),e.stemless?e.xstem&&(a=((n=e.ts_prev).stem>0?n.y:n.ys)-e.y,a+=staff_tb[n.st].y-s,out_stem(c,l,a/=e.p_v.scale)):(a=e.ys-e.y,i=e.nflags,e.ntrem&&(i-=e.ntrem),!t||i<=0?(e.nflags>0&&(e.stem>=0?a-=1:a+=1),out_stem(c,l,a,e.grace)):out_stem(c,l,a,e.grace,i,cfmt.straightflags)),t&&e.trem1){var p=e.ntrem||0,d=c;a=3*(e.notes[e.stem>0?e.nhd:0].pit-18),e.head==FULL||e.head==EMPTY?(d+=(e.grace?GSTEM_XOFF:3.5)*e.stem,e.stem>0?a+=6+5.4*p:a-=11.4):e.stem>0?a+=5+5.4*p:a-=10.4,out_trem(d,s+(a/=e.p_v.scale),p)}for(c=e.x,r=0;r<=e.nhd;r++)draw_basic_note(c,e,r,u)}function next_scut(e){var t=e;for(e=e.next;e;e=e.next){if(e.rbstop)return e;t=e}return t}function prev_scut(e){for(;e.prev;)if((e=e.prev).rbstart)return e;for(e=e.p_v.sym;e.type!=CLEF;)e=e.ts_prev;return e.next&&e.next.type==KEY&&(e=e.next),e.next&&e.next.type==METER?e.next:e}function slur_direction(e,t){var n,r,s;if(e.grace&&e.stem>0)return-1;for(n=e;;n=n.next){if(n.type==NOTE){if(!n.stemless){if(n.stem<0)return 1;r=!0}n.notes[0].pit<22&&(s=!0)}if(n==t)break}return r||s?-1:1}function slur_out(e,t,n,r,s,a,o){var i,c,l,f=.3;(c=r-t)<0&&(c=-c),(i=n-e)>40&&c/i<.7&&(f=.3+.002*(i-40))>.7&&(f=.7);var u=.5*(e+n),p=.5*(t+r),d=u+f*(e-u),_=p+f*(t-p)+a;d=e+.45*(d-e),_=t+.45*(_-t);var m=u+f*(n-u),v=p+f*(r-p)+a;m=n+.45*(m-n),v=r+.45*(v-r),i=.03*(n-e),c=2*s,(l=.2+.001*(n-e))>.6&&(l=.6),l*=s;var y=stv_g.v?stv_g.scale:1;o?output.push('<path class="stroke" stroke-dasharray="5,5" d="M'):output.push('<path class="fill" d="M'),out_sxsy(e," ",t),output.push("c"+((d-e)/stv_g.scale).toFixed(2)+" "+((t-_)/y).toFixed(2)+" "+((m-e)/stv_g.scale).toFixed(2)+" "+((t-v)/y).toFixed(2)+" "+((n-e)/stv_g.scale).toFixed(2)+" "+((t-r)/y).toFixed(2)),o||output.push("\n\tv"+(-l).toFixed(2)+"c"+((m-i-n)/stv_g.scale).toFixed(2)+" "+((r+l-v-c)/y).toFixed(2)+" "+((d+i-n)/stv_g.scale).toFixed(2)+" "+((r+l-_-c)/y).toFixed(2)+" "+((e-n)/stv_g.scale).toFixed(2)+" "+((r+l-t)/y).toFixed(2)),output.push('"/>\n')}function slur_multi(e,t){for(;;){if(e.multi)return e.multi;if(e==t)break;e=e.next}return 0}function draw_slur(e,t,n,r,s){for(var a,o,i,c,l,f,u,p,d,_,m,v,y,h,b,g=e;g.v!=t.v;)g=g.ts_next;switch(7&s){case SL_ABOVE:b=1;break;case SL_BELOW:b=-1;break;default:(b=slur_multi(g,t))||(b=slur_direction(g,t))}var x=1,k=g.st,w=!1;if(g!=t)for(a=g.next;a.type!=NOTE&&a.type!=REST||(x++,a.st!=k&&(w=!0,a.st<k&&(k=a.st))),a!=t;)a=a.next;if(w&&error(2,g,"*** multi-staves slurs not treated yet"),i=e.x,e.notes&&e.notes[0].shhd&&(i+=e.notes[0].shhd),e!=t)l=t.x,t.notes&&(l+=t.notes[0].shhd);else{for(a=t.ts_next;a&&a.type!=STAVES;a=a.ts_next);l=a?a.x:realwidth}if(n>=0?c=3*(g.notes[n].pit-18)+5*b:(c=b>0?g.ymx+2:g.ymn-2,g.type==NOTE&&(b>0?g.stem>0&&(i+=5,g.beam_end&&g.nflags>=-1&&!g.in_tuplet&&(g.nflags>0?(i+=2,c=g.ys-3):c=g.ys-6)):g.stem<0&&(i-=1,t.grace?c=g.y-8:g.beam_end&&g.nflags>=-1&&(!g.in_tuplet||g.ys<c+3)&&(g.nflags>0?(i+=2,c=g.ys+3):c=g.ys+6)))),r>=0?f=3*(t.notes[r].pit-18)+5*b:(f=b>0?t.ymx+2:t.ymn-2,t.type==NOTE&&(b>0?t.stem>0&&(l+=1,t.beam_st&&t.nflags>=-1&&!t.in_tuplet&&(f=t.ys-6)):t.stem<0&&(l-=5,t.beam_st&&t.nflags>=-1&&!t.in_tuplet&&(f=t.ys+6)))),g.type!=NOTE&&(c=f+1.2*b,(i=g.x+.5*g.wr)>l-12&&(i=l-12)),t.type!=NOTE&&(f=g.type==NOTE?c+1.2*b:c,g!=t&&(l=t.x-.3*t.wl)),x>=3&&(g.next.type!=BAR&&g.next.x<i+48&&(b>0?c<(_=g.next.ymx-2)&&(c=_):c>(_=g.next.ymn+2)&&(c=_)),t.prev&&t.prev.type!=BAR&&t.prev.x>l-48&&(b>0?f<(_=t.prev.ymx-2)&&(f=_):f>(_=t.prev.ymn+2)&&(f=_))),((d=(f-c)/(l-i))>SLUR_SLOPE||d<-SLUR_SLOPE)&&((d=d>SLUR_SLOPE?SLUR_SLOPE:-SLUR_SLOPE)*b>0?c=f-d*(l-i):f=c+d*(l-i)),(_=f-c)>8?_=8:_<-8&&(_=-8),(m=_)<0&&(m=-m),y=.5*m,h=.3*_,_*b>0?(l-=y,f-=h):(i+=y,c+=h),g.grace&&(i=g.x-.5*GSTEM_XOFF),t.grace&&(l=t.x+1.5*GSTEM_XOFF),v=0,d=(f-c)/(l-i),g!=t&&g.v==t.v){for(p=c-d*i,a=g.next;a!=t;a=a.next)if(a.st==k)switch(a.type){case NOTE:case REST:b>0?((_=3*(a.notes[a.nhd].pit-18)+6)<a.ymx&&(_=a.ymx),(_-=d*a.x+p)>v&&(v=_)):((_=3*(a.notes[0].pit-18)-6)>a.ymn&&(_=a.ymn),(_-=d*a.x+p)<v&&(v=_));break;case GRACE:for(o=a.extra;o;o=o.next)b>0?((_=3*(o.notes[o.nhd].pit-18)+6)<o.ymx&&(_=o.ymx),(_-=d*o.x+p)>v&&(v=_)):((_=3*(o.notes[0].pit-18)-6)>o.ymn&&(_=o.ymn),(_-=d*o.x+p)<v&&(v=_))}c+=.45*v,f+=.45*v,v*=.65}if(u=x>3?(.08*(l-i)+12)*b:(.03*(l-i)+8)*b,b>0?(u<3*v&&(u=3*v),u>40&&(u=40)):(u>3*v&&(u=3*v),u<-40&&(u=-40)),(_=f-c)<0&&(_=-_),b>0?u<.8*_&&(u=.8*_):u>-.8*_&&(u=-.8*_),slur_out(i,c,l,f,b,u*=cfmt.slurheight,s&SL_DOTTED),p=c-(d=(f-c)/(y=l-i))*i+.4*u,g.v==t.v)for(a=g;a!=t;a=a.next)a.st==k&&(_=d*a.x+p,a.ymx<_?a.ymx=_:a.ymn>_&&(a.ymn=_),a.next==t?(y=l,t.sl1&&(y-=5)):y=a.next.x,a!=g&&(i=a.x),y_set(k,b>0,i,y-=i,_));return(b>0?SL_ABOVE:SL_BELOW)|s&SL_DOTTED}function draw_slurs(e,t){for(var n,r,s,a,o,i,c,l,f=e;;){if(!f||f==t){if(!s||!(f=s.next)||f==t)break;s=null}if(f.type!=GRACE)if(f.type!=NOTE&&f.type!=REST&&f.type!=SPACE||!f.slur_start&&!f.sl1)f=f.next;else{r=null,n=f.next;for(var u=!1;;)if(n)if(n.type!=GRACE){if(n.type==BAR&&(":"==n.bar_type[0]||"|]"==n.bar_type||"[|"==n.bar_type||n.text&&"1"!=n.text[0])){r=n;break}if(n.type==NOTE||n.type==REST||n.type==SPACE){if(n.slur_end||n.sl2){r=n;break}if(n.slur_start||n.sl1){if(a){for(r=n;r.next;r=r.next);r.next=a.next,a.next&&(a.next.prev=r),r=null}draw_slurs(n,t),a&&a.next&&(a.next.prev.next=null,a.next.prev=a)}if(n==t)break;n=n.next}else n=n.next}else a=n,n=n.extra;else{if(a){n=a.next,a=null;continue}if(!s||u)break;n=s.next,u=!0}if(n){if(!r){if((f=n)==t)break;continue}}else r=next_scut(f);if(s){for(n=f;n.next;n=n.next);n.next=s.next,s.next&&(s.next.prev=n),s.slur_start=SL_AUTO}if(a&&(a.prev.next=a.extra,a.extra.prev=a.prev,a.slur_start=SL_AUTO),f.slur_start)c=15&f.slur_start,f.slur_start>>=4,o=-1;else{for(o=0;o<=f.nhd&&!f.notes[o].sl1;o++);c=15&f.notes[o].sl1,f.notes[o].sl1>>=4,f.sl1--}if(i=-1,l=0,r.type!=NOTE&&r.type!=REST&&r.type!=SPACE||!r.slur_end&&!r.sl2)r.type==BAR&&(":"==r.bar_type[0]||"|]"==r.bar_type||"[|"==r.bar_type||r.text&&"1"!=r.text[0])||(l=1);else if(r.slur_end)r.slur_end--;else{for(i=0;i<=r.nhd&&!r.notes[i].sl2;i++);r.notes[i].sl2--,r.sl2--}if(c=draw_slur(f,r,o,i,c),l&&(r.p_v.slur_start||(r.p_v.slur_start=0),r.p_v.slur_start<<=4,r.p_v.slur_start+=c),s&&s.next&&(s.next.prev.next=null,s.next.prev=s),a&&(a.prev.next=a,a.extra.prev=null),!f.slur_start&&!f.sl1){if(f==t)break;f=f.next}}else s=f,f=f.extra}}function draw_tuplet(e,t){var n,r,s,a,o,i,c,l,f,u,p,d,_,m,v,y,h,b,g,x,k,w;for(a=e.st,n=e;n;n=n.next)if(n.type==NOTE||n.type==REST){if((n.slur_start||n.slur_end||n.sl1||n.sl2)&&(i=!0),n.st<a&&(a=n.st),0==t){if(n.tp1&&draw_tuplet(n,1),n.te0)break}else if(n.te1)break}else if(n.type==GRACE)for(s=n.extra;s;s=s.next)(s.slur_start||s.sl1)&&(i=!0);if(!n)return error(1,e,"No end of tuplet in this music line"),void(0==t?e.tp0=0:e.tp1=0);if(i){if(draw_slurs(e,n),e.slur_start||e.sl1)return;for(r=e.next;r!=n;r=r.next)if(r.slur_start||r.slur_end||r.sl1||r.sl2)return;if(n.slur_end||n.sl2)return}if(0==t?(x=e.tp0,e.tp0=0,k=e.tq0):(x=e.tp1,e.tp1=0,k=e.tq1),1!=e.tf[0]){if((g=e.tf[3])||(g=e.stem>0?SL_ABOVE:SL_BELOW),e==n)o=!0;else if(1==e.tf[1])o=!0,draw_slur(e,n,-1,-1,g);else if(2==e.tf[0]||e.type!=NOTE||n.type!=NOTE)o=!1;else{for(o=!0,r=e;;r=r.next){if(r.type!=NOTE&&r.type!=REST){if(r.type==GRACE||r.type==SPACE)continue;o=!1;break}if(r==n)break;if(r.beam_end){o=!1;break}}if(o&&!e.beam_st&&!e.beam_br1&&!e.beam_br2)for(r=e.prev;r;r=r.prev)if(r.type==NOTE||r.type==REST){r.nflags>=e.nflags&&(o=!1);break}if(o&&!n.beam_end)for(r=n.next;r;r=r.next)if(r.type==NOTE||r.type==REST){!r.beam_br1&&!r.beam_br2&&r.nflags>=n.nflags&&(o=!1);break}}if(o){if(1==e.tf[2])return;for(p=(n.x+e.x)/2,m=(h=e==n?0:(n.ys-e.ys)/(n.x-e.x))*p+(b=e.ys-h*e.x),g==SL_ABOVE?((d=y_get(a,1,p-4,8))>m&&(b+=d-m),b+=2):((d=y_get(a,0,p-4,8))<m&&(b+=d-m),b-=10),r=e;!(r.x>=p);r=r.next);return e.stem*n.stem>0&&(e.stem>0?p+=1.5:p-=1.5),d=h*p+b,0==e.tf[2]?out_bnum(p,d,x):out_bnum(p,d,x+":"+k),void(g==SL_ABOVE?(d+=10,r.ymx<d&&(r.ymx=d),y_set(a,!0,p-3,6,d)):(r.ymn>d&&(r.ymn=d),y_set(a,!1,p-3,6,d)))}if(0!=e.tf[1]&&error(2,e,"'what' value of %%tuplets not yet coded"),(g=e.tf[3])||(g=e.multi>=0?SL_ABOVE:SL_BELOW),g==SL_ABOVE){if(e.st==n.st?f=u=staff_tb[a].topbar+4:(f=e.ymx,u=n.ymx),c=e.x-4,e.st==a){for(r=e;!r.dur;r=r.next);(d=y_get(a,1,r.x-4,8))>f&&(f=d),e.stem>0&&(c+=3)}if(n.st==a){for(r=n;!r.dur;r=r.prev);(d=y_get(a,1,r.x-4,8))>u&&(u=d)}for(n.dur>n.prev.dur?l=n.next?n.next.x-n.next.wl-5:realwidth-6:(l=n.x+4,w=n.stem>=0?0:n.nhd,n.notes[w].shhd>0&&(l+=n.notes[w].shhd),n.st==a&&n.stem>0&&(l+=3.5)),p=.5*(c+l),d=.5*(f+u),h=(u-f)/(l-c),(_=3*(n.notes[n.nhd].pit-e.notes[e.nhd].pit)/(l-c))>0?h<0?h=0:h>_&&(h=_):h>0?h=0:h<_&&(h=_),h*h<.1*.1&&(h=0),y=0,r=e;;r=r.next)if(r.dur&&r.st==a){if(m=d+(r.x-p)*h,(v=y_get(a,1,r.x-4,8)+2)-m>y&&(y=v-m),r==n)break}else if(r==n)break;for(f=(d+=y)+h*(c-p),u=d+h*(l-p),d+=8,r=e;;r=r.next)if(r.st==a){if(m=d+(r.x-p)*h,r.ymx<m&&(r.ymx=m),r==n)break;y_set(a,!0,r.x,r.next.x-r.x,m)}else if(r==n)break}else{if(c=e.x-7,n.dur>n.prev.dur?l=n.next?n.next.x-n.next.wl-8:realwidth-6:(l=n.x+2,n.notes[n.nhd].shhd>0&&(l+=n.notes[n.nhd].shhd)),e.stem>=0&&(c+=2,l+=2),e.st==a){for(r=e;!r.dur;r=r.next);f=y_get(a,0,r.x-4,8)}else f=0;if(n.st==a){for(r=n;!r.dur;r=r.prev);u=y_get(a,0,r.x-4,8)}else u=0;for(p=.5*(c+l),d=.5*(f+u),h=(u-f)/(l-c),(_=3*(n.notes[0].pit-e.notes[0].pit)/(l-c))>0?h<0?h=0:h>_&&(h=_):h>0?h=0:h<_&&(h=_),h*h<.1*.1&&(h=0),y=0,r=e;;r=r.next)if(r.dur&&r.st==a){if(m=d+(r.x-p)*h,(v=y_get(a,0,r.x-4,8))-m<y&&(y=v-m),r==n)break}else if(r==n)break;for(f=(d+=y-10)+h*(c-p),u=d+h*(l-p),d-=2,r=e;;r=r.next){if(r.st==a){if(r==n)break;m=d+(r.x-p)*h,r.ymn>m&&(r.ymn=m),y_set(a,!1,r.x,r.next.x-r.x,m)}if(r==n)break}}1!=e.tf[2]?(out_tubrn(c,f,l-c,u-f,g==SL_ABOVE,0==e.tf[2]?x.toString():x+":"+k),m=.5*(f+u),g==SL_ABOVE?y_set(a,!0,p-3,6,m+9):y_set(a,!1,p-3,6,m)):out_tubr(c,f+4,l-c,u-f,g==SL_ABOVE)}}function draw_note_ties(e,t,n,r,s){var a,o,i,c,l,f,u,p,d,_,m,v,y,h;for(a=0;a<n.length;a++){switch(i=n[a],l=e.notes[i].pit,c=r[a],f=2!=s?t.notes[c].pit:l,o=(7&e.notes[i].ti1)==SL_ABOVE?1:-1,_=e.x,y=e.notes[i].shhd,o>0?i<e.nhd&&l+1==e.notes[i+1].pit&&e.notes[i+1].shhd>y&&(y=e.notes[i+1].shhd):i>0&&l==e.notes[i-1].pit+1&&e.notes[i-1].shhd>y&&(y=e.notes[i-1].shhd),_+=.6*y,m=t.x,2!=s&&(y=t.notes[c].shhd,o>0?c<t.nhd&&f+1==t.notes[c+1].pit&&t.notes[c+1].shhd<y&&(y=t.notes[c+1].shhd):c>0&&f==t.notes[c-1].pit+1&&t.notes[c-1].shhd<y&&(y=t.notes[c-1].shhd),m+=.6*y),p=e.st,s){case 0:l==f||1&l||(l=f);break;case 3:o=-o;case 1:(_=e.x)>m-20&&(_=m-20),l=f,p=t.st;break;default:if(e!=t)m-=t.wl,t.type==BAR&&(m+=5);else{for(h=e.time+e.dur,d=e.ts_next;d&&!(d.time>h);d=d.ts_next);m=d?d.x:realwidth}m<_+16&&(m=_+16)}m-_>20?(_+=3.5,m-=3.5):(_+=1.5,m-=1.5),u=3*(l-18),1!=s&&3!=s&&o>0&&(1&l||!e.dots||(u=3*(l-18)+6)),v=(.04*(m-_)+10)*o,slur_out(_,staff_tb[p].y+u,m,staff_tb[p].y+u,o,v,e.notes[i].ti1&SL_DOTTED)}}function draw_ties(e,t,n){var r,s,a,o,i,c,l=[],f=[],u=[],p=e.nhd,d=e.time+e.dur;if(2!=n){for(s=0;s<=p;s++)if(e.notes[s].ti1){for(c=-1,i=e.notes[s].apit,o=t.nhd;o>=0;o--){switch(t.notes[o].apit-i){case 1:case-1:e.notes[s].acc!=t.notes[o].acc&&(c=o);default:continue;case 0:c=o}break}c>=0?(l.push(s),f.push(c)):u.push(s)}if(draw_note_ties(e,t,l,f,n),u.length){for(r=e.ts_next;r&&r.time<d;)r=r.ts_next;for(;r&&r.time==d;)if(r.type==NOTE&&r.st==e.st){for(l.length=0,f.length=0,s=u.length;--s>=0;)for(a=u[s],i=e.notes[a].apit,o=r.nhd;o>=0;o--)if(r.notes[o].apit==i){l.push(a),f.push(o),u[s]=u.pop();break}if(l.length>0&&(draw_note_ties(e,r,l,f,1==n?1:0),0==u.length))return;r=r.ts_next}else r=r.ts_next;0!=u.length&&error(1,e,"Bad tie")}}else{for(s=0;s<=p;s++)e.notes[s].ti1&&u.push(s);draw_note_ties(e,t||e,u,u,n)}}function tie_comb(e){var t,n,r;for(n=e.time+e.dur,r=e.st,t=e.ts_next;t;t=t.ts_next)if(t.st==r)if(t.time!=n){if(t.time>n)return e}else if(t.type==NOTE)return t}function draw_all_ties(e){var t,n,r,s,a,o,i,c,l;function f(e,t,n){var r;if(e.type==GRACE)for(r=e.extra;r;r=r.next)r.ti1&&draw_ties(r,t,n);else draw_ties(e,t,n)}for(t=e.sym;t;t=t.next){switch(t.type){case CLEF:case KEY:case METER:continue}break}for(o=e.s_rtie,n=t;n&&(!n.dur&&n.type!=GRACE);n=n.next)n.type==BAR&&n.text&&("1"==n.text[0]?o=e.s_tie:e.s_tie=o);if(n){for(e.s_tie&&(e.s_tie.x=t.x+t.wr,t=e.s_tie,e.s_tie=null,t.st=n.st,t.ts_next=n.ts_next,t.time=n.time-t.dur,draw_ties(t,n,1));;){for(t=n;t&&!t.ti1;t=t.next)if(o&&t.type==BAR&&t.text)if("1"!=t.text[0]){if("|"!=t.bar_type){for(n=t.next;n&&n.type!=NOTE;n=n.next);if(!n){t=null;break}(i=clone(o)).x=t.x,i.next=n,i.st=n.st,i.time=n.time-i.dur,draw_ties(i,n,1)}}else o=null;if(!t)break;for(a=t.time+t.dur,n=t.next;n&&!n.dur;n=n.next)if(n.text){if("1"!=n.text[0])break;o=t}if(n){if(n.type!=NOTE&&n.type!=BAR){error(1,t,"Bad tie");continue}if(n.time!=a){if((r=tie_comb(t))==t){error(1,t,"Bad tie");continue}n=r}}else{for(n=t.ts_next;n;n=n.ts_next)if(n.st==t.st&&!(n.time<a)){if(n.time>a){n=null;break}if(n.dur)break}if(!n){f(t,null,2),e.s_tie=t;break}}for(r=t.ts_next;r;r=r.ts_next)if(r.st==t.st){if(r.time>a)break;r.type!=CLEF||(s=!0)}s||t.st!=n.st?(s=!1,l=.4*(n.x-t.x),c=n.x,n.x-=l,n.x>t.x+32&&(n.x=t.x+32),f(t,n,2),n.x=c,c=t.x,t.x+=l,t.x<n.x-24&&(t.x=n.x-24),draw_ties(t,n,3),t.x=c):f(t,n,n.type==NOTE?0:2)}e.s_rtie=o}}function draw_all_slurs(e){var t,n,r=e.sym,s=e.slur_start,a=0;if(r){if(s)for(e.slur_start=0;0!=s;)a<<=4,a|=15&s,s>>=4;for(draw_slurs(r,void 0);r;r=r.next)if(r.type==NOTE||r.type==REST||r.type==SPACE)for(;r.slur_end||r.sl2;){if(r.slur_end)r.slur_end--,n=-1;else{for(n=0;n<=r.nhd&&!r.notes[n].sl2;n++);r.notes[n].sl2--,r.sl2--}s=15&a,draw_slur(t=prev_scut(r),r,-1,n,s),t.type==BAR&&(":"==t.bar_type[0]||"|]"==t.bar_type||"[|"==t.bar_type||t.text&&"1"!=t.text[0])||(a>>=4)}for(r=e.sym;0!=a;)s=15&a,a>>=4,draw_slur(r,t=next_scut(r),-1,-1,s),t.type==BAR&&(":"==t.bar_type[0]||"|]"==t.bar_type||"[|"==t.bar_type||t.text&&"1"!=t.text[0])||(e.slur_start||(e.slur_start=0),e.slur_start<<=4,e.slur_start+=s)}}function draw_sym_near(){var e,t,n,r,s,a,o,i,c,l,f,u;for(r=0;r<voice_tb.length;r++){var p={},d=!0;for(n=(e=voice_tb[r]).sym;n;n=n.next)switch(n.type){case GRACE:for(a=n.extra;a;a=a.next)a.beam_st&&!a.beam_end&&calculate_beam(p,a);break;case NOTE:(n.beam_st&&!n.beam_end||d&&!n.beam_st)&&(d=!1,calculate_beam(p,n))}}for(c=0;c<=nstaff;c++)for((t=staff_tb[c]).top||(t.top=new Float32Array(YSTEP),t.bot=new Float32Array(YSTEP)),i=0;i<YSTEP;i++)t.top[i]=0,t.bot[i]=24;for(set_tie_room(),draw_deco_near(),n=tsfirst;n;n=n.ts_next)if(!n.invis){switch(n.type){case GRACE:for(a=n.extra;a;a=a.next)y_set(n.st,!0,a.x-2,4,a.ymx+1),y_set(n.st,!1,a.x-2,4,a.ymn-1);continue;case MREST:y_set(n.st,!0,n.x+16,32,n.ymx+2);continue;default:y_set(n.st,!0,n.x-n.wl,n.wl+n.wr,n.ymx+2),y_set(n.st,!1,n.x-n.wl,n.wl+n.wr,n.ymn-2);continue;case NOTE:}n.stem>0?(n.beam_st?(l=3,o=n.beam_end?4:10):(l=-8,o=n.beam_end?11:16),y_set(n.st,!0,n.x+l,o,n.ymx+2),y_set(n.st,!1,n.x-n.wl,n.wl+n.wr,n.ymn-2)):(y_set(n.st,!0,n.x-n.wl,n.wl+n.wr,n.ymx+2),n.beam_st?(l=-6,o=n.beam_end?4:10):(l=-8,o=n.beam_end?5:16),y_set(n.st,!1,n.x+l,o,n.ymn-2)),n.notes[n.nhd].acc&&(s=n.y+8,n.ymx<s&&(n.ymx=s),y_set(n.st,!0,n.x,0,s)),n.notes[0].acc&&(s=n.y,1==n.notes[0].acc||3==n.notes[0].acc?s-=7:s-=5,n.ymn>s&&(n.ymn=s),y_set(n.st,!1,n.x,0,s))}for(r=0;r<voice_tb.length;r++)if(n=(e=voice_tb[r]).sym){for(set_color(n.color),set_dscale(c=e.st);n;n=n.next)n.tp0&&draw_tuplet(n,0);for(draw_all_slurs(e),n=e.sym;n;n=n.next)n.tp0&&draw_tuplet(n,0)}for(c=0;c<=nstaff;c++)for(f=(t=staff_tb[c]).topbar+2,u=t.botbar-2,i=0;i<YSTEP;i++)f>t.top[i]&&(t.top[i]=f),u<t.bot[i]&&(t.bot[i]=u);for(set_color(void 0),draw_deco_note(),draw_deco_staff(),set_sscale(-1),set_dscale(-1),r=0;r<voice_tb.length;r++)if((e=voice_tb[r]).have_ly){draw_all_lyrics();break}cfmt.measurenb>=0&&draw_measnb()}function draw_vname(e){var t,n,r,s,a,o,i,c,l=[];for(r=cur_sy.nstaff;r>=0&&!cur_sy.st_print[r];r--);if(!(r<0)){for(s=0;s<voice_tb.length;s++)if((t=voice_tb[s]).sym&&(r=cur_sy.voices[s].st,cur_sy.st_print[r])){if(t.new_name){c=2;break}t.snm&&(c=1)}if(c){for(s=0;s<voice_tb.length;s++)if((t=voice_tb[s]).sym&&(r=cur_sy.voices[s].st,cur_sy.st_print[r]&&(t.new_name&&delete t.new_name,o=2==c?t.nm:t.snm))){if(cur_sy.staves[r].flags&CLOSE_BRACE2)for(;!(cur_sy.staves[r].flags&OPEN_BRACE2);)r--;else if(cur_sy.staves[r].flags&CLOSE_BRACE)for(;!(cur_sy.staves[r].flags&OPEN_BRACE);)r--;l[r]?l[r]+="\\n"+o:l[r]=o}if(0!=l.length)for(set_font("voice"),e=.5*-e,r=0;r<l.length;r++)if(l[r]){if(a=l[r].split("\\n"),i=staff_tb[r].y+.5*staff_tb[r].topbar*staff_tb[r].staffscale+9*(a.length-1)-.3*gene.curfont.size,n=r,cur_sy.staves[r].flags&OPEN_BRACE2)for(;!(cur_sy.staves[n].flags&CLOSE_BRACE2);)n++;else if(cur_sy.staves[r].flags&OPEN_BRACE)for(;!(cur_sy.staves[n].flags&CLOSE_BRACE);)n++;for(n!=r&&(i-=.5*(staff_tb[r].y-staff_tb[n].y)),n=0;n<a.length;n++)xy_str(e,i,o=a[n],"c"),i-=18}}}}function set_staff(){var e,t,n,r,s,a,o,i,c,l,f,u;for(r=0;r<voice_tb.length;r++)1!=(f=voice_tb[r]).scale&&(f.scale_str='transform="scale('+f.scale.toFixed(2)+')"');for(t=0;t<=nstaff&&!gene.st_print[t];t++);if(s=0,t>nstaff)u=staff_tb[--t];else for(u=staff_tb[t],e=0;e<YSTEP;e++)s<(l=u.top[e])&&(s=l);if(s+=draw_partempo(t,s),!gene.st_print[t])return s;(s*=u.staffscale)<(a=.5*cfmt.staffsep+u.topbar*u.staffscale)&&(s=a),s<u.ann_top&&(s=u.ann_top),u.y=-s,n=t;var p=cur_sy.staves[n];for(t++;t<=nstaff;t++)if(u=staff_tb[t],gene.st_print[t]){if(a=p.sep||cfmt.sysstaffsep,i=p.maxsep||cfmt.maxsysstaffsep,o=0,u.staffscale==staff_tb[n].staffscale){for(e=0;e<YSTEP;e++)o<(l=u.top[e]-staff_tb[n].bot[e])&&(o=l);o*=u.staffscale}else for(e=0;e<YSTEP;e++)o<(l=u.top[e]*u.staffscale-staff_tb[n].bot[e]*staff_tb[n].staffscale)&&(o=l);o<(a+=u.topbar*u.staffscale)&&(o=a),o>(i+=u.topbar*u.staffscale)&&(o=i),s+=o,u.y=-s,n=t,p=cur_sy.staves[n]}for(c=0,e=0;e<YSTEP;e++)c>(l=staff_tb[n].bot[e])&&(c=l);for(c>u.ann_bot&&(c=u.ann_bot),c*=staff_tb[n].staffscale,t=0;t<=nstaff;t++)o=(u=staff_tb[t]).y,1!=u.staffscale&&(u.scale_str='transform="translate(0,'+(posy-o).toFixed(2)+") scale("+u.staffscale.toFixed(2)+')"');if(0==c){for(t=nstaff;t>=0&&!gene.st_print[t];t--);if(t<0)return s}return(o=-c)<(a=.5*cfmt.staffsep)&&(o=a),o>(i=.5*cfmt.maxstaffsep)&&(o=i),s+o}function draw_systems(e){var t,n,r,s,a,o,i,c=[],l=[],f=[];function u(){var e,t,n,r,s=0;for(e=0;e<=cur_sy.nstaff;e++)c[e]<0?l[e]=f[e]=0:(t=staff_tb[e].staffscale,n=staff_tb[e].topbar*t,r=staff_tb[e].botbar*t,0==s&&(s=staff_tb[e].y+n),l[e]=staff_tb[e].y+r,f[e]=s-l[e],s=cur_sy.staves[e].flags&STOP_BAR?0:l[e])}function p(e,t,n){var r,s,a,o,i,c=0,l="",f=staff_tb[e].stafflines,u=f.length;if(f.match(/[\[|]/))if(r=n-t,set_sscale(e),s=r/stv_g.scale,cache&&cache.st_l==f&&cache.st_ws==s)xygl(t,staff_tb[e].y,"stdef"+cfmt.fullsvg);else{for(a=0;a<u;a++,c-=6)if("."!=f[a]){for(o=0;a<u;a++,c-=6,o-=6){switch(f[a]){case".":continue;case i:l+="m-"+s.toFixed(2)+" "+o+"h"+s.toFixed(2),o=0;continue}void 0!=i&&(l+='"/>\n'),l+='<path class="stroke"',"["==(i=f[a])&&(l+=' stroke-width="1.5"'),l+=' d="m0 '+c+"h"+s.toFixed(2),o=0}l+='"/>\n'}if(c=staff_tb[e].y,!cache&&r==get_lwidth())return cache={st_l:f,st_ws:s},a="stdef"+cfmt.fullsvg,glyphs[a]='<g id="'+a+'">\n'+l+"</g>",void xygl(t,c,a);out_XYAB('<g transform="translate(X, Y)">\n'+l+"</g>\n",t,c)}}for(draw_vname(e),r=0;r<=nstaff;r++)c[r]=cur_sy.st_print[r]?0:-1;for(u(),draw_lstaff(0),t=tsfirst;t;t=t.ts_next){if(i&&t.time!=i){for(i=0,r=0;r<=nstaff;r++)cur_sy.st_print[r]||(c[r]=-1);u()}switch(t.type){case STAVES:for(o=0,n=t.ts_next;n&&n.time==t.time;n=n.ts_next){switch(n.type){case BAR:case CLEF:case KEY:case METER:o=n.x;continue}break}for(n||(o=realwidth),cur_sy=t.sy,r=0;r<=nstaff;r++)(s=c[r])<0?cur_sy.st_print[r]&&(c[r]=t.ts_next.type==BAR?t.x:t.x-t.wl-2):cur_sy.st_print[r]||(o?(a=o,i=t.time):(a=t.x-t.wl-2,c[r]=-1),p(r,s,a));u();continue;case BAR:if(r=t.st,t.second||t.invis)break;if(c[r]<0){for(n=t.ts_next;n&&n.time==t.time&&n.type!=STAVES;n=n.ts_next);if(!n||n.type!=STAVES)break;c[r]=t.x,u()}draw_bar(t,l[r],f[r]);break;case STBRK:if(0==cur_sy.voices[t.v].range&&t.xmx>14){for(var d=0,_=0;_<voice_tb.length;_++)cur_sy.voices[_].range>0&&d++;for(n=t.ts_next;n&&n.type==STBRK;n=n.ts_next)d--;0==d&&draw_lstaff(t.x)}if(!(n=t.prev))break;if(a=n.x,n.type!=BAR&&(a+=n.wr),r=t.st,(s=c[r])>=0){if(s>=a)continue;p(r,s,a)}c[r]=t.x}}for(r=0;r<=nstaff;r++)i&&!cur_sy.st_print[r]||(s=c[r])<0||s>=realwidth||p(r,s,realwidth)}function draw_symbols(e){var t,n,r,s,a={};for(t=e.sym;t;t=t.next){if(t.invis)switch(t.type){case KEY:e.key=t;default:continue;case NOTE:}switch(n=t.x,set_color(t.color),t.type){case NOTE:set_scale(t),t.beam_st&&!t.beam_end&&calculate_beam(a,t)&&draw_beams(a),t.invis||(anno_start(t),draw_note(t,!a.s2),anno_stop(t)),t==a.s2&&(a.s2=null);break;case REST:draw_rest(t);break;case BAR:break;case CLEF:if(s=t.st,t.time>staff_tb[s].clef.time&&(staff_tb[s].clef=t),t.second)break;if(!staff_tb[t.st].topbar)break;set_color(void 0),set_sscale(s),anno_start(t),r=staff_tb[s].y,t.clef_name?xygl(n,r+t.y,t.clef_name):t.clef_small?xygl(n,r+t.y,"s"+t.clef_type+"clef"):xygl(n,r+t.y,t.clef_type+"clef"),t.clef_octave&&(t.clef_octave>0?(r+=t.ymx-10,t.clef_small&&(r-=1)):(r+=t.ymn+2,t.clef_small&&(r+=1)),xygl(n-2,r,"oct")),anno_stop(t);break;case METER:if(e.meter=t,t.second||!staff_tb[t.st].topbar)break;if(cfmt.alignbars&&0!=t.st)break;set_color(void 0),set_sscale(t.st),anno_start(t),draw_meter(n,t),anno_stop(t);break;case KEY:if(e.key=t,t.second||!staff_tb[t.st].topbar)break;set_color(void 0),set_sscale(t.st),anno_start(t),draw_keysig(e,n,t),anno_stop(t);break;case MREST:set_scale(t),n+=32,anno_start(t),xygl(n,staff_tb[t.st].y+12,"mrest"),out_XYAB('<text style="font-family:serif; font-weight:bold; font-size: 15px"\n\tx ="X" y="Y" text-anchor="middle">A</text>\n',n,staff_tb[t.st].y+28,t.nmes),anno_stop(t);break;case GRACE:set_scale(t),draw_gracenotes(t);break;case SPACE:case STBRK:break;case CUSTOS:set_scale(t),draw_note(t,0);break;case BLOCK:case PART:case REMARK:case STAVES:case TEMPO:break;default:error(2,t,"draw_symbols - Cannot draw symbol "+t.type)}}set_scale(e.sym),draw_all_ties(e),set_color(void 0)}function draw_all_sym(){var e,t,n=voice_tb.length;for(t=0;t<n;t++)(e=voice_tb[t]).sym&&void 0!=e.sym.x&&draw_symbols(e);draw_all_deco(),set_sscale(-1)}function set_tie_dir(e){var t,n,r,s,a,o,i;for(t=e;t;t=t.next)if(t.ti1)if(0==t.multi){for(a=r=0,o=128,n=0;n<=t.nhd;n++)t.notes[n].ti1&&(r++,o<128&&t.notes[n].pit<=o+1&&a++,o=t.notes[n].pit);if(r<=1){for(s=t.stem<0?SL_ABOVE:SL_BELOW,n=0;n<=t.nhd;n++)if(i=t.notes[n].ti1){(7&i)==SL_AUTO&&(t.notes[n].ti1=i&SL_DOTTED|s);break}}else if(0!=a){for(o=128,n=0;n<=t.nhd;n++)if(t.notes[n].ti1){if(o<128&&t.notes[n].pit<=o+1){r=n;break}o=t.notes[n].pit}for(s=SL_BELOW,n=0;n<=t.nhd;n++)0!=(i=t.notes[n].ti1)&&(r==n&&(s=SL_ABOVE),(7&i)==SL_AUTO&&(t.notes[n].ti1=i&SL_DOTTED|s))}else{if(1&r){for(r=(r-1)/2,s=SL_BELOW,n=0;n<=t.nhd;n++)0!=(i=t.notes[n].ti1)&&(0==r&&t.notes[n].pit>=22&&(s=SL_ABOVE),(7&i)==SL_AUTO&&(t.notes[n].ti1=i&SL_DOTTED|s),0==r--&&(s=SL_ABOVE));continue}for(r/=2,s=SL_BELOW,n=0;n<=t.nhd;n++)0!=(i=t.notes[n].ti1)&&((7&i)==SL_AUTO&&(t.notes[n].ti1=i&SL_DOTTED|s),0==--r&&(s=SL_ABOVE))}}else for(s=t.multi>0?SL_ABOVE:SL_BELOW,n=0;n<=t.nhd;n++)(7&(i=t.notes[n].ti1))==SL_AUTO&&(t.notes[n].ti1=i&SL_DOTTED|s)}function set_tie_room(){var e,t,n,r,s,a;for(n=0;n<voice_tb.length;n++)if((e=voice_tb[n].sym)&&(e=e.next))for(set_tie_dir(e);e;e=e.next)if(e.ti1){if(e.notes[0].pit<20&&(7&e.notes[0].ti1)==SL_BELOW);else if(!(e.notes[e.nhd].pit>24&&(7&e.notes[e.nhd].ti1)==SL_ABOVE))continue;for(t=e.next;t&&t.type!=NOTE;)t=t.next;if(t){if(t.st!=e.st)continue;r=t.x-e.x-10}else r=realwidth-e.x-10;a=r<100?9:r<300?12:16,e.notes[e.nhd].pit>24&&(s=3*(e.notes[e.nhd].pit-18)+a,e.ymx<s&&(e.ymx=s),t&&t.ymx<s&&(t.ymx=s),y_set(e.st,!0,e.x+5,r,s)),e.notes[0].pit<20&&(s=3*(e.notes[0].pit-18)-a,e.ymn>s&&(e.ymn=s),t&&t.ymn>s&&(t.ymn=s),y_set(e.st,!1,e.x+5,r,s))}}var musicfont='url("data:application/font-woff;base64,d09GRk9UVE8AABjsAAoAAAAAH8wAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABDRkYgAAADRAAAFPgAABncbyRwGEZGVE0AABg8AAAAHAAAABx6k9cvT1MvMgAAAVQAAABLAAAAYFjAWjRjbWFwAAAChAAAALEAAAH6kDnc6GhlYWQAAAD0AAAANQAAADYHrbQmaGhlYQAAASwAAAAgAAAAJAihAQhobXR4AAAYWAAAAJMAAAC+V4YAJG1heHAAAAFMAAAABgAAAAYAMFAAbmFtZQAAAaAAAADhAAABhgcU47Fwb3N0AAADOAAAAAwAAAAgAAMAAHicY2BkYGAAYpmvsQ7x/DZfGbhZGEDg4nQlcRB92dO/6P+uvzzMX1imALkcDEwgUQAm/gs4AAAAeJxjYGRgYJnyl4chhoX3/67/+5m/MABFUIA+AJ3hBq4AAFAAADAAAHicY2BmvMs4gYGVgYNpJtMZBgaGfgjN+JrBmJGTgYGJgZWZAQ4EEEyGgDTXFAYHBoaXMczG/40ZYlimMH0BCjPCFSgAISMAm6gMnAB4nHWOMWrDQBBFn2zZwTiEVCHlgps0EtI2wT6ADpDCvWwWYTASrGyTk6TKEVLmGDlAjpBj5EuZJoUXhn3z+TN/gFveSBhewg33xhPxk/GUFa/GqfQP4xlLvozn0n/kTNKFlLtxauCJ+NF4SkVhnEp/N57xwKfxXPo3NTv2eHouNFDv9r6/CF4I6s8c5YhqQ3M+1oKKjpbT+Ec5Ak7TudIcG9X/fX+apyRjrfLylTxrTdeeqi42wfm8cBtnuSJfZuvMF6VM127bKjVKPYy3OG0c8tmG2B+61pV5cXX2FwIWN4EAAAB4nGNgYGBmgGAZBkYGEPgC5DGC+SwMN4C0EYMCkCXEwPCA4YHHg4AHMQ+SHmQ+qHnQ/WDJQ8aHzx+lPFnwZM2TA09ePXn3lPFp+tPcZwHPQl/G/P8PMgyoxx2up+pB14MFYD0JUD0PgXoYgHpy4HoYFZjk98hvlV8lv1R+vny/fJN8nryQnK7sVukq6XzpGGkbaUtpDanDUvsl70reFLsMdTOJgJGNgTyNwwgAANfVUlQAAAB4nGNgZsALAAB9AAR4nJ1YCVhTV76/1xByizYK8dKNBvf246utu7ZjVepS1ypqC1QFBJElQCAQAoR9C+QfwpawBJIQSAgQCDtaKCiVitUuY6m2jk6f045dZtpxtO2c2JP2eweivnnvzZuZ73033/c79+Sc3/mf/zn/7dKUmxtF0zRzPDxiVXJqFEXPomhqi2P3LMcejuNxN5jDgTluQg/qkdQ3XgB42JjD2/5Lyc8lPm4ars8sdq4PRc3zmZXi6UMt9XnCy4taOc3Co/gUS/lQiyk/aiW1gdpM7aD2UYepI1Q4FUMlUjIqmyqiVFQ1paNMVBvVTQ1Ro9QEdYn6mLpG3aS+pv5C/UQ5aQ7tQXvSj9O+9DJ6Ob2G/g39Cr2LPkAHPp8gPhF5UpoQs33FihUzsGa9CzbMwFpX59qtM7BulQtenIH1/i54xQWuIRtcnRtcnf6u6f4rXeCa7r/aBWumYeWKmf9Wbp9ZdtW6FS5Y6YJVLljtgpkJa1yca/xn1luz1fW2faULVrlgtQtcE7avdcE6F6x3wQYXvOgCfxdsn4a1Lk2sdUm2dt16F2x1wbZpWOfSy7q1M9Qvrt16/+wfXAGKohV0CV1KK2mgVXQZrabL6Qq6kq6iq2kNraVr6Fq6jq6ndXQD3UjraQNtpJtoE91Mt9Bm2kK30la6jW6nO2gb3Ul30Xa6m+6he+k+up8eoAepFdO3Ywm1nmqj1bMWcELdyrjbudHuZ3nfMrpHlj9yy+NJjx0e4R4THj/Ndp+9aHbibNNsx5xXHqUfDXo0+dF3H/3s0e/5NJ/lH+E38O/MLZ/3queznns95Z5tXge8srwuzs/x5nq/hHxhzHFgjB4bQxfGOGPejucdQ87n3cecBazjALrgPMDjt4JjCQ2OpRxwcyx1LHEudefjvqZUGlra2jiOWje7XB8FoRCTG5y8Kzu8OBpiYUdb4LsnQu1pAzAClurOOjvTell7Dt6Ci5LhwIaxBssQvAen8s4nfpxtL2gHC4wYBk/ZmYATCYGwA2IrouvCW3bVBEMMhKWLouUM/29lRqS5LruOKoxeiutvWBHz59V//uJ6kFXQk+tYhL5iF3gIPqPwr/unG1UUegwfZgWVWyK6Qz8SWsFabmtoMdpsMMIIaih4J+oqZtAsBonQWFgHjsbD3OiO8K4j3SKb3AYtcOacbYRAS0GDnBFUUqK8nAyQM9LmVIvV0NwsJBT9UadeFYpBrBDJk2UiERwh47bA4e4tiME0g6Pw8JAIRaAhbnfcQMxIlE3UIIJkCDwkOkIguVrewBAhbdraRmhgTClNSUJxWkqKL9+RtXMIHe1HxwZpVHcbufUjt9uc+T6OOMc3LH6ah7m5K5/Jx48zWBiBhO4aPP/WYsTNZfDT/ehpHuLW3PpBg+YzSNiPhe75aP7KHzC3hiF/RTg3sPgob3/1kTEFWsig57yRm7sCLzwStL+AQYVu6ChvsmAkuBwvYvBz3tjNvRwtHRmZrGb4Dr9fBH3o+z70M/Lygq+HUSr2H39/5IO+LwaaPhD8cNaxGBnYNBTBRauR59lbgPYBelxxdd3Xz4uffQHwUditfbF6cVDk0dBkWVjMS79JCmJEByWrYDVgOfLB81Am1EAj1KiYRnyQq8qDfPIsC04MgiRIKZfVMIJ7Z99TjXTBeeZ88Pi+HSFBB9e/vwO5Iap//K4QdEqdsoGRo/3cwfJ2XY/hi8GeT+Ab+Djn/aB3Qs9sse4AJg/ylPlKphbPY+vdEXV99Yu+sDlmE346jon0LoVShRBnwzbkXYI2qtCSj6+jnWgJESaAK/jp7ArJy3vgWdjase1yRpIttQ9s8OHE4G/rmPx7W9iaLwd+/IO2V1q7E47BosWLXzrMEIWU6BRvw1mwqKxqM8NHd5x13Q4f+12748keGtDci9ZP0Ur0G0RxHBJnCisGkSbK0FVjNGqaobqsEqqZgXBbmLDY/ViGVEIM6cVvDn0HF+F868TZ3m7jcMUZRs+D4az+pJ7osVffeY4YSERBeCYTc6XrKncgs7+gC6zQom7R3rJPfQKIJqOLz8iGI7sPnj1g2UvuXlJxckFARlRcRkhxLhDVQKxJ8lYGU+E+NGAb8IXq0kqozLfKGmNqbI0tmn44B70iYomxVdEQDZtOYLdtwMRDfIO8Jqw1dyj5lHRPWkiaOE0skYhSGUeB+FeN1VHBs6WaJQYxeUJMe2qslY0VNc3WkdPniTPoOtm4TRNXHg8JzKqji1YJnZKfJeyvGjT3Zw2Pjz7Hm/4agLKj7/QOeRmQAq1HHh9+JwgxDLAvjay5JmwFq6a5qdVUayUHcfHQ+dfgJOQWxkfqv71x7lM4A105AyFMT5hhD6yHWEVk4QnpwpBn9u9bvRwLDuJFkeiAFvl//dc/3r41hlhA6xm4kPVx/KmgK/52zAUGP4Y5L+LHfQWGe944irUYTW1tyU2JCRmpCb5xJlmbULCpCBWzrUZTpyW1KTE+LT3BN9YobRfyvwPkdxn5cVAiUrPOEuTHK3WUcJ1u3g/bxI6cynbU1IH6/rTyL17wqR3twsKhM71jtimbdUDw2U30e/QIW6Wqgir4Gia3wqvwWuQ+PEvCFH2VhoIAmCLcz5aCskSI90PQj0XoSRXijV9CSxCPEfzpZkVg+fGKgFdk+4JgIwR0hfZLUy15rcSxjr9lf6dGJW/BRsLRlcB2qZtr23WXu9rOwxWYyB8LP8UIrt2MGD5sfJ1YXgExlcKLpW8VjyPB7aEpQM/CT4rJV6/4Szf6A17DQGD1rsoN4fEno9LkMYm796SGJx2TbYPtgPch6ln0GmigFjQqpg4v5KoIHRSCf3R8KKRCulquYQQ3bo6qelthmBmOOBV8OCr82M4PX798Y6D/C2EVj8yrVmqVNUXni6aYnfe+ZzWXbZcuW23xmnByzq+sX747lBG8d7O0VtEHg9Ckai4zEv+03LmyDX1o/b0Vvd9Ow/djpgvICz3xBcfh5ZzPSkFSlaBr1TQ0VumhsqwCKpnOGEuMUOF+MitDRlzMrish12AUhk1vDba3NfaUDzI6HvTmdqS2iwcOn9oMiSAqjM1hEs+3TnI7c2xFrWACY5mhesr67nn4gqnnKQYzeuLbjg0eNQVDGqQWpxUdy0pIzopSTG++AJIaZT1ZTLl7V5e50xcqSyugotAkr0/UWOr1VTY4DR0SwxuapIoEEMO+uFUHgSHhoS5bE2PK70qzpwdlnsyUZkplsqQMxrFA+sukyeHHs2QYZTopeU7qgzSmivpyjd7U1zMMvdAaX3+wSqJOhhRmW+T6bUKn171O9pfJ7+9N8viOHdjnxlF0QHyjo8tLhwKR97fj1wQhuk52d9/294QmMFXpG016rYncmdGQkTchHgqKkuPrr75/+gJRtyWvM4ppj9EFwk5IKokriktfF73xSPD2LUuPYfd45FeNfD+58fH1qf4fAHkz8HbuRLI9/PwB60pgFq3avZAYlaMGv8w2Neibm9MapSlZGSm+Er2cBNNNxegN1tSgtzRlNEiTM7NSfJMa0luE/G6sbEOAnrzURGvQLBQ+XtfIQefQBlbpfhJSY0qTmGjridN95uFhIViyLLJmWXNIayDgx5Sr9wLeCArVCVCoX216oy+y9+SobBQYxC8butB5V6VOV4M65UhahDhZnJyQlwQiSKpLaRMNFl6FTxlAz42fu1DWB2eSyKEolMUliiKVQlWgYvj2/ybSBTua9W8KVQRKZREwd6IX8RZn7twF+Jm/F689oTetr4hZYP9BxSMy9l2y3f7fMuZBsSpfzTh28arL1GXV8A/kw3PxL2xBZWFVoca1F/jBPNndSqLQCsza0eEOGvpUP6FMNEvVz3FkoU0svtuP7vKcFm98t480kNsCdqEHurWXXeTBx5tuowW3aTA7ss0c82XWkY0XOLPdJWiIde41jzqyg82OvZJgZ/Yoj3/1Af8MOwdxLv4XTyh+dgLtnqChAxk6OOj0R6y6qKyIOIYD+ImXXgYppFUVNCgqSeCpgvPoiRvXiIkZCjVypqmOlQyHGY/C87DoZXgB0ipkWpn56JBsmET4H68RN2koNuYRHxCGFyAbCa6fc2Ldtp85+Z6QZFVl+spblquj8Ee4/Hr3HsiEzJIMxeqUTa/DaqKP/VjthmaDY5+jBM8BLv9vwWSjtzmjwazVZLJapSaxWCoVi01Sqy9/MeL30qN25PEBBz2L+GxHS3y0L0TLw+PDE8IkyemlDArlmXuaLcL2XjYC4tNTYhj0WbTzJq8LzljHx8+OW0ZgGN4+2h0KDB/7gxUtMXOsy0gE8kNLTgP24+Iljh1solKpBOenaMsY4FQzgOMT/HIgl794wnynhfP7z9g7bYB3LRVzscEN0O7pt00tAGj7pA4+358JaOek3tXYmgyA93CXJgHaJCHNHQezYM1EA+kjjXUTjYC3cvkL8bwrt6do49TdKQ4KJLnR1NRB98AzXENjZxcJFBMfbyWvQdz0xtiZ161bJ3hjwUHBBwH8pwDOj41xa7P7I8lf/ELk2UsO96vxuvavz3KuIU9W5V4DtQXa7KosdTqkQw5kK7ILorPiUhNSE3IzcmBaYWBqaWlWMZZeNgpS0+UiBk3FOX/H64Tetja7tctkb+yv0Jc3QAMMiYYjyJS1kWw54dXO8JbP8Jbe500nvFkZufd5m+/zRkOqTB5PeOMJbzsMtFntbV1Ge0N/lYv3rbhTx4n4bwAqoUvQVY5exaL+77gadUU1uYnVxdX55Qzu/xtXCUqVkphfQSZkQ5G6qIIc+PGNXK0CFHnFDI54hasoLS0mJp5XmaWFMlBBGXEVzwN6j1zJTlIz9cAt9OaX+M33gdzT97h8JAM0B837Aw1alE5aci0ZpHXXkevAfouWwfSPXa7DfozWHcVgP/QI9pt5GBwrRGe8uyytnbZEa2xcglgkahN3+PKxgjhdDlK7kXzD25VvTHep6fvdWI28kZrHfwV7Ik/SeZYsSJpnkSfpg/tdyPNhH34KxxHpL3EGHE+xN/Cbz+Cd6Cl8gJtSL61KgSMQTgoeOG47/OXh8N7MHmiHPqtlgEB3dncsgykUcRfFExE8RjoJ81MctHmSxVzcPyJHfo6lXEWZDEpLQwPEacdA31RhICWQPcYYHRubHnLotOSscBDqqvXlDHEcJ2wopdOLUOxFTwl+izbjIHYdPn06BwXfW3afJj74eOL/RaOfptmPQ7hF6cnyY8AIbi724FtmWB8QB6CndhDuH5Fykg14OPIhXROhSyN0ydN0NZXGSsa1ftPP/876Rg1ZPwCHElbpzPrf3B8n+OM0tVDwzQN230HQTLPz/+K8L90DAfc/lPEO2ux8sP8/+7hV/X8EuPtAgDsuAe7+TwEC/k5bP/4TNfz9uHtEqzNyS2woYeaX+ED0fTO/LUT6nyk0dYY9hIP+tYoD8NGH3M4t/+osHH4+3Nx/VxeB+MhDXThy/zH1jB5efygo2R9FNuiQLEInSTC8N2DmoAw3Z5gZed4bwJ5mR5gEe/4yMG026CAOJPbsh+bQxQQn0RzOO1fZJR6OzbiZgLP4MIs8XUHHiwQd0v1guAzNcQyR4f3Tw+89PzP8F+lhdqkHDnaWEOBfKrn0Wg9yu3jC7gX1juX1gqMOjx6WhDVtWh2DNyJvrqw+RS1TpYGsKDNbKksXwwmI1SbrpYygsSHDkF9PYqKmFprAkKdNh1zILsnMz6wpqoc26GvqaANGB3X5hmwGbcTeXEGcMctSaAQDsaH6umaj3kryjRHRuZDpiXKlDDI0eQZgiJtX6zS63KosiGdOporEQj6KAJRCd73FXr32I6nuGTRvGpahtdLmTesXonl4Dp63jMAivJx4wog30O9wRaoX6mgVNKGOyyye20oqJnMrVxB2f56sZeM6Mm+7P1fQpERzE0lA85Om3Kdokly95hrK5d97rnQyYBCVdPZ/EjqGNtq8YAL5jde+++25qt7JvtEJ9ML5ykmB9defY0tZfW19Q0NWvTwzM0vuK9dl6YROw5/Y8Cg5KQrEILkSaWF60Xquqhymn7HtelIjlKsqVeWkew0XLSo8vQ2iGcELv5I6KHz6O1CVtJfJzuG2BAwldQMz8s7box/t+g+8B4f646WbfQWyX2MaJK3CD6DFfPZLRl7NTYk4WZAKMshpgBY4PXUdPa4ll1PEVRYpC0koOfhBFhyDEmWJUhGPHzP0LtkbLgk+TrIYhbqkChg9DGinRow1BrMJ6qE2Sx9nD6/PJik8mPTvjjYlDUeSbJdslThmXetQR1BPkQ1uwcQV+AqQEHPQXFz9OaPkQTrate3KUvx4tHgXLGME4l+jQiKThJGQbEpuMxtH7C3DWgO5A/UwmNQeBeEQVpAULU0oSoUIBmJ0iUYR09fKZpkV9dAKk/39dqgDTWm5vKywrIBsIkSasvsAg8Z+w4ZqU5vhFNy0TH7Z3yJuPAShsDUlYKeC4X/0TVNj4beHzh3SW/TN33mhV5vzvt+vb28UTC5AHSiflaRnpaalNzQ3N9YZhQZjdoqv4NIW/HQBa67LzfQlFUpeYaFcnlkqJbE5T5mbk0uSAtIUN2WZQQtatbac6TLHtdu7NZqqihoinzYfEhnBxVwIjSyASEbSktZsatOR2v5SGAweV8I5MFVrtKSM1RRqCuwnEiQWSX1enaIWbNBgghYG6kp0udoEc0rSyc48jVJDlFOvLe8g6m4J6wN1pA0Yu6HJ3JxlCfcVlIfFgvJEMMlxc7WkLq6urNVqGnWaMjswFkNHkzXZIPHNA1lxQb5Y1CYVReXl5CoKIAOKjWBSDduLoJvpSNFLJZIMkRBEPcryUNV0UVkMGfmF019vcioKq0/2W9skltzqnHKSAInkkuQUnWTQtw50iobM6sLy6TI0OydPUkoE3BKiLu5OACZaLk0SG9I7fTtA2TNMkpV/merzVE53MyjvqUg+STJ+gFHivnrmOx5h6+d42Dxs1eOVxoqbc+aYZ5sryyvera2r1c151IdaKqDcaXr+3vDsClJa6k2mdL1Ump4u9ZXq003C2XVt1krieOrcPyi+tLcmvKxQlT/zCaJAUShPSCoSA5Ptvqti78WcgdIqJUnJQFumUVcxs6+vfhv7YJ/Vb67b8uWbyAf5fPn2deHsfxIoZne2tnZ2JrbGxiYmxcS2Jnb6zkZ8lyOeC9zZ/wlF9IlhAAAAAQAAAADVs2WlAAAAANGXIhcAAAAA00lPcnicY2JgYGCcACTCgfSD/3eY4xiqmLkZGJguAfH+/7sYrzEwgPjMfECs/v8E40wGTsYZDJxMgkB5GaCeA0DsCcReQL4ByAwg5mUwYjgBphkYuRlEGPOAtMP/v4wSQDURQLuaIJhRB4IZ3gHxf6g5/UB8A4KZg4Hqjf9/YFb4/5BxK5DtwsALwiy8YLt5GBgAC1ge5AA=")',defined_font={},font_tb={},fid=1,font_scale_tb={serif:1.05,serifBold:1.05,"sans-serif":1.1,"sans-serifBold":1.1,Palatino:1.1,Mono:1.35},fmt_lock={},cfmt={aligncomposer:1,breaklimit:.7,breakoneoln:!0,cancelkey:!0,composerspace:6,dblrepbar:":][:",decoerr:!0,dynalign:!0,fullsvg:"",gracespace:[6.5,8,12],graceslurs:!0,hyphencont:!0,indent:0,infoname:'R "Rhythm: "\nB "Book: "\nS "Source: "\nD "Discography: "\nN "Notes: "\nZ "Transcription: "\nH "History: "',infospace:0,keywarn:!0,leftmargin:1.4*CM,lineskipfac:1.1,linewarn:!0,maxshrink:.65,maxstaffsep:2e3,maxsysstaffsep:2e3,measurefirst:1,measurenb:-1,musicspace:6,parskipfac:.4,partsspace:8,pagewidth:21*CM,printmargin:0,rightmargin:1.4*CM,rbdbstop:!0,rbmax:4,rbmin:2,scale:1,slurheight:1,staffnonote:1,staffsep:46,stemheight:21,stretchlast:.25,stretchstaff:!0,subtitlespace:3,sysstaffsep:34,textspace:14,titlespace:6,titletrim:!0,topspace:22,tuplets:[0,0,0,0],vocalspace:10,writefields:"CMOPQsTWw",wordsspace:5};function get_bool(e){return!e||!e.match(/^(0|n|f)/i)}function get_int(e){var t=parseInt(e);return isNaN(t)&&(syntax(1,"Bad integer value"),t=1),t}function get_font_scale(e){var t=e.split(/\s+/);if(!(t.length<=1)){var n=parseFloat(t[t.length-1]);if(isNaN(n)||t<=0)syntax(1,"Bad scale value in %%font");else for(var r in font_scale_tb[t[0]]=n,font_tb)if(font_tb.hasOwnProperty(r)){var s=font_tb[r];s.name==t[0]&&(s.swfac=s.size*n)}}}function param_set_font(e,t){var n,r,s,a,o,i,c,l,f,u;if("-"==e[e.length-2]){if((a=e[e.length-1])<"1"||a>"9")return;e="u"+a+"font"}(r=cfmt[e])&&(n=font_tb[r])&&(s=n.name+"."+n.size,n.class&&(s+="."+n.class)),(a=t.indexOf("class="))>=0&&(a+=6,u=(o=t.indexOf(" ",a))>0?t.slice(a,o):t.slice(a),t=t.replace(new RegExp("class="+u),"").trim()),i="*"==(i=(o=t.split(/\s+/))[0])&&n?n.name:(i=(i=(i=i.replace("Times-Roman","serif")).replace("Times","serif")).replace("Helvetica","sans-serif")).replace("Courier","monospace"),o.length>1?"*"==(l=o[o.length-1])&&n&&(l=n.size):n&&(l=n.size),l&&(c=i+"."+l,u&&(c+="."+u),c!=s&&((n=font_tb[c])||((f=font_scale_tb[i])||(f=1.1),n={name:i,size:Number(l),swfac:l*f},font_tb[c]=n),u&&(n.class=u),cfmt[e]=c))}function get_unit(e){var t=parseFloat(e);switch(e.slice(-2)){case"CM":case"cm":t*=CM;break;case"IN":case"in":t*=IN;break;case"PT":case"pt":t*=.75}return t}function set_infoname(e){for(var t=cfmt.infoname.split("\n"),n=e[0],r=0;r<t.length;r++){if(t[r][0]==n)return 1==e.length?t.splice(r,1):t[r]=e,void(cfmt.infoname=t.join("\n"))}cfmt.infoname+="\n"+e}var textopt={align:"j",center:"c",fill:"f",justify:"j",ragged:"f",right:"r",skip:"s"};function get_textopt(e){return textopt[e]}var posval={above:SL_ABOVE,auto:0,below:SL_BELOW,down:SL_BELOW,hidden:SL_HIDDEN,opposite:SL_HIDDEN,under:SL_BELOW,up:SL_ABOVE};function set_pos(e,t){void 0!=posval[t]?("ste"==(e=e.slice(0,3))&&(e="stm"),curvoice&&(curvoice.pos=clone(curvoice.pos)),set_v_param(e,t,"pos")):syntax(1,err_bad_val_s,e)}function set_writefields(e){var t,n,r=e.split(/\s+/);if(get_bool(r[1]))for(n=0;n<r[0].length;n++)t=r[0][n],cfmt.writefields.indexOf(t)<0&&(cfmt.writefields+=t);else for(n=0;n<r[0].length;n++)t=r[0][n],cfmt.writefields.indexOf(t)>=0&&(cfmt.writefields=cfmt.writefields.replace(t,""))}function set_v_param(e,t,n){if(curvoice)n?curvoice[n][e]=posval[t]:curvoice[e]=t;else{e=[e+"=",t];info.V||(info.V={}),info.V["*"]?Array.prototype.push.apply(info.V["*"],e):info.V["*"]=e}}function set_page(){img.chg&&(img.chg=!1,img.lm=cfmt.leftmargin-cfmt.printmargin,img.lm<0&&(img.lm=0),img.rm=cfmt.rightmargin-cfmt.printmargin,img.rm<0&&(img.rm=0),img.width=cfmt.pagewidth-2*cfmt.printmargin,img.width-img.lm-img.rm<100&&(error(0,void 0,"Bad staff width"),img.width=img.lm+img.rm+150),set_posx())}function set_format(e,t,n){var r,s,a,o,i;if(n)fmt_lock[e]=!0;else if(fmt_lock[e])return;if(e.match(/.+font$/)||e.match(/.+font-[\d]$/))switch(" box"==t.slice(-4)&&(o=!0,t=t.slice(0,-4)),param_set_font(e,t),e){case"gchordfont":cfmt.gchordbox=o;break;case"measurefont":cfmt.measurebox=o;break;case"partsfont":cfmt.partsbox=o}else switch(e){case"aligncomposer":case"barsperstaff":case"capo":case"infoline":case"measurefirst":case"measurenb":case"rbmax":case"rbmin":case"shiftunison":case"staffnonote":cfmt[e]=get_int(t);break;case"microscale":if(r=get_int(t),isNaN(r)||r<4||r>256||r%1){syntax(1,err_bad_val_s,"%%"+e);break}set_v_param("uscale",r);break;case"bgcolor":case"dblrepbar":case"titleformat":cfmt[e]=t;break;case"breaklimit":case"lineskipfac":case"maxshrink":case"pagescale":case"parskipfac":case"scale":case"slurheight":case"stemheight":case"stretchlast":if(r=parseFloat(t),isNaN(r)){syntax(1,err_bad_val_s,"%%"+e);break}switch(e){case"scale":r/=.75;case"pagescale":e="scale",img.chg=!0}cfmt[e]=r;break;case"bstemdown":case"breakoneoln":case"cancelkey":case"custos":case"decoerr":case"dynalign":case"flatbeams":case"gchordbox":case"graceslurs":case"graceword":case"hyphencont":case"keywarn":case"linewarn":case"measurebox":case"partsbox":case"rbdbstop":case"singleline":case"squarebreve":case"straightflags":case"stretchstaff":case"timewarn":case"titlecaps":case"titleleft":case"titletrim":cfmt[e]=get_bool(t);break;case"chordnames":for(a=t.split(","),cfmt.chordnames={},i=0;i<a.length;i++)cfmt.chordnames["CDEFGAB"[i]]=a[i];break;case"composerspace":case"indent":case"infospace":case"maxstaffsep":case"maxsysstaffsep":case"musicspace":case"partsspace":case"staffsep":case"subtitlespace":case"sysstaffsep":case"textspace":case"titlespace":case"topspace":case"vocalspace":case"wordsspace":r=get_unit(t),isNaN(r)?syntax(1,"Bad value in $1","%%"+e):cfmt[e]=r;break;case"print-leftmargin":syntax(0,"$1 is deprecated - use %%printmargin instead","%%"+e),e="printmargin";case"printmargin":case"leftmargin":case"pagewidth":case"rightmargin":if(r=get_unit(t),isNaN(r)){syntax(1,"Bad value in $1","%%"+e);break}cfmt[e]=r,img.chg=!0;break;case"concert-score":cfmt.sound="concert";break;case"contbarnb":cfmt.contbarnb=get_int(t);break;case"writefields":set_writefields(t);break;case"dynamic":case"gchord":case"gstemdir":case"ornament":case"stemdir":case"vocal":case"volume":set_pos(e,t);break;case"font":get_font_scale(t);break;case"fullsvg":if(0!=parse.state){syntax(1,"Cannot have %%fullsvg inside a tune");break}cfmt[e]=t;break;case"gracespace":cfmt[e]=t.split(/\s+/);break;case"tuplets":cfmt[e]=t.split(/\s+/),(a=cfmt[e][3])&&posval[a]&&(cfmt[e][3]=posval[a]);break;case"infoname":set_infoname(t);break;case"notespacingfactor":if(r=parseFloat(t),isNaN(r)||r<1||r>2){syntax(1,err_bad_val_s,"%%"+e);break}for(s=space_tb[i=5];--i>=0;)s/=r,space_tb[i]=s;for(s=space_tb[i=5];++i<space_tb.length;)s*=r,space_tb[i]=s;break;case"play":cfmt.sound="play";break;case"pos":set_pos((e=t.split(/\s+/))[0],e[1]);break;case"sounding-score":cfmt.sound="sounding";break;case"staffwidth":if(a=get_unit(t),isNaN(a)){syntax(1,"Bad value in $1","%%"+e);break}if(a<100){syntax(1,"%%staffwidth too small");break}if((a=cfmt.pagewidth-a-cfmt.leftmargin)<2){syntax(1,"%%staffwidth too big");break}cfmt.rightmargin=a,img.chg=!0;break;case"textoption":cfmt[e]=get_textopt(t);break;case"combinevoices":case"voicecombine":if(a=parseInt(t),isNaN(a))return void syntax(1,err_bad_val_s,"%%"+e);if(curvoice&&"combinevoices"==e){for(r=0;r<voice_tb.length;r++)voice_tb[r].combine=a;break}set_v_param("combine",a);break;case"voicemap":set_v_param("map",t);break;case"voicescale":if(a=parseFloat(t),isNaN(a)||a<.6||a>1.5)return void syntax(1,err_bad_val_s,"%%"+e);set_v_param("scale",a);break;default:0==parse.state&&(cfmt[e]=t)}}function font_init(){param_set_font("annotationfont","sans-serif 12"),param_set_font("composerfont","serifItalic 14"),param_set_font("footerfont","serif 16"),param_set_font("gchordfont","sans-serif 12"),param_set_font("headerfont","serif 16"),param_set_font("historyfont","serif 16"),param_set_font("infofont","serifItalic 14"),param_set_font("measurefont","serifItalic 14"),param_set_font("partsfont","serif 15"),param_set_font("repeatfont","serif 13"),param_set_font("subtitlefont","serif 16"),param_set_font("tempofont","serifBold 15"),param_set_font("textfont","serif 16"),param_set_font("titlefont","serif 20"),param_set_font("vocalfont","serifBold 13"),param_set_font("voicefont","serifBold 13"),param_set_font("wordsfont","serif 16")}function style_font(e){var t=e.split("."),n=t[1],r=e.indexOf("Italic"),s=100,a=e.indexOf("Oblique"),o=e.indexOf("Bold");return e=t[0],t="",o>0&&(t+="font-weight:bold; ",s=o),(r>0||a>0)&&(r>0&&(t+="font-style:italic; ",r<s&&(s=r)),a>0&&(t+="font-style:oblique; ",a<s&&(s=a))),100!=s&&("-"==e[s-1]&&s--,e=e.slice(0,s)),"font-family:"+e+"; "+t+"font-size:"+n+"px"}function font_class(e){return e.class?"f"+e.fid+cfmt.fullsvg+" "+e.class:"f"+e.fid+cfmt.fullsvg}function style_add_font(e){font_style+="\n.f"+e.fid+cfmt.fullsvg+" {"+style_font(e.name+"."+e.size)+"}"}function use_font(e){defined_font[e.fid]||(defined_font[e.fid]=!0,style_add_font(e))}function get_font(e){var t=cfmt[e+="font"],n=font_tb[t];return n||(syntax(1,"Unknown font $1",e),n=gene.curfont),n.fid||(n.fid=fid++),use_font(n),n}Abc.prototype.style_font=style_font;var abc_utf={"=D":"","=H":"","=T":"","=d":"","=h":"","=t":"","/O":"","/o":"","/L":"","/l":"",vL:"",vl:"",vd:"",".i":"",AA:"",aa:"",AE:"",ae:"",DH:"",dh:"",OE:"",oe:"",ss:"",TH:"",th:""};function cnv_escape(e){for(var t,n,r,s,a="",o=0;!((r=e.indexOf("\\",o))<0);){if(a+=e.slice(o,r),!(t=e[++r]))return a+"\\";switch(t){case"0":case"2":if("0"==e[r+1])switch(e[r+2]){case"1":a+="",o=r+3;continue;case"2":a+="",o=r+3;continue;case"3":a+="",o=r+3;continue;case"4":a+="&#x1d12a;",o=r+3;continue;case"5":a+="&#x1d12b;",o=r+3;continue}case"1":case"3":if(e[r+1]>="0"&&e[r+1]<="7"&&e[r+2]>="0"&&e[r+2]<="7"){o=parseInt(e.slice(r,r+3),8),a+=String.fromCharCode(o),o=r+3;continue}break;case"u":if(o=Number("0x"+e.slice(r+1,r+5)),isNaN(o)){a+=e[++r]+"",o=r+1;continue}if(s=[o],o>=55296&&o<=57343){if(o=Number("0x"+e.slice(r+7,r+11)),isNaN(o))break;s.push(o),o=r+11}else o=r+5;a+=String.fromCharCode.apply(null,s);continue;case"t":a+=" ",o=r+1;continue;default:if(n=abc_utf[e.slice(r,r+2)]){a+=n,o=r+2;continue}switch(t){case"`":a+=e[++r]+"",o=r+1;continue;case"'":a+=e[++r]+"",o=r+1;continue;case"^":a+=e[++r]+"",o=r+1;continue;case"~":a+=e[++r]+"",o=r+1;continue;case"=":a+=e[++r]+"",o=r+1;continue;case"_":a+=e[++r]+"",o=r+1;continue;case".":a+=e[++r]+"",o=r+1;continue;case'"':a+=e[++r]+"",o=r+1;continue;case"o":a+=e[++r]+"",o=r+1;continue;case":":a+=e[++r]+"",o=r+1;continue;case"v":a+=e[++r]+"",o=r+1;continue;case"c":a+=e[++r]+"",o=r+1;continue;case";":a+=e[++r]+"",o=r+1;continue}}a+="\\"+t,o=r+1}return a+e.slice(o)}var include=0;function do_include(fn){var file,parse_sav;user.read_file?include>2?syntax(1,"Too many include levels"):(include++,file=user.read_file(fn),file?(".js"==fn.slice(-3)?is_secure(file)?eval('"use strict"\n'+file):syntax(1,"Unsecure code"):(parse_sav=clone(parse),tosvg(fn,file),parse=parse_sav),include--):syntax(1,"Cannot read file '$1'",fn)):syntax(1,"No read_file support")}var err_ign_s="$1: inside tune - ignored",err_bad_val_s="Bad value in $1";function tosvg(e,t){var n,r,s,a,o,i,c,l,f,u,p,d,_,m,v,y,h,b,g,x,k,w="\n",E=t.length;function A(){var e,n,a=t.indexOf("K:",r);return!(a<0)&&(a=t.indexOf("\n",a),!!parse.select.test(t.slice(r,a))||((e=/\n\w*\n/).lastIndex=a,n=e.exec(t),s=n?e.lastIndex:E,!1))}function T(e,t){return e=e.replace(/[ \t]*[^\\]%.*/,"").replace(/\\%/g,"%"),t&&e.indexOf("\\")>=0?cnv_escape(e):e}function C(){generate(),info.W&&put_words(info.W),put_history(),blk_flush(),parse.state=0,cfmt=m,info=v,char_tb=y,glovar=h,maps=b,mac=g,maci=x,init_tune(),img.chg=!0,set_page()}for(parse.file=t,parse.ctx={fname:e},r=0,r=0;r<E;r=parse.eol+1){for((s=t.indexOf("\n",r))<0&&(s=E),parse.eol=s;;){switch(t[--s]){case" ":case"\t":continue}break}if(++s!=r){if(parse.istart=parse.bol=r,parse.iend=s,parse.line.index=0,c=t[r],l=t[r+1],"%"==c){if(parse.prefix.indexOf(l)<0)continue;"a"==t[r+2]&&"b"==t[r+3]&&"c"==t[r+4]&&" "==t[r+5]?(c=t[r+=6],l=t[r+1]):k=!0}else"I"==c&&":"==l&&(k=!0);if(k){for(k=!1,r+=2;;){switch(t[r]){case" ":case"\t":r++;continue}break}if(!(p=t.slice(r,s))||"%"==p[0])continue;switch((d=p.split(/\s+/,2))[0]||d.shift(),d[0]){case"abcm2ps":case"ss-pref":parse.prefix=d[1];continue;case"abc-include":if(!(o=d[1].match(/.*\.(.*)/)))continue;switch(o[1]){case"abc":case"js":do_include(d[1])}continue}if(_=d[0].match(/begin(.*)/)){if(a="\n"+c+l+"end"+_[1],(n=t.indexOf(a,s))<0){syntax(1,"No $1 after %%$2",a.slice(1),_[0]),parse.eol=E;continue}do_begin_end(_[1],d[1],t.slice(s+1,n).replace(new RegExp("^"+c+l,"gm"),"")),parse.eol=t.indexOf("\n",n+6),parse.eol<0&&(parse.eol=E);continue}switch(d[0]){case"select":if(0!=parse.state){syntax(1,"%%select ignored");continue}if('"'==(i=T(p.slice(7).trim(),!1))[0]&&(i=i.slice(1,-1)),!i){delete parse.select;continue}i=(i=i.replace(/\(/g,"\\(")).replace(/\)/g,"\\)"),parse.select=new RegExp(i,"m");continue;case"tune":syntax(1,"%%tune not treated yet");continue;case"voice":if(0!=parse.state){syntax(1,"%%voice ignored");continue}if(!(i=T(p.slice(6).trim(),!1))){parse.cur_tune_opts?parse.cur_tune_opts.voice_opts=null:parse.voice_opts=null;continue}if("end"==i)continue;for(parse.cur_tune_opts?(parse.cur_tune_opts.voice_opts||(parse.cur_tune_opts.voice_opts={}),u=parse.cur_tune_opts.voice_opts):(parse.voice_opts||(parse.voice_opts={}),u=parse.voice_opts),u[i]=[];r=++s,"%"==t[r];)if(s=t.indexOf("\n",s),t[r+1]==l){switch(r+=2,(d=(p=s<0?t.slice(r):t.slice(r,s)).match(/\S+/))[0]){default:u[i].push(T(p.trim(),!0));continue;case"score":case"staves":case"tune":case"voice":r-=2}break}parse.eol=r-1;continue}do_pscom(T(p.trim(),!0))}else if(":"==l){if(p=T(t.slice(r+2,s).trim(),!0),"+"==c){if(!f){syntax(1,"+: without previous info field");continue}w=" ",c=f}switch(c){case"X":if(0!=parse.state){syntax(1,err_ign_s,c);continue}if(parse.select&&!A()){(s=t.indexOf("\nX:",parse.eol))<0&&(s=E),parse.eol=s;continue}if(m=clone(cfmt),cfmt.pos=clone(cfmt.pos),v=clone(info),info.V)for(n in v.V={},info.V)info.V.hasOwnProperty(n)&&(v.V[n]=clone(info.V[n]));for(y=clone(char_tb),h=clone(glovar),b=maps,g=clone(mac),x=new Int8Array(128),n=0;n<128;n++)x[n]=maci[n];info.X=p,parse.state=1;continue;case"T":switch(parse.state){case 0:continue;case 1:void 0==info.T?info.T=p:info.T+="\n"+p;continue}new_block("title").text=p;continue;case"K":switch(parse.state){case 0:continue;case 1:info.K=p}do_info(c,p);continue;case"W":if(0==parse.state||cfmt.writefields.indexOf(c)<0)break;void 0==info.W?info.W=p:info.W+=w+p;break;case"m":if(parse.state>=2){syntax(1,err_ign_s,c);continue}if((!cfmt.sound||"play"!=cfmt.sound)&&cfmt.writefields.indexOf(c)<0)break;if(!(d=p.match(/(.*?)[= ]+(.*)/))||!d[2]){syntax(1,err_bad_val_s,"m:");continue}mac[d[1]]=d[2],maci[d[1].charCodeAt(0)]=1;break;case"s":if(3!=parse.state||cfmt.writefields.indexOf(c)<0)break;get_sym(p," "==w);break;case"w":if(3!=parse.state||cfmt.writefields.indexOf(c)<0)break;if(get_lyrics(p," "==w),"\\"==p.slice(-1)){w=" ",f=c;continue}break;case"|":if(parse.state<2)continue;parse.line.buffer=t.slice(r,s),parse_music_line();continue;default:if("ABCDFGHOSZ".indexOf(c)>=0){if(parse.state>=2){syntax(1,err_ign_s,c);continue}info[c]?info[c]+=w+p:info[c]=p;break}do_info(c,p);continue}w="\n",f=c}else{if(f=void 0,parse.state<2)continue;parse.line.buffer=t.slice(r,s),parse_music_line()}}else 1==parse.state?(parse.istart=r,syntax(1,"Empty line in tune header - ignored")):parse.state>=2&&(C(),parse.select&&((s=t.indexOf("\nX:",parse.eol))<0&&(s=E),parse.eol=s))}include||(parse.state>=2&&C(),parse.state=0)}Abc.prototype.tosvg=tosvg;var gene,staff_tb,nstaff,tsnext,realwidth,insert_meter,beta_last,space_tb=new Float32Array([7,10,14.15,20,28.3,40,56.6,80,100,120]),smallest_duration,dx_tb=new Float32Array([10,10,11,13,13]),hw_tb=new Float32Array([4.5,5,6,7,8]),w_note=new Float32Array([3.5,3.7,5,6,7]);function set_head_shift(e){var t,n,r,s,a,o,i=dx_tb[e.head],c=e.stem,l=e.nhd;if(0!=l){o=.78*i,e.grace&&(o*=.5),c>=0?(n=1,r=l+1,a=e.notes[0].pit):(o=-o,n=l-1,r=-1,a=e.notes[l].pit);var f=!1,u=0;for(t=n;t!=r;t+=c){if(s=e.notes[t].pit-a,a=e.notes[t].pit,0==s){if(f){var p=e.notes[t].shhd=e.notes[t-c].shhd+o;u<p&&(u=p);continue}if(t+c!=r&&a+c==e.notes[t+c].pit){e.notes[t].shhd=-o,u<-o&&(u=-o);continue}}s<0&&(s=-s),s>3||s>=2&&e.head!=SQUARE?f=!1:(f=!f)&&(e.notes[t].shhd=o,u<o&&(u=o))}e.xmx=u}}function acc_shift(e,t){var n,r,s,a,o,i,c,l=e.length;for(n=l-1;--n>=0;)if((s=e[n].shhd)&&!(s>0))for(s=t-s,o=e[n].pit,r=l;--r>=0;)if(e[r].acc){if((i=e[r].pit)<o-3)break;i>o+3||e[r].shac<s&&(e[r].shac=s)}for(n=l;--n>=0;)if(c=e[n].acc){for((s=e[n].shac)||(s=(s=e[n].shhd)<0?t-s:t),o=e[n].pit,r=l;--r>n;)e[r].acc&&((i=e[r].pit)>=o+4&&(i>o+4||c<0||e[r].acc<0)||s>e[r].shac-6&&(a=e[r].shac+7)>s&&(s=a));e[n].shac=s}}function set_acc_shft(){var e,t,n,r,s,a,o;for(e=tsfirst;e;)if(e.type!=NOTE||e.invis)e=e.ts_next;else{for(s=e.st,a=e.time,r=!1,t=e;t&&(t.time==a&&t.type==NOTE&&t.st==s);t=t.ts_next)if(!r)for(n=0;n<=t.nhd;n++)if(t.notes[n].acc){r=!0;break}if(r){for(o=dx_tb[e.head],s={notes:[]};e!=t;e=e.ts_next)s.notes=s.notes.concat(e.notes);sort_pitch(s),acc_shift(s.notes,o)}else e=t}}function lkvsym(e,t){e.next=t,e.prev=t.prev,e.prev?e.prev.next=e:e.p_v.sym=e,t.prev=e}function lktsym(e,t){t?(e.ts_next=t,e.ts_prev=t.ts_prev,e.ts_prev&&(e.ts_prev.ts_next=e),t.ts_prev=e):e.ts_next=e.ts_prev=null}function unlksym(e){e.next&&(e.next.prev=e.prev),e.prev?e.prev.next=e.next:e.p_v.sym=e.next,e.ts_next&&(e.seqst&&!e.ts_next.seqst&&(e.ts_next.seqst=!0,e.ts_next.shrink=e.shrink,e.ts_next.space=e.space),e.ts_next.ts_prev=e.ts_prev),e.ts_prev&&(e.ts_prev.ts_next=e.ts_next),tsfirst==e&&(tsfirst=e.ts_next),tsnext==e&&(tsnext=e.ts_next)}function may_combine(e){var t,n=e.ts_next;return!(!n||n.type!=NOTE&&n.type!=REST)&&(n.v!=e.v&&n.st==e.st&&n.time==e.time&&n.dur==e.dur&&(!(e.combine<=0&&n.type!=e.type)&&((!e.a_gch||!n.a_gch)&&(e.type==REST?!(e.type==n.type&&e.invis&&!n.invis):!(n.a_ly||n.sl1||n.sl2||n.slur_start||n.slur_end)&&(n.beam_st==e.beam_st&&n.beam_end==e.beam_end&&(t=n.nhd,!(e.combine<=1&&e.notes[0].pit<=n.notes[t].pit+1)))))))}function combine_notes(e,t){var n,r,s;if(e.notes=e.notes.concat(t.notes),e.nhd=n=e.notes.length-1,sort_pitch(e),e.combine>=3){for(s=n;s>0;s--)e.notes[s].pit==e.notes[s-1].pit&&e.notes[s].acc==e.notes[s-1].acc&&e.notes.splice(s,1);e.nhd=n=e.notes.length-1}e.ymx=3*(e.notes[n].pit-18)+4,e.ymn=3*(e.notes[0].pit-18)-4,(15&(r=e.notes[0].ti1))==SL_AUTO&&(e.notes[0].ti1=SL_BELOW|r&~SL_DOTTED),(15&(r=e.notes[n].ti1))==SL_AUTO&&(e.notes[n].ti1=SL_ABOVE|r&~SL_DOTTED)}function do_combine(e){for(var t;e.nhd,(t=e.ts_next).nhd,e.type!=t.type?t.type!=REST&&(e=(t=e).ts_next):e.type==REST?e.invis&&!t.invis&&delete e.invis:combine_notes(e,t),t.a_gch&&(e.a_gch=t.a_gch),t.a_dd&&(e.a_dd?e.a_dd=e.a_dd.concat(t.a_dd):e.a_dd=t.a_dd),unlksym(t),!e.in_tuplet&&may_combine(e););}function combine_voices(){var e,t;for(e=tsfirst;e;e=e.ts_next){switch(e.type){case REST:if(e.combine<0)continue;may_combine(e)&&do_combine(e);continue;default:continue;case NOTE:if(e.combine<=0)continue}if(e.beam_st)if(e.beam_end)may_combine(e)&&do_combine(e);else{for(t=e;;){if(!may_combine(t)){t=null;break}if(t.beam_end)break;do{t=t.next}while(t.type!=NOTE&&t.type!=REST)}if(t)for(t=e;do_combine(t),!t.beam_end;)do{t=t.next}while(t.type!=NOTE&&t.type!=REST)}}}function insert_clef(e,t,n){var r,s=e.p_v,a=e.st;for(e.type==BAR&&e.prev&&e.prev.type==BAR&&(e=e.prev),s.last_sym=e.prev,s.last_sym||(s.sym=null),s.time=e.time,(r=sym_add(s,CLEF)).next=e,e.prev=r,r.clef_type=t,r.clef_line=n,r.st=a,r.clef_small=!0,delete r.second,r.notes=[],r.notes[0]={pit:e.notes[0].pit},r.nhd=0;!e.seqst;)e=e.ts_prev;return lktsym(r,e),r.ts_prev.type!=CLEF&&(r.seqst=!0),r}function set_float(){var e,t,n,r,s,a,o,i;for(r=0;r<voice_tb.length;r++)for(n=!1,t=(e=voice_tb[r]).st,s=e.sym;s;s=s.next){if(!s.floating){for(;s&&!s.floating;)s=s.next;if(!s)break;n=!1}if(s.dur)if(s.notes[0].pit>=19)n=!1;else if(s.notes[s.nhd].pit<=12)n=!0,s.st++;else{for(o=127,a=s.ts_prev;a&&(a.st==t&&a.v!=s.v);a=a.ts_prev)a.type==NOTE&&a.notes[0].pit<o&&(o=a.notes[0].pit);if(127!=o)if(s.notes[s.nhd].pit>o-3)n=!1;else{for(i=-127,a=s.ts_next;a&&(a.st==t+1&&a.v!=s.v);a=a.ts_next)a.type==NOTE&&a.notes[a.nhd].pit>i&&(i=a.notes[a.nhd].pit);if(-127!=i)if(s.notes[0].pit<i+3)n=!0,s.st++;else{if(o-=s.notes[s.nhd].pit,i=s.notes[0].pit-i,n){if(o<i-3){n=!1;continue}}else{if(o<i+3)continue;n=!0}s.st++}else n&&s.st++}else n&&s.st++}else n&&s.st++}}function set_graceoffs(e){var t,n,r,s=Number(cfmt.gracespace[0]),a=Number(cfmt.gracespace[1]),o=Number(cfmt.gracespace[2]),i=0,c=e.extra;for(c.beam_st=!0;;c=c.next){for(set_head_shift(c),acc_shift(c.notes,7),r=0,n=c.nhd;n>=0;n--)c.notes[n].shac>r&&(r=c.notes[n].shac);if(i+=r,c.x=i,c.nflags<=0&&(c.beam_st=!0,c.beam_end=!0),!(t=c.next)){c.beam_end=!0;break}t.nflags<=0&&(c.beam_end=!0),c.beam_end&&(t.beam_st=!0,i+=a/4),c.nflags<=0&&(i+=a/4),c.y>t.y+8&&(i-=1.5),i+=a}return i+=s+o,(t=e.next)&&t.type==NOTE&&(c.y>=3*(t.notes[t.nhd].pit-18)?i-=1:c.beam_st&&c.y<3*(t.notes[0].pit-18)-7&&(i+=2)),i}function gchord_width(e,t,n){var r,s,a,o,i,c=0,l=0,f=0,u=0;for(i=0;i<e.a_gch.length;i++)switch((s=e.a_gch[i]).type){default:(o=-s.x)>c&&(c=o),(a=s.w+2-o)>l&&(l=a);break;case"<":(a=s.w+t)>f&&(f=a);break;case">":(a=s.w+e.wr)>u&&(u=a)}if(r=e.prev){if(r.a_gch)for(r=e.ts_prev;;r=r.ts_prev){if(r==e.prev){n<c&&(n=c);break}r.seqst&&(c-=r.shrink)}0!=f&&n<f&&(n=f)}if(r=e.next){if(r.a_gch)for(r=e.ts_next;;r=r.ts_next){if(r==e.next){e.wr<l&&(e.wr=l);break}r.seqst&&(l-=8)}0!=u&&e.wr<u&&(e.wr=f)}return n}function set_width(e){var t,n,r,s,a,o,i,c;switch(e.type){case NOTE:case REST:for(e.wr=o=hw_tb[e.head],e.xmx>0&&(e.wr+=e.xmx+4),t=e.prev;t&&0==w_tb[t.type];t=t.prev);if(t)switch(t.type){case BAR:case CLEF:case KEY:case METER:o+=3}for(r=0;r<=e.nhd;r++)if((s=e.notes[r].shhd)<0&&o<5-s&&(o=5-s),e.notes[r].acc){var l=e.notes[r].shac+(e.notes[r].micro?6.5:4.5);o<l&&(o=l)}if(t)switch(t.type){case BAR:case CLEF:case KEY:case METER:o-=3}if(e.a_dd&&(o+=deco_width(e)),e.beam_st&&e.beam_end&&e.stem>0&&e.nflags>0&&e.wr<e.xmx+9&&(e.wr=e.xmx+9),e.dots>0){switch(e.head){case SQUARE:e.xmx+=4;break;case OVALBARS:case OVAL:e.xmx+=2;break;case EMPTY:e.xmx+=1}e.wr<e.xmx+12&&(e.wr=e.xmx+12),e.dots>=2&&(e.wr+=3.5*(e.dots-1))}if(e.trem2&&e.beam_end&&o<20&&(o=20),i=o,t)switch(t.type){case NOTE:t.stem>0&&e.stem<0&&i<7&&(i=7),(e.y>27&&t.y>27||e.y<-3&&t.y<-3)&&i<6&&(i=6),t.ti1&&i<14&&(i=14);break;case CLEF:if(t.second||t.clef_small)break;i+=8;break;case KEY:i+=4}return e.a_gch&&(i=gchord_width(e,o,i)),e.a_ly&&(i=ly_width(e,i)),void(t&&t.type==GRACE?e.wl=o-4.5:e.wl=i);case SPACE:return s=e.width/2,e.wr=s,e.a_gch&&(s=gchord_width(e,s,s)),e.a_dd&&(s+=deco_width(e)),void(e.wl=s);case BAR:if(e.norepbra)break;if(e.invis)e.wl=e.wr=0;else{var f=e.bar_type;switch(f){case"|":a=7;break;case"|:":case":|":a=15;break;case"::":a=26;break;default:if(!f)break;for(a=4+3*f.length,n=0;n<f.length;n++)switch(f[n]){case"[":case"]":a+=3;break;case":":a+=2}}for(e.wl=a,e.next&&e.next.type!=METER?e.wr=7:e.wr=5,t=e.prev;t;t=t.prev)if(0!=w_tb[t.type]){t.type==GRACE&&(e.wl-=8);break}}return e.a_dd&&(e.wl+=deco_width(e)),void(e.text&&e.text.length<4&&e.next&&e.next.a_gch&&(set_font("repeat"),e.wr+=strw(e.text)+2));case CLEF:return void(e.wl=e.wr=e.clef_small?6:12);case KEY:var u,p,d;if(e.wl=3,d=4,e.k_a_acc){if(u=p=e.k_a_acc.length,p)var _=e.k_a_acc[0].acc;for(n=1;n<p;n++)(c=e.k_a_acc[n]).pit>e.k_a_acc[n-1].pit+6||c.pit<e.k_a_acc[n-1].pit-6?u--:c.acc!=_&&(d+=3),_=c.acc}else(u=e.k_sf)*(p=e.k_old_sf&&(cfmt.cancelkey||0==u)?e.k_old_sf:0)>=0?(u<0&&(u=-u),p<0&&(p=-p),p>u&&(u=p)):((u-=p)<0&&(u=-u),d+=3);return void(e.wr=5.5*u+d);case METER:for(a=0,n=0;n<e.a_meter.length;n++){var m=e.a_meter[n];"C|"==m.top?a+=6.5:!m.bot||m.top.length>m.bot.length?a+=6.5*m.top.length:a+=6.5*m.bot.length}return e.wl=a,void(e.wr=a+7);case MREST:return e.wl=6,void(e.wr=66);case GRACE:return e.wl=set_graceoffs(e),e.wr=0,void(e.a_ly&&ly_width(e,i));case STBRK:return e.wl=e.xmx,void(e.next&&e.next.type==CLEF?(e.wr=2,delete e.next.clef_small):e.wr=8);case CUSTOS:return void(e.wl=e.wr=4);case BLOCK:case PART:case REMARK:case STAVES:case TEMPO:break;default:error(2,e,"set_width - Cannot set width for symbol $1",e.type)}e.wl=e.wr=0}function set_space(e){var t,n,r,s,a=e.ts_prev.time,o=e.time-a;if(0==o){switch(e.type){case MREST:return e.wl}return 0}if(e.ts_prev.type==MREST)return 71;for(smallest_duration>=BASE_LEN/2?o/=smallest_duration>=BASE_LEN?4:2:!e.next&&o>=BASE_LEN&&(o/=2),r=o-(BASE_LEN/16/8<<(n=o>=BASE_LEN/4?o<BASE_LEN/2?5:o<BASE_LEN?6:o<2*BASE_LEN?7:o<4*BASE_LEN?8:9:o>=BASE_LEN/8?4:o>=BASE_LEN/16?3:o>=BASE_LEN/32?2:o>=BASE_LEN/64?1:0)),s=space_tb[n],0!=r&&(r<0?s=space_tb[0]*o/(BASE_LEN/16/8):(n>=9&&(n=8),s+=(space_tb[n+1]-space_tb[n])*r/o));!e.dur;){switch(e.type){case BAR:return.9*s-7;case CLEF:return s-e.wl;case BLOCK:case PART:case REMARK:case STAVES:case TEMPO:if(!(e=e.ts_next))return s;continue}break}if(e.beam_st||(s*=.9),e.type==NOTE&&e.nflags>=-1&&e.stem>0){var i=!0;for(t=e.ts_prev;t&&t.time==a;t=t.ts_prev)if(t.type==NOTE&&(t.nflags<-1||t.stem>0)){i=!1;break}if(i){for(t=e.ts_next;t&&t.time==e.time;t=t.ts_next)if(t.type==NOTE&&(t.nflags<-1||t.stem<0)){i=!1;break}i&&(s*=.9)}}return s}function add_end_bar(e){return{type:BAR,bar_type:"|",ctx:e.ctx,istart:e.istart,iend:e.iend,v:e.v,p_v:e.p_v,st:e.st,dur:0,seqst:!0,invis:!0,time:e.time+e.dur,nhd:0,notes:[{pit:e.notes[0].pit}],wl:0,wr:0}}function set_allsymwidth(e){for(var t,n=tsfirst,r=0,s=[];;){var a=r,o=n;do{e&&n.dur||set_width(n),(t=(s[n.st]||0)+n.wl)>a&&(a=t),n=n.ts_next}while(n!=e&&!n.seqst);if(o.shrink=a-r,o.ts_prev?o.space=set_space(o):o.space=0,0==o.shrink&&0==o.space&&o.type==CLEF&&(delete o.seqst,o.time=o.ts_prev.time),n==e)break;r=a,n=o;do{(!s[n.st]||s[n.st]<r+n.wr)&&(s[n.st]=r+n.wr),n=n.ts_next}while(!n.seqst)}}function to_rest(e){e.type=REST,delete e.in_tuplet,delete e.sl1,delete e.sl2,delete e.a_dd,delete e.a_gch,e.slur_start=e.slur_end=0}var err_no_s="Not enough notes/rests for %%repeat",err_no_m="Not enough measures for %%repeat";function set_repeat(e){var t,n,r,s,a,o=e.repeat_n,i=e.repeat_k,c=e.st,l=e.v;if(e.repeat_n=0,o<0){for(r=o=-o,n=e.prev;n;n=n.prev)if(n.dur){if(--r<=0)break}else if(n.type==BAR)return void error(1,n,"Bar in repeat sequence");if(!n)return void error(1,e,err_no_s);for(a=e.time-n.time,r=i*o,t=e;t;t=t.next)if(t.dur){if(--r<=0)break}else if(t.type==BAR)return void error(1,t,"Bar in repeat sequence");if(!t||!t.next)return void error(1,e,err_no_s);for(t=e.prev;t!=n;t=t.prev)if(t.type==NOTE){t.beam_end=!0;break}for(s=i;--s>=0;){for(r=o,e.dur&&r--,t=e.ts_next;r>0;)t.st==c&&(unlksym(t),t.v==l&&t.dur&&r--),t=t.ts_next;for(to_rest(e),e.dur=e.notes[0].dur=a,e.rep_nb=-1,e.beam_st=!0,set_width(e),e.seqst&&(e.space=set_space(e)),e.head=SQUARE,e=t;e&&(e.st!=c||e.v!=l||!e.dur);e=e.ts_next);}}else{for(r=o,t=e.prev.prev;t&&(t.type!=BAR&&t.time!=tsfirst.time||!(--r<=0));t=t.prev);if(t){for(a=e.time-t.time,r=1==o?i:o,t=e;t&&!(t.type==BAR&&--r<=0);t=t.next);if(t){if(r=i,2==o&&r>1){if(!(t=t.next))return void error(1,e,err_no_m);t.repeat_n=o,t.repeat_k=--r}if(a/=o,2==o){for(n=e,t=e.ts_next;;t=t.ts_next)if(t.st==c){if(t.v==l&&t.type==BAR)break;unlksym(t)}for(to_rest(n),n.dur=n.notes[0].dur=a,n.invis=!0,n.seqst&&(n.space=set_space(n)),t.bar_mrep=2,t.seqst&&(t.space=set_space(t)),t=(n=t.next).ts_next;;t=t.ts_next)if(t.st==c){if(t.v==l&&t.type==BAR)break;unlksym(t)}return to_rest(n),n.dur=n.notes[0].dur=a,n.invis=!0,set_width(n),n.seqst&&(n.space=set_space(n)),void(t.seqst&&(t.space=set_space(t)))}for(n=e,s=i;--s>=0;){for(t=n.ts_next;;t=t.ts_next)if(t.st==c){if(t.v==l&&t.type==BAR)break;unlksym(t)}if(to_rest(n),n.dur=n.notes[0].dur=a,n.beam_st=!0,n.seqst&&(n.space=set_space(n)),t.seqst&&(t.space=set_space(t)),1==i){n.rep_nb=1;break}n.rep_nb=i-s+1,n=t.next}}else error(1,e,err_no_m)}else error(1,e,err_no_m)}}function custos_add(e){for(var t,n,r,s=e;s.type!=NOTE;)if(!(s=s.next))return;for((t=e.p_v).last_sym=e.prev,t.time=e.time,(n=sym_add(t,CUSTOS)).next=e,e.prev=n,lktsym(n,e),n.seqst=!0,n.shrink=e.shrink,n.shrink<12&&(n.shrink=12),n.space=s.space,n.wl=0,n.wr=4,n.nhd=s.nhd,n.notes=[],r=0;r<e.notes.length;r++)n.notes[r]={pit:s.notes[r].pit,shhd:0,dur:BASE_LEN/4};n.stemless=!0}function set_nl(e){var t;function n(e){cfmt.custos&&1==voice_tb.length&&custos_add(e);for(var t=e.ts_next;t;t=t.ts_next)if(t.seqst){e.nl=!0;break}}function r(e){if(!e.next)return n(e),e;for(e=e.ts_next;e;e=e.ts_next)if(e.seqst){n(e);break}return e}if(e.eoln&&!cfmt.keywarn&&!cfmt.timewarn)return r(e);switch(e.type){case CLEF:case BAR:case STAVES:break;case KEY:if(cfmt.keywarn&&!e.k_none)break;return r(e);case METER:if(cfmt.timewarn)break;return r(e);case GRACE:if(!(e=e.next))return e;default:return r(e)}for(;e;e=e.ts_prev)if(e.seqst){switch(e.type){case KEY:case CLEF:case METER:continue}break}for(t=0;;e=e.ts_next){if(!e)return e;if(e.seqst){if(t<0)break;switch(e.type){case STAVES:if(e.ts_prev&&e.ts_prev.type==BAR)break;for(;e.ts_next&&(0==w_tb[e.ts_next.type]||e.ts_next.type==CLEF);)e=e.ts_next;if(!e.ts_next||e.ts_next.type!=BAR)continue;e=e.ts_next;case BAR:if(t)break;t=1;continue;case STBRK:e.stbrk_forced?t=-1:unlksym(e);continue;case METER:if(!cfmt.timewarn)break;continue;case CLEF:if(t)break;continue;case KEY:if(!cfmt.keywarn||e.k_none)break;continue;default:if(!t||e.prev&&e.prev.type==GRACE)continue}break}}return n(e),e}function get_ck_width(){var e=voice_tb[0];return set_width(e.clef),set_width(e.key),set_width(e.meter),[e.clef.wl+e.clef.wr+e.key.wl+e.key.wr,e.meter.wl+e.meter.wr]}function get_width(e,t){var n,r,s=0,a=1-cfmt.maxshrink;do{if(e.seqst&&(n=e.shrink,(r=e.space)<n?s+=n:s+=n*cfmt.maxshrink+r*a,e.x=s),e==t)break;e=e.ts_next}while(e);return s}function set_lines(e,t,n,r){for(var s,a,o,i,c,l,f,u,p,d;t&&!t.eoln;t=t.ts_next);for(u=get_width(e,t)+r;;){if((p=Math.ceil(u/n))<=1)return t&&(t=set_nl(t)),t;for(a=s=e,f=(c=e.x-e.shrink-r)+n,l=c+u/p,c+=u/p*cfmt.breaklimit,e=e.ts_next;e!=t&&!(e.x&&(e.type==BAR&&(a=e),e.x>=c));e=e.ts_next);if(e==t)return t&&(t=set_nl(t)),t;for(d=!1,o=null;e!=t;e=e.ts_next)if(i=e.x){if(i>f)break;if(e.type==BAR){if(!(i<l)){(!o||l-o.x>e.x-l)&&(o=e);break}o=e}}if(o&&(e=o,d=!0),!d){var _=0,m=a.time;for(f-=8,e=a,o=null;e!=t;e=e.ts_next)if(e.beam_st&&_++,e.beam_end&&_>0&&_--,i=e.x){if(i+e.wr>=f)break;if(!_&&!e.in_tuplet){if((e.time-m)%(BASE_LEN/4)!=0){(!o||l-o.x>e.x-l)&&(o=e);break}o=e}}o&&(e=o,d=!0)}if(!d){for(o=e=a;e!=t;e=e.ts_next)if(i=e.x){if(!(i<l)){l-o.x>e.x-l&&(o=e);break}o=e}e=o}if(e.nl)for(error(0,e,"Line split problem - adjust maxshrink and/or breaklimit"),p=2,e=e.ts_next;e!=t&&!(e.x&&--p<=0);e=e.ts_next);if(!(e=set_nl(e))||t&&e.time>=t.time)break;u-=e.x-s.x,r=0}return e}function cut_tune(e,t){var n,r,s,a,o=tsfirst;if(0!=t&&(e-=s=set_indent(),t-=s),e-=(s=get_ck_width())[0],t+=s[1],cfmt.custos&&1==voice_tb.length&&(e-=12),cfmt.barsperstaff)for(s=cfmt.barsperstaff,n=o;n;n=n.ts_next)n.type!=BAR||!n.bar_num||--s>0||(n.eoln=!0,s=cfmt.barsperstaff);for(a=t,n=o;o;o=o.ts_next)if(o.seqst||o.eoln){if((a+=o.shrink)>e)n=set_lines(n,o,e,t);else{if(!o.eoln)continue;if(delete o.eoln,o.dur){for(r=o.ts_next;r&&!(r.seqst||r.dur<o.dur);r=r.ts_next);n=r&&!r.seqst?set_lines(n,o,e,t):set_nl(o)}else n=set_nl(o)}if(!n)break;n.ts_prev?(a=n.shrink,o=n.ts_prev,t=0):delete n.nl}}function set_yval(e){switch(e.type){case CLEF:if(e.second||e.invis){e.ymx=e.ymn=12;break}switch(e.y=6*(e.clef_line-1),e.clef_type){default:e.ymx=e.y+28,e.ymn=e.y-14;break;case"c":e.ymx=e.y+13,e.ymn=e.y-11;break;case"b":e.ymx=e.y+7,e.ymn=e.y-12}e.clef_small&&(e.ymx-=2,e.ymn+=2),e.ymx<26&&(e.ymx=26),e.ymn>-1&&(e.ymn=-1),e.clef_octave&&(e.clef_octave>0?e.ymx+=12:e.ymn-=12);break;case KEY:e.k_sf>2?e.ymx=34:e.k_sf>0?e.ymx=30:e.ymx=26,e.ymn=-2;break;default:e.ymx=26,e.ymn=-2}}function set_auto_clef(e,t,n){var r,s,a,o,i,c;for(a=12,s=20,r=t;r&&(r.type!=STAVES||r==t);r=r.ts_next)if(r.st==e)if(r.type==NOTE)r.notes[0].pit<s?s=r.notes[0].pit:r.notes[r.nhd].pit>a&&(a=r.notes[r.nhd].pit);else if(r.type==CLEF){if("a"!=r.clef_type)break;unlksym(r)}if(s>=19||s>=13&&"b"!=n)return"t";if(a<=13||a<=19&&"t"!=n)return"b";"a"==n&&(n=(a+s)/2>=16?"t":"b");var l=n,f=r,u=null;for(r=t;r!=f&&(r.type!=STAVES||r==t);r=r.ts_next)if(r.st==e&&r.type==NOTE){if(o=r.time,"t"==l){if(r.notes[0].pit>12||r.notes[r.nhd].pit>20){r.notes[0].pit>20&&(u=r);continue}if((i=r.ts_prev)&&i.time==o&&i.st==e&&i.type==NOTE&&i.notes[0].pit>=19)continue;if((i=r.ts_next)&&i.st==e&&i.time==o&&i.type==NOTE&&i.notes[0].pit>=19)continue}else{if(r.notes[0].pit<12||r.notes[r.nhd].pit<20){r.notes[r.nhd].pit<12&&(u=r);continue}if((i=r.ts_prev)&&i.time==o&&i.st==e&&i.type==NOTE&&i.notes[0].pit<=13)continue;if((i=r.ts_next)&&i.st==e&&i.time==o&&i.type==NOTE&&i.notes[0].pit<=13)continue}if(u){for(c=r,i=r.ts_prev;i!=u;i=i.ts_prev)if(i.st==e){if(i.type==BAR&&i.v==r.v){c=i;break}i.type==NOTE&&i.beam_st&&!i.p_v.second&&(c=i)}c.time!=u.time?(u=r,(i=insert_clef(c,l="t"==l?"b":"t","t"==l?2:4)).clef_auto=!0):u=r}else l=n="t"==l?"b":"t",u=r}return n}function set_clefs(){var e,t,n,r,s,a,o,i,c,l=new Array(nstaff),f=cur_sy,u=[];for(staff_tb=new Array(nstaff),n=0;n<=nstaff;n++)l[n]={autoclef:!0},staff_tb[n]={output:[],sc_out:[]};for(r=0;r<voice_tb.length;r++)s=voice_tb[r],f.voices[r].range<0||(n=f.voices[r].st,f.voices[r].second||(void 0!=s.stafflines&&(f.staves[n].stafflines=s.stafflines),s.staffscale&&(f.staves[n].staffscale=s.staffscale),f.voices[r].sep&&(f.staves[n].sep=f.voices[r].sep),f.voices[r].maxsep&&(f.staves[n].maxsep=f.voices[r].maxsep)),f.voices[r].second||s.clef.clef_auto||(l[n].autoclef=!1));for(r=0;r<voice_tb.length;r++)s=voice_tb[r],f.voices[r].range<0||f.voices[r].second||(n=f.voices[r].st,e=s.clef,l[n].autoclef&&(e.clef_type=set_auto_clef(n,tsfirst,e.clef_type),e.clef_line="t"==e.clef_type?2:4),l[n].clef=staff_tb[n].clef=e);for(n=0;n<=f.nstaff;n++)u[n]=3*(f.staves[n].stafflines.length-1);for(e=tsfirst;e;e=e.ts_next){switch(e.repeat_n&&set_repeat(e),e.type){case STAVES:for(f=e.sy,n=0;n<=nstaff;n++)l[n].autoclef=!0;for(r=0;r<voice_tb.length;r++)f.voices[r].range<0||(s=voice_tb[r],n=f.voices[r].st,f.voices[r].second||(void 0!=s.stafflines&&(f.staves[n].stafflines=s.stafflines),s.staffscale&&(f.staves[n].staffscale=s.staffscale),f.voices[r].sep&&(f.staves[n].sep=f.voices[r].sep),f.voices[r].maxsep&&(f.staves[n].maxsep=f.voices[r].maxsep)),(t=s.clef).clef_auto||(l[n].autoclef=!1));for(n=0;n<=f.nstaff;n++)u[n]=3*(f.staves[n].stafflines.length-1);for(r=0;r<voice_tb.length;r++)if(!(f.voices[r].range<0||f.voices[r].second))if(s=voice_tb[r],n=f.voices[r].st,(t=s.clef).clef_auto?i="t"==(o=set_auto_clef(n,e,l[n].clef?l[n].clef.clef_type:"a"))?2:4:(o=t.clef_type,i=t.clef_line),l[n].clef){if(o!=l[n].clef.clef_type||i!=l[n].clef.clef_line){for(a=e.ts_next;a&&(a.v!=r||a.st!=n);)a=a.ts_next;a&&(a.type!=CLEF&&(a=insert_clef(a,o,i),t.clef_auto&&(a.clef_auto=!0)),l[n].clef=s.clef=a)}}else t.clef_auto&&("a"!=t.type&&(s.clef=clone(s.clef)),s.clef.clef_type=o,s.clef.clef_line=i),staff_tb[n].clef=l[n].clef=s.clef;continue;default:e.mid=u[e.st];continue;case CLEF:}if("a"==e.clef_type&&(e.clef_type=set_auto_clef(e.st,e.ts_next,l[e.st].clef.clef_type),e.clef_line="t"==e.clef_type?2:4),(s=e.p_v).clef=e,e.second)unlksym(e);else{if(l[n=e.st].clef){if(e.clef_type==l[n].clef.clef_type&&e.clef_line==l[n].clef.clef_line)continue}else staff_tb[n].clef=e;l[n].clef=e}}for(f=cur_sy,r=0;r<voice_tb.length;r++)if(!(f.voices[r].range<0)&&(t=voice_tb[r].sym)&&127==t.notes[0].pit){switch(n=f.voices[r].st,staff_tb[n].clef.clef_type){default:c=22;break;case"c":c=16;break;case"b":c=10}for(e=t;e;e=e.next)e.notes[0].pit=c}}var delta_tb={t:-4,c:0,b:4,p:-6},rest_sp=[[18,18],[12,18],[12,12],[0,12],[6,8],[10,10],[6,4],[10,0],[10,4],[10,10]];function set_pitch(e){var t,n,r,s,a,o=BASE_LEN,i=new Array(nstaff);for(r=0;r<=nstaff;r++)t=staff_tb[r].clef,i[r]=delta_tb[t.clef_type]+2*t.clef_line,t.clefpit&&(i[r]+=t.clefpit),cfmt.sound?t.clef_octave&&!t.clef_oct_transp&&(i[r]+=t.clef_octave):t.clef_oct_transp&&(i[r]-=t.clef_octave);for(t=tsfirst;t!=e;t=t.ts_next)switch(r=t.st,t.type){case CLEF:i[r]=delta_tb[t.clef_type]+2*t.clef_line,t.clefpit&&(i[r]+=t.clefpit),cfmt.sound?t.clef_octave&&!t.clef_oct_transp&&(i[r]+=t.clef_octave):t.clef_oct_transp&&(i[r]-=t.clef_octave),set_yval(t);break;case GRACE:for(n=t.extra;n;n=n.next){if(0!=(s=i[n.st])&&!t.p_v.key.k_drum)for(a=0;a<=n.nhd;a++)n.notes[a].pit+=s;n.ymn=3*(n.notes[0].pit-18)-2,n.ymx=3*(n.notes[n.nhd].pit-18)+2}set_yval(t);break;case KEY:t.k_y_clef=i[r];default:set_yval(t);break;case MREST:if(t.invis)break;t.y=12,t.ymx=39,t.ymn=-2;break;case REST:if(1==voice_tb.length){t.y=12,t.ymx=24,t.ymn=0;break}case NOTE:if(0!=(s=i[r])&&!t.p_v.key.k_drum)for(a=t.nhd;a>=0;a--)t.notes[a].pit+=s;t.type==NOTE?(t.ymx=3*(t.notes[t.nhd].pit-18)+4,t.ymn=3*(t.notes[0].pit-18)-4):(t.y=6*((t.notes[0].pit-18)/2|0),t.ymx=t.y+rest_sp[5-t.nflags][0],t.ymn=t.y-rest_sp[5-t.nflags][1]),t.dur<o&&(o=t.dur)}e||(smallest_duration=o)}function set_stem_dir(){for(var e,t,n,r,s,a,o,i,c,l,f=[],u=tsfirst,p=cur_sy,d=p.nstaff;u;){for(r=0;r<=d;r++)f[r]=[];for(l=[],t=u;t&&t.type!=BAR;t=t.ts_next)if(t.type!=STAVES){if(!(t.type!=NOTE&&t.type!=REST||t.invis)){if((r=t.st)>d){var _="*** fatal set_stem_dir(): bad staff number "+r+" max "+d;throw error(2,null,_),new Error(_)}for((o=l[a=t.v])||(o={st1:-1,st2:-1},l[a]=o),o.st1<0?o.st1=r:o.st1!=r&&(r>o.st1?r>o.st2&&(o.st2=r):(o.st1>o.st2&&(o.st2=o.st1),o.st1=r)),i=f[r],s=p.voices[a].range,n=i.length;--n>=0&&(c=i[n]).v!=s;);if(n<0){for(c={v:s,ymx:0,ymn:24},n=0;n<i.length;n++)if(s<i[n].v){i.splice(n,0,c);break}n==i.length&&i.push(c)}t.type==NOTE&&(t.ymx>c.ymx&&(c.ymx=t.ymx),t.ymn<c.ymn&&(c.ymn=t.ymn),t.xstem&&(t.ts_prev.st!=r-1||t.ts_prev.type!=NOTE?(error(1,u,"Bad !xstem!"),t.xstem=!1):(t.ts_prev.multi=1,t.multi=1,t.stemless=!0)))}}else{if(t!=u)break;for(p=u.sy,r=d;r<=p.nstaff;r++)f[r]=[];d=p.nstaff}for(;u!=t;u=u.ts_next)if(!u.multi&&(u.type==NOTE||u.type==REST||u.type==GRACE))if(r=u.st,o=l[a=u.v],i=f[r],o&&o.st2>=0)r==o.st1?u.multi=-1:r==o.st2&&(u.multi=1);else if(i.length<=1)u.floating&&(u.multi=r==voice_tb[a].st?-1:1);else{for(s=p.voices[a].range,n=i.length;--n>=0&&i[n].v!=s;);n<0||(n==i.length-1?u.multi=-1:(u.multi=1,0!=n&&n+2==i.length&&(i[n].ymn-cfmt.stemheight>i[n+1].ymx&&(u.multi=-1),e=u.ts_next,u.ts_prev&&u.ts_prev.time==u.time&&u.ts_prev.st==u.st&&u.notes[u.nhd].pit==u.ts_prev.notes[0].pit&&u.beam_st&&u.beam_end&&(!e||e.st!=u.st||e.time!=u.time)&&(u.multi=-1))))}for(;u&&u.type==BAR;)u=u.ts_next}}function set_rest_offset(){var e,t,n,r,s,a,o,i,c,l,f,u=[],p=cur_sy;for(e=tsfirst;e;e=e.ts_next)if(!e.invis&&(e.type==STAVES&&(p=e.sy),e.dur&&((a=u[e.v])||(a={},u[e.v]=a),a.s=e,a.st=e.st,a.end_time=e.time+e.dur,e.type==REST))){for(i=-127,o=127,s=l=!1,n=0;n<=u.length;n++)(a=u[n])&&a.s&&a.st==e.st&&n!=e.v&&(a.end_time<=e.time||(s=!0,t=a.s,p.voices[n].range<p.voices[e.v].range?t.time==e.time?t.ymn<o&&(o=t.ymn,t.dots&&(l=!0)):t.y<o&&(o=t.y):t.time==e.time?t.ymx>i&&(i=t.ymx,t.dots&&(l=!0)):t.y>i&&(i=t.y)));for(r=e.time+e.dur,t=e.ts_next;t&&!(t.time>=r);t=t.ts_next)t.st==e.st&&t.dur&&!t.invis&&(s=!0,p.voices[t.v].range<p.voices[e.v].range?t.time==e.time?t.ymn<o&&(o=t.ymn,t.dots&&(l=!0)):t.y<o&&(o=t.y):t.time==e.time?t.ymx>i&&(i=t.ymx,t.dots&&(l=!0)):t.y>i&&(i=t.y));if(s)if(127==o&&e.y<12&&(c=12-e.y,e.y+=c,e.ymx+=c,e.ymn+=c),-127==i&&e.y>12&&(c=e.y-12,e.y-=c,e.ymx-=c,e.ymn-=c),(c=o-e.ymx)<0){if(c=6*Math.ceil(-c/6),e.ymn-c>=i){e.y-=c,e.ymx-=c,e.ymn-=c;continue}f=l?15:10,e.notes[0].shhd=f,e.xmx=f}else if((c=i-e.ymn)>0){if(c=6*Math.ceil(c/6),e.ymx+c<=o){e.y+=c,e.ymx+=c,e.ymn+=c;continue}f=l?15:10,e.notes[0].shhd=f,e.xmx=f}else;else e.y=12,e.ymx=24,e.ymn=0}}function new_sym(e,t,n){var r={type:e,ctx:n.ctx,v:t.v,p_v:t,st:t.st,time:n.time,next:t.last_sym.next};return r.next&&(r.next.prev=r),t.last_sym.next=r,r.prev=t.last_sym,t.last_sym=r,lktsym(r,n),r.ts_prev.type!=e&&(r.seqst=!0),n.type==e&&r.v!=n.v&&(delete n.seqst,n.shrink=0),r}function init_music_line(){var e,t,n,r,s,a,o=voice_tb.length;for(s=0;s<o;s++)if(!(cur_sy.voices[s].range<0)){for((e=voice_tb[s]).second=cur_sy.voices[s].second,a=cur_sy.voices[s].st;a<nstaff&&!cur_sy.st_print[a];)a++;e.st=a}for(r=tsfirst;r.type==CLEF;)s=r.v,cur_sy.voices[s].range>=0&&!cur_sy.voices[s].second&&(delete r.clef_small,(e=r.p_v).last_sym=e.sym=r),r=r.ts_next;for(s=0;s<o;s++)(e=voice_tb[s]).sym&&e.sym.type==CLEF||cur_sy.voices[s].range<0||cur_sy.voices[s].second&&!e.bar_start||(a=cur_sy.voices[s].st,staff_tb[a]&&staff_tb[a].clef&&((t=clone(staff_tb[a].clef)).v=s,t.p_v=e,t.st=a,t.time=tsfirst.time,t.prev=null,t.next=e.sym,t.next&&(t.next.prev=t),e.sym=t,e.last_sym=t,t.ts_next=r,t.ts_prev=r?r.ts_prev:null,t.ts_prev?(t.ts_prev.ts_next=t,delete t.seqst):(tsfirst=t,t.seqst=!0),r&&(r.ts_prev=t,r.type==CLEF&&delete r.seqst),delete t.clef_small,t.second=cur_sy.voices[s].second,cur_sy.st_print[a]||(t.invis=!0)));for(s=0;s<o;s++)cur_sy.voices[s].range<0||cur_sy.voices[s].second||!cur_sy.st_print[cur_sy.voices[s].st]||(e=voice_tb[s],r&&r.v==s&&r.type==KEY?(e.last_sym=r,r.k_old_sf=r.k_sf,r=r.ts_next):((n=e.key).k_sf||n.k_a_acc)&&((t=new_sym(KEY,e,r)).k_sf=n.k_sf,t.k_old_sf=n.k_sf,t.k_none=n.k_none,t.k_a_acc=n.k_a_acc,t.istart=n.istart,t.iend=n.iend,n.k_bagpipe&&(t.k_bagpipe=n.k_bagpipe,"p"==t.k_bagpipe&&(t.k_old_sf=3))));if(1&insert_meter){for(s=0;s<o;s++)n=(e=voice_tb[s]).meter,cur_sy.voices[s].range<0||cur_sy.voices[s].second||!cur_sy.st_print[cur_sy.voices[s].st]||0==n.a_meter.length||(r&&r.v==s&&r.type==METER?(e.last_sym=r,r=r.ts_next):((t=new_sym(METER,e,r)).istart=n.istart,t.iend=n.iend,t.wmeasure=n.wmeasure,t.a_meter=n.a_meter));insert_meter&=-2}for(s=0;s<o;s++)e=voice_tb[s],r&&r.v==s&&r.type==BAR?(e.last_sym=r,r=r.ts_next):(n=e.bar_start)&&(e.bar_start=null,cur_sy.voices[s].range<0||!cur_sy.st_print[cur_sy.voices[s].st]||(n.next=e.last_sym.next,n.next&&(n.next.prev=n),e.last_sym.next=n,n.prev=e.last_sym,e.last_sym=n,lktsym(n,r),n.time=tsfirst.time,n.ts_prev.type!=n.type&&(n.seqst=!0),r&&r.type==n.type&&n.v!=r.v&&(delete r.seqst,r.shrink=0)));for(set_pitch(r),t=r;t;t=t.ts_next)if(t.seqst){for(t=t.ts_next;t&&!t.seqst;t=t.ts_next);break}set_allsymwidth(t)}function set_words(e){var t,n,r,s,a=!0,o=127;for(t=e.sym;t;t=t.next)if(t.type==NOTE){o=t.notes[0].pit;break}for(t=e.sym;t;t=t.next){switch(t.type){case MREST:a=!0;break;case BAR:t.beam_on||(a=!0),!t.next&&t.prev&&t.prev.head==OVALBARS&&(t.prev.head=SQUARE);break;case NOTE:case REST:if(t.trem2)break;r=t.nflags,t.ntrem&&(r+=t.ntrem),t.type==REST&&t.beam_end&&(t.beam_end=!1,a=!0),(a||r<=0)&&(s&&(s.beam_end=!0,s=null),r<=0?(t.beam_st=!0,t.beam_end=!0):t.type==NOTE&&(t.beam_st=!0,a=!1)),t.beam_end&&(a=!0),t.type==NOTE&&(s=t)}if(t.type==NOTE)for(0!=t.nhd&&sort_pitch(t),o=t.notes[0].pit,n=t.prev;n&&n.type==REST;n=n.prev)n.notes[0].pit=o;else t.notes||(t.notes=[],t.notes[0]={},t.nhd=0),t.notes[0].pit=o}s&&(s.beam_end=!0)}function set_rb(e){for(var t,n,r,s=e.sym;s;)if(s.type==BAR&&s.rbstart&&!s.norepbra){if(n=cfmt.rbmax,s.text&&"1"==s.text[0]){for(r=0,t=null,s=s.next;s;s=s.next)if(s.type==BAR){if(r++,s.rbstop){r<=cfmt.rbmax&&(n=r,t=null);break}r==cfmt.rbmin&&(t=s)}t&&(t.rbstop=1,n=cfmt.rbmin)}for(;s;){if(2!=s.rbstart){if(!(s=s.next))break;if(2!=s.rbstart){if(!(s=s.next))break;if(2!=s.rbstart)break}}for(r=0,t=null,s=s.next;s;s=s.next)if(s.type==BAR){if(r++,s.rbstop)break;s.next?r==n&&(s.rbstop=1):s.rbstop=2}}}else s=s.next}var delpit=[0,-7,-14,0];function set_global(){var e,t,n,r,s;for(t=(s=cur_sy).nstaff;s=s.next;)s.nstaff>t&&(t=s.nstaff);for(nstaff=t,r=voice_tb.length,n=0;n<r;n++)set_words(e=voice_tb[n]),set_rb(e);set_float(),set_clefs(),set_pitch(null)}function set_indent(e){var t,n,r,s,a,o,i,c,l=voice_tb.length,f=0;for(n=0;n<l;n++)if(s=voice_tb[n],!(cur_sy.voices[n].range<0)&&(t=cur_sy.voices[n].st,a=(e||s.new_name)&&s.nm?s.nm:s.snm))for(c||(c=get_font("voice"),gene.curfont=gene.deffont=c),o=0;(r=strw((i=a.indexOf("\\n",o))<0?a.slice(o):a.slice(o,i)))>f&&(f=r),!(i<0);)o=i+1;for(c&&(f+=4*cwid(" ")*c.swfac),r=0,t=0;t<=cur_sy.nstaff;t++){if(cur_sy.staves[t].flags&(OPEN_BRACE2|OPEN_BRACKET2)){r=16;break}cur_sy.staves[t].flags&(OPEN_BRACE|OPEN_BRACKET)&&(r=8)}return f+=r,e&&(f+=cfmt.indent),f}function set_beams(e){var t,n,r,s,a,o,i,c,l,f=-1;for(t=e;t;t=t.next)if(t.type==NOTE){if(t.stem||0!=(t.stem=t.multi))t.beam_st&&!t.beam_end&&(r=!0);else if(i=t.mid/3+18,r)t.stem=f;else if(t.beam_st&&!t.beam_end){for(r=!0,c=t.notes[t.nhd].pit,l=t.notes[0].pit,n=t.next;n;n=n.next)if(n.type==NOTE){if(n.stem||n.multi){t.stem=n.stem||n.multi;break}if(n.notes[n.nhd].pit>c&&(c=n.notes[n.nhd].pit),n.notes[0].pit<l&&(l=n.notes[0].pit),n.beam_end)break}n.beam_end&&((c+l)/2<i?t.stem=1:(c+l)/2>i?t.stem=-1:cfmt.bstemdown&&(t.stem=-1)),t.stem||(t.stem=f)}else{if((a=(t.notes[t.nhd].pit+t.notes[0].pit)/2)==i){for(a=0,o=0;o<=t.nhd;o++)a+=t.notes[o].pit;a/=t.nhd+1}a<i?t.stem=1:a>i?t.stem=-1:cfmt.bstemdown?t.stem=-1:t.stem=f}if(t.beam_end&&(r=!1),f=t.stem,s){for(n=s.extra;n;n=n.next)n.stem=-f;s.stem=-f,s=null}}else{if(t.type!=GRACE)continue;if(2==(n=t.extra).stem){s=t;continue}for(t.stem||0!=(t.stem=t.multi)||(t.stem=1);n;n=n.next)n.stem=t.stem,n.multi=t.multi}}function same_head(e,t){var n,r,s,a,o,i,c,l,f,u,p;if(e.shiftunison&&e.shiftunison>=3)return!1;if((s=e.dur)>=BASE_LEN)return!1;if((a=t.dur)>=BASE_LEN)return!1;if(e.stemless&&t.stemless)return!1;if(e.dots!=t.dots&&(e.shiftunison&&1&e.shiftunison||e.dots*t.dots!=0))return!1;if(e.stem*t.stem>0)return!1;if(n=r=0,e.notes[0].pit>t.notes[0].pit){if(e.stem<0)return!1;for(;t.notes[r].pit!=e.notes[0].pit;)if(++r>t.nhd)return!1}else if(e.notes[0].pit<t.notes[0].pit){if(t.stem<0)return!1;for(;t.notes[0].pit!=e.notes[n].pit;)if(++n>e.nhd)return!1}if(t.notes[r].acc!=e.notes[n].acc)return!1;i=n,l=r,u=e.notes[n].shhd,p=t.notes[r].shhd;do{if(r++,++n>e.nhd)break;if(r>t.nhd)break;if(t.notes[r].acc!=e.notes[n].acc)return!1;u<e.notes[n].shhd&&(u=e.notes[n].shhd),p<t.notes[r].shhd&&(p=t.notes[r].shhd)}while(t.notes[r].pit==e.notes[n].pit);if(n<=e.nhd){if(r<=t.nhd)return!1;if(t.stem>0)return!1}else if(r<=t.nhd&&e.stem>0)return!1;if(c=n,f=r,o=0,s!=a)if(s<a&&(s=a,a=e.dur),s<BASE_LEN/2)t.dots>0?o=2:e.dots>0&&(o=1);else{if(!(a<BASE_LEN/4))return!1;if(e.shiftunison&&2&e.shiftunison)return!1;o=t.dur>=BASE_LEN/2?2:1}if(0==o&&(o=e.p_v.scale<t.p_v.scale?2:1),1==o){for(r=l;r<f;r++)t.notes[r].invis=!0,delete t.notes[r].acc;for(r=0;r<=t.nhd;r++)t.notes[r].shhd+=u}else{for(n=i;n<c;n++)e.notes[n].invis=!0,delete e.notes[n].acc;for(n=0;n<=e.nhd;n++)e.notes[n].shhd+=p}return!0}function unison_acc(e,t,n,r){var s,a;if(t.notes[r].acc){for(a=2*w_note[e.head]+e.xmx+t.notes[r].shac+2,t.notes[r].micro&&(a+=2),e.dots&&(a+=6),s=0;s<=t.nhd;s++)t.notes[s].shhd+=a,t.notes[s].shac-=a;t.xmx+=a}else{for(a=2*w_note[t.head]+t.xmx+e.notes[n].shac+2,e.notes[n].micro&&(a+=2),t.dots&&(a+=6),s=0;s<=e.nhd;s++)e.notes[s].shhd+=a,e.notes[s].shac-=a;e.xmx+=a}}var MAXPIT=96;function set_left(e){var t,n,r,s,a=w_note[e.head],o=a,i=[];for(n=0;n<MAXPIT;n++)i.push(-100);if(e.nflags>-2)for(e.stem>0?(o=-o,n=2*e.notes[0].pit,r=2*(Math.ceil((e.ymx-2)/3)+18)):(n=2*(Math.ceil((e.ymn+2)/3)+18),r=2*e.notes[e.nhd].pit),n<0&&(n=0),r>=MAXPIT&&(r=MAXPIT-1);n<=r;)i[n++]=o;for(s=e.notes[e.stem>0?0:e.nhd].shhd,t=0;t<=e.nhd;t++)o=-e.notes[t].shhd+a+s,(n=2*e.notes[t].pit)<0?n=0:n>=MAXPIT-1&&(n=MAXPIT-2),o>i[n]&&(i[n]=o),e.head!=SQUARE&&(o-=1),o>i[n-1]&&(i[n-1]=o),o>i[n+1]&&(i[n+1]=o);return i}function set_right(e){var t,n,r,s,a,o=w_note[e.head],i=o,c=e.nflags>0&&e.beam_st&&e.beam_end,l=[];for(n=0;n<MAXPIT;n++)l.push(-100);if(e.nflags>-2)for(e.stem<0?(i=-i,n=2*(Math.ceil((e.ymn+2)/3)+18),r=2*e.notes[e.nhd].pit,s=n+4):(n=2*e.notes[0].pit,r=2*(Math.ceil((e.ymx-2)/3)+18)),n<0&&(n=0),r>MAXPIT&&(r=MAXPIT);n<r;)l[n++]=i;if(c)if(e.stem>0)for(n=0==e.xmx?2*e.notes[e.nhd].pit:2*e.notes[0].pit,(n+=4)<0&&(n=0);n<MAXPIT&&n<=r-4;n++)l[n]=11;else for((n=s)<0&&(n=0);n<MAXPIT&&n<=2*e.notes[0].pit-4;n++)l[n]=3.5;for(a=e.notes[e.stem>0?0:e.nhd].shhd,t=0;t<=e.nhd;t++)i=e.notes[t].shhd+o-a,(n=2*e.notes[t].pit)<0?n=0:n>=MAXPIT-1&&(n=MAXPIT-2),i>l[n]&&(l[n]=i),e.head!=SQUARE&&(i-=1),i>l[n-1]&&(l[n-1]=i),i>l[n+1]&&(l[n+1]=i);return l}function set_overlap(){var e,t,n,r,s,a,o,i,c,l,f,u,p,d,_,m,v,y,h,b,g,x,k;for(e=tsfirst;e;e=e.ts_next)if(e.type==NOTE&&!e.invis){if(e.xstem&&e.ts_prev.stem<0){for(n=e.ts_prev,i=0;i<=n.nhd;i++)n.notes[i].shhd+=7,n.notes[i].shac-=7;n.xmx+=7}for(n=e;n=n.ts_next;){if(n.time!=e.time){n=null;break}if(n.type==NOTE&&!n.invis&&n.st==e.st)break}if(n&&(t=e,cur_sy.voices[t.v].range<cur_sy.voices[n.v].range?n.dot_low=!0:t.dot_low=!0,!(t.ymn>n.ymx||t.ymx<n.ymn||same_head(t,n)))){if(y=set_right(t),h=set_left(n),(r=t.ts_prev)&&r.time==t.time&&r.st==t.st&&r.type==NOTE&&!r.invis)for(g=set_right(r),s=0;s<MAXPIT;s++)g[s]>y[s]&&(y[s]=g[s]);else r=null;for(u=-10,s=0;s<MAXPIT;s++)h[s]+y[s]>u&&(u=h[s]+y[s]);if(!(u<-3&&(!t.dots||!n.dots||!n.dot_low||t.stem>0||n.stem<0||t.notes[t.nhd].pit+2!=n.notes[0].pit||1&n.notes[0].pit))){if(b=set_right(n),v=set_left(t),r)for(g=set_left(r),s=0;s<MAXPIT;s++)g[s]>v[s]&&(v[s]=g[s]);for(p=d=_=-100,s=0;s<MAXPIT;s++)v[s]+b[s]>p&&(p=v[s]+b[s]),b[s]>_&&(_=b[s]),y[s]>d&&(d=y[s]);for(l=0,a=t.nhd,o=n.nhd;;){switch(f=t.notes[a].pit-n.notes[o].pit){case 0:if(t.notes[a].acc!=n.notes[o].acc){l=-1;break}n.notes[o].acc&&(n.notes[o].acc=0),t.dots&&n.dots&&1&t.notes[a].pit&&(l=1);break;case-1:t.dots&&n.dots&&(1&t.notes[a].pit?(t.dot_low=!1,n.dot_low=!1):(t.dot_low=!0,n.dot_low=!0));break;case-2:if(t.dots&&n.dots&&!(1&t.notes[a].pit)){t.dot_low=!1,n.dot_low=!1;break}}if(l<0)break;if(f>=0&&--a<0)break;if(f<=0&&--o<0)break}if(l<0)unison_acc(t,n,a,o);else{if(c=0,t.dots?n.dots&&(l||(c=1)):n.dots&&p+d<u+_&&(c=1),x=h,k=b,!r&&p+d<u+_&&(t=n,n=e,u=p,x=v,k=y,_=d),(u+=3)<0&&(u=0),i=t.stem>=0?0:t.nhd,u+=t.notes[i].shhd,i=n.stem>=0?0:n.nhd,u-=n.notes[i].shhd,t.dots)if(m=7.7+t.xmx+3.5*t.dots-3.5+3,c){if(m<u+_+n.xmx){for(p=0,a=0;a<=t.nhd;a++)1&(s=t.notes[a].pit)||(t.dot_low?s--:s++),(s*=2)<1?s=1:s>=MAXPIT-1&&(s=MAXPIT-2),k[s]>p&&(p=k[s]),k[s-1]+1>p&&(p=k[s-1]=1),k[s+1]+1>p&&(p=k[s+1]+1);p>4.5&&7.7+t.xmx+2<u+p+n.xmx&&(n.xmx=p+3-7.7)}}else{for(p=-100,a=0;a<=t.nhd;a++)1&(s=t.notes[a].pit)||(t.dot_low?s--:s++),(s*=2)<1?s=1:s>=MAXPIT-1&&(s=MAXPIT-2),x[s]>p&&(p=x[s]),x[s-1]+1>p&&(p=x[s-1]+1),x[s+1]+1>p&&(p=x[s+1]+1);m+p+2>u&&(u=m+p+2)}for(i=n.nhd;i>=0;i--)n.notes[i].shhd+=u;n.xmx+=u,c&&(t.xmx=n.xmx)}}}}}function set_stems(){var e,t,n,r,s,a,o,i,c,l;for(e=tsfirst;e;e=e.ts_next)if(e.type==NOTE){if(set_head_shift(e),i=e.nflags,e.beam_st&&!e.beam_end){for(e.feathered_beam&&(i=++e.nflags),t=e.next;t.type!=NOTE||(e.feathered_beam&&t.nflags++,!t.beam_end);t=t.next);t.nflags>i&&(i=t.nflags)}else if(!e.beam_st&&e.beam_end){for(t=e.prev;!t.beam_st;t=t.prev);t.nflags>i&&(i=t.nflags)}switch(r=cfmt.stemheight,i){case 2:r+=2;break;case 3:r+=5;break;case 4:r+=10;break;case 5:r+=16}1!=(s=e.p_v.scale)&&(r*=.5*(s+1)),a=3*(e.notes[0].pit-18),e.nhd>0?(r-=2,o=3*(e.notes[e.nhd].pit-18)):o=a,e.ntrem&&(r+=2*e.ntrem),e.stemless?(e.stem>=0?(e.y=a,e.ys=o):(e.ys=a,e.y=o),-4==i&&(a-=6),e.ymx=o+4,e.ymn=a-4):e.stem>=0?(i>=2&&(r-=1),e.notes[e.nhd].pit>26&&(i<=0||!e.beam_st||!e.beam_end)&&(r-=2,e.notes[e.nhd].pit>28&&(r-=2)),e.y=a,e.notes[0].ti1&&(a-=3),e.ymn=a-4,e.ys=o+r,e.ys<e.mid&&(e.ys=e.mid),e.ymx=e.ys+2.5|0):(e.notes[0].pit<18&&(i<=0||!e.beam_st||!e.beam_end)&&(r-=2,e.notes[0].pit<16&&(r-=2)),e.ys=a-r,e.ys>e.mid&&(e.ys=e.mid),e.ymn=e.ys-2.5|0,e.y=o,e.notes[e.nhd].ti1&&(o+=3),e.ymx=o+4)}else{if(e.type!=GRACE)continue;for(c=l=e.mid,n=e.extra;n;n=n.next)r=GSTEM,n.nflags>1&&(r+=1.2*(n.nflags-1)),a=3*(n.notes[0].pit-18),o=3*(n.notes[n.nhd].pit-18),e.stem>=0?(n.y=a,n.ys=o+r,o=Math.round(n.ys)):(n.y=o,n.ys=a-r,a=Math.round(n.ys)),o+=2,(a-=2)<c?c=a:o>l&&(l=o),n.ymx=o,n.ymn=a;e.ymx=l,e.ymn=c}}function check_bar(e){for(var t,n,r=e.p_v;e.type==CLEF||e.type==KEY||e.type==METER;)if(e.type==METER&&e.time>r.sym.time&&(insert_meter|=1),!(e=e.prev))return;if(e.type==BAR&&(void 0!=e.text&&(r.bar_start=clone(e),r.bar_start.bar_type="[",delete e.text,delete e.a_gch),":"!=(t=e.bar_type)&&":"==t.slice(-1))){if(r.bar_start||(r.bar_start=clone(e)),":"!=t[0])return"||:"==t?(r.bar_start.bar_type="|:",void(e.bar_type="||")):(r.bar_start.bar_type=t,void(e.prev&&e.prev.type==BAR?unlksym(e):e.bar_type="|"));if("::"==t)return r.bar_start.bar_type="|:",void(e.bar_type=":|");if("||:"==t)return r.bar_start.bar_type="|:",void(e.bar_type="||");for(n=0;":"==t[n];)n++;if(n<t.length){for(e.bar_type=t.slice(0,n)+"|",n=t.length-1;":"==t[n];)n--;r.bar_start.bar_type="|"+t.slice(n+1)}else n=t.length/2|0,e.bar_type=t.slice(0,n)+"|",r.bar_start.bar_type="|"+t.slice(n)}}function sym_staff_move(e){for(var t=tsfirst;t&&!t.nl;t=t.ts_next)t.st==e&&t.type!=CLEF&&(t.st++,t.invis=!0)}var blocks=[];function block_gen(e){switch(e.subtype){case"leftmargin":case"rightmargin":case"pagescale":case"pagewidth":case"scale":case"staffwidth":set_format(e.subtype,e.param);break;case"ml":svg_flush(),user.img_out(e.text);break;case"newpage":blk_flush(),block.newpage=!0,blk_out();break;case"sep":set_page(),vskip(e.sk1),output.push('<path class="stroke"\n\td="M'),out_sxsy(e.x," ",0),output.push("h"+e.l.toFixed(2)+'"/>\n'),vskip(e.sk2);break;case"text":write_text(e.text,e.opt);break;case"title":write_title(e.text,!0);break;case"vskip":vskip(e.sk);break;default:error(2,e,"Block $1 not treated",e.subtype)}}function set_piece(){var e,t,n,r,s,a,o,i=[],c=[],l=cur_sy;function f(e){var t=staff_tb[e],n=l.staves[e];t||(t=staff_tb[e]={}),t.y=0,t.stafflines=n.stafflines,t.staffscale=n.staffscale,t.ann_top=t.ann_bot=0}function u(){var e,t,n,r=l.staves.length;for(e=0;e<r;e++)if(l.staves[e].flags&(OPEN_BRACE|OPEN_BRACE2)){for(n=0,t=e;e<r&&(n|=i[e]?1:2,!(l.staves[e].flags&(CLOSE_BRACE|CLOSE_BRACE2)));)e++;if(3==n)for(;t<=e;)i[t]=!0,c[t++]=!0}}for(nstaff=a=l.nstaff,r=0;r<=a;r++)f(r);for(e=tsfirst;e&&!e.nl;e=e.ts_next){switch(e.ts_next||(t=e),e.type){case STAVES:if(u(),l.st_print=new Uint8Array(i),a=(l=e.sy).nstaff,nstaff<a){for(r=nstaff+1;r<=a;r++)f(r);nstaff=a}i=[];continue;case BLOCK:blocks.push(e),unlksym(e),t&&(t=e.ts_prev);continue}if(r=e.st,!i[r])switch(e.type){case CLEF:r>nstaff&&(staff_tb[r].clef=e,unlksym(e));break;case BAR:if(cfmt.staffnonote<=1)break;case GRACE:c[r]=i[r]=!0;break;case NOTE:case REST:case SPACE:case MREST:cfmt.staffnonote>1?c[r]=i[r]=!0:e.invis||0==cfmt.staffnonote&&e.type!=NOTE||(c[r]=i[r]=!0)}}for(tsnext=e,u(),l.st_print=new Uint8Array(i),function(){var e,t,n,r;for(e=0;e<=nstaff;e++)if(t=staff_tb[e],c[e]){for(r=t.stafflines.length,t.topbar=6*(r-1),n=0;n<r-1&&"."==t.stafflines[n];n++);t.botline=t.botbar=6*n,n>=r-2&&(t.botbar-=6,t.topbar+=6)}else t.botbar=t.topbar=0}(),r=0;r<nstaff;r++)c[r]||sym_staff_move(r);if(c[nstaff]||(staff_tb[nstaff].topbar=0),init_music_line(),gene.st_print=new Uint8Array(c),tsnext)for(delete(e=tsnext).nl,(t=e.ts_prev).ts_next=null,o=voice_tb.length,s=0;s<o;s++){if((n=voice_tb[s]).sym&&n.sym.time<=tsnext.time){for(e=tsnext.ts_prev;e;e=e.ts_prev)if(e.v==s){n.s_next=e.next,e.next=null,check_bar(e);break}if(e)continue}n.s_next=n.sym,n.sym=null}t.type!=BAR&&((e=add_end_bar(t)).prev=e.ts_prev=t,t.ts_next=t.next=e,e.shrink=t.wr+2,e.space=set_space(e),e.space<e.shrink&&(e.space=e.shrink))}function set_sym_glue(e){for(var t,n,r,s,a,o,i,c=tsfirst,l=0,f=0;c.type!=GRACE||i||(i=c),c.seqst&&(t=c.space,l+=c.shrink,t<c.shrink&&(t=c.shrink),f+=t),c.ts_next;)c=c.ts_next;if(0!=f){for(o=f,cfmt.stretchstaff&&(o*=1.8),1,tsnext?f>=e?beta_last=0:(beta_last=(e-f)/(o-f))>1&&(cfmt.stretchstaff?cfmt.linewarn&&error(0,c,"Line underfull ($1pt of $2pt)",(1*o+0*f).toFixed(2),e.toFixed(2)):(e=f,beta_last=0)):f<e&&(r=(e-f)/(o-f))>=beta_last&&(r=beta_last*o+(1-beta_last)*f)<e*(1-cfmt.stretchlast)&&(e=r),a=e/f,f=o=0,c=tsfirst;c.seqst&&(t=c.shrink,0!=c.space&&(o+=c.space*a*1.8),f+=t,o+=t,c.x=f,c.xmax=o),c.ts_next;)c=c.ts_next;if(f>=e?(r=0,f==l?n=1:(n=(f-e)/(f-l))>1&&error(1,c,"Line too much shrunk $1 $2 $3",l.toFixed(2),f.toFixed(2),e.toFixed(2)),realwidth=l*n+f*(1-n)):(n=0,(r=o>f?(e-f)/(o-f):1)>1&&(cfmt.stretchstaff||(r=0)),realwidth=o*r+f*(1-r)),c=tsfirst,0!=n)if(n<1)for(f=l=0;c;c=c.ts_next)c.seqst&&(f=(l+=c.shrink*n)+c.x*(1-n)),c.x=f;else for(n=realwidth/f,f=0;c;c=c.ts_next)c.seqst&&(f=c.x*n),c.x=f;else for(f=0;c;c=c.ts_next)c.seqst&&(f=c.xmax*r+c.x*(1-r)),c.x=f;for(c=i;c;c=c.ts_next)if(c.type==GRACE)for(f=c.gr_shift?c.prev.x+c.prev.wr+Number(cfmt.gracespace[0]):c.x-c.wl+Number(cfmt.gracespace[0]),s=c.extra;s;s=s.next)s.x+=f}else realwidth=0}function set_sym_line(){var e,t,n,r=voice_tb.length;for(n=0;n<r;n++)t=(e=voice_tb[n]).s_next,e.sym=t,t&&(t.prev=null)}function set_posx(){posx=img.lm/cfmt.scale}function gen_init(){for(var e=tsfirst,t=e.time;e;e=e.ts_next){if(e.time!=t)return void set_page();switch(e.type){case NOTE:case REST:case MREST:return void set_page();default:continue;case STAVES:cur_sy=e.sy;break;case BLOCK:block_gen(e)}unlksym(e),e.p_v.s_next==e&&(e.p_v.s_next=e.next)}tsfirst=null}function output_music(){var e,t,n,r,s;if(gen_init(),tsfirst){for(set_global(),voice_tb.length>1&&(combine_voices(),set_stem_dir()),t=0;t<voice_tb.length;t++)set_beams(voice_tb[t].sym);for(set_stems(),voice_tb.length>1&&(set_rest_offset(),set_overlap()),set_acc_shft(),set_allsymwidth(null),r=set_indent(!0),cfmt.singleline?(n=r+(t=get_ck_width())[0]+t[1]+get_width(tsfirst,null),img.width=n*cfmt.scale+img.lm+img.rm+2):cut_tune(n=get_lwidth(),r),beta_last=0;;){if(set_piece(),set_sym_glue(n-r),0!=realwidth)for(0!=r&&(posx+=r),e=output,output=void 0,draw_sym_near(),output=e,s=set_staff(),delayed_update(),draw_systems(r),draw_all_sym(),vskip(s),0!=r&&(posx-=r,insert_meter&=-3);0!=blocks.length;)block_gen(blocks.shift());if(tsfirst=tsnext,svg_flush(),!tsnext)break;if(gen_init(),!tsfirst)break;tsfirst.ts_prev=null,set_sym_line(),n=get_lwidth(),r=set_indent()}}}function reset_gen(){insert_meter=cfmt.writefields.indexOf("M")>=0?3:2}var a_gch,a_dcn,multicol,maps={},not_ascii="Not an ASCII character",bar_grace="Cannot have a bar in grace notes",qplet_tb=new Int8Array([0,1,3,2,3,0,2,0,3,0]),ntb="CDEFGABcdefgab";function set_ref(e){e.ctx=parse.ctx,e.istart=parse.istart,e.iend=parse.iend}function new_clef(e){var t={type:CLEF,clef_line:2,clef_type:"t",v:curvoice.v,p_v:curvoice,time:curvoice.time,dur:0},n=1;switch(set_ref(t),e[0]){case'"':n=e.indexOf('"',1),t.clef_name=e.slice(1,n),n++;break;case"a":if("u"==e[1]){t.clef_type="a",t.clef_auto=!0,n=4;break}n=4;case"C":t.clef_type="c",t.clef_line=3;break;case"b":n=4;case"F":t.clef_type="b",t.clef_line=4;break;case"n":n=4,t.invis=!0;break;case"t":if("e"==e[1]){t.clef_type="c",t.clef_line=4;break}n=6;case"G":break;case"p":n=4;case"P":t.clef_type="p",t.clef_line=3;break;default:return void syntax(1,"Unknown clef '$1'",e)}if(e[n]>="1"&&e[n]<="9"&&(t.clef_line=Number(e[n]),n++),"8"!=e[n+1])return t;switch(e[n]){case"^":t.clef_oct_transp=!0;case"+":t.clef_octave=7;break;case"_":t.clef_oct_transp=!0;case"-":t.clef_octave=-7}return t}function get_transp(e,t){var n,r,s,a,o=[];if("0"==e[0])return 0;if("123456789-+".indexOf(e[0])>=0){if(r=3*parseInt(e),isNaN(r)||r<-108||r>108)return void syntax(1,"Bad transpose value");switch(e.slice(-1)){default:return r;case"#":r++;break;case"b":r+=2}return r>0?r:r-3}if("instr"==t)if(s=e.indexOf("/"),cfmt.sound)e=s<0?"c"+e:e.replace(/.*\//,"c");else{if(s<0)return 0;e=e.replace("/","")}for((s=new scanBuf).buffer=e,n=0;n<2;n++){if(!(a=parse_acc_pit(s)))return void syntax(1,"Bad transpose value");a.pit+=124,r=12*(a.pit/7|0)+note_pit[a.pit%7],a.acc&&3!=a.acc&&(r+=a.acc),o[n]=r}if(cfmt.sound&&(o[0]=252),r=3*(o[1]-o[0]),a)switch(a.acc){default:return r;case 2:case 1:r++;break;case-1:case-2:r+=2}return r>0?r:r-3}function set_linebreak(e){var t,n;for(t=0;t<128;t++)"\n"==char_tb[t]&&(char_tb[t]=nil);for(e=e.split(/\s+/),t=0;t<e.length;t++){switch(n=e[t]){case"!":case"$":case"*":case";":case"?":case"@":break;case"<none>":continue;case"<EOL>":n="\n";break;default:syntax(1,"Bad value '$1' in %%linebreak - ignored",n);continue}char_tb[n.charCodeAt(0)]="\n"}}function set_user(e){var t,n,r,s=e.match(/(.*?)[= ]*([!"].*[!"])/);if(s)if(n=s[1],(r=s[2]).slice(-1)==r[0])if("\\"==n[0]&&("t"==n[1]?n="\t":n[1]||(n=" ")),(t=n.charCodeAt(0))>=128)syntax(1,not_ascii);else{switch(char_tb[t][0]){case"0":case"d":case"i":case" ":break;case'"':case"!":if(char_tb[t].length>1)break;default:return void syntax(1,"Bad user character '$1'",n)}switch(r){case"!beambreak!":r=" ";break;case"!ignore!":r="i";break;case"!nil!":case"!none!":r="d"}char_tb[t]=r}else syntax(1,"Lack of ending $1 in U:/%%user",r[0]);else syntax(1,'Lack of starting ! or " in U: / %%user')}function get_st_lines(e){var t,n;if(e){if(e.match(/^[\]\[|.]+$/))return e.replace(/\]/g,"[");switch(t=parseInt(e)){case 0:return"...";case 1:return"..|";case 2:return".||";case 3:return".|||"}if(!(isNaN(t)||t<0||t>16)){for(n="|";--t>0;)n+="|";return n}}}function new_block(e){var t={type:BLOCK,subtype:e,dur:0};2==parse.state&&goto_tune();var n=curvoice;return curvoice=voice_tb[par_sy.top_voice],sym_link(t),curvoice=n,t}function set_kv_parm(e){var t,n,r,s,a;if(curvoice.init||(curvoice.init=!0,info.V&&(info.V["*"]&&(e=info.V["*"].concat(e)),info.V[curvoice.id]&&(e=info.V[curvoice.id].concat(e)))),0==e.length)return 0;for(;n=e.shift();){if("="==n[n.length-1]&&!e[0]){syntax(1,err_bad_val_s,n);break}switch(n){case"clef=":t=e.shift();break;case"clefpitch=":if((n=e.shift())&&(s=ntb.indexOf(n[0]))>=0){switch(n[1]){case"'":s+=7;break;case",":s-=7,","==n[2]&&(s-=7)}a=4-s;break}syntax(1,err_bad_val_s,n);break;case"combine=":case"octave=":case"uscale=":s=parseInt(e.shift()),isNaN(s)?syntax(1,err_bad_val_s,n):curvoice[n.slice(0,-1)]=s;break;case"cue=":curvoice.scale="on"==e.shift()?.7:1;break;case"instrument=":curvoice.transp=get_transp(e.shift(),"instr");break;case"map=":n=n.slice(0,-1),curvoice[n]=e.shift();break;case"name=":case"nm=":curvoice.nm=e.shift(),'"'==curvoice.nm[0]&&(curvoice.nm=curvoice.nm.slice(1,-1)),curvoice.new_name=!0;break;case"stem=":n="stm=";case"dyn=":case"gch=":case"gst=":case"orn=":case"stm=":case"voc=":case"vol=":if(void 0==(s=posval[e.shift()])){syntax(1,err_bad_val_s,n);break}n=n.slice(0,-1),r||(r={}),r[n]=s;break;case"scale=":do_pscom("voicescale "+e.shift());break;case"score=":if(cfmt.sound)break;(n=e.shift()).indexOf("/")<0&&(n+="/c"),curvoice.transp=get_transp(n);break;case"shift=":curvoice.shift=get_transp(e.shift());break;case"sound=":case"transpose=":if(!cfmt.sound)break;curvoice.transp=get_transp(e.shift());break;case"subname=":case"sname=":case"snm=":curvoice.snm=e.shift(),'"'==curvoice.snm[0]&&(curvoice.snm=curvoice.snm.slice(1,-1));break;case"stafflines=":do_pscom("stafflines "+e.shift());break;case"staffscale=":do_pscom("staffscale "+e.shift());break;default:switch(n.slice(0,4)){case"treb":case"bass":case"alto":case"teno":case"perc":t=n;break;default:"GFC".indexOf(n[0])>=0?t=n:"="==n.slice(-1)&&e.shift()}}}if(r)for(n in curvoice.pos=clone(curvoice.pos),r)r.hasOwnProperty(n)&&(curvoice.pos[n]=r[n]);t&&(t=new_clef(t))&&(a&&(t.clefpit=a),get_clef(t))}function memo_kv_parm(e,t){0!=t.length&&(info.V||(info.V={}),info.V[e]?Array.prototype.push.apply(info.V[e],t):info.V[e]=t)}function new_key(e){var t,n,r,s,a=0,o={type:KEY,k_delta:0,dur:0};switch(set_ref(o),t=1,e[0]){case"A":o.k_sf=3;break;case"B":o.k_sf=5;break;case"C":o.k_sf=0;break;case"D":o.k_sf=2;break;case"E":o.k_sf=4;break;case"F":o.k_sf=-1;break;case"G":o.k_sf=1;break;case"H":switch(e[1]){case"P":o.k_bagpipe="P",t++;break;case"p":o.k_bagpipe="p",o.k_sf=2,t++;break;default:syntax(1,"Unknown bagpipe-like key")}n=!0;break;case"P":o.k_drum=!0,n=!0;break;case"n":0==e.indexOf("none")&&(o.k_sf=0,o.k_none=!0,t=4);default:n=!0}if(!n){switch(e[t]){case"#":o.k_sf+=7,t++;break;case"b":o.k_sf-=7,t++}switch((e=e.slice(t).trim()).slice(0,3).toLowerCase()){case"aeo":case"m":case"min":o.k_sf-=3,a=5;break;case"dor":o.k_sf-=2,a=1;break;case"ion":case"maj":break;case"loc":o.k_sf-=5,a=6;break;case"lyd":o.k_sf+=1,a=3;break;case"mix":o.k_sf-=1,a=4;break;case"phr":o.k_sf-=4,a=2;break;default:if("m"==e[0]&&(" "==e[1]||"\t"==e[1]||"\n"==e[1])){o.k_sf-=3,a=5;break}n=!0}if(n||(e=e.replace(/\w+\s*/,"")),0==e.indexOf("exp ")&&((e=e.replace(/\w+\s*/,""))||syntax(1,"No accidental after 'exp'"),o.k_exp=!0),"^"==(r=e[0])||"_"==r||"="==r){o.k_a_acc=[],(s=new scanBuf).buffer=e;do{var i=parse_acc_pit(s);if(!i)return[o,null];for(o.k_a_acc.push(i),r=e[s.index];" "==r;)r=e[++s.index]}while("^"==r||"_"==r||"="==r);e=e.slice(s.index)}else o.k_exp&&0==e.indexOf("none")&&(o.k_sf=0,e=e.replace(/\w+\s*/,""))}return o.k_delta=cgd2cde[(o.k_sf+7)%7],o.k_mode=a,[o,info_split(e,0)]}function new_meter(e){var t,n,r,s,a,o,i={type:METER,dur:0,a_meter:[]},c={},l=0,f=0,u=e;if(set_ref(i),0==u.indexOf("none"))f=4,a=1;else for(a=0;f<e.length&&"="!=u[f];){switch(u[f]){case"C":c.top=u[f++],"|"==u[f]&&(c.top+=u[f++]),l=4,r=4;break;case"c":case"o":l="c"==u[f]?4:3,r=4,c.top=u[f++],"."==u[f]&&(c.top+=u[f++]);break;case"(":for("("==u[f+1]&&(o=!0,c.top=u[f++],i.a_meter.push(c),c={}),s=f+1;s<e.length&&")"!=u[s]&&"/"!=u[s];)s++;if(")"==u[s]&&"/"==u[s+1]){f++;continue}case")":o="("==u[f],c.top=u[f++],i.a_meter.push(c),c={};continue;default:if(u[f]<="0"||u[f]>"9")return void syntax(1,"Bad char '$1' in M:",u[f]);for(r=2,c.top=u[f++];;){for(;u[f]>="0"&&u[f]<="9";)c.top+=u[f++];if(")"==u[f]){if("/"!=u[f+1])break;f++}if("/"==u[f]){if(u[++f]<="0"||u[f]>"9")return void syntax(1,"Bad char '$1' in M:",u[f]);for(c.bot=u[f++];u[f]>="0"&&u[f]<="9";)c.bot+=u[f++];break}if(" "!=u[f]&&"+"!=u[f])break;if(f>=e.length||"("==u[f+1])break;c.top+=u[f++]}l=parseInt(c.top)}for(o||(c.bot&&(r=parseInt(c.bot)),a+=l*BASE_LEN/r),i.a_meter.push(c),c={};" "==u[f];)f++;"+"==u[f]&&(c.top=u[f++],i.a_meter.push(c),c={})}if("="==u[f]){if(!(t=u.substring(++f).match(/^(\d+)\/(\d+)$/)))return void syntax(1,"Bad duration '$1' in M:",u.substring(f));a=BASE_LEN*t[1]/t[2]}if(i.wmeasure=a,3!=parse.state){if(info.M=e,glovar.meter=i,parse.state>=1)for(glovar.ulen||(glovar.ulen=a<=1||a>=3*BASE_LEN/4?BASE_LEN/8:BASE_LEN/16),n=0;n<voice_tb.length;n++)voice_tb[n].meter=i,voice_tb[n].wmeasure=a}else curvoice.wmeasure=a,is_voice_sig()?(curvoice.meter=i,reset_gen()):sym_link(i)}function new_tempo(e){var t,n,r,s=0,a={type:TEMPO,dur:0};if(set_ref(a),cfmt.writefields.indexOf("Q")<0&&(a.del=!0),'"'==e[0]){if((s=e.indexOf('"',1))<0)return void syntax(1,"Unterminated string in Q:");for(a.tempo_str1=e.slice(1,s),s++;" "==e[s];)s++}for((r=new scanBuf).buffer=e,r.index=s;!(void 0==(t=e[r.index])||t<="0"||t>"9");)for(n=parse_dur(r),a.tempo_notes||(a.tempo_notes=[]),a.tempo_notes.push(BASE_LEN*n[0]/n[1]);" "==(t=e[r.index]);)r.index++;if("="==t){for(t=e[++r.index];" "==t;)t=e[++r.index];for(s=r.index,"c"==t&&"a"==e[s+1]&&"."==e[s+2]&&" "==e[s+3]&&(a.tempo_ca="ca. ",r.index+=4),"/"!=e[r.index+1]?a.tempo=r.get_int():(n=parse_dur(r),a.new_beat=BASE_LEN*n[0]/n[1]),t=e[r.index];" "==t;)t=e[++r.index]}if('"'==t){if(r.index++,(s=e.indexOf('"',r.index+1))<0)return void syntax(1,"Unterminated string in Q:");a.tempo_str2=e.slice(r.index,s)}if(3!=parse.state){if(1==parse.state)return info.Q=e,void(glovar.tempo=a);goto_tune()}curvoice.v==par_sy.top_voice&&(sym_link(a),glovar.tempo&&0==curvoice.time&&(glovar.tempo.del=!0))}function do_info(e,t){var n,r,s,a;switch(e){case"I":do_pscom(t);break;case"L":if(2==parse.state&&goto_tune(),a=t.match(/^(\d+)\/(\d+)(=(\d+)\/(\d+))?$/)){if(!(r=Number(a[2]))||0!=(r&r-1))break;if(r=Number(a[1])/r*BASE_LEN,a[3]){if(!(s=Number(a[5]))||0!=(s&s-1)){s=0;break}s=Number(a[4])/s*BASE_LEN}else s=r}else"auto"==t&&(r=s=-1);if(!s){syntax(1,"Bad L: value");break}parse.state<2?glovar.ulen=r:(curvoice.ulen=r,curvoice.dur_fact=s/r);break;case"M":new_meter(t);break;case"U":set_user(t);break;case"P":if(0==parse.state)break;if(1==parse.state){info.P=t;break}if(2==parse.state&&goto_tune(),cfmt.writefields.indexOf(e)<0)break;n={type:PART,text:t,dur:0};var o=voice_tb[par_sy.top_voice];if(curvoice.v!=o.v){if(curvoice.time!=o.time)break;if(o.last_sym&&o.last_sym.type==PART)break;var i=curvoice;curvoice=o,sym_link(n),curvoice=i}else sym_link(n);break;case"Q":if(0==parse.state)break;new_tempo(t);break;case"V":get_voice(t);break;case"K":if(0==parse.state)break;get_key(t);break;case"N":case"R":info[e]?info[e]+="\n"+t:info[e]=t;break;case"r":if(!user.keep_remark||3!=parse.state)break;sym_link(n={type:REMARK,text:t,dur:0});break;default:syntax(0,"'$1:' line ignored",e)}}function adjust_dur(e){var t,n,r,s,a;if((t=curvoice.last_sym)&&t.type!=MREST&&t.type!=BAR){for(;t.type!=BAR&&t.prev;)t=t.prev;if(n=t.time,r=curvoice.time-n,0==n){for(;t&&!t.dur;)t=t.next;t&&t.type==REST&&t.invis&&(n+=t.dur*curvoice.wmeasure/r,t.prev?t.prev.next=t.next:curvoice.sym=t.next,t.next&&(t.next.prev=t.prev),t=t.next)}if(curvoice.wmeasure!=r){for(;t;t=t.next)if(t.time=n,t.dur&&!t.grace&&(t.dur=t.dur*curvoice.wmeasure/r,t.dur_orig=t.dur_orig*curvoice.wmeasure/r,n+=t.dur,t.type==NOTE||t.type==REST)){for(s=0;s<=t.nhd;s++)t.notes[s].dur=t.notes[s].dur*curvoice.wmeasure/r;a=identify_note(t,t.dur_orig),t.head=a[0],t.dots=a[1],t.nflags=a[2],t.nflags<=-2?t.stemless=!0:delete t.stemless}curvoice.time=e.time=n}}}function new_bar(){var e,t,n,r=parse.line,s={type:BAR,ctx:parse.ctx,istart:parse.bol+r.index,dur:0,multi:0};for(vover&&vover.bar&&get_vover("|"),glovar.new_nbar&&(s.bar_num=glovar.new_nbar,glovar.new_nbar=0),n=r.char();;){switch(t=r.next_char()){case"|":case"[":case"]":case":":n+=t;continue}break}switch(":"==n[0]&&(1==n.length?(n="|",s.bar_dotted=!0):s.rbstop=2),a_gch&&gch_build(s),a_dcn&&(deco_cnv(a_dcn,s),a_dcn=null),n.slice(-1)){case"[":if(1==n.length){s.text="";break}if(t>"0"&&t<="9")break;n=n.slice(0,-1),r.index--,t="[";break;case":":s.rbstop=2}if(t>"0"&&t<="9"){for(s.text=t;t=r.next_char(),!("0123456789,.-".indexOf(t)<0);)s.text+=t;s.rbstop=2,s.rbstart=2}else if('"'==t&&"["==n){for(;;){if(!(t=r.next_char()))return void syntax(1,"No end of repeat string");if('"'==t){r.index++;break}"\\"==t&&(s.text+=t,t=r.next_char()),s.text+=t}s.text=cnv_escape(s.text),s.rbstop=2,s.rbstart=2}if("]"==n[0]&&(s.rbstop=2,1!=n.length?n=n.slice(1):s.invis=!0),s.iend=parse.bol+r.index,s.rbstart&&curvoice.norepbra&&!curvoice.second&&(s.norepbra=!0),curvoice.ulen<0&&adjust_dur(s),(e=curvoice.last_sym)&&e.type==SPACE)e.time--;else if(e&&e.type==BAR&&!e.a_gch&&!e.a_dd&&!s.a_gch&&!s.a_dd){if("["==n&&!e.text&&(0==curvoice.st||par_sy.staves[curvoice.st-1].flags&STOP_BAR||s.norepbra))return s.text&&(e.text=s.text),s.a_gch&&(e.a_gch=s.a_gch),s.norepbra&&(e.norepbra=s.norepbra),s.rbstart&&(e.rbstart=s.rbstart),void(s.rbstop&&(e.rbstop=s.rbstop));if("|:"==n){if(":|"==e.bar_type)return e.bar_type="::",void(e.rbstop=2);if("||"==e.bar_type)return e.bar_type="||:",void(e.rbstop=2)}}switch(n){case"[":s.rbstop=2;case"[]":case"[|]":s.invis=!0,n="[]";break;case":|:":case":||:":n="::";break;case"||":if(!cfmt.rbdbstop)break;case"[|":case"|]":s.rbstop=2}s.bar_type=n,curvoice.lyric_restart||(curvoice.lyric_restart=s),curvoice.sym_restart||(curvoice.sym_restart=s),!e||e.type!=KEY||e.prev&&e.prev.type==BAR?sym_link(s):(curvoice.last_sym=e.prev,e.prev||(curvoice.sym=e.prev),sym_link(s),s.next=e,e.prev=s,curvoice.last_sym=e),s.st=curvoice.st,s.rbstart&&!curvoice.norepbra&&curvoice.st>0&&!(par_sy.staves[curvoice.st-1].flags&STOP_BAR)&&(sym_link(e={type:BAR,ctx:s.ctx,istart:s.istart,iend:s.iend,bar_type:"[",multi:0,invis:!0,text:s.text,rbstart:2}),e.st=curvoice.st,delete s.text,s.rbstart=0)}var err_mispl_sta_s="Misplaced '$1' in %%staves";function parse_staves(e){for(var t,n=[],r=!1,s=0,a=0,o=0,i=0,c=0,l=0;l<e.length;){switch(e[l]){case" ":case"\t":break;case"[":if(i||a+o>=2){syntax(1,err_mispl_sta_s,"["),r=!0;break}s|=a+o==0?OPEN_BRACKET:OPEN_BRACKET2,o++,c<<=8,c|=OPEN_BRACKET;break;case"{":if(i||a||o>=2){syntax(1,err_mispl_sta_s,"{"),r=!0;break}s|=o?OPEN_BRACE2:OPEN_BRACE,a++,c<<=8,c|=OPEN_BRACE;break;case"(":if(i){syntax(1,err_mispl_sta_s,"("),r=!0;break}s|=OPEN_PARENTH,i++,c<<=8,c|=OPEN_PARENTH;break;case"*":!a||i||s&(OPEN_BRACE|OPEN_BRACE2)||(s|=FL_VOICE);break;case"+":s|=MASTER_VOICE;break;default:if(!e[l].match(/\w/)){syntax(1,"Bad voice ID in %%staves"),r=!0;break}for(t="";l<e.length&&!(" \t()[]{}|*".indexOf(e[l])>=0);)t+=e[l++];for(;l<e.length;l++){switch(e[l]){case" ":case"\t":continue;case"]":if(!(c&OPEN_BRACKET)){syntax(1,err_mispl_sta_s,"]"),r=!0;break}s|=a+--o==0?CLOSE_BRACKET:CLOSE_BRACKET2,c>>=8;continue;case"}":if(!(c&OPEN_BRACE)){syntax(1,err_mispl_sta_s,"}"),r=!0;break}a--,s|=o?CLOSE_BRACE2:CLOSE_BRACE,s&=~FL_VOICE,c>>=8;continue;case")":if(!(c&OPEN_PARENTH)){syntax(1,err_mispl_sta_s,")"),r=!0;break}i--,s|=CLOSE_PARENTH,c>>=8;continue;case"|":s|=STOP_BAR;continue}break}n.push([t,s]),s=0;continue}l++}if(0!=c&&(syntax(1,"'}', ')' or ']' missing in %%staves"),r=!0),!r&&0!=n.length)return n}function info_split(e){var t,n,r=[],s="",a=e.length;for(t=0;t<a;t++)switch(e[t]){case"=":if(!s){s="=";break}s+="=",r.push(s),s="";break;case" ":case"\t":if(!s)break;r.push(s),s="";break;case'"':for(s&&(r.push(s),s=""),n=t++;t<a&&'"'!=e[t];)"\\"==e[t]&&t++,t++;if('"'!=e[t]){syntax(1,"Unterminated string");break}r.push(e.slice(n,t+1));break;case"\\":s+=e[t++];default:s+=e[t]}return s&&r.push(s),r}function identify_note(e,t){var n,r,s;for(t%12!=0&&syntax(1,"Invalid note duration $1",t),0==(t/=12)&&syntax(1,"Note too short"),s=5;0!=t&&!(1&t);t>>=1,s--);switch(t>>=1){case 0:r=0;break;case 1:r=1;break;case 3:r=2;break;default:r=3}if((s-=r)>=0)n=FULL;else switch(s){default:syntax(1,"Note too long"),s=-4;case-4:n=SQUARE;break;case-3:n=cfmt.squarebreve?SQUARE:OVALBARS;break;case-2:n=OVAL;break;case-1:n=EMPTY}return[n,r,s]}var reg_dur=/(\d*)(\/*)(\d*)/g;function parse_dur(e){var t,n,r;return reg_dur.lastIndex=e.index,(t=reg_dur.exec(e.buffer))[0]?(n=t[1]||1,r=t[3]||1,t[3]||(r*=1<<t[2].length),e.index=reg_dur.lastIndex,[n,r]):[1,1]}function parse_acc_pit(e){var t,n,r,s,a,o,i=e.char();switch(i){case"^":"^"==(i=e.next_char())?(n=2,i=e.next_char()):n=1;break;case"=":n=3,i=e.next_char();break;case"_":"_"==(i=e.next_char())?(n=-2,i=e.next_char()):n=-1}if((n&&3!=n&&i>="1"&&i<="9"||"/"==i)&&(r=(o=parse_dur(e))[0],1==(s=o[1])?s=curvoice?curvoice.uscale:1:s*=2,i=e.char()),a=ntb.indexOf(i)+16,i=e.next_char(),!(a<16)){for(;"'"==i;)a+=7,i=e.next_char();for(;","==i;)a-=7,i=e.next_char();return t={pit:a,apit:a,shhd:0,shac:0,ti1:0},n&&(t.acc=n,r&&(t.micro_n=r,t.micro_d=s)),t}syntax(1,"'$1' is not a note",e.buffer[e.index-1])}function set_map(e){var t,n,r,s,a=maps[curvoice.map];for(t="abcdefg"[(e.pit+77)%7],r=(n=e.acc?["__","_","","^","^^","="][e.acc+2]:"")+t,s=e.pit;s>=28;s-=7)r+="'";for(s=e.pit;s<21;s+=7)r+=",";(a[r]||a[r="octave,"+n+t]||a[r="key,"+"abcdefg"[(e.pit+77-curvoice.ckey.k_delta)%7]]||a[r="all"])&&(e.map=a[r],e.map[1]&&(e.apit=e.pit=e.map[1].pit,e.acc=e.map[1].acc))}function parse_basic_note(e,t){var n,r=parse_acc_pit(e);if(r)return"0"==e.char()&&(parse.stemless=!0,e.index++),n=parse_dur(e),r.dur=t*n[0]/n[1],r}function parse_vpos(){var e=parse.line,t=0;switch("."!=e.buffer[e.index-1]||a_dcn||(t=SL_DOTTED),e.next_char()){case"'":return e.index++,t+SL_ABOVE;case",":return e.index++,t+SL_BELOW}return t+SL_AUTO}var cde2fcg=new Int8Array([0,2,4,-1,1,3,5]),cgd2cde=new Int8Array([0,4,1,5,2,6,3]),acc2=new Int8Array([-2,-1,3,1,2]);function note_transp(e){var t,n,r,s,a,o,i,c,l,f,u=e.nhd,p=curvoice.okey.k_sf,d=curvoice.ckey.k_sf-p,_=cgd2cde[(d+28)%7],m=curvoice.vtransp;for(m<0&&0!=_&&(_-=7),_+=7*(m/3/12|0),t=0;t<=u;t++){if(r=(f=e.notes[t]).pit,f.pit+=_,f.apit=f.pit,i=cde2fcg[(r+5+112)%7],!(a=f.acc))if(curvoice.okey.a_acc){for(n=0;n<curvoice.okey.a_acc.length;n++)if((r+112-(o=curvoice.okey.a_acc[n]).pit)%7==0){a=o.acc;break}}else p>0?i<p-1&&(a=1):p<0&&i>=p+6&&(a=-1);if(c=i+d,a&&3!=a&&(c+=7*a),a=acc2[i=(2+((c+1+21)/7|0)-3+160)%5],f.acc);else if(curvoice.ckey.k_none){if(3==a||acc_same_pitch(f.pit))continue}else{if(!curvoice.ckey.a_acc)continue;for(l=cgd2cde[(c+112)%7],n=0;n<curvoice.ckey.a_acc.length&&(l+112-curvoice.ckey.a_acc[n].pits)%7!=0;n++);if(n<curvoice.ckey.a_acc.length)continue}if(i=f.acc,(s=f.micro_d)&&i!=a)switch(r=f.micro_n,a){case 3:r>s/2?(r-=s/2,f.micro_n=r,a=i):a=-i;break;case 2:r>s/2?(f.pit+=1,f.apit=f.pit,r-=s/2):r+=s/2,a=i,f.micro_n=r;break;case-2:r>=s/2?(f.pit-=1,f.apit=f.pit,r-=s/2):r+=s/2,a=i,f.micro_n=r}f.acc=a}}function sort_pitch(e){e.notes=e.notes.sort(function(e,t){return e.pit-t.pit})}function new_note(e,t){var n,r,s,a,o,i,c,l,f,u,p,d,_,m=0,v=parse.line,y=a_dcn;switch(a_dcn=null,parse.stemless=!1,(r={type:NOTE,ctx:parse.ctx,stem:0,multi:0,nhd:0,xmx:0}).istart=parse.bol+v.index,curvoice.color&&(r.color=curvoice.color),e?r.grace=!0:(a_gch&&gch_build(r),parse.repeat_n&&(r.repeat_n=parse.repeat_n,r.repeat_k=parse.repeat_k,parse.repeat_n=0)),a=v.char()){case"X":r.invis=!0;case"Z":if(r.type=MREST,a=v.next_char(),r.nmes=a>"0"&&a<="9"?v.get_int():1,r.dur=curvoice.wmeasure*r.nmes,curvoice.second)return curvoice.time+=r.dur,null;break;case"y":r.type=SPACE,r.invis=!0,r.dur=0,a=v.next_char(),r.width=a>="0"&&a<="9"?v.get_int():10;break;case"x":r.invis=!0;case"z":r.type=REST,v.index++,u=parse_dur(v),r.dur_orig=(curvoice.ulen<0?15120:curvoice.ulen)*u[0]/u[1],r.dur=r.dur_orig*curvoice.dur_fact,r.notes=[{pit:18,dur:r.dur_orig}];break;case"[":s=!0,a=v.next_char();default:for(curvoice.uscale&&(r.uscale=curvoice.uscale),r.notes=[];;){if(s)for(;a&&"%"!=a;){if((c=a.charCodeAt(0))>=128)return syntax(1,not_ascii),null;switch((i=char_tb[c])[0]){case"(":m<<=4,m+=parse_vpos(),a=v.char();continue;case"!":if(a_dcn||(a_dcn=[]),i.length>1)a_dcn.push(i.slice(1,-1));else{for(o="";;){if(!(a=v.next_char())||"%"==a)return void syntax(1,"No end of decoration");if("!"==a)break;o+=a}a_dcn.push(o)}a=v.next_char();continue}break}if(!(n=parse_basic_note(v,r.grace?BASE_LEN/4:curvoice.ulen<0?15120:curvoice.ulen)))return;if(curvoice.octave&&(n.apit=n.pit+=7*curvoice.octave),curvoice.ottava&&(n.pit+=curvoice.ottava),m&&(n.sl1=m,r.sl1?r.sl1++:r.sl1=1,m=0),a_dcn&&(n.a_dcn=a_dcn,a_dcn=null),r.notes.push(n),!s)break;for(a=v.char();;){switch(a){case")":n.sl2?n.sl2++:n.sl2=1,r.sl2?r.sl2++:r.sl2=1,a=v.next_char();continue;case"-":n.ti1=parse_vpos(),r.ti1=!0,a=v.char();continue;case".":if("-"!=(a=v.next_char())){syntax(1,"Misplaced dot");break}continue}break}if("]"==a){for(v.index++,u=parse_dur(v),r.nhd=r.notes.length-1,c=0;c<=r.nhd;c++)(n=r.notes[c]).dur=n.dur*u[0]/u[1];break}}r.dur_orig=r.notes[0].dur,r.dur=r.notes[0].dur*curvoice.dur_fact}if(!r.grace||r.type==NOTE){if(r.notes){if(r.grace){var h=curvoice.key.k_bagpipe?8:4;for(c=0;c<=r.nhd;c++)r.notes[c].dur/=h;r.dur/=h,r.dur_orig/=h,e.stem&&(r.stem=e.stem)}else{switch(curvoice.pos.stm){case SL_ABOVE:r.stem=1;break;case SL_BELOW:r.stem=-1;break;case SL_HIDDEN:r.stemless=!0}if(r.combine=curvoice.combine,r.dur*=t,d=curvoice.brk_rhythm){if(curvoice.brk_rhythm=0,f=curvoice.last_note,d>0){for(l=2*d-1,r.dur=r.dur*l/d,r.dur_orig=r.dur_orig*l/d,c=0;c<=r.nhd;c++)r.notes[c].dur=r.notes[c].dur*l/d;for(f.dur/=d,f.dur_orig/=d,c=0;c<=f.nhd;c++)f.notes[c].dur/=d}else{for(l=2*(d=-d)-1,r.dur/=d,r.dur_orig/=d,c=0;c<=r.nhd;c++)r.notes[c].dur/=d;for(f.dur=f.dur*l/d,f.dur_orig=f.dur_orig*l/d,c=0;c<=f.nhd;c++)f.notes[c].dur=f.notes[c].dur*l/d}for(curvoice.time=f.time+f.dur,p=identify_note(f,f.dur_orig),f.head=p[0],f.dots=p[1],f.nflags=p[2],f.nflags<=-2?f.stemless=!0:delete f.stemless,f=f.next;f;f=f.next)f.time=curvoice.time}}r.type==NOTE?(p=identify_note(r,r.dur_orig),r.head=p[0],r.dots=p[1],r.nflags=p[2],r.nflags<=-2&&(r.stemless=!0)):((_=r.dur_orig)==curvoice.wmeasure&&(_=_<2*BASE_LEN?BASE_LEN:_<4*BASE_LEN?2*BASE_LEN:4*BASE_LEN),p=identify_note(r,_),r.head=p[0],r.dots=p[1],r.nflags=p[2]),curvoice.last_note=r}if(sym_link(r),r.type==NOTE&&(curvoice.vtransp&&note_transp(r),curvoice.map&&maps[curvoice.map]))for(c=0;c<=r.nhd;c++)set_map(r.notes[c]);return cfmt.shiftunison&&(r.shiftunison=cfmt.shiftunison),e||(curvoice.lyric_restart||(curvoice.lyric_restart=r),curvoice.sym_restart||(curvoice.sym_restart=r)),y&&deco_cnv(y,r,r.prev),parse.stemless&&(r.stemless=!0),r.iend=parse.bol+v.index,r}syntax(1,"Not a note in grace note sequence")}var nil=["0"],char_tb=[nil,nil,nil,nil,nil,nil,nil,nil,nil," ","\n",nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil," ","!",'"',"i","\n",nil,"&",nil,"(",")","i",nil,nil,"-","!dot!",nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,nil,"|","i","<","n","<","i","i","n","n","n","n","n","n","n","!fermata!","d","d","d","!emphasis!","!lowermordent!","d","!coda!","!uppermordent!","d","d","!segno!","!trill!","d","d","d","n","d","n","[","\\","|","n","n","i","n","n","n","n","n","n","n","d","d","d","d","d","d","d","d","d","d","d","d","d","!upbow!","!downbow!","d","n","n","n","{","|","}","!roll!",nil];function parse_music_line(){var e,t,n,r,s,a,o=[],c=-1,l=1,f=0,u=parse.line;function p(e){var t,n,r;for(t=1,n=u.index+1;t<e.length;t++,n++)if(e[t]!=u.buffer[n]){if("n"!=e[t])return;if((r=ntb.indexOf(u.buffer[n]))<0)return;for(;"'"==u.buffer[n+1];)r+=7,n++;for(;","==u.buffer[n+1];)r-=7,n++}return u.index=n,r}function d(e,t){var n=u,r=parse.istart;parse.line=u=new scanBuf,parse.istart+=n.index,u.buffer=t?function(e,t){var n,r,s="",a=e.length;for(i=0;i<a;i++)if((n=e[i])>="h"&&n<="z"){for(r=t+n.charCodeAt(0)-"n".charCodeAt(0),n="";r<0;)r+=7,n+=",";for(;r>14;)r-=7,n+="'";s+=ntb[r]+n}else s+=n;return s}(e,t):e,_(!0),parse.line=u=n,parse.istart=r}function _(s){for(var i,_,m,v,y,h,b,g;(x=u.char())&&"%"!=x;){if("."==x)switch(u.buffer[u.index+1]){case"(":case"-":case"|":x=u.next_char()}if((i=x.charCodeAt(0))>=128){syntax(1,not_ascii),u.index++;break}if(!s&&maci[i]){for(m in b=0,mac)if(mac.hasOwnProperty(m)&&m[0]==x){if(m.indexOf("n")<0){if(u.buffer.indexOf(m,u.index)!=u.index)continue;u.index+=m.length}else if(!(b=p(m)))continue;d(mac[m],b),b=1;break}if(b)continue}switch((_=char_tb[i])[0]){case" ":(v=curvoice.last_note)&&(v.beam_end=!0,e&&(e.gr_shift=!0));break;case"\n":if(cfmt.barsperstaff)break;0==par_sy.voices[curvoice.v].range&&curvoice.last_sym&&(curvoice.last_sym.eoln=!0);break;case"&":if(")"==(x=u.next_char())){get_vover(")");break}get_vover("&");continue;case"(":if((x=u.next_char())>"0"&&x<="9"){var x,k=u.get_int(),w=qplet_tb[k],E=k;if(":"==(x=u.char())&&((x=u.next_char())>"0"&&x<="9"&&(w=u.get_int(),x=u.char()),":"==x)){if(!((x=u.next_char())>"0"&&x<="9")){syntax(1,"Invalid 'r' in tuplet");continue}E=u.get_int(),x=u.char()}0!=w&&void 0!=w||(w=curvoice.wmeasure%9==0?3:2),(a=o[++c])||(o[c]=a={}),a.p=k,a.q=w,a.r=E,a.f=cfmt.tuplets,a.fact=l*w/k,l=a.fact;continue}if("&"==x){get_vover("(");break}f<<=4,u.index--,f+=parse_vpos();continue;case")":if(curvoice.ignore)break;if(v=curvoice.last_sym)switch(v.type){case NOTE:case REST:case SPACE:break;default:v=null}if(!v){syntax(1,"Bad character '$1'",x);break}v.slur_end?v.slur_end++:v.slur_end=1;break;case"!":if(a_dcn||(a_dcn=[]),_.length>1)y=_.slice(1,-1);else{for(y="",h=u.index;"%"==(x=u.next_char())&&(x=0),x&&"!"!=x;)y+=x;if(!x){u.index=h,syntax(1,"No end of decoration");break}}ottava[y]&&set_ottava(y),a_dcn.push(y);break;case'"':parse_gchord(_);break;case"-":var A;if(!curvoice.last_note||curvoice.last_note.type!=NOTE){syntax(1,"No note before '-'");break}for(A=parse_vpos(),v=curvoice.last_note,h=0;h<=v.nhd;h++)v.notes[h].ti1?0==v.nhd&&syntax(1,"Too many ties"):v.notes[h].ti1=A;v.ti1=!0,e&&(e.ti1=!0);continue;case"[":var T=u.buffer[u.index+1];if('|[]: "'.indexOf(T)>=0||T>="1"&&T<="9"){if(e){syntax(1,bar_grace);break}new_bar();continue}if(":"==u.buffer[u.index+2]){if((h=u.buffer.indexOf("]",u.index+1))<0){syntax(1,"Lack of ']'");break}g=u.buffer.slice(u.index+3,h).trim(),parse.istart=parse.bol+u.index,parse.iend=parse.bol+h++,u.index=0,do_info(T,g),u.index=h;continue}case"n":if(!(v=new_note(e,l)))continue;if(v.type==NOTE&&f&&(v.slur_start=f,f=0),e){c>=0&&(v.in_tuplet=!0);continue}c>=0&&v.notes&&(v.in_tuplet=!0,c>0?(o[0].p&&(v.tp0=o[0].p,v.tq0=o[0].q,v.tf=o[0].f,o[0].p=0),o[0].r--,a.p&&(v.tp1=a.p,v.tq1=a.q,v.tf=a.f,a.p=0)):a.p&&(v.tp0=a.p,v.tq0=a.q,v.tf=a.f,a.p=0),a.r--,0==a.r&&(0==c--?(v.te0=!0,l=1,curvoice.time=Math.round(curvoice.time),v.dur=curvoice.time-v.time):(v.te1=!0,0==(a=o[0]).r?(c--,v.te0=!0,l=1,curvoice.time=Math.round(curvoice.time),v.dur=curvoice.time-v.time):l=a.fact)));continue;case"<":if(!curvoice.last_note){syntax(1,"No note before '<'");break}if(e){syntax(1,"Cannot have a broken rhythm in grace notes");break}for(b="<"==x?1:-1;"<"==x||">"==x;)b*=2,x=u.next_char();curvoice.brk_rhythm=b;continue;case"i":break;case"{":if(e){syntax(1,"'{' in grace note");break}switch(t=curvoice.last_note,curvoice.last_note=null,n=a_dcn,a_dcn=void 0,e={type:GRACE,ctx:parse.ctx,istart:parse.bol+u.index,dur:0,multi:0},curvoice.pos.gst){case SL_ABOVE:e.stem=1;break;case SL_BELOW:e.stem=-1;break;case SL_HIDDEN:e.stem=2}if(sym_link(e),"/"==(x=u.next_char())){e.sappo=!0;break}continue;case"|":if(e){syntax(1,bar_grace);break}x=u.buffer[u.index-1],new_bar(),"."==x&&(curvoice.last_sym.bar_dotted=!0);continue;case"}":if(v=curvoice.last_note,!e||!v){syntax(1,"Bad character '$1'",x);break}if(a_dcn&&syntax(1,"Decoration ignored"),v.gr_end=!0,e.extra=e.next,e.extra.prev=null,e.next=null,curvoice.last_sym=e,e=null,!v.prev&&!curvoice.key.k_bagpipe){for(h=0;h<=v.nhd;h++)v.notes[h].dur*=2;v.dur*=2,v.dur_orig*=2;var C=identify_note(v,v.dur_orig);v.head=C[0],v.dots=C[1],v.nflags=C[2]}curvoice.last_note=t,a_dcn=n;break;case"\\":for(h=u.index+1;;h++){switch(u.buffer[h]){case" ":case"\t":continue;case"%":u.index=u.buffer.length;case void 0:x=void 0,r=!0}break}if(!x)break;default:syntax(1,"Bad character '$1'",x)}u.index++}}if(3!=parse.state){if(2!=parse.state)return;goto_tune()}if(_(),c>=0)for(syntax(1,"No end of tuplet"),s=curvoice.last_note;s;s=s.prev)if(s.tp1&&(s.tp1=0),s.tp0){s.tp0=0;break}e&&(syntax(1,"No end of grace note sequence"),curvoice.last_sym=e.prev,curvoice.last_note=t,e.prev&&(e.prev.next=null)),cfmt.breakoneoln&&curvoice.last_note&&(curvoice.last_note.beam_end=!0),r||cfmt.barsperstaff||"\n"==char_tb["\n".charCodeAt(0)]&&0==par_sy.voices[curvoice.v].range&&curvoice.last_sym&&(curvoice.last_sym.eoln=!0)}var cw_tb=new Float32Array([.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.25,.333,.408,.5,.5,.833,.778,.333,.333,.333,.5,.564,.25,.564,.25,.278,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.278,.278,.564,.564,.564,.444,.921,.722,.667,.667,.722,.611,.556,.722,.722,.333,.389,.722,.611,.889,.722,.722,.556,.722,.667,.556,.611,.722,.722,.944,.722,.722,.611,.333,.278,.333,.469,.5,.333,.444,.5,.444,.5,.444,.333,.5,.5,.278,.278,.5,.278,.778,.5,.5,.5,.5,.333,.389,.278,.5,.5,.722,.5,.5,.444,.48,.2,.48,.541,.5]);function cwid(e){var t=e.charCodeAt(0);if(t>=128){if(t>=768&&t<880)return 0;t=97}return cw_tb[t]}function strw(e){var t,n,r,s=gene.curfont.swfac,a=0,o=e.length;for(t=0;t<o;t++){switch(r=e[t]){case"$":if("0"==(r=e[t+1]))gene.curfont=gene.deffont;else{if(!(r>="1"&&r<="9")){r="$";break}gene.curfont=get_font("u"+r)}t++,s=gene.curfont.swfac;continue;case"&":(n=e.indexOf(";",t))>0&&n-t<10&&(t=n,r="a")}a+=cwid(r)*s}return a}function set_font(e){gene.curfont=gene.deffont=get_font(e)}function out_str(e){var t,n=gene.curfont,r=n;output.push(e.replace(/<|>|&.*?;|&|  |\$./g,function(e){switch(e[0]){case"<":return"&lt;";case">":return"&gt;";case"&":return"&"==e?"&amp;":e;case" ":return" ";case"$":if("0"==e[1])use_font(t=gene.deffont);else{if(!(e[1]>="1"&&e[1]<="9"))return e;t=get_font("u"+e[1])}return e="",t==r?e:(r!=n&&(e="</tspan>"),(r=t)==n?e:e+'<tspan\n\tclass="'+font_class(t)+'">')}})),r!=n&&(output.push("</tspan>"),gene.curfont=r)}function xy_str(e,t,n,r,s){switch(t+=.2*gene.curfont.size,output.push('<text class="'+font_class(gene.curfont)+'" x="'),out_sxsy(e,'" y="',t),r){case"c":output.push('" text-anchor="middle">');break;case"j":output.push('" textLength="'+s.toFixed(2)+'">');break;case"r":output.push('" text-anchor="end">');break;default:output.push('">')}out_str(n),output.push("</text>\n")}function xy_str_b(e,t,n){var r=strw(n);output.push('<rect class="stroke" x="'),out_sxsy(e-2,'" y="',t+gene.curfont.size+1),output.push('" width="'+(r+4).toFixed(2)+'" height="'+(gene.curfont.size+3).toFixed(2)+'"/>\n'),xy_str(e,t,n)}function trim_title(e,t){var n;return cfmt.titletrim&&((n=e.lastIndexOf(", "))<0||e[n+2]<"A"||e[n+2]>"Z"||n<e.length-7||e.indexOf(" ",n+3)>=0)&&(n=0),!t&&cfmt.writefields.indexOf("X")>=0&&(e=info.X+".  "+e),n&&(e=e.slice(n+2).trim()+" "+e.slice(0,n)),cfmt.titlecaps?e.toUpperCase():e}function get_lwidth(){return(img.width-img.lm-img.rm-2)/cfmt.scale}function write_title(e,t){var n;e&&(set_page(),e=trim_title(e,t),t?(set_font("subtitle"),n=gene.curfont.size,vskip(cfmt.subtitlespace+n)):(set_font("title"),n=gene.curfont.size,vskip(cfmt.titlespace+n)),cfmt.titleleft?xy_str(0,0,e):xy_str(get_lwidth()/2,0,e,"c"))}function put_inf2r(e,t,n,r,s){if(!n){if(!r)return;n=r,r=null}xy_str(e,t,r?n+" ("+r+")":n,s)}function write_text(e,t){if("s"!=t){set_font("text"),set_page();var n,r,s,a,o,i,c,l=get_lwidth(),f=gene.curfont.size*cfmt.lineskipfac,u=gene.curfont.size*cfmt.parskipfac,p=block.started?function(){}:blk_out,d=block.started?svg_flush:blk_flush;switch(p(),t){default:switch(t){case"c":s=l/2;break;case"r":s=l;break;default:s=0}for(r=0;;){if((n=e.indexOf("\n",r))<0){vskip(f),xy_str(s,0,e.slice(r),t);break}if(n==r){for(vskip(u),d(),use_font(gene.curfont);"\n"==e[n+1];)vskip(f),n++;if(n==e.length)break;p()}else vskip(f),xy_str(s,0,e.slice(r,n),t);r=n+1}vskip(u),d();break;case"f":case"j":for(r=0;;){for(a=(a=(n=e.indexOf("\n\n",r))<0?e.slice(r):e.slice(r,n)).split(/\s+/),o=i=0,r=0;r<a.length;r++)(o+=c=strw(a[r]+" "))>=l&&(vskip(f),xy_str(0,0,a.slice(i,r).join(" "),t,l),i=r,o=c);if(0!=o&&(vskip(f),xy_str(0,0,a.slice(i).join(" "))),vskip(u),d(),n<0)break;for(;"\n"==e[n+2];)vskip(f),n++;if(n==e.length)break;p(),use_font(gene.curfont),r=n+2}}}}function put_words(e){var t,n,r,s,a,o,i,c;function l(e,t,n){var r,s,a=0;if("$"==e[a]&&e[a+1]>="0"&&e[a+1]<="9"&&(a+=2),s=0,r=a,e[a]>="0"&&e[a]<="9"||"."==e[a+1]){for(;a<e.length&&" "!=e[++a]&&":"!=e[a-1]&&"."!=e[a-1];);for(s=a;" "==e[a];)a++}return 0!=s&&xy_str(t,0,e.slice(r,s),"r"),a<e.length&&xy_str(t+5,0,e.slice(a),"l"),a>=e.length&&0==s}blk_out(),set_font("words");var f=get_lwidth()/2,u=(f-45)/(cwid("a")*gene.curfont.swfac);for(s=0,a=(e=e.split("\n")).length,n=0;n<a;n++){if((t=e[n]).length>u){s=0;break}t?c=!0:c&&(s++,c=!1)}if(s>0){for(n=s=(s+1)/2|0,c=!1,i=0;i<a;i++){for(t=e[i],r=0;" "==t[r];)r++;if(r==t.length){if(c&&--n<=0)break;c=!1}else c=!0}o=i+1}else o=i=a;for(vskip(cfmt.wordsspace),n=0;n<i||o<a;n++)n<i&&0==e[n].length&&(blk_out(),use_font(gene.curfont)),vskip(cfmt.lineskipfac*gene.curfont.size),n<i&&l(e[n],45),o<a&&(l(e[o],20+f)&&0==--s&&(n<i?s++:o<e.length-1&&(f*=.6)),o++)}function put_history(){var e,t,n,r,s,a,o,i,c=cfmt.infoname.split("\n"),l=c.length;for(e=0;e<l;e++)if(n=c[e][0],!(cfmt.writefields.indexOf(n)<0)&&(r=info[n])){for(s||(s=!0,set_font("history"),vskip(cfmt.textspace),a=gene.curfont.size*cfmt.lineskipfac),'"'==(i=c[e].slice(2))[0]&&(i=i.slice(1,-1)),vskip(a),xy_str(0,0,i),xy_str(o=strw(i),0,(r=r.split("\n"))[0]),t=1;t<r.length;t++)vskip(a),xy_str(o,0,r[t]);vskip(.3*a),blk_out(),use_font(gene.curfont)}}var info_font_init={A:"info",C:"composer",O:"composer",P:"parts",Q:"tempo",R:"info",T:"title",X:"title"};function write_headform(e){for(var t,n,r,s,a,o,i={},c=clone(info_font_init),l={A:cfmt.infospace,C:cfmt.composerspace,O:cfmt.composerspace,R:cfmt.infospace},f={},u="",p=cfmt.titleformat,d=0,_=0;;){for(;" "==p[_];)_++;if(_>=p.length)break;if((t=p[_++])<"A"||t>"Z")if("+"==t){if(0==u.length||"+"==u.slice(-1))continue;u=u.slice(0,-1)+"+"}else","==t&&("+"==u.slice(-1)&&(u=u.slice(0,-1)+"l"),u+="\n");else{if(i[t])f[t]++;else{if(!info[t])continue;i[t]=info[t].split("\n"),f[t]=1}switch(u+=t,p[_]){case"-":u+="l",_++;break;case"0":u+="c",_++;break;case"1":u+="r",_++;break;default:u+="c"}}}"+"==u.slice(-1)&&(u=u.slice(0,-1)+"l"),u+="\n";var m,v={l:cfmt.titlespace,c:cfmt.titlespace,r:cfmt.titlespace},y={l:0,c:.5*e,r:e},h={};for(p=u,_=0;;){for(h.l=h.c=h.r=a=0,d=_;"\n"!=(t=p[d++]);){if("+"==(r=p[d++]))r=p[d+1];else if(0!=h[r])continue;(m=i[t])&&((n=c[t])||(n="history"),o=1.1*get_font(n).size,l[t]&&(o+=l[t]),a<o&&(a=o),h[r]=o)}for(v.l+=a-h.l,v.c+=a-h.c,v.r+=a-h.r;"\n"!=(t=p[_++]);)if(r=p[_++],0!=i[t].length){if(m=i[t].shift(),"+"==r&&(f[t]--,t=p[_++],r=p[_++],i[t].length>0&&(m?m+=" "+i[t].shift():m=" "+i[t].shift())),(n=c[t])||(n="history"),o=1.1*get_font(n).size,l[t]&&(o+=l[t]),set_font(n),s=y[r],a=v[r]+o,"Q"==t){if(!glovar.tempo.del){if("l"!=r){var b=tempo_width(glovar.tempo);"c"==r&&(b*=.5),s-=b}write_tempo(glovar.tempo,s,-a)}}else m&&xy_str(s,-a,m,r);if("T"==t&&(n=c.T="subtitle",l.T=cfmt.subtitlespace),f[t]<=1)for("T"==t&&(o=1.1*get_font(n).size,l[t]&&(o+=l[t]),set_font(n));i[t].length>0;)xy_str(s,-(a+=o),m=i[t].shift(),r);f[t]--,v[r]=a}if(v.c>v.l&&(v.l=v.c),v.r>v.l&&(v.l=v.r),_>=u.length)break;v.c=v.r=v.l}vskip(v.l)}function write_heading(){var e,t,n,r,s,a,o,i,c=get_lwidth();if(blk_out(),vskip(cfmt.topspace),cfmt.titleformat)return write_headform(c),void vskip(cfmt.musicspace);if(info.T&&cfmt.writefields.indexOf("T")>=0)for(e=0;;){if((t=info.T.indexOf("\n",e))<0){write_title(info.T.substring(e),0!=e);break}write_title(info.T.slice(e,t),0!=e),e=t+1}if(set_font("composer"),o=i=0,parse.ckey.k_bagpipe&&!cfmt.infoline&&cfmt.writefields.indexOf("R")>=0&&(a=info.R),a&&(xy_str(0,-cfmt.composerspace,a),o=cfmt.composerspace),n=info.A,cfmt.writefields.indexOf("C")>=0&&(r=info.C),cfmt.writefields.indexOf("O")>=0&&(s=info.O),r||s||cfmt.infoline){var l,f;if(vskip(cfmt.composerspace),cfmt.aligncomposer<0?(l=0,f=" "):0==cfmt.aligncomposer?(l=.5*c,f="c"):(l=c,f="r"),i=o,r||s){for(cfmt.aligncomposer>=0&&o!=i&&vskip(o-i),e=0;;){if(vskip(gene.curfont.size),(t=r?r.indexOf("\n",e):-1)<0){put_inf2r(l,0,r?r.substring(e):null,s,f);break}xy_str(l,0,r.slice(e,t),f),o+=gene.curfont.size,e=t+1}i>o&&vskip(i-o)}((a=a?null:info.R)||n)&&cfmt.infoline&&(set_font("info"),vskip(gene.curfont.size+cfmt.infospace),put_inf2r(c,0,a,n,"r"),o+=gene.curfont.size+cfmt.infospace)}else i=cfmt.composerspace;info.P&&cfmt.writefields.indexOf("P")>=0&&(set_font("parts"),(o=cfmt.partsspace+gene.curfont.size-o)>0&&(i+=o),i>.01&&vskip(i),xy_str(0,0,info.P),i=0),vskip(i+cfmt.musicspace)}var output=[],style="\n.fill {fill: currentColor}\n.stroke {stroke: currentColor; fill: none}\n.music text, .music tspan {fill:currentColor}",font_style="",posx=cfmt.leftmargin/cfmt.scale,posy=0,img={width:cfmt.pagewidth,lm:cfmt.leftmargin,rm:cfmt.rightmargin},defined_glyph={},defs="",fulldefs="",stv_g={scale:1,dy:0,st:-1,v:0,g:0},block={},tgls={sgno:{x:-6,y:4,c:""},coda:{x:-12,y:6,c:""},tclef:{x:-8,y:0,c:""},cclef:{x:-8,y:0,c:""},bclef:{x:-8,y:0,c:""},pclef:{x:-6,y:0,c:""},stclef:{x:-8,y:0,c:""},scclef:{x:-8,y:0,c:""},sbclef:{x:-7,y:0,c:""},csig:{x:0,y:0,c:""},ctsig:{x:0,y:0,c:""},HDD:{x:-7,y:0,c:""},breve:{x:-6,y:0,c:""},HD:{x:-5.2,y:0,c:""},Hd:{x:-3.8,y:0,c:""},hd:{x:-3.7,y:0,c:""},srep:{x:-5,y:0,c:""},dot:{x:-2,y:0,c:""},"acc-1":{x:-3,y:0,c:""},acc3:{x:-2,y:0,c:""},acc1:{x:-3,y:0,c:""},acc2:{x:-3,y:0,c:""},pshhd:{x:-3,y:0,c:""},"acc-2":{x:-3,y:0,c:""},accent:{x:-3,y:0,c:""},marcato:{x:-3,y:0,c:""},hld:{x:-7,y:0,c:""},r00:{x:-1.5,y:0,c:""},r0:{x:-1.5,y:0,c:""},r1:{x:-3.5,y:6,c:""},r2:{x:-3.2,y:0,c:""},r4:{x:-3,y:0,c:""},r8:{x:-3,y:0,c:""},r16:{x:-4,y:0,c:""},r32:{x:-4,y:0,c:""},r64:{x:-4,y:0,c:""},r128:{x:-4,y:0,c:""},mrest:{x:-10,y:0,c:""},mrep:{x:-6,y:0,c:""},mrep2:{x:-9,y:0,c:""},turn:{x:-5,y:4,c:""},umrd:{x:-7,y:2,c:""},lmrd:{x:-7,y:2,c:""},ped:{x:-10,y:0,c:""},pedoff:{x:-5,y:0,c:""},longa:{x:-6,y:0,c:""}},glyphs={brace:'<text id="brace"></text>',ghd:'<g id="ghd" transform="translate(4.5,0) scale(0.66)">\n\t<text x="-3.7"></text>\n</g>',acc1_1_4:'<g id="acc1_1_4">\n\t<path d="m0 7.8v-15.4" class="stroke"/>\n\t<path class="fill" d="M-1.8 2.7l3.6 -1.1v2.2l-3.6 1.1v-2.2z\n\t\tM-1.8 -3.7l3.6 -1.1v2.2l-3.6 1.1v-2.2"/>\n</g>',acc1_3_4:'<g id="acc1_3_4">\n\t<path d="m-2.5 8.7v-15.4M0 7.8v-15.4M2.5 6.9v-15.4" class="stroke"/>\n\t<path class="fill" d="m-3.7 3.1l7.4 -2.2v2.2l-7.4 2.2v-2.2z\n\t\tM-3.7 -3.2l7.4 -2.2v2.2l-7.4 2.2v-2.2"/>\n</g>',"acc-1_1_4":'<g id="acc-1_1_4" transform="scale(-1,1)">\n\t<text x="-3"></text>\n</g>',"acc-1_3_4":'<g id="acc-1_3_4">\n    <path class="fill" d="m0.6 -2.7\n\tc-5.7 -3.1 -5.7 3.6 0 6.7c-3.9 -4 -4 -7.6 0 -5.8\n\tM1 -2.7c5.7 -3.1 5.7 3.6 0 6.7c3.9 -4 4 -7.6 0 -5.8"/>\n    <path d="m1.6 3.5v-13M0 3.5v-13" class="stroke" stroke-width=".6"/>\n</g>',turnx:'<g id="turnx">\n\t<text x="-5" y="-4"></text>\n\t<path class="stroke" d="m0 -1.5v-9"/>\n</g>',pfthd:'<g id="pfthd">\n\t<text x="-3"></text>\n\t<circle r="4" class="stroke"/>\n</g>',pmsig:'<path id="pmsig" class="stroke" stroke-width="0.8"\n\td="m0 -7a5 5 0 0 1 0 -10a5 5 0 0 1 0 10"/>',pMsig:'<g id="pMsig">\n\t<use xlink:href="#pmsig"/>\n\t<path class="fill" d="m0 -10a2 2 0 0 1 0 -4a2 2 0 0 1 0 4"/>\n</g>',imsig:'<path id="imsig" class="stroke" stroke-width="0.8"\n\td="m3 -8a5 5 0 1 1 0 -8"/>',iMsig:'<g id="iMsig">\n\t<use xlink:href="#imsig"/>\n\t<path class="fill" d="m0 -10a2 2 0 0 1 0 -4a2 2 0 0 1 0 4"/>\n</g>',hl:'<path id="hl" class="stroke" stroke-width="1" d="m-6 0h12"/>',hl1:'<path id="hl1" class="stroke" stroke-width="1" d="m-7 0h14"/>',hl2:'<path id="hl2" class="stroke" stroke-width="1" d="m-9 0h18"/>',ghl:'<path id="ghl" class="stroke" d="m-3.5 0h7"/>',rdots:'<g id="rdots" class="fill">\n\t<circle cx="0" cy="-9" r="1.2"/>\n\t<circle cx="0" cy="-15" r="1.2"/>\n</g>',grm:'<path id="grm" class="fill" d="m-5 -2.5\n\tc5 -8.5 5.5 4.5 10 -2\n\t-5 8.5 -5.5 -4.5 -10 2"/>',stc:'<circle id="stc" class="fill" cx="0" cy="-3" r="1.2"/>',sld:'<path id="sld" class="fill" d="m-7.2 4.8\n\tc1.8 .7 4.5 -.2 7.2 -4.8\n\t-2.1 5 -5.4 6.8 -7.6 6"/>',emb:'<path id="emb" class="stroke" stroke-width="1.2" stroke-linecap="round"\n\td="m-2.5 -3h5"/>',brth:'<text id="brth" y="-6" style="font-family:serif; font-weight:bold; font-style:italic; font-size:30px">,</text>',roll:'<path id="roll" class="fill" d="m-6 0\n\tc0.4 -7.3 11.3 -7.3 11.7 0\n\t-1.3 -6 -10.4 -6 -11.7 0"/>',upb:'<path id="upb" class="stroke" d="m-2.6 -9.4\n\tl2.6 8.8\n\tl2.6 -8.8"/>',dnb:'<g id="dnb">\n\t<path d="M-3.2 -2v-7.2m6.4 0v7.2" class="stroke"/>\n\t<path d="M-3.2 -6.8v-2.4l6.4 0v2.4" class="fill"/>\n</g>',dplus:'<path id="dplus" class="stroke" stroke-width="1.7"\n\td="m0 -.5v-6m-3 3h6"/>',lphr:'<path id="lphr" class="stroke" stroke-width="1.2"\n\td="m0 0v18"/>',mphr:'<path id="mphr" class="stroke" stroke-width="1.2"\n\td="m0 0v12"/>',sphr:'<path id="sphr" class="stroke" stroke-width="1.2"\n\td="m0 0v6"/>',sfz:'<text id="sfz" x="-5" y="-7" style="font-family:serif; font-style:italic; font-size:14px">\n\ts<tspan font-size="16" font-weight="bold">f</tspan>z</text>',trl:'<text id="trl" x="-2" y="-4"\n\tstyle="font-family:serif; font-weight:bold; font-style:italic; font-size:16px">tr</text>',opend:'<circle id="opend" class="stroke"\n\tcx="0" cy="-3" r="2.5"/>',snap:'<path id="snap" class="stroke" d="m-3 -6\n\tc0 -5 6 -5 6 0\n\t0 5 -6 5 -6 0\n\tM0 -5v6"/>',thumb:'<path id="thumb" class="stroke" d="m-2.5 -7\n\tc0 -6 5 -6 5 0\n\t0 6 -5 6 -5 0\n\tM-2.5 -9v4"/>',wedge:'<path id="wedge" class="fill" d="m0 -1l-1.5 -5h3l-1.5 5"/>',ltr:'<path id="ltr" class="fill"\n\td="m0 -.4c2 -1.5 3.4 -1.9 3.9 .4\n\t0.2 .8 .7 .7 2.1 -.4\n\tv0.8c-2 1.5 -3.4 1.9 -3.9 -.4\n\t-.2 -.8 -.7 -.7 -2.1 .4z"/>',custos:'<g id="custos">\n\t<path class="fill" d="m-4 0l2 2.5 2 -2.5 2 2.5 2 -2.5\n\t\t-2 -2.5 -2 2.5 -2 -2.5 -2 2.5"/>\n\t<path class="stroke" d="m3.5 0l5 -7"/>\n</g>',oct:'<text id="oct" style="font-family:serif; font-size:12px">8</text>'};function def_use(e){var t,n,r;if(!defined_glyph[e])if(defined_glyph[e]=!0,r=glyphs[e]){for(n=0;!((t=r.indexOf('xlink:href="#',n))<0);)t+=13,n=r.indexOf('"',t),def_use(r.slice(t,n));defs+="\n"+r}else error(1,null,"Unknown glyph: '$1'",e)}function defs_add(e){var t,n,r,s,a,o=0;for(e=e.replace(/<!--.*?-->/g,"");!((a=e.indexOf("<",o))<0||(t=e.indexOf('id="',a))<0||(t+=4,(n=e.indexOf('"',t))<0)||(r=e.slice(t,n),(o=e.indexOf(">",n))<0));){if("/"==e[o-1])o++;else{if((t=e.indexOf(" ",a))<0)break;if(s=e.slice(a+1,t),(o=e.indexOf("</"+s+">",o))<0)break;o+=3+s.length}"<filter"==e.substr(a,7)?fulldefs+="\n"+e.slice(a,o):glyphs[r]=e.slice(a,o)}}function set_g(){stv_g.started&&(stv_g.started=!1,output.push("</g>\n")),(1!=stv_g.scale||stv_g.color)&&(output.push("<g "),1!=stv_g.scale&&(stv_g.st>=0?output.push(staff_tb[stv_g.st].scale_str):output.push(voice_tb[stv_g.v].scale_str)),stv_g.color&&(1!=stv_g.scale&&output.push(" "),output.push('style="color:'+stv_g.color+'"')),output.push(">\n"),stv_g.started=!0)}function set_color(e){if(e==stv_g.color)return null;var t=stv_g.color;return stv_g.color=e,set_g(),t}function set_sscale(e){var t,n;e!=stv_g.st&&1!=stv_g.scale&&(stv_g.scale=0),t=e>=0?staff_tb[e].staffscale:1,n=e>=0&&1!=t?staff_tb[e].y:posy,t==stv_g.scale&&n==stv_g.dy||(stv_g.scale=t,stv_g.dy=n,stv_g.st=e,set_g())}function set_scale(e){var t=e.p_v.scale;1!=t?t==stv_g.scale&&stv_g.dy==posy||(stv_g.scale=t,stv_g.dy=posy,stv_g.st=-1,stv_g.v=e.v,set_g()):set_sscale(e.st)}function set_dscale(e,t){e<0?(stv_g.scale=1,output=staff_tb[0].output):(stv_g.scale=t?1:staff_tb[e].staffscale,output=1==stv_g.scale?staff_tb[e].output:staff_tb[e].sc_out),stv_g.st=e,stv_g.dy=0}function delayed_update(){var e;for(e=0;e<=nstaff;e++)0!=staff_tb[e].sc_out.length&&(output.push('<g transform="translate(0,'+(posy-staff_tb[e].y).toFixed(2)+") scale("+staff_tb[e].staffscale.toFixed(2)+')">\n'),output.push(staff_tb[e].sc_out.join("")),output.push("</g>\n"),staff_tb[e].sc_out=[]),0!=staff_tb[e].output.length&&(output.push('<g transform="translate(0,'+(-staff_tb[e].y).toFixed(2)+')">\n'),output.push(staff_tb[e].output.join("")),output.push("</g>\n"),staff_tb[e].output=[])}var anno_type=["bar","clef","custos","","grace","key","meter","Zrest","note","part","rest","yspace","staves","Break","tempo","","block","remark"];function anno_out(e,t,n){if(void 0!=e.istart){var r=e.type,s=e.ymx-e.ymn+4,a=e.wl||2,o=e.wr||2;e.grace&&(r=GRACE),n(t||anno_type[r],e.istart,e.iend,e.x-a-2,staff_tb[e.st].y+e.ymn+s-2,a+o+4,s,e)}}function a_start(e,t){anno_out(e,t,user.anno_start)}function a_stop(e,t){anno_out(e,t,user.anno_stop)}function empty_function(){}var anno_start=user.anno_start?a_start:empty_function,anno_stop=user.anno_stop?a_stop:empty_function;function out_XYAB(e,t,n,r,s){t=sx(t),n=sy(n),output.push(e.replace(/X|Y|A|B|F|G/g,function(e){switch(e){case"X":return t.toFixed(2);case"Y":return n.toFixed(2);case"A":return r;case"B":return s;case"F":return r.toFixed(2);default:return s.toFixed(2)}}))}function g_open(e,t,n,r,s){out_XYAB('<g transform="translate(X,Y',e,t),n&&output.push(") rotate("+n.toFixed(2)),r&&(s?output.push(") scale("+r.toFixed(2)+", "+s.toFixed(2)):output.push(") scale("+r.toFixed(2))),output.push(')">\n'),stv_g.g++}function g_close(){stv_g.g--,output.push("</g>\n")}function out_svg(e){output.push(e)}function sx(e){return stv_g.g?e:(e+posx)/stv_g.scale}function sy(e){return stv_g.g?e:1==stv_g.scale?posy-e:stv_g.st<0?(posy-e)/stv_g.scale:stv_g.dy-e}function out_sxsy(e,t,n){e=sx(e),n=sy(n),output.push(e.toFixed(2)+t+n.toFixed(2))}function xypath(e,t,n){out_XYAB('<path class="A" d="mX Y\n',e,t,n?"fill":"stroke")}function xygl(e,t,n){var r=tgls[n];!r||glyphs[n]?glyphs[n]?(def_use(n),out_XYAB('<use x="X" y="Y" xlink:href="#A"/>\n',e,t,n)):error(1,null,"no definition of $1",n):out_XYAB('<text x="X" y="Y">A</text>\n',e+r.x*stv_g.scale,t+r.y,r.c)}function out_acciac(e,t,n,r,s){s?(e-=1,t+=4):(e-=5,t-=4),out_XYAB('<path class="stroke" d="mX YlF G"/>\n',e,t,n,-r)}function out_bar(e,t,n,r){output.push('<path class="stroke" stroke-width="1" '+(r?'stroke-dasharray="5,5" ':"")+'d="m'+(e+posx).toFixed(2)+" "+(posy-t).toFixed(2)+"v"+(-n).toFixed(2)+'"/>\n')}function out_bnum(e,t,n){out_XYAB('<text style="font-family:serif; font-style:italic; font-size:12px"\n\tx="X" y="Y" text-anchor="middle">A</text>\n',e,t,n.toString())}function out_brace(e,t,n){def_use("brace"),e+=posx-6,t=posy-t,n/=24,output.push('<use transform="translate('+e.toFixed(2)+","+t.toFixed(2)+") scale(2.5,"+n.toFixed(2)+')" xlink:href="#brace"/>\n')}function out_bracket(e,t,n){e+=posx-5,t=posy-t-3,n+=2,output.push('<path class="fill"\n\td="m'+e.toFixed(2)+" "+t.toFixed(2)+"\n\tc10.5 1 12 -4.5 12 -3.5c0 1 -3.5 5.5 -8.5 5.5\n\tv"+n.toFixed(2)+'\n\tc5 0 8.5 4.5 8.5 5.5c0 1 -1.5 -4.5 -12 -3.5"/>\n')}function out_hyph(e,t,n){var r,s=25+3*(n/20|0);out_XYAB('<path class="stroke" stroke-width="1.2"\n\tstroke-dasharray="5,F"\n\td="mX YhG"/>\n',e+=(n-s*(r=n>15?(n-15)/s|0:0)-5)/2,t+3,Math.round((s-5)/stv_g.scale),s*r+5)}function out_stem(e,t,n,r,s,a){var o=r?GSTEM_XOFF:3.5,i=-n;if(n<0&&(o=-o),e+=o*stv_g.scale,stv_g.st<0&&(i/=stv_g.scale),out_XYAB('<path class="stroke" d="mX YvF"/>\n',e,t,i),s){if(output.push('<path class="fill"\n\td="'),t+=n,n>0)if(a)if(r)for(;--s>=0;)out_XYAB("MX Yl3 1.5 0 2 -3 -1.5z\n",e,t),t-=3;else for(t+=1;--s>=0;)out_XYAB("MX Yl7 3.2 0 3.2 -7 -3.2z\n",e,t),t-=5.4;else if(r)if(1==s)out_XYAB("MX Yc0.6 3.4 5.6 3.8 3 10\n\t1.2 -4.4 -1.4 -7 -3 -7\n",e,t);else for(;--s>=0;)out_XYAB("MX Yc1 3.2 5.6 2.8 3.2 8\n\t1.4 -4.8 -2.4 -5.4 -3.2 -5.2\n",e,t),t-=3.5;else if(1==s)out_XYAB("MX Yc0.6 5.6 9.6 9 5.6 18.4\n\t1.6 -6 -1.3 -11.6 -5.6 -12.8\n",e,t);else for(;--s>=0;)out_XYAB("MX Yc0.9 3.7 9.1 6.4 6 12.4\n\t1 -5.4 -4.2 -8.4 -6 -8.4\n",e,t),t-=5.4;else if(a){if(!r)for(t+=1;--s>=0;)out_XYAB("MX Yl7 -3.2 0 -3.2 -7 3.2z\n",e,t),t+=5.4}else if(r)if(1==s)out_XYAB("MX Yc0.6 -3.4 5.6 -3.8 3 -10\n\t1.2 4.4 -1.4 7 -3 7\n",e,t);else for(;--s>=0;)out_XYAB("MX Yc1 -3.2 5.6 -2.8 3.2 -8\n\t1.4 4.8 -2.4 5.4 -3.2 5.2\n",e,t),t+=3.5;else if(1==s)out_XYAB("MX Yc0.6 -5.6 9.6 -9 5.6 -18.4\n\t1.6 6 -1.3 11.6 -5.6 12.8\n",e,t);else for(;--s>=0;)out_XYAB("MX Yc0.9 -3.7 9.1 -6.4 6 -12.4\n\t1 5.4 -4.2 8.4 -6 8.4\n",e,t),t+=5.4;output.push('"/>\n')}}function out_thbar(e,t,n){e+=posx+1.5,t=posy-t,output.push('<path class="stroke" stroke-width="3" d="m'+e.toFixed(2)+" "+t.toFixed(2)+"v"+(-n).toFixed(2)+'"/>\n')}function out_trem(e,t,n){for(out_XYAB('<path class="fill" d="mX Y\n\t',e-4.5,t);output.push("l9 -3v3l-9 3z"),!(--n<=0);)output.push("m0 5.4");output.push('"/>\n')}function out_tubr(e,t,n,r,s){var a=s?-3:3;t+=a,n/=stv_g.scale,output.push('<path class="stroke" d="m'),out_sxsy(e," ",t),output.push("v"+a.toFixed(2)+"l"+n.toFixed(2)+" "+(-r).toFixed(2)+"v"+(-a).toFixed(2)+'"/>\n')}function out_tubrn(e,t,n,r,s,a){var o=10*a.length,i=s?-3:3;out_XYAB('<text style="font-family:serif; font-style:italic; font-size:12px"\n\tx="X" y="Y" text-anchor="middle">A</text>\n',e+(n/=stv_g.scale)/2,t+r/2,a),s||(t+=6),output.push('<path class="stroke" d="m'),out_sxsy(e," ",t),output.push("v"+i.toFixed(2)+"m"+n.toFixed(2)+" "+(-r).toFixed(2)+"v"+(-i).toFixed(2)+'"/>\n'),output.push('<path class="stroke" stroke-dasharray="'+((n-o)/2).toFixed(2)+" "+o.toFixed(2)+'" d="m'),out_sxsy(e," ",t-i),output.push("l"+n.toFixed(2)+" "+(-r).toFixed(2)+'"/>\n')}function out_wln(e,t,n){out_XYAB('<path class="stroke" stroke-width="0.8" d="mX YhF"/>\n',e,t,n)}Abc.prototype.out_svg=out_svg,Abc.prototype.sx=sx,Abc.prototype.sy=sy,Abc.prototype.sh=function(e){return stv_g.st<0?e/stv_g.scale:e},Abc.prototype.ax=function(e){return e+posx},Abc.prototype.ay=function(e){return stv_g.st<0?posy-e:posy+(stv_g.dy-e)*stv_g.scale-stv_g.dy},Abc.prototype.ah=function(e){return stv_g.st<0?e:e*stv_g.scale},Abc.prototype.out_sxsy=out_sxsy,Abc.prototype.xypath=xypath;var deco_str_style={crdc:{dx:0,dy:5,style:"font-family:serif; font-style:italic; font-size:14px"},dacs:{dx:0,dy:3,style:"font-family:serif; font-size:16px",anchor:' text-anchor="middle"'},fng:{dx:0,dy:1,style:"font-family:Bookman; font-size:8px",anchor:' text-anchor="middle"'},pf:{dx:0,dy:5,style:"font-family:serif; font-weight:bold; font-style:italic; font-size:16px"},"@":{dx:0,dy:5,style:"font-family:sans-serif; font-size:12px"}};function out_deco_str(e,t,n,r){var s=deco_str_style[n];s?(e+=s.dx,t+=s.dy,s.def||(style+="\n."+n+" {"+s.style+"}",s.def=!0),out_XYAB('<text x="X" y="Y" class="A"B>',e,t,n,s.anchor||""),set_font("annotation"),out_str(r),output.push("</text>\n")):xygl(e,t,n)}function out_arp(e,t,n){for(g_open(e,t,270),e=0,t=-4,n=Math.ceil(n/6);--n>=0;)xygl(e,t,"ltr"),e+=6;g_close()}function out_cresc(e,t,n,r){out_XYAB('<path class="stroke"\n\td="mX YlA ',e+=n,t+5,n=-n),r.nost?output.push("-2.2m0 -3.6l"+(-n).toFixed(2)+' -2.2"/>\n'):output.push("-4l"+(-n).toFixed(2)+' -4"/>\n')}function out_dim(e,t,n,r){out_XYAB('<path class="stroke"\n\td="mX YlA ',e,t+5,n),r.noen?output.push("-2.2m0 -3.6l"+(-n).toFixed(2)+' -2.2"/>\n'):output.push("-4l"+(-n).toFixed(2)+' -4"/>\n')}function out_ltr(e,t,n){for(t+=4,n=Math.ceil(n/6);--n>=0;)xygl(e,t,"ltr"),e+=6}function out_8va(e,t,n,r){r.nost?n-=5:(out_XYAB('<text x="X" y="Y" style="font-family:serif; font-weight:bold; font-style:italic; font-size:12px">8<tspan dy="-4" style="font-size:10px">va</tspan></text>\n',e-8,t),e+=12,n-=12),out_XYAB('<path class="stroke" stroke-dasharray="6,6" d="mX YhA"/>\n',e,t+=6,n),r.noen||out_XYAB('<path class="stroke" d="mX Yv6"/>\n',e+n,t)}function out_8vb(e,t,n,r){r.nost?n-=5:(out_XYAB('<text x="X" y="Y" style="font-family:serif; font-weight:bold; font-style:italic; font-size:12px">8<tspan dy="-4" style="font-size:10px">vb</tspan></text>\n',e-8,t),e+=4,n-=4),out_XYAB('<path class="stroke" stroke-dasharray="6,6" d="mX YhA"/>\n',e,t,n),r.noen||out_XYAB('<path class="stroke" d="mX Yv-6"/>\n',e+n,t)}function out_15ma(e,t,n,r){r.nost?n-=5:(out_XYAB('<text x="X" y="Y" style="font-family:serif; font-weight:bold; font-style:italic; font-size:12px">15<tspan dy="-4" style="font-size:10px">ma</tspan></text>\n',e-10,t),e+=20,n-=20),out_XYAB('<path class="stroke" stroke-dasharray="6,6" d="mX YhA"/>\n',e,t+=6,n),r.noen||out_XYAB('<path class="stroke" d="mX Yv6"/>\n',e+n,t)}function out_15mb(e,t,n,r){r.nost?n-=5:(out_XYAB('<text x="X" y="Y" style="font-family:serif; font-weight:bold; font-style:italic; font-size:12px">15<tspan dy="-4" style="font-size:10px">mb</tspan></text>\n',e-10,t),e+=7,n-=7),out_XYAB('<path class="stroke" stroke-dasharray="6,6" d="mX YhA"/>\n',e,t,n),r.noen||out_XYAB('<path class="stroke" d="mX Yv-6"/>\n',e+n,t)}var deco_val_tb={arp:out_arp,cresc:out_cresc,dim:out_dim,ltr:out_ltr,"8va":out_8va,"8vb":out_8vb,"15ma":out_15ma,"15mb":out_15mb};function out_deco_val(e,t,n,r,s){deco_val_tb[n]?deco_val_tb[n](e,t,r,s):error(1,null,"No function for decoration '$1'",n)}function out_glisq(e,t,n){var r=n.start,s=r.x,a=r.y+staff_tb[r.st].y,o=-Math.atan2(t-a,e-s),i=o/Math.PI*180,c=(e-s)/Math.cos(o);for(g_open(s,a,i),(c=(c-(s=r.s.dots?13+r.s.xmx:8)-6)/6|0)<1&&(c=1);--c>=0;)xygl(s,0,"ltr"),s+=6;g_close()}function out_gliss(e,t,n){var r=n.start,s=r.x,a=r.y+staff_tb[r.st].y,o=-Math.atan2(t-a,e-s),i=o/Math.PI*180,c=(e-s)/Math.cos(o);g_open(s,a,i),c-=(s=r.s.dots?13+r.s.xmx:8)+8,xypath(s,0),output.push("l"+c.toFixed(2)+' 0" stroke-width="1"/>\n'),g_close()}var deco_l_tb={glisq:out_glisq,gliss:out_gliss},par_sy,cur_sy,voice_tb,curvoice,staves_found,vover,tsfirst;function out_deco_long(e,t,n){var r=n.dd.glyph;deco_l_tb[r]?deco_l_tb[r](e,t,n):error(1,null,"No function for decoration '$1'",r)}function vskip(e){posy+=e}function svg_flush(){if(!multicol&&0!=output.length&&user.img_out&&0!=posy){var e='<svg xmlns="http://www.w3.org/2000/svg" version="1.1"\n\txmlns:xlink="http://www.w3.org/1999/xlink"\n\tcolor="black" class="music" stroke-width=".7"',t="";cfmt.bgcolor&&(e+=' style="background-color: '+cfmt.bgcolor+'"'),posy*=cfmt.scale,user.imagesize?e+="\n"+user.imagesize+' viewBox="0 0 '+img.width.toFixed(0)+" "+posy.toFixed(0)+'">\n':e+='\n\twidth="'+img.width.toFixed(0)+'px" height="'+posy.toFixed(0)+'px">\n',(style||font_style||musicfont)&&(e+='<style type="text/css">'+style+font_style,musicfont&&(musicfont.indexOf("(")>0?e+='\n.music {font-family: music; font-size: 24px; fill: currentColor}\n@font-face {\n  font-family: "music";\n  src: '+musicfont+"}":e+="\n.music {font-family: "+musicfont+"; font-size: 24px; fill: currentColor}"),e+="\n</style>\n"),(defs+=fulldefs)&&(e+="<defs>"+defs+"\n</defs>\n"),1!=cfmt.scale&&(e+='<g class="g" transform="scale('+cfmt.scale.toFixed(2)+')">\n',t="</g>\n"),psvg&&psvg.ps_flush(!0),user.img_out(e+output.join("")+t+"</svg>"),output=[],font_style="",cfmt.fullsvg?(defined_glyph={},defined_font={}):(musicfont="",style="",fulldefs=""),defs="",posy=0}}function blk_out(){!multicol&&user.img_out&&(blk_flush(),user.page_format&&!block.started&&(block.started=!0,block.newpage?(block.newpage=!1,user.img_out('<div class="nobrk newpage">')):user.img_out('<div class="nobrk">')))}function blk_flush(){svg_flush(),block.started&&(block.started=!1,user.img_out("</div>"))}function voice_filter(){var e,t,n;for(e in parse.voice_opts)if(parse.voice_opts.hasOwnProperty(e)&&((t=new RegExp(e)).test(curvoice.id)||t.test(curvoice.nm)))for(n in parse.voice_opts[e])parse.voice_opts[e].hasOwnProperty(n)&&do_pscom(parse.voice_opts[e][n])}function sym_link(e){e.ctx||set_ref(e),curvoice.ignore||(parse.last_sym=e,e.prev=curvoice.last_sym,curvoice.last_sym?curvoice.last_sym.next=e:curvoice.sym=e,curvoice.last_sym=e),e.v=curvoice.v,e.p_v=curvoice,e.st=curvoice.cst,e.time=curvoice.time,e.dur&&!e.grace&&(curvoice.time+=e.dur),e.pos=curvoice.pos,curvoice.second&&(e.second=!0),curvoice.floating&&(e.floating=!0)}function sym_add(e,t){var n,r={type:t,dur:0},s=curvoice;return curvoice=e,sym_link(r),curvoice=s,(n=r.prev)||(n=r.next),n&&(r.ctx=n.ctx,r.istart=n.istart,r.iend=n.iend),r}function mrest_expand(e){var t,n,r,s=e.nmes,a=e.dur/s,o=e.a_dd;for(e.type=REST,e.dur=a,e.head=FULL,e.nflags=-2,r=e.next,(t=e.p_v).last_sym=e,t.time=e.time+a,t.cst=e.st,n=e;--s>0;)(n=sym_add(t,BAR)).bar_type="|",n=sym_add(t,REST),e.invis&&(n.invis=!0),n.dur=a,n.head=FULL,n.nflags=-2,t.time+=a;n.next=r,r&&(r.prev=n),n.a_dd=o}Abc.prototype.blk_out=blk_out,Abc.prototype.blk_flush=blk_flush;var w_tb=new Uint8Array([2,1,8,0,3,5,6,9,9,0,9,3,0,7,0,0,0,0]);function sort_all(){var e,t,n,r,s,a,o,i,c,l,f,u,p=voice_tb.length,d=[],_=[],m=-1;for(t=0;t<p;t++)d.push(voice_tb[t].sym);for(var v=1,y=cur_sy;;){if(y&&v)for(u=y,y=null,o=-1,_=[],t=0;t<p;t++)u.voices[t]?(a=u.voices[t].range)<0||(_[a]=t,o++):u.voices[t]={range:-1};for(s=n=1e6,a=0;a<p&&void 0!=(t=_[a]);a++)!(e=d[t])||e.time>n||(r=w_tb[e.type],e.time<n?(n=e.time,s=r):r<s&&(s=r),e.type==MREST&&(1==e.nmes?mrest_expand(e):o>0&&(m=n)));if(s>127)break;if(n==m){for(c=0,a=0;a<p&&void 0!=(t=_[a]);a++)if((e=d[t])&&e.time==n&&w_tb[e.type]==s){if(e.type!=MREST){m=-1;break}if(0==c)c=e.nmes;else if(c!=e.nmes){m=-1;break}}if(m<0)for(a=0;a<p&&void 0!=(t=_[a]);a++)(e=d[t])&&e.type==MREST&&mrest_expand(e)}for(a=0;a<p&&void 0!=(t=_[a]);a++)if((e=d[t])&&e.time==n&&w_tb[e.type]==s){if(e.type==STAVES){for(y=e.sy,l=0;l<p&&void 0!=_[l];l++);for(f=0;f<p;f++)y.voices[f]&&((a=y.voices[f].range)<0||u.voices[f].range>=0||(_[l++]=f))}v&&(v=0,e.seqst=!0),e.ts_prev=i,i?i.ts_next=e:tsfirst=e,i=e,d[t]=e.next}v=s}}function voice_adj(){var e,t,n,r;function s(e){var t,n,r,s,a,o,i=e.dur,c=1;for(t=e;t&&(!t.beam_end&&t.next);t=t.next)c++;if(c<=1)delete e.feathered_beam;else{if(n=t,s=i/2,o=i/(c-1),r=e.time,e.feathered_beam>0)for(t=e,a=c-1;t!=n;t=t.next,a--)i=(o*a|0)+s,t.dur=i,t.time=r,r+=i;else for(t=e,a=0;t!=n;t=t.next,a++)i=(o*a|0)+s,t.dur=i,t.time=r,r+=i;t.dur=t.time+t.dur-r,t.time=r}}for((t=glovar.tempo)&&staves_found<=0&&(r=par_sy.top_voice,(e=voice_tb[r]).sym&&e.sym.type!=TEMPO&&((t=clone(t)).v=r,t.p_v=e,t.st=e.st,t.time=0,t.next=e.sym,t.next&&(t.next.prev=t),e.sym=t)),r=0;r<voice_tb.length;r++){for((e=voice_tb[r]).ignore&&(e.ignore=!1),t=e.sym;t&&!(t.time>=staves_found);t=t.next);for(;t;t=t.next){switch(t.type){case GRACE:if(t.next&&t.next.type==BAR&&t.time--,!cfmt.graceword)continue;for(n=t.next;n;n=n.next){switch(n.type){case SPACE:continue;case NOTE:if(!n.a_ly)break;t.a_ly=n.a_ly,n.a_ly=null}break}continue}t.feathered_beam&&s(t)}}}function dupl_voice(){var e,t,n,r,s,a,o,i,c=voice_tb.length;for(o=0;o<c;o++)if(t=(e=voice_tb[o]).clone){for(e.clone=null,n=e.sym;n&&!(n.time>=staves_found);n=n.next);for(t.clef=clone(e.clef),curvoice=t;n;n=n.next)if(n.type!=STAVES){if(r=clone(n),n.notes)for(r.notes=[],i=0;i<=n.nhd;i++)r.notes.push(clone(n.notes[i]));if(sym_link(r),t.second?r.second=!0:delete r.second,t.floating?r.floating=!0:delete r.floating,delete r.a_ly,s=r.extra)for(a=clone(s),r.extra=a,(r=a).v=t.v,r.p_v=t,r.st=t.st,s=s.next;s;s=s.next){if(a=clone(s),s.notes)for(a.notes=[],i=0;i<=s.nhd;i++)a.notes.push(clone(s.notes[i]));r.next=a,a.prev=r,(r=a).v=t.v,r.p_v=t,r.st=t.st}}}}function new_syst(e){var t,n,r={voices:[],staves:[],top_voice:0};if(e)cur_sy=par_sy=r;else{for(n=0;n<voice_tb.length;n++){t=par_sy.voices[n].st;var s=par_sy.staves[t],a=voice_tb[n];void 0!=a.stafflines&&(s.stafflines=a.stafflines),a.staffscale&&(s.staffscale=a.staffscale),r.voices[n]=clone(par_sy.voices[n]),r.voices[n].range=-1,delete r.voices[n].second}for(t=0;t<par_sy.staves.length;t++)r.staves[t]=clone(par_sy.staves[t]),r.staves[t].flags=0;par_sy.next=r,par_sy=r}}function go_global_time(e,t){var n,r,s;if(t.bar<=1){if(1==t.bar){for(n=e;n&&(n.type!=BAR||0==n.time);n=n.ts_next);n.time<voice_tb[cur_sy.top_voice].meter.wmeasure&&(e=n)}}else{for(;e&&!(e.type==BAR&&e.bar_num>=t.bar);e=e.ts_next);if(!e)return;if(0!=t.seq){for(s=t.seq,e=e.ts_next;e&&(e.type!=BAR||e.bar_num!=t.bar||0!=--s);e=e.ts_next);if(!e)return}}if(0==t.time)return e;for(r=e.time+t.time;e.time<r;)if(!(e=e.ts_next))return e;do{e=e.ts_prev}while(!e.seqst);return e}function do_clip(){var e,t,n,r,s;if(e=tsfirst,clip_start.bar>0||clip_start.time>0){if(!(e=go_global_time(e,clip_start)))return void(tsfirst=null);for(n=cur_sy,t=tsfirst;t!=e;t=t.ts_next)switch(t.type){case CLEF:t.p_v.clef=t;break;case KEY:t.p_v.key=clone(t.as.u.key);break;case METER:t.p_v.meter=clone(t.as.u.meter);break;case STAVES:n=e.sy}for(cur_sy=n,s=0;s<voice_tb.length;s++){for(r=voice_tb[s],t=e;t;t=t.ts_next)if(t.v==s){delete t.prev;break}r.sym=t}tsfirst=e,delete e.ts_prev}if(e=go_global_time(e,clip_end)){do{if(!(e=e.ts_next))return}while(!e.seqst);for(s=0;s<voice_tb.length;s++){for(r=voice_tb[s],t=e.ts_prev;t;t=t.ts_prev)if(t.v==s){delete t.next;break}t||(r.sym=null)}delete e.ts_prev.ts_next}}function set_bar_num(){var e,t,n,r=cur_sy.top_voice,s=voice_tb[r].meter.wmeasure,a=gene.nbar;for(e=tsfirst;;e=e.ts_next){if(!e)return;switch(e.type){case METER:case CLEF:case KEY:case STBRK:continue;case BAR:if(e.bar_num){gene.nbar=e.bar_num;break}e.text&&!cfmt.contbarnb&&("1"==e.text[0]?a=gene.nbar:(gene.nbar=a,e.bar_num=gene.nbar))}break}for(var o=e.time+s,i=gene.nbar;e;e=e.ts_next)switch(e.type){case METER:s=e.wmeasure,e.time<o&&(o=e.time+s);break;case MREST:for(i+=e.nmes-1;e.ts_next&&e.ts_next.type!=BAR;)e=e.ts_next;break;case BAR:if(e.bar_num){if(i=e.bar_num,e.time<o){delete e.bar_num;break}}else{if(e.time<o)break;i++}n=e.time,t=e;do{if(t.type==BAR&&t.text&&!cfmt.contbarnb){"1"==t.text[0]?a=i:i=a;break}t=t.next}while(t&&t.time==n);e.bar_num=i,o=e.time+s}glovar.break&&function(){var e,t,n,s,a,o;for(t=0;t<glovar.break.length;t++){for(n=glovar.break[t].m,s=glovar.break[t].n,a=glovar.break[t].d,e=voice_tb[r].sym;e&&(e.type!=BAR||e.bar_num!=n);e=e.next);if(e){if(0!=s){for(o=e.time+s/a;e&&!(e.time>o);e=e.next);if(!e)continue}e.eoln=!0}}}(),cfmt.measurenb<0&&(gene.nbar=i)}function get_break(e){var t,n,r,s,a,o=e.split(" ");for(a in glovar.break=[],o)if(o.hasOwnProperty(a))if((r=(t=o[a]).indexOf(":"))<0)glovar.break.push({m:t,n:0,d:1});else{if((s=t.indexOf("/"))<0){syntax(1,"'/' missing in %%break");break}if(n=parseInt(t.slice(s+1)),isNaN(n)||n<=1){syntax(1,"Bad denominator in %%break");break}glovar.break.push({m:t.slice(0,r-1),n:t.slice(r+1,s-1),d:n})}}function get_map(e){if(e){var t,n,r,s,a,o,i=info_split(e,2);if(i.length<3)syntax(1,"Not enough parameters in %%map");else{if(0==(o=i[1]).indexOf("octave,")||0==o.indexOf("key,"))"k"==(o=o.replace(/[,']+$/m,"").toLowerCase())[0]&&(o=o.replace(/[_=^]+/,""));else if("*"==o[0]||0==o.indexOf("all"))o="all";else{if((a=new scanBuf).buffer=i[1],!(n=parse_acc_pit(a)))return void syntax(1,"Bad note in %%map");for(o="abcdefg"[(n.pit+77)%7],n.acc&&(o=["__","_","","^","^^","="][n.acc+2]+o),t=n.pit;t>=28;t-=7)o+="'";for(t=n.pit;t<21;t+=7)o+=","}if((r=maps[i[0]])||(maps[i[0]]=r={}),(s=r[o])||(r[o]=s=[]),i[2]){if(t=2,i[2].indexOf("=")<0){if("*"!=i[2][0]&&((a=new scanBuf).buffer=i[2],s[1]=parse_acc_pit(a)),!i[3])return;t++,i[3].indexOf("=")<0&&(s[0]=i[3].split(","),t++)}for(;t<i.length;t++)switch(i[t]){case"heads=":s[0]=i[++t].split(",");break;case"print=":(a=new scanBuf).buffer=i[++t],s[1]=parse_acc_pit(a);break;case"color=":s[2]=i[++t]}}}}}function get_midi(e){var t,n=e.split(/\s+/);switch(n[0]){case"program":if(n[2]?(n[1],t=n[2]):(0,t=n[1]),t=parseInt(t),isNaN(t)||t<0||t>127)return void syntax(1,"Bad program in %%MIDI");curvoice?curvoice.instr=t:glovar.instr=t}}function set_transp(){var e,t;if(!curvoice.ckey.k_bagpipe&&!curvoice.ckey.k_drum&&(cfmt.transp&&curvoice.transp&&syntax(0,"Mix of old and new transposition syntaxes"),(t=(cfmt.transp||0)+(curvoice.transp||0)+(curvoice.shift||0))!=(curvoice.vtransp||0))){if(curvoice.vtransp=t,!(e=curvoice.last_sym))return curvoice.key=clone(curvoice.okey),key_transp(curvoice.key),curvoice.ckey=clone(curvoice.key),void(curvoice.key.k_none&&(curvoice.key.k_sf=0));for(;e.type!=KEY;){if(!e.prev){e=curvoice.key;break}e=e.prev}key_transp(e),curvoice.ckey=clone(e),curvoice.key.k_none&&(e.k_sf=0)}}function set_ottava(e){if(!cfmt.sound)switch(e){case"15ma(":curvoice.ottava=-14;break;case"8va(":curvoice.ottava=-7;break;case"8vb(":curvoice.ottava=7;break;case"15mb(":curvoice.ottava=14;break;case"15ma)":case"8va)":case"8vb)":case"15mb)":curvoice.ottava=0}}function do_pscom(e){var t,n,r,s,a,o,i,c,l=!1;if(e.match(/ lock$/)&&(l=!0,e=e.slice(0,-5).trim()),s=e.match(/(\w|-)+/)){switch(s=s[0],a=e.replace(s,"").trim(),s){case"break":return void get_break(a);case"center":return parse.state>=2?((r=new_block("text")).text=cnv_escape(a),void(r.opt="c")):void write_text(cnv_escape(a),"c");case"clef":return void(parse.state>=2&&(2==parse.state&&goto_tune(),(r=new_clef(a))&&get_clef(r)));case"clip":return;case"deco":return void deco_add(a);case"linebreak":return void set_linebreak(a);case"MIDI":return void get_midi(a);case"map":return void get_map(a);case"maxsysstaffsep":if(3==parse.state)return void(par_sy.voices[curvoice.v].maxsep=get_unit(a));break;case"multicol":switch(generate(),a){case"start":blk_out(),multicol={posy:posy,maxy:posy,lmarg:cfmt.leftmargin,rmarg:cfmt.rightmargin,state:parse.state};break;case"new":if(!multicol){syntax(1,"%%multicol new without start");break}posy>multicol.maxy&&(multicol.maxy=posy),cfmt.leftmargin=multicol.lmarg,cfmt.rightmargin=multicol.rmarg,img.chg=!0,set_page(),posy=multicol.posy;break;case"end":if(!multicol){syntax(1,"%%multicol end without start");break}posy<multicol.maxy&&(posy=multicol.maxy),cfmt.leftmargin=multicol.lmarg,cfmt.rightmargin=multicol.rmarg,multicol=void 0,blk_out(),img.chg=!0,set_page();break;default:syntax(1,"Unknown keyword '$1' in %%multicol",a)}return;case"musicfont":return void(musicfont=a);case"ottava":if(3!=parse.state){if(2!=parse.state)return;goto_tune()}if(o=parseInt(a),isNaN(o)||o<-2||o>2)return void syntax(1,err_bad_val_s,"%%ottava");switch(curvoice.ottava){case 14:c="15mb)";break;case 7:c="8vb)";break;case-7:c="8va)";break;case-14:c="15ma)"}switch(c&&(a_dcn||(a_dcn=[]),a_dcn.push(c),set_ottava(c)),o){case-2:c="15mb(";break;case-1:c="8vb(";break;case 0:return;case 1:c="8va(";break;case 2:c="15ma("}return a_dcn||(a_dcn=[]),a_dcn.push(c),void set_ottava(c);case"repbra":return void(parse.state>=2&&(2==parse.state&&goto_tune(),curvoice.norepbra=!get_bool(a)));case"repeat":if(3!=parse.state)return;if(!curvoice.last_sym)return void syntax(1,"%%repeat cannot start a tune");if(a.length){if(c=a.split(/\s+/),o=parseInt(c[0]),i=parseInt(c[1]),isNaN(o)||o<1||curvoice.last_sym.type==BAR&&o>2)return void syntax(1,"Incorrect 1st value in %%repeat");if(isNaN(i))i=1;else if(i<1)return void syntax(1,"Incorrect 2nd value in %%repeat")}else o=1,i=1;return parse.repeat_n=curvoice.last_sym.type==BAR?o:-o,void(parse.repeat_k=i);case"sep":var f,u,p,d;return set_page(),d=img.width-img.lm-img.rm,t=f=u=0,a&&(t=get_unit((p=a.split(/\s+/))[0]),p[1]&&(f=get_unit(p[1]),p[2]&&(u=get_unit(p[2])))),t<1&&(t=14),f<1&&(f=t),u<1&&(u=90),parse.state>=2?((r=new_block(s)).x=(d-u)/2/cfmt.scale,r.l=u/cfmt.scale,r.sk1=t,void(r.sk2=f)):(blk_out(),vskip(t),output.push('<path class="stroke"\n\td="M'),out_sxsy((d-u)/2/cfmt.scale," ",0),output.push("h"+(u/cfmt.scale).toFixed(2)+'"/>\n'),vskip(f),void blk_flush());case"setbarnb":return n=parseInt(a),void(isNaN(n)?syntax(1,"Bad %%setbarnb value"):parse.state>=2?glovar.new_nbar=n:cfmt.measurefirst=n);case"staff":if(3!=parse.state){if(2!=parse.state)return;goto_tune()}return n=parseInt(a),isNaN(n)?void syntax(1,"Bad %%staff value '$1'",a):(_="+"==a[0]||"-"==a[0]?curvoice.cst+n:n-1)<0||_>nstaff?void syntax(1,"Bad %%staff number $1 (cur $2, max $3)",_,curvoice.cst,nstaff):(delete curvoice.floating,void(curvoice.cst=_));var _;case"staffbreak":if(3!=parse.state){if(2!=parse.state)return;goto_tune()}return r={type:STBRK,dur:0},a[0]>="0"&&a[0]<="9"?(r.xmx=get_unit(a),"f"==a.slice(-1)&&(r.stbrk_forced=!0)):(r.xmx=14,"f"==a[0]&&(r.stbrk_forced=!0)),void sym_link(r);case"stafflines":return void(void 0==(n=get_st_lines(a))?syntax(1,"Bad %%stafflines value"):set_v_param(s,n));case"staffscale":return n=parseFloat(a),void(isNaN(n)||n<.3||n>2?syntax(1,"Bad %%staffscale value"):set_v_param(s,n));case"staves":case"score":if(0==parse.state)return;return void get_staves(s,a);case"sysstaffsep":if(3==parse.state)return void(par_sy.voices[curvoice.v].sep=get_unit(a));break;case"text":return parse.state>=2?((r=new_block(s)).text=cnv_escape(a),void(r.opt=cfmt.textoption)):void write_text(cnv_escape(a),cfmt.textoption);case"transpose":if(cfmt.sound)return;switch(parse.state){case 0:cfmt.transp=0;case 1:case 2:return void(cfmt.transp=(cfmt.transp||0)+get_transp(a))}for(r=curvoice.last_sym;r;r=r.prev){switch(r.type){case NOTE:(r=clone(curvoice.okey)).k_old_sf=curvoice.ckey.k_sf,sym_link(r);break;case KEY:break;default:continue}break}return void do_info("V",curvoice.id+" shift="+a);case"tune":return;case"user":return void set_user(a);case"voicecolor":if(3!=parse.state){if(2!=parse.state)return;goto_tune()}return void(curvoice.color=a);case"vskip":return(n=get_unit(a))<0?void syntax(1,"%%vskip cannot be negative"):parse.state>=2?void((r=new_block(s)).sk=n):void vskip(n);case"newpage":case"leftmargin":case"rightmargin":case"pagescale":case"pagewidth":case"printmargin":case"scale":case"staffwidth":if(3==parse.state)return void((r=new_block(s)).param=a);if("newpage"==s)return blk_flush(),void(block.newpage=!0)}set_format(s,a,l)}}function do_begin_end(type,opt,text){var i,j,action,s;switch(type){default:"nosvg"!=opt&&psvg&&psvg.ps_eval(text);break;case"js":is_secure(text)?eval('"use strict"\n'+text):syntax(1,"Unsecure code");break;case"ml":parse.state>=2?(s=new_block(type),s.text=text):(svg_flush(),user.img_out(text));break;case"svg":for(j=0;i=text.indexOf('<style type="text/css">\n',j),!(i<0);){if(j=text.indexOf("</style>",i),j<0){syntax(1,"No </style> in %%beginsvg sequence");break}style+=text.slice(i+23,j).replace(/\s+$/,"")}for(j=0;i=text.indexOf("<defs>\n",j),!(i<0);){if(j=text.indexOf("</defs>",i),j<0){syntax(1,"No </defs> in %%beginsvg sequence");break}defs_add(text.slice(i+6,j))}break;case"text":if(action=get_textopt(opt),action||(action=cfmt.textoption),parse.state>=2){s=new_block(type),s.text=cnv_escape(text),s.opt=action;break}write_text(cnv_escape(text),action)}}function generate(){var e,t;if(vover&&(syntax(1,"No end of voice overlay"),get_vover(vover.bar?"|":")")),0!=voice_tb.length&&(voice_adj(),dupl_voice(),sort_all(),tsfirst&&(set_bar_num(),tsfirst))){for(user.get_abcmodel&&user.get_abcmodel(tsfirst,voice_tb,anno_type,info),user.img_out&&output_music(),e=0;e<voice_tb.length;e++)(t=voice_tb[e]).time=0,t.sym=t.last_sym=null,t.st=cur_sy.voices[e].st,t.second=cur_sy.voices[e].second,delete t.have_ly,t.hy_st=0,delete t.bar_start,delete t.slur_st,delete t.s_tie,delete t.s_rtie;staves_found=0}}function key_transp(e){var t=curvoice.vtransp/3|0,n=(-2&t)+7*(1&t)+e.k_sf;switch((curvoice.vtransp+210)%3){case 1:n=(n+4+48)%12-4;break;case 2:n=(n+7+48)%12-7;break;default:n=(n+5+48)%12-5}e.k_sf=n,e.k_delta=cgd2cde[(n+7)%7]}function set_k_acc(e){var t,n,r,s,a,o=[],i=[],c=[],l=[];if(e.k_sf>0)for(s=0;s<e.k_sf;s++)o[s]=1,i[s]=[26,23,27,24,21,25,22][s];else for(s=0;s<-e.k_sf;s++)o[s]=-1,i[s]=[22,25,21,24,20,23,26][s];for(r=e.k_a_acc.length,t=0;t<r;t++){for(a=e.k_a_acc[t],n=0;n<s;n++)if(i[n]==a.pit){o[n]=a.acc,a.micro_n&&(c[n]=a.micro_n,l[n]=a.micro_d);break}n==s&&(o[n]=a.acc,i[n]=a.pit,a.micro_n&&(c[n]=a.micro_n,l[n]=a.micro_d),s++)}for(t=0;t<s;t++)(a=e.k_a_acc[t])||(a=e.k_a_acc[t]={}),a.acc=o[t],a.pit=i[t],c[t]?(a.micro_n=c[t],a.micro_d=l[t]):(delete a.micro_n,delete a.micro_d)}function acc_same_pitch(e){var t,n,r=curvoice.last_sym.prev;if(r)for(n=r.time;r;r=r.prev)switch(r.type){case BAR:if(r.time<n)return;for(;;){if(!(r=r.prev))return;if(r.type==NOTE){if(r.time+r.dur==n)break;return}if(r.time<n)return}for(t=0;t<=r.nhd;t++)if(r.notes[t].pit==e&&r.notes[t].ti1)return r.notes[t].acc;return;case NOTE:for(t=0;t<=r.nhd;t++)if(r.notes[t].pit==e)return r.notes[t].acc}}function get_staves(e,t){var n,r,s,a,o,i,c,l,f=parse_staves(t);if(f){0!=voice_tb.length&&(voice_adj(),dupl_voice());var u=0,p=!0;for(i=0;i<voice_tb.length;i++)(r=voice_tb[i]).time>u&&(u=r.time),r.sym&&(p=!1);if(p||0==u&&staves_found<0)for(i=0;i<par_sy.voices.length;i++)par_sy.voices[i].range=-1;else{for(i=0;i<par_sy.voices.length;i++)if(par_sy.voices[i].range>=0){curvoice=voice_tb[i];break}curvoice.time=u,sym_link(n={type:STAVES,dur:0}),par_sy.nstaff=nstaff,new_syst(),n.sy=par_sy}for(staves_found=u,i=0;i<voice_tb.length;i++)delete(r=voice_tb[i]).second,delete r.ignore,delete r.floating;for(l=0,a=0;a<f.length;a++){if((r=new_voice(f[a][0])).time=u,i=r.v,0==a&&(par_sy.top_voice=r.v),par_sy.voices[i].range>=0){for(s=clone(r),par_sy.voices[voice_tb.length]=clone(par_sy.voices[i]),i=voice_tb.length,s.v=i,s.sym=s.last_sym=null,s.time=u,voice_tb.push(s),delete s.clone;r.clone;)r=r.clone;r.clone=s,r=s}f[a][0]=r,par_sy.voices[i].range=l++}if("t"==e[1])for(a=0;a<f.length;a++)(o=f[a][1])&(OPEN_BRACE|OPEN_BRACE2)&&(o&(OPEN_BRACE|CLOSE_BRACE))!=(OPEN_BRACE|CLOSE_BRACE)&&(o&(OPEN_BRACE2|CLOSE_BRACE2))!=(OPEN_BRACE2|CLOSE_BRACE2)&&0==f[a+1][1]&&(o&OPEN_PARENTH||f[a+2][1]&OPEN_PARENTH||(f[a+2][1]&(CLOSE_BRACE|CLOSE_BRACE2)?f[a+1][1]|=FL_VOICE:0==f[a+2][1]&&f[a+3][1]&(CLOSE_BRACE|CLOSE_BRACE2)&&(f[a][1]|=OPEN_PARENTH,f[a+1][1]|=CLOSE_PARENTH,f[a+2][1]|=OPEN_PARENTH,f[a+3][1]|=CLOSE_PARENTH)));for(c=-1,a=0;a<f.length;a++)if(((o=f[a][1])&(OPEN_PARENTH|CLOSE_PARENTH))==(OPEN_PARENTH|CLOSE_PARENTH)&&(o&=~(OPEN_PARENTH|CLOSE_PARENTH),f[a][1]=o),r=f[a][0],o&FL_VOICE?(r.floating=!0,r.second=!0):(c++,par_sy.staves[c]||(par_sy.staves[c]={stafflines:"|||||",staffscale:1}),par_sy.staves[c].flags=0),i=r.v,r.st=r.cst=par_sy.voices[i].st=c,par_sy.staves[c].flags|=o,o&OPEN_PARENTH){for(s=r;a<f.length-1&&(i=(r=f[++a][0]).v,f[a][1]&MASTER_VOICE?(s.second=!0,s=r):r.second=!0,r.st=r.cst=par_sy.voices[i].st=c,!(f[a][1]&CLOSE_PARENTH)););par_sy.staves[c].flags|=f[a][1]}if(c<0&&(c=0),par_sy.nstaff=nstaff=c,"c"==e[1])for(c=0;c<nstaff;c++)par_sy.staves[c].flags^=STOP_BAR;for(i=0;i<voice_tb.length;i++)r=voice_tb[i],par_sy.voices[i].range<0?r.ignore=!0:(par_sy.voices[i].second=r.second,!((c=r.st)>0)||r.norepbra||par_sy.staves[c-1].flags&STOP_BAR||(r.norepbra=!0));curvoice=parse.state>=2?voice_tb[par_sy.top_voice]:null}}var err_no_strt_ov="No note in voice overlay",capo;function get_vover(e){var t,n,r,s,a,o,i,c;parse.line;function l(e){var t,n;for(t=0;t<voice_tb.length;t++)if((n=voice_tb[t]).id==e)return n;return(n=clone(curvoice)).v=voice_tb.length,n.id=e,n.sym=n.last_sym=null,delete n.nm,delete n.snm,delete n.new_name,delete n.lyric_restart,delete n.lyric_cont,delete n.ly_a_h,delete n.sym_restart,delete n.sym_cont,voice_tb.push(n),n}if(!curvoice.ignore){if("|"==e||")"==e)return curvoice.last_note?(curvoice.last_note.beam_end=!0,vover?(curvoice.time!=vover.mxtime&&syntax(1,"Wrong duration in voice overlay"),curvoice=vover.p_voice,void(vover=null)):void syntax(1,"Erroneous end of voice overlay")):void syntax(1,err_no_strt_ov);if("("==e)return vover?void syntax(1,"Voice overlay already started"):void(vover={p_voice:curvoice,time:curvoice.time});if(curvoice.last_note){if(curvoice.last_note.beam_end=!0,!(t=curvoice.voice_down)){t=l(curvoice.id+"o"),curvoice.voice_down=t,t.time=0,t.second=!0,i=t.v,par_sy.voices[i]={st:curvoice.st,second:!0};var f=void 0!=curvoice.clone?1:0;for(r=par_sy.voices[curvoice.v].range,o=0;o<par_sy.voices.length;o++)par_sy.voices[o].range>r&&(par_sy.voices[o].range+=f+1);par_sy.voices[i].range=r+1,f&&((n=l(t.id+"c")).second=!0,c=n.v,par_sy.voices[c]={second:!0,range:r+2},t.clone=n)}if(t.ulen=curvoice.ulen,t.dur_fact=curvoice.dur_fact,curvoice.uscale&&(t.uscale=curvoice.uscale),vover)vover.mxtime?curvoice.time!=vover.mxtime&&syntax(1,"Wrong duration in voice overlay"):vover.mxtime=curvoice.time;else{for(vover={bar:!0,mxtime:curvoice.time,p_voice:curvoice},a=t.time,s=curvoice.last_sym;!(s.type==BAR||s.time<=a);s=s.prev);vover.time=s.time}t.time=vover.time,curvoice=t}else syntax(1,err_no_strt_ov)}}function is_voice_sig(){var e;if(!curvoice.sym)return!0;if(0!=curvoice.time)return!1;for(e=curvoice.last_sym;e;e=e.prev)if(0!=w_tb[e.type])return!1;return!0}function get_clef(e){var t,n;if(is_voice_sig())curvoice.clef=e;else{for(t=curvoice.last_sym;t&&t.prev&&t.time==curvoice.time&&0==w_tb[t.type];t=t.prev);if(t&&t.prev&&t.time==curvoice.time&&(t.type==KEY&&!t.k_none||t.type==BAR)){for(n=t;n.prev;n=n.prev){switch(n.prev.type){case KEY:case BAR:continue}break}t=curvoice.last_sym,curvoice.last_sym=n.prev,sym_link(e),e.next=n,n.prev=e,curvoice.last_sym=t}else sym_link(e);e.clef_small=!0}}function get_key(e){var t,n,r,s,a=new_key(e),o=a[0];switch(a=a[1],o.k_sf&&!o.k_exp&&o.k_a_acc&&set_k_acc(o),parse.state){case 1:for(void 0!=o.k_sf||o.k_a_acc||(o.k_sf=0,o.k_none=!0),t=0;t<voice_tb.length;t++)(n=voice_tb[t]).key=clone(o),n.okey=clone(o),n.ckey=clone(o);return parse.okey=clone(o),parse.ckey=o,0!=a.length&&memo_kv_parm("*",a),glovar.ulen||(glovar.ulen=BASE_LEN/8),parse.state=2,set_page(),write_heading(),reset_gen(),void(gene.nbar=cfmt.measurefirst);case 2:goto_tune(!0)}if(0!=a.length&&set_kv_parm(a),s=(cfmt.transp||0)+(curvoice.transp||0)+(curvoice.shift||0),void 0==o.k_sf){if(!o.k_a_acc&&!s)return;o.k_sf=curvoice.okey.k_sf}if(curvoice.okey=clone(o),s&&(curvoice.vtransp=s,key_transp(o)),o.k_old_sf=curvoice.ckey.k_sf,curvoice.ckey=o,is_voice_sig())return curvoice.key=clone(o),void(o.k_none&&(curvoice.key.k_sf=0));(r=curvoice.last_sym)&&r.type==METER?(curvoice.last_sym=r.prev,curvoice.last_sym||(curvoice.sym=null),sym_link(o),o.next=r,r.prev=o,curvoice.last_sym=r):sym_link(o)}function new_voice(e){var t,n,r,s=voice_tb.length;if(1==s&&voice_tb[0].default&&(delete voice_tb[0].default,0==voice_tb[0].time))return(t=voice_tb[0]).id=e,cfmt.transp&&parse.state>=2&&(r=curvoice,curvoice=t,set_transp(),curvoice=r),t;for(n=0;n<s;n++)if((t=voice_tb[n]).id==e)return t;return t={v:n,id:e,time:0,new:!0,pos:{dyn:0,gch:0,gst:0,orn:0,stm:0,voc:0,vol:0},scale:1,combine:0,ulen:glovar.ulen,dur_fact:1,key:clone(parse.ckey),ckey:clone(parse.ckey),okey:clone(parse.okey),meter:clone(glovar.meter),wmeasure:glovar.meter.wmeasure,clef:{type:CLEF,clef_auto:!0,clef_type:"a",time:0},hy_st:0,instr:glovar.instr||0},voice_tb.push(t),par_sy.voices[n]={range:-1},t}function init_tune(){nstaff=-1,voice_tb=[],curvoice=null,new_syst(!0),staves_found=-1,gene={},a_de=[],od={},capo&&(capo=!1)}function get_voice(e){var t,n=info_split(e,1),r=n.shift();if(parse.state<2)return 0!=n.length&&memo_kv_parm(r,n),void("*"!=r&&1==parse.state&&new_voice(r));"*"!=r?(curvoice=new_voice(r),set_kv_parm(n),2==parse.state&&goto_tune(),set_transp(),t=curvoice.v,curvoice.new&&(delete curvoice.new,staves_found<0&&(curvoice.st=curvoice.cst=++nstaff,par_sy.nstaff=nstaff,par_sy.voices[t].st=nstaff,par_sy.voices[t].range=t,par_sy.staves[nstaff]={stafflines:"|||||",staffscale:1}),par_sy.voices[t].range<0&&staves_found>=0&&(curvoice.ignore=!0)),curvoice.filtered||curvoice.ignore||!parse.voice_opts||(curvoice.filtered=!0,voice_filter())):syntax(1,"Cannot have V:* in tune body")}function goto_tune(e){var t,n,r={type:STAVES,dur:0,sy:par_sy};for(parse.state=3,0==voice_tb.length?((curvoice=new_voice("1")).clef.istart=curvoice.key.istart,curvoice.clef.iend=curvoice.key.iend,curvoice.default=!0):curvoice||(curvoice=voice_tb[staves_found<0?0:par_sy.top_voice]),curvoice.init||e||(set_kv_parm([]),set_transp()),t=0;t<voice_tb.length;t++)(n=voice_tb[t]).ulen=glovar.ulen,n.key.k_bagpipe&&!n.pos.stm&&(n.pos=clone(n.pos),n.pos.stm=SL_BELOW);if(staves_found<0){for(nstaff=voice_tb.length-1,t=0;t<=nstaff;t++)delete(n=voice_tb[t]).new,n.st=n.cst=par_sy.voices[t].st=par_sy.voices[t].range=t,par_sy.staves[t]={stafflines:"|||||",staffscale:1};par_sy.nstaff=nstaff}n=curvoice,curvoice=voice_tb[par_sy.top_voice],sym_link(r),staves_found<0&&(r.default=!0),curvoice=n}function get_sym(e,t){var n,r,s,a,o;if(!curvoice.ignore){if(t){if(!(n=curvoice.sym_cont))return void syntax(1,"+: symbol line without music")}else if(curvoice.sym_restart?(curvoice.sym_start=n=curvoice.sym_restart,curvoice.sym_restart=null):n=curvoice.sym_start,n||(n=curvoice.sym),!n)return void syntax(1,"s: without music");for(s=0;;){for(;" "==e[s]||"\t"==e[s];)s++;if(!(r=e[s]))break;switch(r){case"|":for(;n&&n.type!=BAR;)n=n.next;if(!n)return void syntax(1,"Not enough measure bars for symbol line");n=n.next,s++;continue;case"!":case'"':if(a=++s,(s=e.indexOf(r,a))<0){syntax(1,"!"==r?"No end of decoration":"No end of guitar chord"),s=e.length;continue}o=e.slice(a-1,s+1);break;case"*":break;default:if((o=r.charCodeAt(0))<128&&(o=char_tb[o]).length>1&&("!"==o[0]||'"'==o[0])){r=o[0];break}syntax(1,"Bad character '$1'",r)}for(;n&&(n.type!=NOTE||n.grace);)n=n.next;if(!n)return void syntax(1,"Too many elements in symbol line");switch(r){default:break;case"!":deco_cnv([o.slice(1,-1)],n,n.prev);break;case'"':a_gch=n.a_gch,parse_gchord(o),a_gch&&gch_build(n)}n=n.next,s++}curvoice.lyric_cont=n}}function get_lyrics(e,t){var n,r,s,a,o,i;if(!curvoice.ignore){if(curvoice.pos.voc!=SL_HIDDEN&&(curvoice.have_ly=!0),t){if(!(n=curvoice.lyric_cont))return void syntax(1,"+: lyric without music")}else if(set_font("vocal"),curvoice.lyric_restart?(curvoice.lyric_start=n=curvoice.lyric_restart,curvoice.lyric_restart=null,curvoice.lyric_line=0):(curvoice.lyric_line++,n=curvoice.lyric_start),n||(n=curvoice.sym),!n)return void syntax(1,"w: without music");for(s=e,a=0;;){for(;" "==s[a]||"\t"==s[a];)a++;if(!s[a])break;switch(o=parse.istart+a+2,s[a]){case"|":for(;n&&n.type!=BAR;)n=n.next;if(!n)return void syntax(1,"Not enough measure bars for lyric line");n=n.next,a++;continue;case"-":r="-\n";break;case"_":r="_\n";break;case"*":r="";break;default:if("\\"==s[a]&&a==s.length-1)return void(curvoice.lyric_cont=n);for(r="";s[a];){switch(s[a]){case"_":case"*":case"|":a--;case" ":case"\t":break;case"~":r+=" ",a++;continue;case"-":r+="\n";break;case"\\":r+=s[++a],a++;continue;default:r+=s[a++];continue}break}}for(;n&&(n.type!=NOTE||n.grace);)n=n.next;if(!n)return void syntax(1,"Too many words in lyric line");r&&n.pos.voc!=SL_HIDDEN&&(r.match(/^\$\d/)&&("0"==r[1]?set_font("vocal"):set_font("u"+r[1]),r=r.slice(2)),i={t:r,font:gene.curfont,w:strw(r),istart:o,iend:o+r.length},n.a_ly||(n.a_ly=[]),n.a_ly[curvoice.lyric_line]=i),n=n.next,a++}curvoice.lyric_cont=n}}function ly_width(e,t){var n,r,s,a,o,i,c,l,f,u,p,d=e.a_ly;for(a=0,c=0;c<d.length;c++)if(n=d[c]){for(p=n.t,i=n.w,s=n.font.swfac,o=i+2*cwid(" ")*s,e.type==GRACE?u=e.wl:p[0]>="0"&&p[0]<="9"&&p.length>2||":"==p[1]||"("==p[0]||")"==p[0]?("("==p[0]?r=cwid("(")*s:(l=p.indexOf(" "),gene.curfont=gene.deffont=n.font,r=l>0?strw(p.slice(0,l)):i),(u=.4*(i-r+2*cwid(" ")*s))>20&&(u=20),u+=r,n.t[0]>="0"&&n.t[0]<="9"&&u>a&&(a=u)):"-\n"==p||"_\n"==p?u=0:(u=.4*o)>20&&(u=20),n.shift=u,t<u&&(t=u),o-=u,u=2*cwid(" ")*s,f=e.next;f;f=f.next){switch(f.type){case NOTE:case REST:if(f.a_ly&&f.a_ly[c]&&0!=f.a_ly[c].w){if("-\n"!=f.a_ly[c].t&&"_\n"!=f.a_ly[c].t)break;o-=u}else o-=9;if(o<=0)break;continue;case CLEF:case METER:case KEY:o-=10;continue;default:o-=5}break}o>e.wr&&(e.wr=o)}if(a>0)for(c=0;c<d.length;c++)(n=d[c])&&n.t[0]>="0"&&n.t[0]<="9"&&(n.shift=a);return t}function draw_lyric_line(e,t,n){var r,s,a,o,i,c,l,f,u,p;for(e.hy_st&1<<t&&(l=!0,e.hy_st&=~(1<<t)),o=e.sym;o.type==CLEF||o.type==KEY||o.type==METER;o=o.next);for(s=o.prev?o.prev.x:tsfirst.x,u=0;o;o=o.next)if(c=o.a_ly?o.a_ly[t]:null)c.font!=gene.curfont&&(gene.curfont=c.font),r=c.t,a=c.w,p=c.shift,l&&("_\n"==r?r="-\n":"-\n"!=r&&(out_hyph(s,n,o.x-p-s),l=!1,s=o.x+o.wr)),f&&"_\n"!=r&&(out_wln(s+3,n,u-s+3),f=!1,s=o.x+o.wr),"-\n"!=r&&"_\n"!=r?(u=o.x-p,"\n"==r.slice(-1)&&(r=r.slice(0,-1),l=!0),(user.anno_start||user.anno_stop)&&(i={st:o.st,istart:c.istart,iend:c.iend,x:u,y:n,ymn:n,ymx:n+gene.curfont.size,wl:0,wr:a},anno_start(i,"lyrics")),xy_str(u,n,r),anno_stop(i,"lyrics"),s=u+a):(0==u&&s>o.x-18&&(s=o.x-18),"-"==r[0]?l=!0:f=!0,u=o.x-p);else switch(o.type){case REST:case MREST:f&&(out_wln(s+3,n,u-s),f=!1,s=o.x+o.wr)}for(l&&(l=!1,(u=realwidth-10)<s+10&&(u=s+10),out_hyph(s,n,u-s),cfmt.hyphencont&&(e.hy_st|=1<<t)),e.s_next;o;o=o.next)if(o.type==NOTE){if(!o.a_ly)break;(c=o.a_ly[t])&&"_\n"==c.t&&(f=!0,(u=realwidth-15)<s+12&&(u=s+12));break}f&&(out_wln(s+3,n,u-s+3),f=!1)}function draw_lyrics(e,t,n,r,s){var a,o,i=staff_tb[e.st].staffscale;if(set_font("vocal"),s>0){for(r>-cfmt.vocalspace&&(r=-cfmt.vocalspace),r*=i,a=0;a<t;a++)draw_lyric_line(e,a,r-=1.1*n[a]);return(r-n[a-1]/6)/i}for(r<(o=staff_tb[e.st].topbar+cfmt.vocalspace)&&(r=o),r*=i,a=t;--a>=0;)draw_lyric_line(e,a,r),r+=1.1*n[a];return r/i}function draw_all_lyrics(){var e,t,n,r,s,a,o,i,c,l,f=new Array(nstaff),u=voice_tb.length,p=new Array(u),d=new Array(u),_=new Array(u),m=new Array(u),v=0,y=0,h=-1;for(n=0;n<u;n++)if((e=voice_tb[n]).sym){if(e.st!=h&&(v=0,y=0,h=e.st),r=0,e.have_ly){for(p[n]||(p[n]=[]),t=e.sym;t;t=t.next)if(c=t.a_ly){for(a=t.x,i=10,s=0;s<c.length;s++)if((l=c[s])&&0!=l.w){a-=l.shift,i=l.w;break}for(v<(o=y_get(e.st,1,a,i))&&(v=o),y>(o=y_get(e.st,0,a,i))&&(y=o);r<c.length;)p[n][r++]=0;for(s=0;s<c.length;s++)(l=c[s])&&(!p[n][s]||l.font.size>p[n][s])&&(p[n][s]=l.font.size)}}else v<(o=y_get(e.st,1,0,realwidth))&&(v=o),y>(o=y_get(e.st,0,0,realwidth))&&(y=o);f[h]||(f[h]={}),f[h].top=v,f[h].bot=y,d[n]=r,0!=r&&(e.pos.voc?_[n]=e.pos.voc==SL_ABOVE:voice_tb[n+1]&&voice_tb[n+1].st==h&&voice_tb[n+1].have_ly?_[n]=!0:_[n]=!1,_[n]?f[h].a=!0:f[h].b=!0)}for(s=0,n=0;n<u;n++)(e=voice_tb[n]).sym&&e.have_ly&&(_[n]?m[s++]=n:(set_dscale(h=e.st,!0),d[n]>0&&(f[h].bot=draw_lyrics(e,d[n],p[n],f[h].bot,1))));for(;--s>=0;)n=m[s],set_dscale(h=(e=voice_tb[n]).st,!0),f[h].top=draw_lyrics(e,d[n],p[n],f[h].top,-1);for(n=0;n<u;n++)if((e=voice_tb[n]).sym){if(f[h=e.st].a)for(v=f[h].top+2,t=e.sym.next;t;t=t.next)t.a_ly&&y_set(h,1,t.x-2,10,v);if(f[h].b)if(y=f[h].bot-2,d[e.v]>0)for(t=e.sym.next;t;t=t.next)t.a_ly&&y_set(h,0,t.x-2,10,y);else y_set(h,0,0,realwidth,y)}}function parse_gchord(e){var t,n,r,s,a,o,i,c,l=get_font("annotation").size,f=parse.line;function u(){for(var e="";;){if(t=n[o++],"1234567890.-".indexOf(t)<0)return parseFloat(e);e+=t}}if(i=parse.bol+f.index,e.length>1)n=e.slice(1,-1),c=i+1;else{for(n="";;){if(!(t=f.next_char()))return void syntax(1,"No end of guitar chord");if('"'==t)break;"\\"==t&&(n+=t,t=f.next_char()),n+=t}c=parse.bol+f.index+1}if(curvoice.pos.gch!=SL_HIDDEN)for(o=0,e="g";t=n[o];){switch(r={text:"",istart:i,iend:c},t){case"@":e=t,o++,s=u(),","!=t?(syntax(1,"',' lacking in annotation '@x,y'"),a=0):(a=u()," "!=t&&o--),r.x=s,r.y=a-l/2;break;case"^":case"_":case"<":case">":o++,e=t}for(r.type=e;t=n[o];){switch(t){case"\\":if(!(t=n[++o])||"n"==t)break;r.text+="\\";default:r.text+=t,o++;continue;case"&":for(;;){switch(r.text+=t,t=n[++o]){default:continue;case";":case void 0:case"\\":}break}if(";"==t){r.text+=t;continue}break;case";":}o++;break}a_gch||(a_gch=[]),a_gch.push(r)}}function gch_capo(e){for(var t,n,r=0;;){if(!(t=e.a_gch[r++]))return;if("g"==t.type)break}(n=clone(t)).text=gch_tr1(n.text,-cfmt.capo),capo||(capo=!0,n.text+="  (capo: "+cfmt.capo.toString()+")"),n.type="^",e.a_gch.splice(r,0,n)}var note_names="CDEFGAB",latin_names=["Do","R","Mi","Fa","Sol","La","Si"],acc_name=["bb","b","","#","##"],note_pit=new Int8Array([0,2,4,5,7,9,11]),pit_note=new Int8Array([0,0,1,2,2,3,3,4,5,5,6,6]),pit_acc=new Int8Array([2,3,2,1,2,2,3,2,1,2,1,2]);function gch_tr1(e,t){var n,r,s,a,o,i,c,l,f=0;switch(e[0]){case"A":r=5;break;case"B":r=6;break;case"C":r=0;break;case"D":if("o"==e[1]){f++,r=0;break}r=1;break;case"E":r=2;break;case"F":"a"==e[1]&&f++,r=3;break;case"G":r=4;break;case"L":f++,r=5;break;case"M":f++,r=2;break;case"R":f++,"e"!=e[1]&&f++,r=1;break;case"S":f++,"o"==e[1]?(f++,r=4):r=6;break;case"/":f--;break;default:return e}if(i=0,c=f+1,f>=0){for(;"#"==e[c];)i++,c++;for(;"b"==e[c];)i--,c++;a=(note_pit[r]+i+t+12)%12,o=pit_note[a],s=pit_acc[a],n=(f?latin_names[o]:note_names[o])+acc_name[s]}else n="";return(l=e.indexOf("/",c))<0?n+e.slice(c):(r=note_names.indexOf(e[++l]))<0?n+e.slice(c):(n+=e.slice(c,l),i=0,"#"==e[++l]?(i++,"#"==e[++l]&&(i++,l++)):"b"==e[l]&&(i--,"b"==e[++l]&&(i--,l++)),a=(note_pit[r]+i+t+12)%12,o=pit_note[a],s=pit_acc[a],n+note_names[o]+acc_name[s]+e.slice(l))}function gch_transp(e){for(var t,n,r,s=0,a=7*(curvoice.ckey.k_sf-curvoice.okey.k_sf+12)%12;;){if(!(t=e.a_gch[s++]))return;"g"==t.type&&((r=(n=t.text).indexOf("\t"))>=0&&(r++,n=n.slice(0,r)+gch_tr1(n.slice(r),a)),t.text=gch_tr1(n,a))}}function gch_build(e){var t,n,r,s,a=curvoice.pos.gch==SL_BELOW?-1:1,o=get_font("gchord"),i=get_font("annotation"),c=0,l=0,f=0,u=0,p=o.size,d=i.size,_=cfmt.gchordbox;for(e.a_gch=a_gch,a_gch=null,cfmt.capo&&gch_capo(e),curvoice.vtransp&&gch_transp(e),s=0;s<e.a_gch.length;s++){if("g"==(t=e.a_gch[s]).type)cfmt.chordnames&&(t.text=t.text.replace(/A|B|C|D|E|F|G/g,function(e){return cfmt.chordnames[e]}),"H"==cfmt.chordnames.B&&(t.text=t.text.replace(/Hb/g,"Bb"))),t.text=t.text.replace(/##|#|=|bb|b/g,function(e){switch(e){case"##":return"&#x1d12a;";case"#":return"";case"=":return"";case"b":return""}return"&#x1d12b;"}),t.font=o;else if(t.text=cnv_escape(t.text),t.font=i,"@"==t.type&&!user.anno_start)continue;switch(gene.curfont=t.font,n=strw(t.text),t.w=n,t.type){case"@":break;case"^":(r=.4*n)>8&&(r=8),t.x=-r,c-=d,t.y=c;break;case"_":(r=.4*n)>8&&(r=8),t.x=-r,l-=d,t.y=l;break;case"<":t.x=-(n+6),f-=d,t.y=f+d/2;break;case">":t.x=6,u-=d,t.y=u+d/2;break;default:t.box=_,(r=.4*n)>8&&(r=8),t.x=-r,a<0?(l-=p,t.y=l,_&&(l-=2,t.y-=1)):(c-=p,t.y=c,_&&(c-=2,t.y-=1))}}for(f/=2,u/=2,s=0;s<e.a_gch.length;s++)switch((t=e.a_gch[s]).type){case"^":t.y-=c;break;case"<":t.y-=f;break;case">":t.y-=u;break;case"g":a>0&&(t.y-=c)}}function draw_gchord(e,t,n){var r,s,a,o,i,c,l,f,u,p,d,_=e.a_gch[0].w,m=y_get(e.st,1,e.x-2,_),v=y_get(e.st,0,e.x-2,_),y=3*((e.notes[e.nhd].pit+e.notes[0].pit>>1)-18);for(o=0;o<e.a_gch.length&&!("g"==(r=e.a_gch[o]).type&&(s=r,r.y<0));o++);for(s&&(s.y>=0?m<n&&(m=n):v>t&&(v=t)),set_dscale(e.st),o=0;o<e.a_gch.length;o++){switch(use_font((r=e.a_gch[o]).font),gene.curfont=gene.deffont=r.font,d=r.font.size,_=r.w,i=e.x+r.x,a=r.text,r.type){case"_":c=r.y+v,y_set(e.st,0,i,_,c-.2*d-2);break;case"^":c=r.y+m,y_set(e.st,1,i,_,c+.8*d+2);break;case"<":e.notes[0].acc&&(i-=e.notes[0].shac),c=r.y+y-d/2;break;case">":i+=e.xmx,e.dots>0&&(i+=1.5+3.5*e.dots),c=r.y+y-d/2;break;default:if(p=r.box?3:2,r.y>=0?(c=r.y+m,y_set(e.st,!0,i,_,c+d+p)):(c=r.y+v,y_set(e.st,!1,i,_,c-p)),(f=a.indexOf("\t"))>=0){i=realwidth;for(var h=e.next;h;h=h.next){switch(h.type){default:continue;case NOTE:case REST:case BAR:i=h.x}break}for(u=2;!((f=a.indexOf("\t",f+1))<0);)u++;var b=(i-e.x)/u;for(i=e.x,c*=staff_tb[e.st].staffscale,user.anno_start&&user.anno_start("gchord",r.istart,r.iend,i-2,c+d+2,_+4,d+4,e),u=f=0;!((f=a.indexOf("\t",u))<0);)xy_str(i,c,a.slice(u,f),"c"),i+=b,u=f+1;xy_str(i,c,a.slice(u),"c"),user.anno_stop&&user.anno_stop("gchord",r.istart,r.iend,e.x-2,c+d+2,_+4,d+4,e);continue}break;case"@":(c=r.y+y)>0?(l=c+d)>staff_tb[e.st].ann_top&&(staff_tb[e.st].ann_top=l):c<staff_tb[e.st].ann_bot&&(staff_tb[e.st].ann_bot=c)}user.anno_start&&user.anno_start("annot",r.istart,r.iend,i-2,c+d+2,_+4,d+4,e),r.box?xy_str_b(i,c,a):xy_str(i,c,a),user.anno_stop&&user.anno_stop("annot",r.istart,r.iend,i-2,c+d+2,_+4,d+4,e)}}var psdeco=function(e,t,n,r){return!1},psxygl=function(e,t,n){return!1};function ps_def(e){function t(e,t,n,r,s){var a=psvg.getorig();psvg.ps_flush(),e((t+a[0])*stv_g.scale,n-a[1],r,s)}psvg||"function"!=typeof Psvg||(Abc.prototype.arpps=function(e,n,r){t(out_arp,n,r,e)},Abc.prototype.ltrps=function(e,n,r){t(out_ltr,n,r,e)},Abc.prototype.xyglsps=function(e,n,r,s){t(out_deco_str,n,r,s,e)},Abc.prototype.xyglvps=function(e,n,r,s){t(out_deco_val,n,r,s,e)},Abc.prototype.xyglps=function(e,n,r){t(xygl,e,n,r)},Abc.prototype.get_y=function(e,t){return t+staff_tb[e].y},Abc.prototype.set_ps=function(e,t){psdeco=e,psxygl=t},Abc.prototype.stv_g=stv_g,Abc.prototype.psget_x=function(){return posx/stv_g.scale},Abc.prototype.psget_y=function(){return stv_g.started?stv_g.dy:posy},psvg=new Psvg(e))}Abc.prototype.ps_def=ps_def,ps_def(this),font_init(),init_tune();for(var i=0;i<128;i++)maci[i]=0}exports.abc2svg=abc2svg,exports.Abc=Abc}]).default});
//# sourceMappingURL=react-abc2svg.min.js.map